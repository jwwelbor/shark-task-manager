---
task_key: T-E04-F06-003
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F06-task-creation
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F06-001", "T-E04-F06-002", "T-E04-F02-001"]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F06-003.md
---

# Task: Task Creation Command Implementation

## Goal

Implement the `pm task create` CLI command using Cobra that orchestrates validation, key generation, database insertion, template rendering, and file creation in a single atomic operation with proper error handling and output formatting.

## Success Criteria

- [ ] `pm task create` command registered with Cobra CLI framework
- [ ] Required flags implemented: --epic, --feature, --title, --agent
- [ ] Optional flags implemented: --description, --priority, --depends-on, --json
- [ ] Missing required flags return descriptive errors with exit code 1
- [ ] Input validation executed before any database/file operations
- [ ] Task creation is atomic: database record AND file both created, or neither
- [ ] Database record created with all metadata per PRD requirements
- [ ] Task history record created with "Task created" entry
- [ ] Markdown file generated from template and saved to docs/tasks/todo/
- [ ] Human-readable output displays task key, file path, and next steps
- [ ] JSON output flag returns complete task object
- [ ] All error cases handled with clear messages and proper exit codes
- [ ] Integration with E04-F02 CLI framework (colored output, error handling)
- [ ] Integration with E04-F05 folder management (atomic file operations)

## Implementation Guidance

### Overview

This task brings together all components to implement the complete task creation workflow. The command orchestrates validation, key generation, database operations, template rendering, and file creation. Atomicity is critical - if any step fails, all changes must be rolled back to prevent orphaned database records or files.

### Key Requirements

- **Command Signature**: Per [PRD - Task Creation Command Requirements 1-4](../prd.md#task-creation-command-pm-task-create)
  ```go
  var taskCreateCmd = &cobra.Command{
      Use:   "create",
      Short: "Create a new task",
      Long:  "Create a new task with automatic key generation and file creation",
      RunE: func(cmd *cobra.Command, args []string) error {
          // Implementation
          return nil
      },
  }

  func init() {
      taskCreateCmd.Flags().StringP("epic", "e", "", "Epic key (e.g., E01) (required)")
      taskCreateCmd.MarkFlagRequired("epic")
      taskCreateCmd.Flags().StringP("feature", "f", "", "Feature key (e.g., F02 or E01-F02) (required)")
      taskCreateCmd.MarkFlagRequired("feature")
      taskCreateCmd.Flags().StringP("title", "t", "", "Task title (required)")
      taskCreateCmd.MarkFlagRequired("title")
      taskCreateCmd.Flags().StringP("agent", "a", "", "Agent type: frontend, backend, api, testing, devops, general (required)")
      taskCreateCmd.MarkFlagRequired("agent")
      taskCreateCmd.Flags().StringP("description", "d", "", "Detailed description")
      taskCreateCmd.Flags().IntP("priority", "p", 5, "Priority (1-10)")
      taskCreateCmd.Flags().String("depends-on", "", "Comma-separated dependency task keys")
      taskCreateCmd.Flags().Bool("json", false, "Output JSON instead of human-readable format")

      taskCmd.AddCommand(taskCreateCmd)
  }
  ```

- **Workflow Steps**: Per [PRD - Requirements 5-36](../prd.md#functional-requirements)
  1. Validate all inputs (epic exists, feature exists, agent valid, priority valid, dependencies exist)
  2. Generate next task key (using key generator from T-E04-F06-002)
  3. Begin database transaction
  4. Insert task record into database
  5. Insert task_history record (status change: null → todo)
  6. Render template with task data (using template renderer from T-E04-F06-001)
  7. Write markdown file to docs/tasks/todo/{task-key}.md
  8. Commit database transaction
  9. Output success message or JSON

- **Database Record Creation**: Per [PRD - Requirements 17-18](../prd.md#database-record-creation)
  - Use TaskRepository.Create() from E04-F01
  - Fields: feature_id, key, title, description, status="todo", agent_type, priority, depends_on (JSON array), file_path, created_at
  - Use database transaction for atomicity with database/sql Tx

- **Task History Record**: Per [PRD - Requirement 36](../prd.md#history-recording)
  - Use TaskHistoryRepository.Create() from E04-F01
  - Fields: task_id, old_status=null, new_status="todo", agent=current_user, notes="Task created", timestamp=created_at

- **Atomic Creation**: Per [PRD - Requirements 30-33](../prd.md#atomic-creation)
  - Use TransactionalFileOperation from E04-F05 (if available)
  - Wrap database operations in transaction (tx.Begin(), defer tx.Rollback(), tx.Commit())
  - If database fails, don't create file
  - If file creation fails, rollback database transaction
  - Both operations succeed together or fail together

- **Template Rendering**: Per [PRD - Requirements 25-29](../prd.md#markdown-file-creation)
  - Use template renderer from T-E04-F06-001
  - Select template based on agent type
  - Render with task data (key, title, description, epic, feature, agent_type, priority, depends_on, created_at)
  - Save to `docs/tasks/todo/{task-key}.md`
  - Use UTF-8 encoding (Go's default for string operations)
  - Return error if file already exists (don't overwrite) using os.O_CREATE|os.O_EXCL

- **Command Output**: Per [PRD - Requirements 34-35](../prd.md#command-output)
  - Human-readable:
    ```
    Created task T-E01-F02-003: Build auth middleware
    File created at: docs/tasks/todo/T-E01-F02-003.md
    Start work with: pm task start T-E01-F02-003
    ```
  - JSON output (--json flag):
    ```json
    {
      "key": "T-E01-F02-003",
      "title": "Build auth middleware",
      "status": "todo",
      "file_path": "docs/tasks/todo/T-E01-F02-003.md",
      "epic": "E01",
      "feature": "E01-F02",
      "agent_type": "backend",
      "priority": 5,
      "depends_on": ["T-E01-F01-005"],
      "created_at": "2025-12-14T10:30:00Z"
    }
    ```

- **Error Handling**: Per [PRD - Non-Functional Requirements - Usability](../prd.md#non-functional-requirements)
  - Specific error messages with actionable suggestions
  - Example: "Epic E99 does not exist. Use 'pm epic list' to see available epics."
  - Return error from RunE to set exit code 1 (Cobra handles this)
  - Rollback all changes on error using defer tx.Rollback()

### Files to Create/Modify

**New Files**:
- `cmd/pm/task_create.go` - Task creation CLI command (~500 lines)
- `internal/taskcreation/creator.go` - Task creation orchestration (~250 lines)
- `cmd/pm/task_create_test.go` - Command tests (~350 lines)
- `internal/taskcreation/integration_test.go` - End-to-end creation tests (~300 lines)

**Modified Files**:
- `cmd/pm/task.go` - Register task create subcommand
- `cmd/pm/main.go` - Wire up dependencies

### Integration Points

- **CLI Framework (E04-F02)**: Use Cobra commands and flags, colored output (fatih/color or similar), --json support pattern
- **Database (E04-F01)**: Use TaskRepository and TaskHistoryRepository for database operations
- **Folder Management (E04-F05)**: Use folder utilities to ensure docs/tasks/todo/ exists
- **Key Generator (T-E04-F06-002)**: Use key generation function for automatic numbering
- **Template Renderer (T-E04-F06-001)**: Use template rendering for markdown file generation
- **Validators (T-E04-F06-002)**: Use validation functions for all inputs

### Orchestration Flow

```go
// Pseudo-code
func runTaskCreate(cmd *cobra.Command, args []string) error {
    // 1. Parse CLI flags (Cobra handles this)
    epic, _ := cmd.Flags().GetString("epic")
    feature, _ := cmd.Flags().GetString("feature")
    title, _ := cmd.Flags().GetString("title")
    agent, _ := cmd.Flags().GetString("agent")
    description, _ := cmd.Flags().GetString("description")
    priority, _ := cmd.Flags().GetInt("priority")
    dependsOn, _ := cmd.Flags().GetString("depends-on")
    outputJSON, _ := cmd.Flags().GetBool("json")

    // 2. Call validators
    validated, err := ValidateTaskInput(TaskInput{
        EpicKey:     epic,
        FeatureKey:  feature,
        AgentType:   agent,
        Priority:    priority,
        DependsOn:   dependsOn,
    })
    if err != nil {
        return err
    }

    // 3. Generate task key
    key, err := GenerateTaskKey(epic, validated.NormalizedFeatureKey)
    if err != nil {
        return err
    }

    // 4. Begin transaction
    tx, err := db.Begin()
    if err != nil {
        return err
    }
    defer tx.Rollback() // Rollback if not committed

    // 5. Create task record
    task := &Task{
        FeatureID:   validated.FeatureID,
        Key:         key,
        Title:       title,
        Description: description,
        Status:      "todo",
        AgentType:   agent,
        Priority:    priority,
        DependsOn:   validated.ValidatedDepsOn, // JSON
        FilePath:    fmt.Sprintf("docs/tasks/todo/%s.md", key),
        CreatedAt:   time.Now().UTC(),
    }
    err = taskRepo.CreateWithTx(tx, task)
    if err != nil {
        return err
    }

    // 6. Create history record
    history := &TaskHistory{
        TaskID:    task.ID,
        OldStatus: "",
        NewStatus: "todo",
        Agent:     getCurrentUser(),
        Notes:     "Task created",
        Timestamp: task.CreatedAt,
    }
    err = historyRepo.CreateWithTx(tx, history)
    if err != nil {
        return err
    }

    // 7. Render template
    templateData := TemplateData{
        Key:         key,
        Title:       title,
        Description: description,
        Epic:        epic,
        Feature:     validated.NormalizedFeatureKey,
        AgentType:   agent,
        Priority:    priority,
        DependsOn:   validated.ValidatedDepsOn,
        CreatedAt:   task.CreatedAt,
    }
    markdown, err := templateRenderer.Render(agent, templateData)
    if err != nil {
        return err
    }

    // 8. Write file
    filePath := filepath.Join("docs", "tasks", "todo", fmt.Sprintf("%s.md", key))
    err = os.MkdirAll(filepath.Dir(filePath), 0755)
    if err != nil {
        return err
    }
    err = writeFileExclusive(filePath, []byte(markdown))
    if err != nil {
        return err
    }

    // 9. Commit transaction
    err = tx.Commit()
    if err != nil {
        return err
    }

    // 10. Output result
    if outputJSON {
        jsonData, _ := json.MarshalIndent(task, "", "  ")
        fmt.Println(string(jsonData))
    } else {
        fmt.Printf("Created task %s: %s\n", key, title)
        fmt.Printf("File created at: %s\n", filePath)
        fmt.Printf("Start work with: pm task start %s\n", key)
    }

    return nil
}
```

### Error Scenarios

- **Validation Failure**: Validation error raised → Display error, exit 1, no database/file changes
- **Database Constraint Violation**: Duplicate key, foreign key violation → Rollback transaction, display error, exit 1
- **File Already Exists**: File exists at path → Rollback transaction, display error, exit 1
- **File Write Failure**: Permission error, disk full → Rollback transaction, display error, exit 1
- **Template Rendering Failure**: Template not found, rendering error → Display error, exit 1, no database/file changes

## Validation Gates

- **Command Registration**: Per [PRD - Acceptance Criteria - Basic Task Creation](../prd.md#basic-task-creation)
  - Command `pm task create` is available
  - Required flags are enforced by Click
  - Missing required flag shows error and exits with code 1

- **End-to-End Creation**: Per [PRD - Acceptance Criteria - Basic Task Creation](../prd.md#basic-task-creation)
  - Create task with all required flags
  - Verify database record exists
  - Verify file exists at correct path
  - Verify file contains correct frontmatter
  - Verify task appears in `pm task list` (if implemented)

- **Atomicity Tests**: Per [PRD - Acceptance Criteria - Atomic Creation](../prd.md#atomic-creation)
  - Test database fails → no file created
  - Test file creation fails → no database record exists
  - Test partial failure scenarios

- **Output Format Tests**: Per [PRD - Acceptance Criteria - JSON Output](../prd.md#json-output)
  - Test human-readable output format
  - Test --json flag produces valid JSON
  - Test JSON can be parsed with jq
  - Verify JSON contains all expected fields

- **Error Handling Tests**: Per [PRD - Acceptance Criteria - Input Validation](../prd.md#input-validation)
  - Test non-existent epic error
  - Test invalid agent type error
  - Test non-existent dependency error
  - Test missing required flag error
  - Verify all errors include actionable messages
  - Verify all errors exit with code 1

- **Integration Tests**: Test full workflow
  - Create task with minimal metadata
  - Create task with full metadata (description, priority, dependencies)
  - Create multiple tasks in sequence (verify numbering)
  - Create task with dependencies on previous tasks

## Context & Resources

- **PRD**: [Task Creation & Templating PRD](../prd.md)
  - [Task Creation Command Requirements 1-40](../prd.md#functional-requirements)
  - [Atomic Creation Requirements 30-33](../prd.md#atomic-creation)
  - [Command Output Requirements 34-35](../prd.md#command-output)
  - [All Acceptance Criteria](../prd.md#acceptance-criteria)
- **Epic**: [E04 Task Management CLI](../../epic.md)
- **CLI Framework**: Reference E04-F02 for Click patterns and Rich formatting
- **Database**: Reference E04-F01 for repository interfaces

## Notes for Agent

- **Cobra Integration**: Use Cobra's built-in flag validation (MarkFlagRequired). Define custom validation in PreRunE if needed
- **Transaction Management**: Use `tx, _ := db.Begin()` with `defer tx.Rollback()` for automatic rollback. Only call `tx.Commit()` on success
- **File Path Construction**: Use `filepath.Join()` for cross-platform path construction. Go handles forward/backward slashes automatically
- **Timestamp Format**: Use `time.Now().UTC().Format(time.RFC3339)` for ISO 8601 format with UTC timezone
- **Current User Detection**: For task history, use `os.Getenv("USER")` or `os.Getenv("USERNAME")` for current user. Default to "system" if not available
- **Colored Output**: Use `fatih/color` package for colored output. Use `color.Green()`, `color.Red()`, `color.Blue()` for formatting
- **JSON Serialization**: Use `encoding/json` package. Create a struct for JSON output or use the Task model directly. Ensure time.Time fields use RFC3339 format
- **File Write Exclusive**: Use `os.OpenFile(path, os.O_CREATE|os.O_EXCL|os.O_WRONLY, 0644)` to create file only if it doesn't exist. Returns error if file exists
- **Testing Strategy**: Use table-driven tests with Go's testing package. Use testify/assert for assertions. Mock database and file operations using interfaces. Use temporary directories with `t.TempDir()` for file tests
- **Error Message Quality**: Use fmt.Errorf with context. Include specific values in errors: "Epic E99 does not exist" (not just "Epic not found"). Consider error wrapping with %w for error chains
- **Folder Creation**: Use `os.MkdirAll(path, 0755)` to ensure directory exists (similar to mkdir -p)
- **Dependency Injection**: Pass dependencies (repos, renderer) as parameters or use a struct to hold them. This improves testability
- **SQLite Driver**: Use `github.com/mattn/go-sqlite3` driver imported with blank identifier
