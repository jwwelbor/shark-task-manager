---
task_key: T-E04-F04-001
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [E04-F01-database-schema, E04-F02-cli-infrastructure]
estimated_time: 6 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F04-001.md
---

# Task: Progress Calculation Service

## Goal

Implement the core progress calculation engine that computes feature progress (completed tasks / total tasks) and epic progress (weighted average of feature progress) using efficient SQL queries to avoid N+1 query problems.

## Success Criteria

- [ ] Feature progress calculation implemented: (completed + archived tasks) / total tasks × 100
- [ ] Epic progress calculation implemented: weighted average of feature progress by task count
- [ ] Edge cases handled: zero tasks (return 0.0), zero features (return 0.0), division by zero (return 0.0)
- [ ] SQL queries use JOINs/aggregations (no N+1 query problems)
- [ ] Progress values returned as floats with precision to one decimal place
- [ ] Service functions callable from CLI commands
- [ ] Unit tests cover all edge cases and acceptance criteria scenarios
- [ ] EXPLAIN QUERY PLAN shows efficient execution (no full table scans for indexed queries)

## Implementation Guidance

### Overview

This phase creates the business logic layer for calculating progress percentages. The implementation must be mathematically accurate and performant, using database-level aggregations rather than loading all data into memory. All progress calculations must handle edge cases gracefully (features with no tasks, epics with no features).

### Key Requirements

- **Feature Progress Formula**: See [PRD - Functional Requirements #26](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Formula: (count of tasks with status IN ('completed', 'archived')) / (count of all tasks) × 100
  - Return type: float (REAL in SQLite)
  - Edge case: If feature has 0 tasks, return 0.0 (not null, not error)

- **Epic Progress Formula**: See [PRD - Functional Requirements #28-31](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Formula: Σ(feature_progress × feature_task_count) / Σ(feature_task_count)
  - Weighted by task count per feature
  - Edge cases:
    - Epic has 0 features → return 0.0
    - Epic has features with 0 tasks → those features contribute 0% to weighted average
    - Feature with 10 tasks at 50% has 5× weight of feature with 2 tasks at 50%

- **Performance Requirements**: See [PRD - Non-Functional Requirements - Performance](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#non-functional-requirements)
  - Progress calculations must not cause N+1 query problems
  - Use SQL JOINs or aggregations (e.g., COUNT, SUM, AVG)
  - Single query per epic/feature progress calculation
  - Leverage indexes from E04-F01 database schema

- **Database Integration**: See [PRD - Functional Requirements #33-35](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Query E04-F01 database using ORM models (Epic, Feature, Task)
  - Use SQLAlchemy select() with JOINs and aggregations
  - Leverage existing repositories from E04-F01 or create new service layer

### Files to Create/Modify

**New Files**:
- `pm/services/__init__.py` - Services package initialization
- `pm/services/progress.py` - Progress calculation service (~300 lines)
  - `calculate_feature_progress(feature_id: int) -> float`
  - `calculate_feature_progress_by_key(feature_key: str) -> float`
  - `calculate_epic_progress(epic_id: int) -> float`
  - `calculate_epic_progress_by_key(epic_key: str) -> float`
  - Helper functions for SQL aggregations

**Test Files**:
- `tests/unit/services/test_progress.py` - Unit tests for progress calculations (~400 lines)
- `tests/integration/test_progress_integration.py` - Integration tests with database (~200 lines)

### Integration Points

- **E04-F01 Database**: Use ORM models (Epic, Feature, Task) and repositories
  - Import from `pm.database.models`
  - Use `SessionFactory` for database connections
  - Query using SQLAlchemy 2.0 select() syntax

- **E04-F02 CLI Framework**: Service functions called by CLI commands
  - Invoked by `pm epic list`, `pm epic get`, `pm feature list`, `pm feature get`
  - Return plain float values (formatting happens in CLI layer)
  - Raise domain exceptions for error conditions

## Validation Gates

- **Accuracy Tests**: Verify all acceptance criteria scenarios from PRD
  - Feature with 10 tasks (7 completed, 2 in_progress, 1 todo) → 70.0% progress
  - Feature with 0 tasks → 0.0% progress
  - Epic with 2 features (F1: 50% with 10 tasks, F2: 100% with 10 tasks) → 75.0% progress
  - Epic with 2 features (F1: 100% with 1 task, F2: 0% with 9 tasks) → 10.0% progress
  - Epic with 0 features → 0.0% progress

- **Edge Case Tests**:
  - Division by zero handling (zero tasks, zero features)
  - Features with mixed status tasks
  - Epics with varying feature sizes
  - Null/missing data handling

- **Performance Tests**:
  - Run EXPLAIN QUERY PLAN on progress queries
  - Verify no full table scans (should use indexes)
  - Benchmark query execution time (<50ms for single feature, <100ms for epic with 50 features)
  - No N+1 queries (verify with SQL logging enabled)

- **Integration Tests**:
  - Progress calculation with real database
  - Create test data: epics with features, features with tasks
  - Verify calculations match expected percentages
  - Test with E04-F01 database session management

## Context & Resources

- **PRD**: [Complete Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md)
  - [Functional Requirements #26-32](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements) - Progress calculation formulas
  - [Acceptance Criteria - Progress Calculation](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#progress-calculation) - Test scenarios
  - [Non-Functional Requirements - Performance](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#non-functional-requirements) - Performance targets

- **Database Schema** (E04-F01):
  - Epic, Feature, Task models with relationships
  - Indexes on epic_id, feature_id, status columns
  - CASCADE deletes from epic → feature → task

- **Existing Patterns**:
  - Check E04-F01 repositories for query patterns
  - Follow E04-F01 error handling (custom exceptions)
  - Use E04-F02 session management patterns

## Notes for Agent

- **Weighted Average**: Epic progress is NOT a simple average. Feature with 100 tasks has 10× weight of feature with 10 tasks. Formula: `SUM(feature_progress × task_count) / SUM(task_count)`.
- **Status Filtering**: Only count tasks with status='completed' OR status='archived' as done. All other statuses (todo, in_progress, blocked, etc.) are incomplete.
- **Precision**: Return float values. CLI layer will format to one decimal place (e.g., "75.3%").
- **SQL Efficiency**: Use single query with JOINs. Example: `SELECT COUNT(*) FROM tasks WHERE feature_id = ? AND status IN ('completed', 'archived')`.
- **Error Handling**: If epic/feature doesn't exist, raise `DatabaseNotFound` exception (from E04-F01). Let CLI layer convert to exit code 1.
- **Testing Strategy**: Create test fixtures with known progress values. Assert calculated progress matches expected float values.
