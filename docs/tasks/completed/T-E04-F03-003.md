---
task_key: T-E04-F03-003
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F03-002"]
estimated_time: 6 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F03-003.md
priority: 2
---

# PRP: Blocking and Exception State Operations (block, unblock, reopen)

## Goal

Implement task lifecycle commands for handling exceptions and rework: `pm task block` (marks tasks as blocked with reasons), `pm task unblock` (returns blocked tasks to todo), and `pm task reopen` (returns tasks from review to in-progress for rework). These commands handle workflow deviations while maintaining state consistency and history tracking.

## Success Criteria

- [ ] `pm task block <task-key> --reason="..."` transitions task to "blocked" status
- [ ] Block command accepts task from "todo" or "in_progress" states
- [ ] Block command requires `--reason` flag (mandatory blocking reason)
- [ ] Blocked_at timestamp and blocked_reason fields set correctly
- [ ] Blocked tasks remain in their current folder (no file move)
- [ ] `pm task unblock <task-key>` transitions task from "blocked" to "todo"
- [ ] Unblock command clears blocked_reason and blocked_at fields
- [ ] Unblock command triggers file move to todo/ folder
- [ ] `pm task reopen <task-key>` transitions task from "ready_for_review" to "in_progress"
- [ ] Reopen command accepts optional `--notes` flag for rework explanation
- [ ] Reopen command clears completed_at timestamp
- [ ] Reopen command triggers file move from ready-for-review/ back to active/
- [ ] All commands validate state transitions and reject invalid states
- [ ] History records created for all state changes with reasons/notes
- [ ] Feature progress recalculated after state changes
- [ ] All commands complete in <200ms
- [ ] 100% test coverage for blocking operations

## Implementation Guidance

### Overview

This phase implements the exception handling and rework commands that manage workflow deviations. Blocking allows agents to mark tasks they cannot complete due to missing dependencies or requirements. Unblocking returns tasks to the queue once blockers are resolved. Reopening enables developers to send tasks back for additional work after review.

### Key Requirements

- **Task Block Command**: Implement as specified in [PRD - Task Block](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-block-pm-task-block)
  - Accept task key as required argument
  - Accept required `--reason` flag explaining why task is blocked
  - Validate current status is "todo" or "in_progress"
  - Update database: status = "blocked", blocked_at = current UTC timestamp, blocked_reason = reason
  - Record history with blocking reason
  - Do NOT move file (blocked tasks stay in current folder for visibility)
  - Display success message: "Task T-E01-F02-003 blocked. Reason: Missing API specification"
  - Missing --reason flag shows error: "Missing required option '--reason'" with exit code 1

- **Task Unblock Command**: Implement as specified in [PRD - Task Unblock](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-unblock-pm-task-unblock)
  - Accept task key as required argument
  - Validate current status is "blocked" (reject if not)
  - Update database: status = "todo", clear blocked_reason (NULL), clear blocked_at (NULL)
  - Record history: old_status="blocked", new_status="todo"
  - Trigger file move to todo/ folder if needed
  - Display success message: "Task T-E01-F02-003 unblocked and returned to todo queue"

- **Task Reopen Command**: Implement as specified in [PRD - Task Reopen](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-reopen-pm-task-reopen)
  - Accept task key as required argument
  - Accept optional `--notes` flag explaining why task needs rework
  - Validate current status is "ready_for_review" (reject if not)
  - Update database: status = "in_progress", clear completed_at (NULL)
  - Record history with reopen notes if provided
  - Trigger file move from ready-for-review/ back to active/
  - Update feature progress calculation (task no longer counts toward completion)
  - Display success message: "Task T-E01-F02-003 reopened for rework. File moved to active/"

- **State Transition Validation**: Extend validation from T-E04-F03-002
  - Add valid transitions:
    - todo → blocked (block)
    - in_progress → blocked (block)
    - blocked → todo (unblock)
    - ready_for_review → in_progress (reopen)
  - Reject all other transitions with clear error messages
  - Return exit code 3 for validation errors

- **History Recording**: Extend history service from T-E04-F03-002
  - Record blocking reason in history.notes field
  - Record reopen explanation in history.notes field
  - Include agent identifier for all operations
  - Ensure atomic recording with state updates

### Files to Create/Modify

**New Files**:
- `pm/cli/commands/task_exceptions.py` - Exception handling command implementations (~200 lines)
- `pm/services/task_exception_service.py` - Business logic for blocking operations (~150 lines)
- `tests/unit/cli/test_task_exceptions.py` - Unit tests for CLI commands (~150 lines)
- `tests/unit/services/test_task_exception_service.py` - Service layer tests (~200 lines)
- `tests/integration/test_task_exception_commands.py` - End-to-end tests (~150 lines)

**Modified Files**:
- `pm/cli/__init__.py` - Register exception handling commands
- `pm/cli/commands/__init__.py` - Export exception handling commands
- `pm/services/state_validator.py` - Add block/unblock/reopen transitions to validation map
- `pm/database/models.py` - Ensure blocked_at, blocked_reason fields exist on Task model

### Integration Points

- **E04-F01 Database**: Uses Task model with blocked_at, blocked_reason fields
- **E04-F02 CLI Framework**: Uses Click command registration, required/optional flags
- **E04-F03-002**: Reuses state_validator and history_service from core transitions
- **E04-F05 Folder Management**: Calls file move functions for unblock and reopen operations
  - Block operation does NOT trigger file move (intentional)

Reference [PRD - Integration with Other Features](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#integration-with-other-features).

## Validation Gates

- **Block Command Tests**: Verify from [PRD - Task Block Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-block)
  - Task with status="in_progress" can be blocked successfully
  - Task with status="todo" can be blocked successfully
  - Block requires --reason flag (error if missing)
  - Blocked_at timestamp is set correctly
  - Blocked_reason is stored
  - File does NOT move (stays in current folder)
  - History record includes blocking reason

- **Unblock Command Tests**: Verify from [PRD - Task Unblock Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-unblock)
  - Task with status="blocked" can be unblocked
  - Task with other statuses cannot be unblocked
  - Unblock clears blocked_reason (NULL)
  - Unblock clears blocked_at (NULL)
  - File moves to todo/ folder
  - History record created

- **Reopen Command Tests**: Verify from [PRD - Task Reopen Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-reopen)
  - Task with status="ready_for_review" can be reopened
  - Task with other statuses cannot be reopened
  - Reopen notes are recorded in history when provided
  - Completed_at is cleared (NULL)
  - File moves from ready-for-review/ back to active/
  - Feature progress is recalculated (task no longer counts as complete)

- **State Validation Tests**: Extend from T-E04-F03-002
  - Invalid block transitions rejected (e.g., completed → blocked)
  - Invalid unblock transitions rejected (e.g., todo → todo via unblock)
  - Invalid reopen transitions rejected (e.g., in_progress → in_progress via reopen)
  - All rejections return exit code 3 with clear messages

- **Required Flag Tests**: Verify Click validation
  - Block command without --reason shows error and exits with code 1
  - Error message is clear: "Missing required option '--reason'"

- **Performance Tests**: Meet <200ms target from [PRD - Performance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#non-functional-requirements)

- **Coverage**: 100% line coverage for exception operations
  - Run `pytest --cov=pm/cli/commands/task_exceptions --cov=pm/services/task_exception_service --cov-report=term-missing`

## Context & Resources

- **PRD**: [Task Lifecycle Operations PRD](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md)
  - [Task Block Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-block-pm-task-block)
  - [Task Unblock Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-unblock-pm-task-unblock)
  - [Task Reopen Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-reopen-pm-task-reopen)
  - [State Transition Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#state-transition-validation)
  - [Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#acceptance-criteria)
- **E04-F01 Database**: [Task Model Schema](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md)
- **E04-F02 CLI Framework**: [CLI Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)

## Notes for Agent

- **Required vs Optional Flags**: Use Click `@click.option("--reason", required=True)` for block command, `@click.option("--notes")` (optional) for reopen
- **No File Move for Block**: Block is intentional - keeps blocked tasks visible in their current folder (todo/ or active/) so developers see them
- **Field Clearing**: Set blocked_reason and completed_at to NULL/None when clearing (not empty string)
- **State Transition Map**: Update the VALID_TRANSITIONS dictionary from T-E04-F03-002 to include new transitions
- **Progress Impact**: Reopen reduces feature progress (task was counted as complete, now isn't)
- **Error Messages**: For missing --reason: "Error: --reason is required when blocking a task. Explain why the task cannot proceed."
- **History Notes**: Store blocking reason in history.notes field for audit trail
- **Unblock Folder**: If task was blocked in active/, unblock should move to todo/ (reset to initial state)
