---
task_key: T-E04-F04-002
status: completed
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F04-001]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F04-002.md
---

# Task: Epic Query Commands

## Goal

Implement `pm epic list` and `pm epic get <epic-key>` CLI commands with Rich table formatting, progress percentage display, and comprehensive error handling.

## Success Criteria

- [ ] `pm epic list` command implemented with table output
- [ ] `pm epic get <epic-key>` command implemented with epic details and feature breakdown
- [ ] Rich tables formatted to fit 80-column terminal width
- [ ] Progress percentages displayed with one decimal place (e.g., "45.3%")
- [ ] Progress values right-aligned for easy scanning
- [ ] Non-existent epic returns exit code 1 with message "Error: Epic <key> does not exist"
- [ ] Empty epic list shows "No epics found" (exit code 0)
- [ ] Database errors return exit code 2 with user-friendly message
- [ ] Commands integrate with E04-F02 CLI framework (Click decorators, error handling)
- [ ] Help text accurate and examples provided

## Implementation Guidance

### Overview

This phase implements the epic query commands that allow users to view all epics or drill into specific epic details. Commands must produce human-readable table output using Rich formatting, integrate with the progress calculation service from T-E04-F04-001, and follow E04-F02 CLI framework patterns.

### Key Requirements

- **`pm epic list` Command**: See [PRD - Functional Requirements #1-7](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Returns all epics from database
  - Table columns: Key | Title | Status | Progress | Priority
  - Progress format: "45.3%" (one decimal place, right-aligned)
  - Calls progress calculation service for each epic
  - Empty results: "No epics found" message (exit code 0)

- **`pm epic get <epic-key>` Command**: See [PRD - Functional Requirements #8-13](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Returns single epic by key (e.g., "E01")
  - Displays epic metadata: key, title, description, status, priority, business_value, progress
  - Displays table of all features: Key | Title | Status | Progress | Task Count
  - Calls progress calculation service for epic and all features
  - Non-existent epic: exit code 1, message "Error: Epic <key> does not exist"
  - Suggests related command: "Use 'pm epic list' to see available epics"

- **Table Formatting**: See [PRD - Non-Functional Requirements - Usability](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#non-functional-requirements)
  - Use Rich library for tables (already available from E04-F02)
  - Fit in 80-column terminal width
  - Truncate long titles with "..." ellipsis
  - Progress percentages right-aligned
  - Consistent styling across all tables

- **Error Handling**: See [PRD - Functional Requirements #39-41](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Non-existent epic: exit code 1, clear error message
  - Database connection errors: exit code 2, message "Error: Database error. Run with --verbose for details."
  - Integration with E04-F02 error handling framework
  - Helpful error messages with suggestions

### Files to Create/Modify

**New Files**:
- `pm/cli/epic.go` - Epic command group and subcommands (~400 lines)
  - `@click.group()` for epic command group
  - `@epic.command()` for list subcommand
  - `@epic.command()` for get subcommand
  - Helper functions for table formatting

**Modified Files**:
- `pm/cli/__init__.go` - Register epic command group with main CLI
- `pm/cli/main.go` - Import and add epic commands (if not already structured for groups)

**Test Files**:
- `tests/unit/cli/test_epic.go` - Unit tests for epic commands (~300 lines)
- `tests/integration/cli/test_epic_integration.go` - Integration tests (~200 lines)

### Integration Points

- **Progress Service** (T-E04-F04-001): Call progress calculation functions
  - Import from `pm.services.progress`
  - `calculate_epic_progress_by_key(epic_key)` for epic progress
  - `calculate_feature_progress(feature_id)` for feature progress in epic details

- **E04-F01 Database**: Query Epic and Feature models
  - Use repositories or ORM queries via session
  - Load epic with features (use `selectinload` for features relationship)
  - Handle DatabaseNotFound exceptions

- **E04-F02 CLI Framework**: Follow existing patterns
  - Use Click decorators (@click.command, @click.argument)
  - Integrate with global flags (--json, --no-color, --verbose)
  - Use Rich for table formatting
  - Return appropriate exit codes

## Validation Gates

- **Acceptance Criteria Tests**: See [PRD - Acceptance Criteria - Epic Listing](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#epic-listing)
  - Given 5 epics in database, `pm epic list` displays all 5 with progress
  - Given Epic E01 with 3 features (50%, 75%, 100%), `pm epic get E01` shows 75% epic progress
  - Given Epic E99 does not exist, `pm epic get E99` returns exit code 1 with error message

- **Acceptance Criteria Tests**: See [PRD - Acceptance Criteria - Epic Details](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#epic-details)
  - Epic metadata displayed correctly
  - All features listed with individual progress
  - Overall epic progress prominently displayed
  - Feature table shows: Key, Title, Status, Progress, Task Count

- **Table Formatting Tests**:
  - Terminal width 80 columns: table fits without wrapping
  - Long titles (>40 chars) truncated with "..."
  - Progress percentages right-aligned
  - Empty epic list shows "No epics found"

- **Error Handling Tests**:
  - Non-existent epic key returns exit code 1
  - Database connection failure returns exit code 2
  - Error messages match PRD specifications
  - Suggestions provided (e.g., "Use 'pm epic list'...")

## Context & Resources

- **PRD**: [Complete Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md)
  - [Functional Requirements #1-13](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements) - Epic command specifications
  - [Acceptance Criteria - Epic Listing](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#epic-listing)
  - [Acceptance Criteria - Epic Details](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#epic-details)
  - [User Stories #1-2](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#user-stories) - Epic use cases

- **E04-F02 CLI Framework**: Reference existing command patterns
  - Click command structure
  - Rich table formatting examples
  - Error handling conventions
  - Exit code standards

- **Progress Service**: Progress calculation functions from T-E04-F04-001

## Notes for Agent

- **Command Structure**: Use Click command groups. `pm epic list` and `pm epic get` are subcommands of the `epic` group.
- **Rich Tables**: Use `rich.table.Table` for formatting. Set `max_width=80` to enforce column wrapping.
- **Progress Display**: Format as `f"{progress:.1f}%"` for one decimal place. Right-align with `justify="right"` in table column.
- **Feature Loading**: Use `selectinload(Epic.features)` in query to eager-load features and avoid N+1 queries.
- **Error Messages**: Be specific and helpful. "Error: Epic E99 does not exist. Use 'pm epic list' to see available epics."
- **Exit Codes**: Follow POSIX convention: 0=success, 1=user error (bad input), 2=system error (database failure).
- **Testing**: Use Click's `CliRunner` for testing CLI commands. Mock database and progress service for unit tests.
