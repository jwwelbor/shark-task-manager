---
task_key: T-E04-F01-006
status: completed
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F01-005"]
estimated_time: 4 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F01-006.md
---

# PRP: Package Export & CLI Integration Preparation

## Goal

Finalize the database package public API exports, create smoke tests to verify package imports, validate type checking with mypy, and document integration points for downstream CLI and feature development.

## Success Criteria

- [ ] `pm/database/__init__.py` exports all public APIs (models, repositories, session, exceptions, config)
- [ ] `__all__` list explicitly defines public API
- [ ] Smoke test verifies all package imports work correctly
- [ ] mypy validation passes with no type errors across entire database package
- [ ] CLI integration guide documents session injection pattern
- [ ] Integration checklist created for downstream features (E04-F02, E04-F03, E04-F05, E04-F07)
- [ ] Database package ready for import and use by CLI layer
- [ ] All validation gates from implementation phases checklist completed

## Implementation Guidance

### Overview

This final phase prepares the database package for integration with the CLI layer (E04-F02) and downstream features. You'll create clean package exports, verify type safety across the entire codebase, document integration patterns, and ensure the database layer is production-ready.

### Key Requirements

- **Package Exports**: Create `__init__.py` as specified in [Implementation Phases - Phase 6](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-6-database-package-export-and-cli-integration-preparation)
  - Export all ORM models (Epic, Feature, Task, TaskHistory)
  - Export session utilities (SessionFactory, init_database, get_db_session)
  - Export all repositories (EpicRepository, FeatureRepository, TaskRepository, TaskHistoryRepository)
  - Export all exceptions (DatabaseError, IntegrityError, ValidationError, DatabaseNotFound, SchemaVersionMismatch)
  - Export DatabaseConfig
  - Define `__all__` list for clean namespace

- **Type Safety Validation**: Run mypy across entire package
  - No type errors in models.py
  - No type errors in repositories.py
  - No type errors in session.py
  - No type errors in validation.py
  - All public APIs have complete type annotations

- **Integration Documentation**: Create guide for CLI integration
  - How CLI commands will receive repositories (dependency injection)
  - How sessions will be managed per-request (context managers)
  - How to serialize models to JSON for output (to_dict() methods)
  - Error handling patterns for CLI layer

- **Integration Checklist**: Document what each downstream feature needs
  - **E04-F02 (CLI Infrastructure)**: SessionFactory, repositories, to_dict() for JSON output
  - **E04-F03 (Task Lifecycle)**: TaskRepository.update_status(), TaskHistoryRepository
  - **E04-F05 (Folder Management)**: Transaction support for atomic file + DB updates
  - **E04-F07 (Initialization & Sync)**: Bulk insert support, init_database()

- **Final Validation**: Complete checklist from [Implementation Phases - Validation Checklist](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#validation-checklist)
  - Code quality (docstrings, mypy, pylint)
  - Functionality (CRUD, constraints, validations, progress, cascades, transactions)
  - Testing (unit, integration, performance all passing)
  - Performance (all benchmarks meet targets)
  - Security (parameterized queries, file permissions, no sensitive logging)
  - Documentation (README, schema diagram, migration guide, examples)

### Files to Create/Modify

**Modified Files**:
- `pm/database/__init__.py` - Public API exports (~50 lines)

**New Files**:
- `docs/cli-integration-guide.md` - Integration patterns for CLI (~100 lines)
- `tests/smoke/test_package_imports.py` - Smoke tests for package (~50 lines)

### Integration Points

- **CLI Infrastructure** (E04-F02): Will use init_database() and dependency inject repositories
- **Task Lifecycle** (E04-F03): Will use TaskRepository.update_status() for atomic status changes
- **Folder Management** (E04-F05): Will use transaction context for atomic file + DB operations
- **Initialization & Sync** (E04-F07): Will use bulk operations and init_database()

Reference [Implementation Phases - Handoff to Next Features](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#handoff-to-next-features) for detailed integration patterns.

## Validation Gates

- **Package Import Test**: Smoke test passes
  - Run `pytest tests/smoke/test_package_imports.py -v`
  - All imports succeed without errors
  - All public APIs accessible via package import
  - Example: `from pm.database import Epic, TaskRepository, init_database`

- **Type Checking**: mypy validation passes
  - Run `mypy pm/database/ --strict`
  - Zero type errors across all modules
  - All function signatures complete
  - All return types annotated

- **Integration Guide**: Documentation complete
  - `docs/cli-integration-guide.md` exists
  - Documents session injection pattern
  - Documents repository usage pattern
  - Documents error handling pattern
  - Includes code examples

- **Validation Checklist**: All items checked
  - Code quality checklist complete (docstrings, mypy, pylint)
  - Functionality checklist complete (all features working)
  - Testing checklist complete (all tests passing)
  - Performance checklist complete (all benchmarks met)
  - Security checklist complete (all measures implemented)
  - Documentation checklist complete (all docs created)

- **Ready for Integration**: Database layer feature-complete
  - Can be imported cleanly by other packages
  - Type-safe across entire package
  - Fully tested and documented
  - Performance targets met
  - Security measures in place

## Context & Resources

- **Implementation Phases**: [Phase 6 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-6-database-package-export-and-cli-integration-preparation)
  - [Validation Checklist](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#validation-checklist)
  - [Handoff to Next Features](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#handoff-to-next-features)
- **Architecture**: [Integration Patterns](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#integration-patterns)
  - [Dependency Injection](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#pattern-1-dependency-injection-cli-commands)
  - [Transaction Context](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#pattern-2-transaction-context-file--db-updates)
  - [Bulk Operations](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#pattern-3-bulk-operations-sync-existing-files)
- **PRD**: [Definition of Done](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/prd.md#acceptance-criteria)

## Notes for Agent

- **`__init__.py` Exports**: Import all public classes/functions at package level for clean imports. Example:
  ```python
  from .models import Epic, Feature, Task, TaskHistory
  from .session import SessionFactory, init_database
  from .repositories import EpicRepository, FeatureRepository, TaskRepository, TaskHistoryRepository
  # ...
  __all__ = ["Epic", "Feature", ..., "init_database"]
  ```
- **Smoke Tests**: Simple tests that just import and verify types. Don't need complex logic, just verify imports work and classes are correct type.
- **mypy Strict Mode**: Use `--strict` flag for maximum type safety. This requires: no implicit Optional, no untyped defs, no untyped calls, etc.
- **Integration Guide Structure**: Include: overview of database package, initialization pattern (init_database), repository injection pattern (Click context), transaction pattern (context managers), serialization pattern (to_dict()), error handling pattern (catch domain exceptions).
- **Validation Checklist**: Manually verify each item from implementation phases doc. Check off items only if truly complete. Document any deviations or skipped items.
- **Final Review**: This is the last phase before handoff. Ensure everything is production-ready: tests passing, docs complete, performance validated, security measures in place.
- **Version for Handoff**: Tag current implementation state in git or document version. Next features depend on this stable foundation.
