---
task_key: T-E04-F01-001
status: completed
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema
created: 2025-12-14
assigned_agent: general-purpose
dependencies: []
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F01-001.md
---

# PRP: Database Foundation - Models & Schema

## Goal

Implement the core database schema and ORM models for the PM task management system, including all four tables (epics, features, tasks, task_history) with complete type safety, validation, and Alembic migration support.

## Success Criteria

- [ ] All 4 ORM models (Epic, Feature, Task, TaskHistory) defined with complete type hints
- [ ] Validation module with key format, enum, and JSON validation functions
- [ ] Custom exception hierarchy (DatabaseError, IntegrityError, ValidationError, etc.)
- [ ] Database configuration class with environment-specific settings
- [ ] Initial Alembic migration creates all tables with constraints, indexes, and triggers
- [ ] `alembic upgrade head` successfully creates complete schema
- [ ] `alembic downgrade base` successfully removes all tables
- [ ] No mypy type errors in any module
- [ ] All validation functions have docstrings with examples
- [ ] Project structure created: `pm/database/` package with all modules

## Implementation Guidance

### Overview

This phase establishes the foundational data layer for the entire Shark CLI system. You'll create SQLAlchemy 2.0+ ORM models with full type safety, comprehensive validation logic, and a migration system. The implementation must follow the exact specifications in the design documents to ensure data integrity and type safety throughout the application.

### Key Requirements

- **ORM Models**: Implement all 4 models as specified in [Backend Design - ORM Models](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#1-orm-models-modelspy)
  - Base class using SQLAlchemy DeclarativeBase
  - Epic model with status/priority enums and CHECK constraints
  - Feature model with progress_pct and epic relationship
  - Task model with JSON dependencies, multiple timestamps, and feature relationship
  - TaskHistory model with audit trail fields

- **Validation Logic**: Implement comprehensive validation as specified in [Backend Design - Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#2-validation-validationpy)
  - Regex patterns for epic, feature, and task key formats
  - Enum classes for all status and type fields
  - Range validation for priority and progress values
  - JSON validation for task dependencies

- **Exception Hierarchy**: Create custom exceptions as specified in [Backend Design - Exceptions](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#3-custom-exceptions-exceptionspy)
  - DatabaseError base class
  - IntegrityError for constraint violations
  - ValidationError for input validation failures
  - DatabaseNotFound and SchemaVersionMismatch

- **Database Configuration**: Implement config class as specified in [Backend Design - Configuration](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#4-database-configuration-configpy)
  - DatabaseConfig class with path, echo, and pool_size settings
  - database_url and connect_args properties
  - Default configuration instance

- **Alembic Migration**: Create initial migration as outlined in [Implementation Phases - Phase 1](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-1-foundation---models-and-schema)
  - All 4 tables with complete field definitions
  - All 10 indexes (see [Data Design - Indexes](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#indexes))
  - All CHECK constraints for enum validation
  - Auto-update triggers for updated_at timestamps
  - Reversible up/down migrations

### Files to Create/Modify

**New Files**:
- `pm/__init__.py` - Package initialization
- `pm/database/__init__.py` - Database package (empty for now)
- `pm/database/models.py` - ORM model definitions (~900 lines)
- `pm/database/validation.py` - Validation functions (~300 lines)
- `pm/database/exceptions.py` - Custom exceptions (~100 lines)
- `pm/database/config.py` - Database configuration (~100 lines)
- `pm/database/migrations/alembic.ini` - Alembic configuration
- `pm/database/migrations/env.py` - Alembic environment (~100 lines)
- `pm/database/migrations/versions/001_initial_schema.py` - Initial migration (~200 lines)

### Integration Points

- **Session Management** (Phase 2): Models will be used by SessionFactory for table creation
- **Repositories** (Phase 3): Models will be queried through repository pattern
- **Tests** (Phase 4): Models will be tested with in-memory and file-based databases
- **CLI** (E04-F02): Models will be serialized to JSON via to_dict() methods

Reference [Architecture - Component Diagram](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#component-diagram) for layer relationships.

## Validation Gates

- **Type Safety**: Run `mypy pm/database/` with no errors
  - All model fields have proper Mapped[] type hints
  - All function signatures have complete type annotations
  - All validation functions properly typed

- **Model Tests**: Verify model structure in [Test Criteria - ORM Models](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/09-test-criteria.md#test-epic-model)
  - Epic model instantiation and to_dict() serialization
  - Feature model with epic_key property
  - Task model with dependencies property (JSON parsing)
  - TaskHistory model with task relationship

- **Validation Tests**: Verify validation logic in [Test Criteria - Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/09-test-criteria.md#2-validation-testsunitdatabasetest_validationpy)
  - Epic/Feature/Task key format validation (regex)
  - Enum validation for all status and type fields
  - Priority and progress range validation
  - JSON dependency array validation

- **Migration Tests**:
  - `alembic upgrade head` creates all 4 tables without errors
  - Database file created at expected location
  - Foreign key constraints verified with `PRAGMA foreign_keys`
  - CHECK constraints verified by attempting invalid insertions
  - `alembic downgrade base` removes all tables

- **Schema Verification**: Check table structure matches [Data Design - DDL](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#ddl-data-definition-language)
  - All columns present with correct types
  - All foreign keys with CASCADE delete
  - All UNIQUE constraints on key columns
  - All CHECK constraints for enums
  - All indexes created

## Context & Resources

- **Architecture**: [System Architecture](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#architectural-overview)
- **Data Design**: [Complete Table Specifications](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md)
  - [DDL Statements](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#ddl-data-definition-language)
  - [Foreign Key Relationships](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#foreign-key-relationships)
  - [Indexes](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#indexes)
- **Backend Design**: [Complete Implementation Specifications](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md)
  - [ORM Models with Examples](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#1-orm-models-modelspy)
  - [Validation Functions](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#2-validation-validationpy)
- **Test Criteria**: [Unit Test Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/09-test-criteria.md#unit-tests)
- **Implementation Phases**: [Phase 1 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-1-foundation---models-and-schema)

## Notes for Agent

- **SQLAlchemy 2.0 Syntax**: Use modern declarative syntax with `Mapped[]` type hints and `mapped_column()`. See examples in backend design doc.
- **Relationship Configuration**: Epic and Feature models use `cascade="all, delete-orphan"` for automatic cascade deletes. Task dependencies use `lazy="selectin"` for eager loading.
- **JSON Dependencies**: Task.depends_on is stored as TEXT (JSON string) but exposed via `@property dependencies` that parses/serializes automatically.
- **Timestamp Management**: Use `server_default=func.now()` and `onupdate=func.now()` for automatic timestamp handling. All timestamps are UTC.
- **Validation Order**: Key format validation happens first (via regex), then enum validation, then range validation. Validation errors include field name for precise error messages.
- **Migration Structure**: Alembic env.py must import Base from models.py to autogenerate migrations. Initial migration must be manually reviewed to ensure all constraints are included.
- **Documentation**: All model classes, validation functions, and exceptions need comprehensive docstrings with Args/Returns/Raises sections and usage examples.
