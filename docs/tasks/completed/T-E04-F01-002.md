---
task_key: T-E04-F01-002
status: completed
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F01-001"]
estimated_time: 6 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F01-002.md
---

# PRP: Session Management

## Goal

Implement database connection management, session lifecycle handling, and transaction support with automatic commit/rollback, SQLite PRAGMA configuration, and database initialization/validation utilities.

## Success Criteria

- [ ] SessionFactory class creates engine with SQLite-specific configuration
- [ ] get_session() context manager provides automatic transaction management
- [ ] SQLite PRAGMAs configured via event listeners (foreign_keys, journal_mode, busy_timeout)
- [ ] create_all_tables() method creates schema and sets file permissions (Unix)
- [ ] check_integrity() validates database health via PRAGMA integrity_check
- [ ] get_schema_version() retrieves current Alembic version
- [ ] init_database() function handles initialization with validation
- [ ] Transactions commit on success, rollback on exception (verified via tests)
- [ ] File permissions set to 600 on Unix systems
- [ ] 100% test coverage for session.py module

## Implementation Guidance

### Overview

This phase implements the session management layer that sits between the ORM models (Phase 1) and the repository layer (Phase 3). You'll create a session factory with context managers for automatic transaction handling, configure SQLite for optimal performance and data integrity, and implement database initialization utilities.

### Key Requirements

- **SessionFactory Class**: Implement session factory as specified in [Backend Design - Session Management](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#5-session-management-sessionpy)
  - `_create_engine()` method with StaticPool for SQLite
  - `get_session()` context manager with auto-commit/rollback
  - `create_all_tables()` for schema creation
  - `check_integrity()` for database validation
  - `get_schema_version()` for Alembic version checking

- **SQLite Configuration**: Configure PRAGMAs via event listeners as specified in [Architecture - Configuration](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#database-layer-physical-storage)
  - `PRAGMA foreign_keys = ON` - Enable referential integrity
  - `PRAGMA journal_mode = WAL` - Write-Ahead Logging for concurrency
  - `PRAGMA busy_timeout = 5000` - 5 second timeout for locks

- **Database Initialization**: Implement init_database() as specified in [Implementation Phases - Phase 2](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-2-session-management)
  - Create database if doesn't exist
  - Verify schema version matches expected
  - Run integrity check on existing database
  - Set file permissions (Unix only)
  - Return initialized SessionFactory

- **Transaction Management**: Context manager behavior as specified in [Architecture - Session Lifecycle](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#session-lifecycle)
  - Automatic commit on context manager exit (success)
  - Automatic rollback on exception
  - Session cleanup in finally block

- **Security**: File permission enforcement as specified in [Security Design - File Permissions](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/06-security-design.md#file-permissions)
  - Set database file to 600 (owner read/write only) on Unix
  - Set WAL and SHM files to 600 as well

### Files to Create/Modify

**New Files**:
- `pm/database/session.py` - Session factory and utilities (~200 lines)
- `tests/unit/database/test_session.py` - Comprehensive session tests (~150 lines)

**Modified Files**:
- `pm/database/__init__.py` - Export SessionFactory and init_database

### Integration Points

- **Models (Phase 1)**: Imports Base from models.py for table creation
- **Config (Phase 1)**: Uses DatabaseConfig for engine configuration
- **Exceptions (Phase 1)**: Raises DatabaseNotFound, SchemaVersionMismatch
- **Repositories (Phase 3)**: Repositories will receive session from get_session()
- **CLI (E04-F02)**: CLI will use init_database() on first run

Reference [Architecture - Session Management Layer](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#layer-3-session-management-layer) for detailed integration patterns.

## Validation Gates

- **Unit Tests**: All tests in [Test Criteria - Session Management](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/09-test-criteria.md#3-session-management-testsunitdatabasetest_sessionpy) passing
  - SessionFactory creation test
  - Context manager commit on success test
  - Context manager rollback on exception test
  - create_all_tables() creates schema test
  - check_integrity() returns True test
  - get_schema_version() retrieves version test

- **PRAGMA Verification**: Confirm PRAGMAs enabled
  - Query `PRAGMA foreign_keys` returns 1 (enabled)
  - Query `PRAGMA journal_mode` returns "wal"
  - Query `PRAGMA busy_timeout` returns 5000

- **Transaction Behavior**: Verify transaction semantics
  - Insert in context manager → data persists after commit
  - Insert + exception → data does NOT persist (rolled back)
  - Nested contexts handled correctly

- **File Permissions** (Unix only): Verify security
  - Database file has permissions 600 (verified via os.stat)
  - WAL file has permissions 600 if exists
  - SHM file has permissions 600 if exists

- **Coverage**: 100% line coverage for session.py
  - Run `pytest --cov=pm/database/session --cov-report=term-missing`
  - Verify all branches covered (success/failure paths)

## Context & Resources

- **Architecture**: [Session Management Layer](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#layer-3-session-management-layer)
  - [Session Lifecycle](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#session-lifecycle)
  - [Transaction Isolation](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#transaction-isolation)
- **Backend Design**: [Session Management Implementation](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/04-backend-design.md#5-session-management-sessionpy)
- **Security Design**: [File Permissions](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/06-security-design.md#file-permissions)
- **Test Criteria**: [Session Management Tests](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/09-test-criteria.md#3-session-management-testsunitdatabasetest_sessionpy)
- **Implementation Phases**: [Phase 2 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-2-session-management)

## Notes for Agent

- **StaticPool for SQLite**: SQLite uses single connection, so use `poolclass=StaticPool` instead of default connection pooling.
- **Event Listeners**: Use `@event.listens_for(engine, "connect")` to configure PRAGMAs on every connection. This ensures settings persist even after connection reset.
- **Context Manager Pattern**: Implement using `@contextmanager` decorator from contextlib. Yield session, commit on success, rollback in except block, close in finally.
- **File Permission Security**: Only set permissions on Unix (`if os.name != 'nt'`). Use `stat.S_IRUSR | stat.S_IWUSR` (equals 600) for owner read/write only.
- **Schema Version Check**: Query `alembic_version` table for version_num. Return None if table doesn't exist (not initialized).
- **Integrity Check**: Execute `PRAGMA integrity_check` and verify result is "ok". This detects database corruption.
- **In-Memory Testing**: Use `DatabaseConfig(db_path=Path(":memory:"))` for fast in-memory tests. Create new engine for each test for isolation.
- **Error Handling**: Translate SQLAlchemy OperationalError to DatabaseError or SchemaVersionMismatch as appropriate.
