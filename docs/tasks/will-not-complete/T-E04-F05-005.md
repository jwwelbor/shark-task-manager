---
task_key: T-E04-F05-005
status: cancelled
feature: /home/jwwelbor/projects/ai-dev-team/docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F05-003, T-E04-F05-004]
estimated_time: 6 hours
file_path: /home/jwwelbor/projects/ai-dev-team/docs/tasks/todo/T-E04-F05-005.md
---


# NOTE: no longer relevant now that files are not moving along with status



# Task: CLI Commands for Validation & Repair

## Goal

Implement the `pm validate` CLI command with --repair and --dry-run flags that allows users and agents to detect and fix inconsistencies between database task status and file locations through a clean command-line interface.

## Success Criteria

- [ ] `pm validate` command detects and reports all mismatches
- [ ] `pm validate --repair` automatically fixes wrong folder locations
- [ ] `pm validate --dry-run` previews repairs without making changes
- [ ] Human-readable table output showing validation results
- [ ] JSON output support for agent consumption (--json flag)
- [ ] Clear exit codes (0=all valid, 1=mismatches found)
- [ ] Integration with E04-F02 CLI framework
- [ ] Unit and integration tests for all command variations

## Implementation Guidance

### Overview

This task implements the user-facing CLI commands for validation and repair. You'll integrate the validation and repair functions from T-E04-F05-003 with the CLI framework from E04-F02, providing a clean interface for both humans and AI agents to check and fix folder consistency.

### Key Requirements

- **Command Structure**: Implement CLI commands using E04-F02 CLI framework
  - `pm validate` - Check consistency and report mismatches
  - `pm validate --repair` - Fix mismatches automatically
  - `pm validate --dry-run` - Preview repairs without changes
  - `pm validate --json` - Output results in JSON format
  - Combine flags: `pm validate --repair --dry-run --json`

- **Output Formatting**: Implement both human and machine-readable output
  - Table format: Show mismatch summary with task keys, types, expected/actual paths
  - JSON format: Structured output for agent consumption
  - Exit codes: 0 (all valid), 1 (mismatches found), 2 (system error)
  - Color-coded output (red for errors, green for success, yellow for warnings)

- **Report Content**: Display validation results as specified in [PRD - Validation Requirements](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation-and-repair)
  - Total tasks checked
  - Tasks with correct file locations
  - Tasks with missing files (count + list)
  - Tasks with files in wrong folders (count + list)
  - Tasks with file_path field not matching actual location

- **Repair Behavior**: Implement repair logic
  - Only repair WRONG_FOLDER mismatches
  - Report MISSING_FILE mismatches for manual intervention
  - Update database file_path after moving files
  - Show repair summary (repaired count, failed count)
  - Log all repairs for audit trail

### Files to Create/Modify

**New Files**:
- `pm/cli/validate.py` - Validation CLI commands (~300 lines)

**Modified Files**:
- `pm/cli/__init__.py` or CLI router - Register validate commands

**Test Files**:
- `tests/unit/cli/test_validate.py` - Unit tests (~300 lines)
- `tests/integration/cli/test_validate_integration.py` - Integration tests (~400 lines)

### Integration Points

- **CLI Framework** (E04-F02): Use existing Click framework and CLI utilities
- **Validation Service** (T-E04-F05-003): Call `validate_folder_structure()` and `repair_mismatches()`
- **Output Formatters** (E04-F02): Use existing table and JSON formatters
- **Error Handling** (E04-F02): Use existing CLI error handling patterns

Reference [Architecture - CLI Integration](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#74-cli-integration) for implementation pattern.

## Validation Gates

**CLI Tests**:
Reference [Architecture - CLI Integration Tests](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#92-integration-tests) for specific test cases:
- `pm validate` with all files correct exits 0
- `pm validate` with mismatches exits 1 and shows report
- `pm validate --repair` fixes mismatches
- `pm validate --dry-run` shows preview without changes
- `pm validate --json` outputs valid JSON

**Output Validation**:
- Table output fits in 80-column terminal
- JSON output is valid and parseable
- Exit codes correct for all scenarios
- Error messages are clear and actionable

**Integration Testing**:
- Create task with file in wrong folder, run `pm validate --repair`, verify fixed
- Create multiple mismatches, verify all detected and repaired
- Test with empty database
- Test with all files correct

**Acceptance Criteria**:
Reference [PRD - Validation Acceptance Criteria](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation) for specific scenarios.

## Context & Resources

- **PRD**: [Validation and Repair Requirements](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation-and-repair)
- **PRD**: [Validation Acceptance Criteria](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation)
- **PRD**: [Repair Acceptance Criteria](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#repair)
- **Architecture**: [CLI Integration](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#74-cli-integration)
- **Testing**: [CLI Tests](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#92-integration-tests)

## Notes for Agent

- **Click Framework**: Use Click decorators (@click.command, @click.option) from E04-F02 CLI framework
- **Exit Codes**: Use sys.exit() or raise SystemExit with appropriate exit codes
- **Rich Output**: Use Rich library for colored table output (already in E04-F02)
- **JSON Output**: Use json.dumps() with indent=2 for pretty JSON
- **Dry-Run Logic**: Pass dry_run=True to repair_mismatches() - no custom logic needed
- **Error Handling**: Catch FileOperationError and other exceptions, show user-friendly messages
- **Logging**: Use --verbose flag to show DEBUG-level logs of file operations
- **Help Text**: Write clear help text for each flag explaining what it does
