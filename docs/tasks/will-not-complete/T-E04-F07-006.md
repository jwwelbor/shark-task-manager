---
task_key: T-E04-F07-006
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F07-002", "T-E04-F07-005"]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F07-006.md
---

# PRP: CLI Command Integration

## Goal

Integrate initialization and synchronization services with Click-based CLI commands, providing `pm init` and `pm sync` commands with all flags, options, error handling, and formatted output (text and JSON).

## Success Criteria

- [ ] `pm init` command registered and callable
- [ ] `pm init` creates all required artifacts (database, folders, config, templates)
- [ ] `pm init --non-interactive` skips all prompts
- [ ] `pm init --force` overwrites existing config and templates
- [ ] `pm sync` command registered and callable
- [ ] `pm sync` imports and updates tasks correctly
- [ ] `pm sync --dry-run` previews changes without modifications
- [ ] `pm sync --json` outputs valid JSON
- [ ] `pm sync --folder=todo` syncs only specified folder
- [ ] `pm sync --strategy=database-wins` keeps database authoritative
- [ ] Error messages are clear and actionable
- [ ] Exit codes correct (0 for success, 2 for errors)
- [ ] All CLI tests pass
- [ ] Command documentation complete

## Implementation Guidance

### Overview

This phase creates the user-facing CLI commands that wrap InitService and SyncService. You'll implement Click command handlers with comprehensive flag parsing, output formatting, error handling, and dependency injection.

### Key Requirements

- **pm init Command**: Implement as specified in [Architecture - CLI Command Integration](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#with-e04-f02-cli-framework)
  - `--non-interactive` flag for automation
  - `--force` flag to overwrite existing files
  - Call InitService.initialize_project()
  - Display formatted InitResult
  - Set exit code 0 on success, 2 on error

- **pm sync Command**: Implement as specified in [Architecture - CLI Command Integration](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#with-e04-f02-cli-framework)
  - `--folder` option for selective sync
  - `--strategy` option (file-wins, database-wins, newer-wins)
  - `--dry-run` flag for preview
  - `--create-missing` flag for auto-creating features
  - `--json` flag for JSON output
  - Call SyncService.sync_filesystem()
  - Display formatted SyncReport (text or JSON)
  - Set exit code 0 on success, 2 on error

- **Output Formatting**: Create formatters for human-readable output
  - Color support using Click.style (if config.color_enabled)
  - Clear sections and bullet points
  - Helpful next steps after init
  - Conflict details in sync report

- **Error Handling**: Implement from [Architecture - Error Handling Strategy](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#error-handling-strategy)
  - Catch service exceptions
  - Display user-friendly error messages
  - Set appropriate exit codes
  - Suggest fixes for common errors

### Files to Create/Modify

**New Files**:
- `pm/cli/commands/init.py` - `pm init` command (~150 lines)
- `pm/cli/commands/sync.py` - `pm sync` command (~200 lines)
- `pm/cli/formatters.py` - Output formatting utilities (~150 lines)
- `tests/cli/test_init_command.py` - Init command tests (~200 lines)
- `tests/cli/test_sync_command.py` - Sync command tests (~250 lines)

**Modified Files**:
- `pm/cli/__init__.py` - Register init and sync commands
- `docs/cli-commands.md` - Add init and sync documentation

**Dependencies**:
- T-E04-F07-002: InitService
- T-E04-F07-005: SyncService
- E04-F02: CLI framework, Click setup

### Integration Points

- **CLI Framework** (E04-F02): Use Click for command registration and argument parsing
- **InitService**: Inject via Click context
- **SyncService**: Inject via Click context
- **ConfigManager**: Read config for color/JSON preferences

Reference [Architecture - CLI Command Integration](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#with-e04-f02-cli-framework) for integration pattern.

## Validation Gates

- **pm init Tests**:
  - `pm init` → All artifacts created, success message displayed
  - `pm init` (second run) → Idempotent, no errors
  - `pm init --non-interactive` → No prompts, uses defaults
  - `pm init --force` → Overwrites existing config
  - `pm init` (permission denied) → Clear error, exit code 2

- **pm sync Tests**:
  - `pm sync` → Imports new tasks, displays report
  - `pm sync --dry-run` → Previews changes, no DB modifications
  - `pm sync --json` → Outputs valid JSON
  - `pm sync --folder=todo` → Syncs only todo folder
  - `pm sync --strategy=database-wins` → DB unchanged on conflicts
  - `pm sync --create-missing` → Auto-creates missing features
  - `pm sync` (DB not found) → Clear error, exit code 2

- **Output Format**:
  - Text output: Readable, colored (if enabled), sections clear
  - JSON output: Valid JSON, parseable by `jq`
  - Error messages: Specific, actionable (e.g., "Database not found at ./project.db. Run 'pm init' first.")

- **Exit Codes**:
  - Success: 0
  - Database error: 2
  - File system error: 2
  - Invalid arguments: 2

- **Documentation**:
  - `--help` output complete for both commands
  - All flags documented
  - Examples provided

## Context & Resources

- **Architecture**: [CLI Command Integration](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#with-e04-f02-cli-framework)
- **Architecture**: [Error Handling Strategy](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#error-handling-strategy)
- **PRD**: [Initialization Command Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#functional-requirements)
- **PRD**: [Synchronization Command Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#synchronization-command-pm-sync)
- **Implementation Phases**: [Phase 6 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-6-cli-command-integration)

## Notes for Agent

- **Dependency Injection**: Use Click context (`@click.pass_context`) to inject services. Set up in main CLI entry point.
- **Flag Names**: Use kebab-case for flags (`--non-interactive`, `--dry-run`), convert to snake_case for Python function args.
- **Color Support**: Check `config.color_enabled` before using Click.style(). Respect `NO_COLOR` environment variable.
- **JSON Output**: Use `json.dumps()` with `indent=2` for readable JSON. Include all report fields.
- **Error Messages**: Be specific - mention file paths, suggest fixes. "Permission denied: /path/to/project.db. Check file permissions." is better than "Init failed".
- **Next Steps**: After `pm init`, show helpful next steps: "Edit .pmconfig.json", "Create tasks with pm task create", etc.
- **Testing CLI**: Use Click's CliRunner for testing. It captures output and provides isolated filesystem.
- **Help Text**: Write clear `help=` strings for all flags. Include examples in docstrings.
- **Strategy Enum**: Convert string strategy (`--strategy=file-wins`) to ConflictStrategy enum (`ConflictStrategy.FILE_WINS`).
