---
task_key: T-E04-F07-002
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F07-001"]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F07-002.md
---

# PRP: Initialization Service Implementation

## Goal

Implement the `pm init` command logic that orchestrates project setup by creating database schema, folder structure, configuration file, and templates in a single idempotent operation with rollback support.

## Success Criteria

- [ ] InitService creates all required artifacts (database, folders, config, templates)
- [ ] Initialization is idempotent (safe to run multiple times without errors)
- [ ] Existing artifacts are detected and skipped appropriately
- [ ] Interactive prompts work for config overwrite (skipped in --non-interactive mode)
- [ ] Force mode (--force) overwrites existing config and templates
- [ ] Rollback works correctly on database or folder creation failures
- [ ] InitResult accurately reports what was created vs skipped
- [ ] All unit and integration tests pass with >80% coverage
- [ ] mypy type checking passes with no errors

## Implementation Guidance

### Overview

This phase implements the core initialization logic that sets up a new Shark CLI project. You'll build an InitService that orchestrates calls to E04-F01 (database), E04-F05 (folders), ConfigManager (config), and TemplateManager (templates), with comprehensive error handling and rollback capability.

### Key Requirements

- **InitService**: Implement initialization orchestration as specified in [Architecture - InitService](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#1-initservice)
  - `initialize_project()` - Main orchestration method
  - Execute steps in order: DB → Folders → Config → Templates
  - Check for existing artifacts before creating
  - Prompt for overwrite in interactive mode
  - Skip prompts in `--non-interactive` mode
  - Rollback on critical failures (DB, folders)

- **Idempotency**: Follow idempotency requirements from [PRD - Functional Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#functional-requirements)
  - Safe to run `pm init` multiple times
  - Skip creation if database already exists
  - Skip creation if folders already exist
  - Prompt for config overwrite (or skip in non-interactive)
  - Don't error on re-initialization

- **Rollback Logic**: Implement transaction management from [Architecture - Transaction Management](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#initialization-transactions)
  - Database and folders are critical (rollback on failure)
  - Config and templates are non-critical (warn but continue)
  - Remove created artifacts if later step fails
  - Provide clear error messages

- **InitResult**: Create result dataclass from [Data Design - InitResult](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#initresult-output)
  - Track what was created vs skipped
  - Collect warnings
  - Format text output with next steps

### Files to Create/Modify

**New Files**:
- `pm/services/__init__.py` - Package initialization
- `pm/services/init_service.py` - InitService class (~300 lines)
- `pm/services/models.py` - InitResult dataclass (~50 lines)
- `tests/unit/services/test_init_service.py` - Unit tests (~250 lines)
- `tests/integration/test_init_integration.py` - Integration tests (~150 lines)

**Dependencies on Other Features**:
- E04-F01: `init_database()` function
- E04-F05: `create_folder_structure()` function
- T-E04-F07-001: `ConfigManager`, `TemplateManager`

### Integration Points

- **E04-F01 Database**: Call `init_database()` to create schema
- **E04-F05 Folders**: Call `create_folder_structure()` to create task folders
- **ConfigManager**: Call `create_default_config()` to create `.pmconfig.json`
- **TemplateManager**: Call `install_templates()` to copy templates
- **CLI Command** (Phase 6): Will be called by `pm init` command

Reference [Architecture - pm init Flow](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#pm-init-flow) for complete data flow.

## Validation Gates

- **Idempotency Tests**:
  - First init: All artifacts created
  - Second init: All artifacts skipped, no errors
  - Partial state (DB exists, folders don't): Creates missing artifacts only
  - Verify no duplicate folders or database corruption

- **Rollback Tests**:
  - Database creation fails → no folders created
  - Folder creation fails → database removed
  - Config creation fails → warning logged, init continues
  - Template installation fails → warning logged, init continues

- **Flag Behavior**:
  - `--non-interactive`: No prompts, skip existing config
  - `--force`: Overwrite existing config and templates
  - Interactive mode: Prompt "Overwrite .pmconfig.json? (y/N)"

- **InitResult Accuracy**:
  - Correctly reports `database_created: true` when DB created
  - Correctly reports `folders_created: false` when folders skipped
  - Collects all warnings (config/template failures)
  - Text output includes next steps

- **Integration Test**:
  - Full init on empty directory
  - Verify `project.db` exists and is valid
  - Verify all task folders exist
  - Verify `.pmconfig.json` has correct structure
  - Verify templates copied to `templates/`

## Context & Resources

- **Architecture**: [InitService Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#1-initservice)
- **Architecture**: [Transaction Management](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#initialization-transactions)
- **Data Design**: [InitResult Output](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#initresult-output)
- **PRD**: [Functional Requirements - Initialization](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#functional-requirements)
- **Implementation Phases**: [Phase 2 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-2-initialization-service)

## Notes for Agent

- **Execution Order**: Database → Folders → Config → Templates. This order ensures dependencies are created first.
- **Critical vs Non-Critical**: Database and folders are critical (rollback on failure). Config and templates are non-critical (warn and continue).
- **Rollback Pattern**: Track what was created (`db_created`, `folders_created`). On exception, remove in reverse order.
- **Prompts**: Use `click.confirm()` for interactive prompts. Skip prompts if `non_interactive=True`.
- **Database Check**: Use `Path(db_path).exists()` to check if database exists. Don't just check file - verify it's valid SQLite.
- **Folder Check**: Check if all 5 task folders exist. If any missing, recreate entire structure.
- **Error Messages**: Be specific - "Database creation failed: permission denied" is better than "Init failed".
- **Next Steps**: InitResult should guide users: "Edit .pmconfig.json", "Create tasks with pm task create", "Import tasks with pm sync".
