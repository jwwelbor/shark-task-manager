---
task_key: T-E04-F07-001
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-14
assigned_agent: general-purpose
dependencies: []
estimated_time: 6 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F07-001.md
---

# PRP: Configuration & Template Management

## Goal

Implement configuration file management and template installation infrastructure for the Shark CLI, enabling `shark init` to create `.pmconfig.json` and install task/epic/feature templates.

## Success Criteria

- [ ] ConfigManager creates and reads `.pmconfig.json` with proper validation
- [ ] Config updates use atomic file writes (temp file + rename)
- [ ] TemplateManager copies templates from package to project directory
- [ ] Template rendering replaces placeholders correctly
- [ ] All configuration validation catches invalid JSON and wrong field types
- [ ] All unit tests pass with >80% coverage
- [ ] mypy type checking passes with no errors

## Implementation Guidance

### Overview

This phase creates the foundation for project initialization by implementing configuration and template management. You'll build a ConfigManager that handles atomic YAML/JSON config operations and a TemplateManager that installs reusable templates for tasks, epics, and features.

### Key Requirements

- **ConfigManager**: Implement configuration management as specified in [Architecture - ConfigManager](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#3-configmanager)
  - `create_default_config()` - Write `.pmconfig.json` with defaults
  - `read_config()` - Parse and validate existing config
  - `update_config()` - Merge updates atomically
  - Atomic file writes using temp file + rename pattern
  - JSON validation with helpful error messages

- **Config Schema**: Follow exact schema from [Data Design - Configuration File](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#1-configuration-file-pmconfigjson)
  - Fields: `default_epic`, `default_agent`, `color_enabled`, `json_output`
  - Validation rules for epic keys and agent types
  - Forward-compatible (ignore unknown fields)

- **TemplateManager**: Implement template installation as specified in [Architecture - TemplateManager](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#4-templatemanager)
  - `install_templates()` - Copy templates from package resources
  - `get_template()` - Load template by name
  - `render_template()` - Replace placeholders with values
  - Handle overwrite behavior based on `force` flag

- **Template Files**: Create templates as defined in [Data Design - Template Files](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#3-template-files)
  - `task.md` - Task/PRP template with frontmatter
  - `epic.md` - Epic PRD template
  - `feature.md` - Feature PRD template
  - All placeholders documented and replaceable

### Files to Create/Modify

**New Files**:
- `pm/config/__init__.py` - Package initialization
- `pm/config/config_manager.py` - ConfigManager class (~200 lines)
- `pm/config/models.py` - Config dataclass (~50 lines)
- `pm/templates/template_manager.py` - TemplateManager class (~150 lines)
- `pm/templates/task.md` - Task template
- `pm/templates/epic.md` - Epic template
- `pm/templates/feature.md` - Feature template
- `tests/unit/config/test_config_manager.py` - Config tests (~150 lines)
- `tests/unit/templates/test_template_manager.py` - Template tests (~100 lines)

### Integration Points

- **InitService** (Phase 2): Will call `ConfigManager.create_default_config()` and `TemplateManager.install_templates()`
- **CLI Commands**: Will use `ConfigManager.read_config()` to load user preferences
- **Template Rendering**: Future task creation commands will use templates

Reference [Implementation Phases - Phase 1](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-1-configuration--template-management) for complete task breakdown.

## Validation Gates

- **Type Safety**: Run `mypy pm/config/ pm/templates/` with no errors
  - All config fields properly typed
  - Config validation functions return proper types
  - Template manager methods have complete type hints

- **Config Tests**:
  - Create default config → verify JSON structure
  - Read config → parse and validate fields
  - Update config → merge preserving existing fields
  - Invalid JSON → raise clear error
  - Wrong field types → raise validation error
  - Unknown fields → ignored (forward compatibility)

- **Template Tests**:
  - Install templates → verify files copied to project directory
  - Get template → load by name
  - Render template → placeholders replaced correctly
  - Overwrite existing → respect `force` flag
  - Missing template → raise clear error

- **Atomic Operations**:
  - Config write uses temp file + rename
  - Interrupted write doesn't corrupt config
  - File permissions set correctly (644)

## Context & Resources

- **Architecture**: [ConfigManager Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#3-configmanager)
- **Architecture**: [TemplateManager Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#4-templatemanager)
- **Data Design**: [Configuration File Schema](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#1-configuration-file-pmconfigjson)
- **Data Design**: [Template Files](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#3-template-files)
- **Implementation Phases**: [Phase 1 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-1-configuration--template-management)

## Notes for Agent

- **Atomic File Writes**: Always write to `.pmconfig.json.tmp` first, then rename to `.pmconfig.json`. This prevents corruption if write is interrupted.
- **JSON Validation**: Use `json.load()` with exception handling. Provide clear error messages like "Invalid JSON in .pmconfig.json: Unexpected token at line 5".
- **Template Location**: Templates stored in `pm/templates/` (package resources), copied to `./templates/` (project directory).
- **Placeholder Format**: Use `{PLACEHOLDER_NAME}` format for template variables (e.g., `{TASK_KEY}`, `{FEATURE_PATH}`).
- **Config Validation**: Epic keys must match `E\d{2}` pattern. Agent types must be in enum. Validate on read, not write.
- **Forward Compatibility**: Don't error on unknown config fields - ignore them to support future versions.
- **Test Coverage**: Aim for >80% coverage. Focus on error paths (invalid JSON, wrong types, missing files).
