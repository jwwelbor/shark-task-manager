---
task_key: T-E04-F07-003
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-14
assigned_agent: general-purpose
dependencies: []
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F07-003.md
---

# PRP: File Scanning & Frontmatter Parsing

## Goal

Implement file discovery and YAML frontmatter parsing for the sync system, enabling detection of task markdown files and extraction of metadata for database synchronization.

## Success Criteria

- [ ] FileScanner recursively finds all *.md files in sync folders
- [ ] FileScanner respects folder filter (--folder=todo)
- [ ] FrontmatterParser extracts valid YAML frontmatter from markdown files
- [ ] Parser returns None for invalid YAML with clear warning logged
- [ ] Parser returns None for missing required fields with clear warning
- [ ] Parser detects key-filename mismatches and logs warnings
- [ ] All validation functions work correctly (key format, status enum, agent type)
- [ ] All unit tests pass with >80% coverage
- [ ] mypy type checking passes with no errors

## Implementation Guidance

### Overview

This phase builds the foundation for filesystem synchronization by implementing file discovery and metadata parsing. You'll create a FileScanner that finds task markdown files and a FrontmatterParser that extracts YAML metadata with comprehensive validation.

### Key Requirements

- **FileScanner**: Implement file discovery as specified in [Architecture - FileScanner](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#21-filescanner)
  - `scan_folders()` - Recursively find *.md files
  - Support folder filtering (`--folder=todo`)
  - Search in: todo/, active/, ready-for-review/, completed/, archived/
  - Return list of Path objects

- **FrontmatterParser**: Implement parsing as specified in [Architecture - FrontmatterParser](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#22-frontmatterparser)
  - `parse_file()` - Extract YAML frontmatter between `---` delimiters
  - Use PyYAML safe loader (security)
  - Validate required fields (task_key, status, feature)
  - Validate key matches filename
  - Return `TaskMetadata` dataclass or None on errors
  - Log warnings for invalid files (don't crash)

- **TaskMetadata**: Create dataclass from [Data Design - Task Frontmatter](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#2-task-frontmatter-format)
  - All frontmatter fields typed
  - Validation methods
  - Conversion to database format

- **Validation**: Implement validation from [Data Design - Frontmatter Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#frontmatter-validation)
  - Task key format: `T-E\d{2}-F\d{2}-\d{3}`
  - Status enum validation
  - Agent type enum validation
  - Dependencies array format

### Files to Create/Modify

**New Files**:
- `pm/sync/__init__.py` - Package initialization
- `pm/sync/file_scanner.py` - FileScanner class (~100 lines)
- `pm/sync/frontmatter_parser.py` - FrontmatterParser class (~200 lines)
- `pm/sync/models.py` - TaskMetadata and related dataclasses (~150 lines)
- `pm/sync/validation.py` - Validation utilities (~100 lines)
- `tests/unit/sync/test_file_scanner.py` - Scanner tests (~100 lines)
- `tests/unit/sync/test_frontmatter_parser.py` - Parser tests (~200 lines)
- `tests/unit/sync/test_validation.py` - Validation tests (~150 lines)
- `tests/fixtures/sync_test_files/` - Sample markdown files for testing

### Integration Points

- **SyncService** (Phase 5): Will call FileScanner and FrontmatterParser
- **MetadataComparator** (Phase 4): Will receive TaskMetadata for comparison
- **Database** (E04-F01): TaskMetadata will be converted to Task model

Reference [Architecture - shark sync Flow](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#pm-sync-flow) for data flow context.

## Validation Gates

- **File Scanning**:
  - Scan all folders → finds all *.md files recursively
  - Scan with filter → finds only files in specified folder
  - Empty folder → returns empty list (no error)
  - Non-existent folder → returns empty list (logs warning)

- **Frontmatter Parsing**:
  - Valid frontmatter → returns TaskMetadata with all fields
  - Invalid YAML → returns None, logs "Invalid frontmatter in <file>"
  - Missing `task_key` → returns None, logs "Missing required field: task_key"
  - Missing `status` → returns None, logs "Missing required field: status"
  - Key mismatch (file: T-E04-F01-001.md, frontmatter: T-E04-F01-002) → returns None, logs warning
  - No frontmatter → returns None, logs warning

- **Validation Functions**:
  - `validate_task_key("T-E04-F01-001")` → True
  - `validate_task_key("INVALID")` → False
  - `validate_status("todo")` → True
  - `validate_status("invalid")` → False
  - `validate_agent_type("general-purpose")` → True
  - `validate_dependencies(["T-E04-F01-001"])` → True

- **Performance**:
  - Parse 100 files in <1 second
  - YAML parsing <10ms per file
  - File scanning <500ms for 1000 files

## Context & Resources

- **Architecture**: [FileScanner Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#21-filescanner)
- **Architecture**: [FrontmatterParser Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#22-frontmatterparser)
- **Data Design**: [Task Frontmatter Format](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#2-task-frontmatter-format)
- **Data Design**: [Frontmatter Validation Rules](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#frontmatter-validation)
- **PRD**: [File Discovery and Parsing Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#file-discovery-and-parsing)
- **Implementation Phases**: [Phase 3 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-3-sync-foundation---file-scanning--parsing)

## Notes for Agent

- **YAML Safety**: Always use `yaml.safe_load()`, never `yaml.load()`. This prevents arbitrary code execution.
- **Error Handling**: Wrap all YAML parsing in try/except. Log warning and return None on errors. Don't crash entire sync.
- **Frontmatter Location**: YAML must be at start of file between `---` delimiters. If not found, return None.
- **Key-Filename Matching**: Extract key from frontmatter, extract key from filename. They must match exactly.
- **Logging**: Use structured logging - include filename in all warning messages for debugging.
- **Test Fixtures**: Create diverse test files - valid frontmatter, invalid YAML, missing fields, key mismatches.
- **Performance**: Use `Path.rglob('*.md')` for efficient recursive scanning. Don't walk directory tree manually.
- **Feature Path Extraction**: Parse feature path from frontmatter, extract `E\d{2}-F\d{2}` pattern from directory name.
