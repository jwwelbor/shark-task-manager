---
task_key: T-E04-F07-004
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F07-003"]
estimated_time: 10 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F07-004.md
---

# PRP: Metadata Comparison & Conflict Resolution

## Goal

Implement metadata comparison and conflict resolution logic for sync operations, enabling detection of new/changed/conflicting tasks and applying appropriate resolution strategies (file-wins, database-wins, newer-wins).

## Success Criteria

- [ ] MetadataComparator correctly detects new tasks (no database record)
- [ ] Comparator detects changes in all relevant fields (status, priority, title, etc.)
- [ ] Comparator reports identical tasks as NO_CHANGE
- [ ] ConflictReconciler implements FILE_WINS strategy correctly
- [ ] Reconciler implements DATABASE_WINS strategy correctly
- [ ] Reconciler implements NEWER_WINS strategy with timestamp comparison
- [ ] Folder-status mismatches generate MOVE_FILE actions
- [ ] All reconciliation actions include necessary metadata for execution
- [ ] All unit tests pass with >80% coverage
- [ ] mypy type checking passes with no errors

## Implementation Guidance

### Overview

This phase implements the core conflict detection and resolution logic for filesystem sync. You'll build a MetadataComparator that identifies differences between file and database metadata, and a ConflictReconciler that determines how to resolve conflicts based on user-specified strategy.

### Key Requirements

- **MetadataComparator**: Implement comparison as specified in [Architecture - MetadataComparator](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#23-metadatacomparator)
  - `compare()` - Compare TaskMetadata with database Task record
  - Detect new tasks (db_task is None)
  - Detect field differences
  - Return ComparisonResult with conflict details
  - Compare fields: status, priority, title, description, agent_type, depends_on

- **ConflictReconciler**: Implement reconciliation as specified in [Architecture - ConflictReconciler](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#24-conflictreconciler)
  - `reconcile()` - Apply conflict resolution strategy
  - FILE_WINS: Update database from file, move file if needed
  - DATABASE_WINS: Keep database, optionally update file
  - NEWER_WINS: Compare timestamps, apply most recent
  - Return ReconciliationAction specifying what to do

- **Conflict Strategies**: Implement strategies from [PRD - Conflict Resolution Strategies](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#conflict-resolution-strategies)
  - FILE_WINS (default): File metadata is authoritative
  - DATABASE_WINS: Database metadata is authoritative
  - NEWER_WINS: Most recently updated wins

- **Folder-Status Validation**: Implement validation from [Data Design - Folder Location Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#folder-location-validation)
  - Detect when file location doesn't match status
  - Generate MOVE_FILE actions for mismatches
  - Handle folder mapping (todo/ → status="todo")

### Files to Create/Modify

**New Files**:
- `pm/sync/comparator.py` - MetadataComparator class (~200 lines)
- `pm/sync/reconciler.py` - ConflictReconciler class (~250 lines)
- `pm/sync/models.py` - Extended with ComparisonResult, ReconciliationAction, ActionType enum (~100 lines added)
- `tests/unit/sync/test_comparator.py` - Comparison tests (~200 lines)
- `tests/unit/sync/test_reconciler.py` - Reconciliation tests (~250 lines)

**Dependencies**:
- T-E04-F07-003: TaskMetadata dataclass
- E04-F01: Task model for database comparison

### Integration Points

- **SyncService** (Phase 5): Will call comparator and reconciler for each file
- **Database Layer** (E04-F01): Reconciler actions will be executed via TaskRepository
- **Folder Management** (E04-F05): MOVE_FILE actions will use TransactionalFileOperation

Reference [Architecture - pm sync Flow](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#pm-sync-flow) for complete data flow.

## Validation Gates

- **Comparison Logic**:
  - New task (db_task=None) → ComparisonResult.NEW
  - Identical metadata → ComparisonResult.NO_CHANGE
  - Status differs → ComparisonResult.CONFLICT with field="status"
  - Multiple fields differ → ComparisonResult.CONFLICT with all differences listed

- **FILE_WINS Strategy**:
  - Conflict on status → ReconciliationAction.UPDATE_DATABASE
  - File in wrong folder → ReconciliationAction.MOVE_FILE
  - New task → ReconciliationAction.CREATE_TASK
  - No changes → ReconciliationAction.SKIP

- **DATABASE_WINS Strategy**:
  - Conflict on status → ReconciliationAction.SKIP (or UPDATE_FILE if --update-files)
  - File in wrong folder → ReconciliationAction.SKIP (DB is authoritative)
  - New task → ReconciliationAction.CREATE_TASK (file has no DB record)

- **NEWER_WINS Strategy**:
  - File modified more recently → apply FILE_WINS logic
  - Database updated more recently → apply DATABASE_WINS logic
  - Timestamps equal → fallback to FILE_WINS

- **Folder-Status Validation**:
  - File in `todo/`, status="todo" → No MOVE_FILE action
  - File in `todo/`, status="in_progress" → MOVE_FILE to `active/`
  - File in `completed/`, status="todo" → MOVE_FILE to `todo/`

- **Action Completeness**:
  - UPDATE_DATABASE action includes task_id and field changes
  - CREATE_TASK action includes all TaskMetadata
  - MOVE_FILE action includes source and destination paths

## Context & Resources

- **Architecture**: [MetadataComparator Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#23-metadatacomparator)
- **Architecture**: [ConflictReconciler Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#24-conflictreconciler)
- **Data Design**: [Folder Location Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#folder-location-validation)
- **Data Design**: [Conflict Record Structure](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#conflict-record)
- **PRD**: [Conflict Resolution Strategies](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#conflict-resolution-strategies)
- **Implementation Phases**: [Phase 4 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-4-sync-core---comparison--reconciliation)

## Notes for Agent

- **Comparison Fields**: Compare status, priority, title, description, agent_type, depends_on. Ignore created_at (never changes).
- **Field Equality**: Use exact equality for strings. For depends_on (JSON array), parse and compare as sets.
- **Timestamp Comparison**: For NEWER_WINS, compare file.stat().st_mtime with db_task.updated_at. Convert to same timezone (UTC).
- **Folder Mapping**: Map folder name to expected status - see [Data Design - Folder Status Mapping](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#folder-status-mapping).
- **Action Chaining**: A single file can generate multiple actions (UPDATE_DATABASE + MOVE_FILE).
- **Conflict Reporting**: Include field name, file value, and DB value in ComparisonResult for user-friendly output.
- **Test Edge Cases**: Test empty strings, null values, missing optional fields, circular dependencies.
- **Performance**: Comparison should be O(1) per file. Don't query database per field - pass entire task object.
