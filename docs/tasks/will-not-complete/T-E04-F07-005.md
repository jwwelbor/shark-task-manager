---
task_key: T-E04-F07-005
status: cancelled
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F07-004"]
estimated_time: 12 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F07-005.md
---

# note: NO LONGER RELEVANT as tasks don't move



# PRP: Sync Service Integration

## Goal

Orchestrate end-to-end filesystem synchronization by integrating file scanning, parsing, comparison, reconciliation, and database/file updates into a single transactional sync operation with dry-run support and comprehensive reporting.

## Success Criteria

- [ ] SyncService imports new tasks from filesystem to database
- [ ] SyncService updates existing tasks with file changes
- [ ] SyncService resolves conflicts according to strategy
- [ ] SyncService moves files to correct folders based on status
- [ ] SyncService creates task history records for changes
- [ ] Dry-run mode previews changes without modifying database or files
- [ ] All database operations use single transaction (atomic)
- [ ] File operations are best-effort (log failures, don't rollback DB)
- [ ] SyncReport accurately tracks all operations (scanned, imported, updated, conflicts)
- [ ] Feature auto-creation works with --create-missing flag
- [ ] All unit and integration tests pass with >80% coverage
- [ ] mypy type checking passes with no errors

## Implementation Guidance

### Overview

This phase brings together all sync components into a cohesive service that orchestrates the complete sync workflow. You'll implement bulk database operations, transactional updates, file moves, dry-run mode, and comprehensive reporting.

### Key Requirements

- **SyncService**: Implement orchestration as specified in [Architecture - SyncService](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#2-syncservice)
  - `sync_filesystem()` - Main orchestration method
  - Phase 1: Scan files (FileScanner)
  - Phase 2: Parse frontmatter (FrontmatterParser)
  - Phase 3: Compare with DB (MetadataComparator)
  - Phase 4: Reconcile conflicts (ConflictReconciler)
  - Phase 5: Apply actions (transactional)
  - Generate SyncReport

- **Bulk Operations**: Implement efficient DB operations from [Data Design - Bulk Data Loading](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#bulk-data-loading)
  - Query all tasks once (index by key)
  - Batch insert new tasks
  - Batch update existing tasks
  - Single transaction for all DB changes

- **Transaction Management**: Follow pattern from [Architecture - Sync Transactions](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#sync-transactions)
  - All database changes in single transaction
  - Commit DB before file operations
  - File operations outside transaction (log failures)
  - Rollback DB on any database error

- **SyncReport**: Create report dataclass from [Data Design - SyncReport](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#syncreport-output)
  - Track counts (scanned, imported, updated, conflicts, skipped)
  - Collect warnings and errors
  - Support text and JSON output

- **Feature Auto-Creation**: Implement from [PRD - Epic and Feature Inference](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#epic-and-feature-inference)
  - Parse feature key from frontmatter path
  - Query if feature exists
  - Create minimal feature record if --create-missing
  - Skip task if feature missing and --create-missing not set

### Files to Create/Modify

**New Files**:
- `pm/services/sync_service.py` - SyncService class (~400 lines)
- `pm/services/models.py` - Extended with SyncReport (~100 lines added)
- `tests/unit/services/test_sync_service.py` - Unit tests (~350 lines)
- `tests/integration/test_sync_integration.py` - Integration tests (~300 lines)

**Dependencies**:
- T-E04-F07-003: FileScanner, FrontmatterParser
- T-E04-F07-004: MetadataComparator, ConflictReconciler
- E04-F01: TaskRepository, FeatureRepository, TaskHistoryRepository
- E04-F05: TransactionalFileOperation for file moves

### Integration Points

- **Database Layer** (E04-F01): Use repositories for all DB operations
- **Folder Management** (E04-F05): Use for file moves
- **CLI Command** (Phase 6): Will be called by `shark sync` command

Reference [Architecture - shark sync Flow](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#pm-sync-flow) for complete data flow.

## Validation Gates

- **Import New Tasks**:
  - 5 new task files → 5 tasks created in DB
  - All frontmatter fields mapped correctly
  - Task history record created: "Task imported from file"
  - SyncReport shows imported=5

- **Update Existing Tasks**:
  - File status changed from "todo" to "in_progress"
  - DB task status updated
  - File moved from todo/ to active/
  - Task history record created: "Updated from file during sync"
  - SyncReport shows updated=1

- **Conflict Resolution**:
  - FILE_WINS: DB updated with file values
  - DATABASE_WINS: DB unchanged, file optionally updated
  - Conflicts tracked in SyncReport

- **Dry-Run Mode**:
  - All analysis performed
  - SyncReport shows what would change
  - Database not modified (verify with query)
  - Files not moved (verify with filesystem check)

- **Transactional Behavior**:
  - DB error during sync → all changes rolled back
  - Verify no partial updates in database
  - File move failure → DB committed, warning logged

- **Feature Auto-Creation**:
  - Task references non-existent feature E99-F99
  - Without --create-missing: Task skipped, warning logged
  - With --create-missing: Feature E99-F99 created, task imported

- **Performance**:
  - Sync 100 files in <10 seconds
  - Bulk insert more efficient than individual inserts
  - Single DB query for all tasks

## Context & Resources

- **Architecture**: [SyncService Specification](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#2-syncservice)
- **Architecture**: [Sync Transactions](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#sync-transactions)
- **Data Design**: [SyncReport Output](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#syncreport-output)
- **Data Design**: [Bulk Data Loading](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#bulk-data-loading)
- **PRD**: [Synchronization Command Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#synchronization-command-pm-sync)
- **Implementation Phases**: [Phase 5 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-5-sync-service-integration)

## Notes for Agent

- **Bulk Query Pattern**: Fetch all tasks once with `repo.list_all()`, then index by key in dict for O(1) lookups.
- **Transaction Scope**: Database operations inside `with session.begin():` block. File operations after commit.
- **File Move Failures**: Log warning, don't rollback DB. File can be moved manually later.
- **Task History**: Create history record for every DB change (import, update) with description of change.
- **Feature Path Parsing**: Extract `E\d{2}-F\d{2}` from frontmatter feature path. See [Data Design - Feature Key Extraction](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#data-mapping-file--database).
- **Dry-Run Implementation**: Execute all phases but skip final commit and file operations. Set `SyncReport.dry_run=True`.
- **Error Accumulation**: Don't halt sync on single file error. Accumulate errors in SyncReport.errors list.
- **JSON Output**: SyncReport should have `to_json()` method that serializes to valid JSON with proper indentation.
- **Integration Test**: Create temp directory, add markdown files, run sync, verify DB and filesystem state.
