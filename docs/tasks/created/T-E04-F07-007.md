---
task_key: T-E04-F07-007
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F07-006"]
estimated_time: 6 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F07-007.md
---

# PRP: Performance Optimization & Validation

## Goal

Validate that initialization and synchronization meet performance targets (<5s for init, <10s for sync of 100 files), optimize bottlenecks if needed, and ensure robust error handling under stress conditions.

## Success Criteria

- [ ] `pm init` completes in <5 seconds
- [ ] `pm sync` processes 100 files in <10 seconds
- [ ] YAML parsing averages <10ms per file
- [ ] All performance benchmarks pass
- [ ] No performance regressions from baseline
- [ ] Error handling robust under stress (disk full, permission denied, corrupt YAML)
- [ ] Rollback works reliably in all error scenarios
- [ ] Stress tests pass (1000 files, slow filesystem)
- [ ] Performance report documents benchmark results

## Implementation Guidance

### Overview

This final phase validates that the implementation meets all performance requirements and handles errors gracefully under stress conditions. You'll write performance benchmarks, identify bottlenecks, optimize as needed, and test error handling with edge cases.

### Key Requirements

- **Performance Benchmarks**: Implement from [Implementation Phases - Phase 7](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-7-performance-optimization--testing)
  - Init performance: <5 seconds
  - Sync 100 files: <10 seconds
  - YAML parsing: <10ms per file
  - Bulk insert: <2 seconds for 100 tasks

- **Performance Targets**: Validate from [Architecture - Performance Considerations](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#performance-considerations)
  - Database creation: <500ms
  - Folder creation: <100ms
  - Config write: <10ms
  - File scanning: <500ms for 1000 files

- **Optimization Strategies**: Follow patterns from [Data Design - Bulk Data Loading](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#bulk-data-loading)
  - Batch DB queries (fetch all tasks once)
  - Bulk insert for new tasks
  - Minimize file I/O
  - Cache parsed metadata if needed

- **Error Handling Validation**: Test from [Architecture - Error Handling Strategy](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#error-handling-strategy)
  - Disk full during sync
  - Permission denied on database
  - Corrupt YAML files
  - Database locked
  - Verify rollback in all cases

### Files to Create/Modify

**New Files**:
- `tests/performance/test_init_performance.py` - Init benchmarks (~100 lines)
- `tests/performance/test_sync_performance.py` - Sync benchmarks (~150 lines)
- `tests/stress/test_large_sync.py` - Stress tests (~100 lines)
- `docs/performance-report.md` - Benchmark results documentation

**Modified Files**:
- May optimize sync_service.py if bottlenecks found
- May optimize frontmatter_parser.py for faster YAML parsing

### Integration Points

- **All Services**: Performance tests exercise full integration
- **Database Layer**: Bulk operations critical for performance
- **File System**: I/O operations can be bottleneck

Reference [Implementation Phases - Phase 7](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-7-performance-optimization--testing) for complete requirements.

## Validation Gates

- **Init Performance**:
  - Empty directory → init completes in <5 seconds
  - Measure each phase: DB creation, folder creation, config, templates
  - Identify slowest phase if target not met

- **Sync Performance**:
  - 100 markdown files → sync in <10 seconds
  - Break down: scanning (2s), parsing (1s), DB ops (5s), file moves (2s)
  - Profile with cProfile if targets not met

- **YAML Parsing**:
  - Parse 100 files → average <10ms per file
  - Use fast PyYAML C bindings (not pure Python)
  - Test with complex frontmatter (nested objects, long strings)

- **Bulk Operations**:
  - Insert 100 new tasks → <2 seconds
  - Verify using SQLAlchemy bulk_insert_mappings
  - Compare to individual inserts (should be 10x+ faster)

- **Stress Tests**:
  - Sync 1000 files → completes without crashes
  - Init on slow filesystem (NFS) → completes correctly
  - Concurrent sync operations → no race conditions

- **Error Handling**:
  - Disk full during sync → rollback, clear error message
  - Permission denied on DB → exit with code 2, helpful message
  - Corrupt YAML (100 invalid files) → skip all, no crashes
  - Database locked → retry or clear error

- **Rollback Verification**:
  - DB error mid-sync → verify no partial updates
  - Query database after rollback → unchanged
  - File system unchanged if DB rollback

## Context & Resources

- **Architecture**: [Performance Considerations](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#performance-considerations)
- **Architecture**: [Error Handling Strategy](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/02-architecture.md#error-handling-strategy)
- **Data Design**: [Bulk Data Loading](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#bulk-data-loading)
- **Data Design**: [Performance Patterns](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/03-data-design.md#performance-considerations)
- **PRD**: [Performance Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/prd.md#non-functional-requirements)
- **Implementation Phases**: [Phase 7 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync/08-implementation-phases.md#phase-7-performance-optimization--testing)

## Notes for Agent

- **Benchmark Tool**: Use `pytest-benchmark` for consistent timing. Warm up before measuring.
- **Profiling**: Use cProfile to identify bottlenecks: `python -m cProfile -o profile.stats -m pm.cli sync`.
- **Bulk Insert Pattern**: Use `session.bulk_insert_mappings(Task, task_dicts)` instead of individual `session.add()` calls.
- **YAML Performance**: Ensure PyYAML C extensions installed (`pip install pyyaml` should use C version). Check with `python -c "import yaml; print(yaml.__with_libyaml__)"`.
- **File I/O**: Minimize file opens. Read file once, extract frontmatter and body in single pass.
- **Database Indexing**: Verify indexes exist on `key` columns for fast lookups.
- **Stress Testing**: Generate test files programmatically. Don't commit 1000 files to repo.
- **Error Simulation**: Use `pytest-mock` to simulate disk full, permission denied, etc.
- **Performance Report**: Document baseline, optimizations applied, final results. Include before/after metrics.
- **Regression Testing**: Run benchmarks in CI to catch future performance regressions.
