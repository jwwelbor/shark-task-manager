---
task_key: T-E04-F05-004
status: todo
feature: /home/jwwelbor/projects/ai-dev-team/docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F05-002]
estimated_time: 6 hours
file_path: /home/jwwelbor/projects/ai-dev-team/docs/tasks/todo/T-E04-F05-004.md
---

# Task: Database-File Synchronization with Rollback

## Goal

Implement the integration service that synchronizes database status updates with file moves, providing compensating transaction logic to rollback file operations when database commits fail, ensuring database and filesystem never diverge.

## Success Criteria

- [ ] `update_task_with_file_move()` function updates DB and moves file with rollback
- [ ] Sequential operation pattern: update DB first, then move file
- [ ] Compensating transaction on file move failure (rollback DB changes)
- [ ] Integration with database transaction context from E04-F01
- [ ] All error scenarios properly rolled back (file and DB stay consistent)
- [ ] Unit tests verify rollback behavior
- [ ] Integration tests validate end-to-end synchronization

## Implementation Guidance

### Overview

This task implements the critical integration layer that keeps database and filesystem synchronized. You'll create a service that updates task status in the database and moves the file atomically using compensating transactions. This is the core function that task operations (E04-F03) will call to change task status.

### Key Requirements

- **Sequential DB-Then-File Pattern**: Implement the pattern specified in [Architecture - ADR-002](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#adr-002-sequential-db-then-file-updates)
  - Update database task status and file_path field first
  - Commit database transaction
  - Move file to new location
  - If file move fails, rollback database changes (compensating transaction)
  - Re-raise exception to notify caller

- **Integration API**: Implement the service function as specified in [Architecture - Integration API](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#42-integration-api)
  - `update_task_with_file_move(task_key: str, new_status: str) -> None`
  - Fetch task from repository (E04-F01)
  - Calculate old and new file paths using `get_file_path_for_status()`
  - Update task status and file_path in transaction
  - Move file after successful DB commit
  - Compensate on failure

- **Error Handling**: Implement rollback for all failure scenarios as specified in [Architecture - Error Scenarios](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#61-error-scenarios)
  - Scenario 1: File move fails (disk full) - rollback DB
  - Scenario 2: Source file missing - rollback DB
  - Scenario 3: Destination file exists - rollback DB
  - Scenario 4: Process crashes - validation will detect and repair

- **Transaction Integration**: Use database transaction context from E04-F01
  - Leverage existing transaction management
  - Ensure clean rollback on errors
  - Maintain transaction isolation

### Files to Create/Modify

**New Files**:
- `pm/file_management/integration.py` - DB-file synchronization service (~250 lines)

**Modified Files**:
- `pm/file_management/__init__.py` - Export integration function

**Test Files**:
- `tests/unit/file_management/test_integration.py` - Unit tests (~400 lines)
- `tests/integration/file_management/test_db_file_sync.py` - Integration tests (~300 lines)

### Integration Points

- **Task Operations** (E04-F03): All status change operations will call `update_task_with_file_move()`
- **Database Layer** (E04-F01): Uses task repository and transaction management
- **File Operations** (T-E04-F05-002): Calls `move_task_file()` for actual file move
- **Folder Utilities** (T-E04-F05-001): Uses `get_file_path_for_status()` for path resolution

Reference [Architecture - Integration with Task Operations](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#71-integration-with-e04-f03-task-operations) for usage pattern.

## Validation Gates

**Unit Tests**:
Reference [Architecture - Integration Service Tests](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#91-unit-tests) for specific test cases:
- Successful status update moves file and updates DB
- File move failure rolls back database changes
- Source file missing rolls back database changes
- Destination exists rolls back database changes
- Database and file both unchanged after rollback

**Integration Tests**:
Reference [Architecture - Integration Tests](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#92-integration-tests) for specific scenarios:
- Full workflow: todo → in_progress (todo/ → active/)
- Full workflow: in_progress → blocked (active/ → blocked/)
- Rollback scenario: make destination read-only, verify DB rollback
- Process crash simulation (manual test)

**Error Scenarios**:
Test all scenarios from [Architecture - Error Handling](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#6-error-handling).

**Acceptance Criteria**:
Reference [PRD - Transaction Rollback](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#transaction-rollback) for specific acceptance criteria.

## Context & Resources

- **Architecture**: [ADR-002 Sequential DB-Then-File Updates](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#adr-002-sequential-db-then-file-updates)
- **Architecture**: [Integration API](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#42-integration-api)
- **Architecture**: [Error Scenarios](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#61-error-scenarios)
- **PRD**: [Transaction Integration](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#transaction-integration)
- **PRD**: [Rollback Acceptance Criteria](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#transaction-rollback)

## Notes for Agent

- **Compensating Transactions**: This is different from ACID transaction rollback - you manually reverse DB changes when file move fails
- **DB First**: Always update database first, then move file. This order is critical (ADR-002).
- **Clean Exceptions**: Re-raise original exception after rollback so caller knows operation failed
- **Status Mapping**: Use STATUS_FOLDER_MAP from T-E04-F05-001 - blocked status maps to blocked/ folder
- **Task Repository**: Use existing task repository from E04-F01 - don't write raw SQL
- **Transaction Context**: Use database transaction context manager from E04-F01 for clean transaction handling
- **Brief Window**: There's a 1-50ms window where DB is updated but file hasn't moved - this is acceptable (validation will repair if crash occurs)
