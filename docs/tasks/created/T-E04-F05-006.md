---
task_key: T-E04-F05-006
status: todo
feature: /home/jwwelbor/projects/ai-dev-team/docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F05-004]
estimated_time: 4 hours
file_path: /home/jwwelbor/projects/ai-dev-team/docs/tasks/todo/T-E04-F05-006.md
---

# Task: Integration with Task Operations

## Goal

Integrate the folder management system with task lifecycle operations (E04-F03) so that all task status changes (start, complete, block, unblock, approve, archive) automatically move task files to the correct folders with atomic database-file synchronization.

## Success Criteria

- [ ] All task operations in E04-F03 integrated with `update_task_with_file_move()`
- [ ] Task status changes automatically move files to correct folders
- [ ] File moves happen atomically with database updates
- [ ] Rollback works correctly if file operations fail
- [ ] All status transitions tested (todo→active, active→blocked, etc.)
- [ ] Integration tests verify file locations after status changes
- [ ] No manual file management required by task operations

## Implementation Guidance

### Overview

This task integrates the folder management system with the task lifecycle operations. You'll modify the task operations (start, complete, block, etc.) to call `update_task_with_file_move()` so that status changes automatically trigger file moves. This is the final integration that makes the folder-based workflow automatic.

### Key Requirements

- **Integration Points**: Update all task operations as specified in [Architecture - Integration with Task Operations](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#71-integration-with-e04-f03-task-operations)
  - `pm task start` → todo to in_progress → move from todo/ to active/
  - `pm task complete` → in_progress to ready_for_review → move from active/ to ready-for-review/
  - `pm task block` → any to blocked → move to blocked/
  - `pm task unblock` → blocked to previous status → move from blocked/ to previous folder
  - `pm task approve` → ready_for_review to completed → move to completed/
  - `pm task archive` → completed to archived → move to archived/

- **Implementation Pattern**: Follow the integration pattern from architecture doc
  - Validate preconditions (task exists, valid state transition)
  - Call `update_task_with_file_move(task_key, new_status)`
  - Handle any additional status-specific fields (e.g., blocked_reason)
  - Let integration service handle DB and file synchronization
  - Catch FileOperationError and report to user

- **Error Handling**: Handle file operation failures gracefully
  - If file move fails, operation fails (no partial state)
  - Show clear error message to user
  - Suggest running `pm validate --repair` if appropriate
  - Log errors for debugging

- **State Transitions**: Ensure all valid transitions handled
  - Reference task state machine from E04-F03
  - Each transition should trigger appropriate file move
  - Invalid transitions should fail before attempting file move

### Files to Create/Modify

**Modified Files** (in E04-F03):
- `pm/operations/task_operations.py` - Update all status change functions (~20 lines per function)
- `pm/cli/task.py` - CLI commands for task operations (error handling updates)

**Test Files**:
- `tests/integration/operations/test_task_operations_with_files.py` - Integration tests (~600 lines)

### Integration Points

- **Task Operations** (E04-F03): All status change operations modified
- **Integration Service** (T-E04-F05-004): Calls `update_task_with_file_move()`
- **Database Layer** (E04-F01): Uses existing task repository
- **CLI Framework** (E04-F02): Error messages displayed through CLI

Reference [Architecture - Task Operations Integration Table](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#71-integration-with-e04-f03-task-operations) for complete status transition mapping.

## Validation Gates

**Integration Tests**:
- Each task operation moves file to correct folder
- Start task: file moves from todo/ to active/
- Complete task: file moves from active/ to ready-for-review/
- Block task: file moves to blocked/
- Unblock task: file moves from blocked/ to previous folder
- Approve task: file moves to completed/
- Archive task: file moves to archived/

**Error Handling Tests**:
- File move failure rolls back database changes
- Task operation fails if file doesn't exist
- Clear error message shown to user
- Exit code is 1 (user error) or 2 (system error)

**State Machine Tests**:
- All valid transitions work correctly
- Invalid transitions fail before file move attempt
- No orphaned files after any operation
- Database and filesystem always consistent

**Acceptance Criteria**:
Reference [PRD - File Move Operation](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#file-move-operation) for specific acceptance criteria.

## Context & Resources

- **Architecture**: [Integration with Task Operations](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#71-integration-with-e04-f03-task-operations)
- **Architecture**: [Integration Pattern Example](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#42-integration-api)
- **PRD**: [Atomic File Operations](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#atomic-file-operations)
- **PRD**: [Transaction Integration](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#transaction-integration)

## Notes for Agent

- **Minimal Changes**: Most of the work is done by `update_task_with_file_move()` - just call it from task operations
- **Import Integration Service**: Add `from pm.file_management import update_task_with_file_move` to task operations module
- **Replace Manual File Handling**: Remove any manual file move code if it exists - use integration service instead
- **Error Handling**: Wrap calls in try/except to catch FileOperationError and show user-friendly messages
- **Blocked Status**: Remember blocked tasks go to blocked/ folder (ADR-001)
- **Unblock Logic**: When unblocking, need to know previous status to determine destination folder
- **Test Coverage**: Integration tests are critical - verify file moves for each operation
- **Backward Compatibility**: If E04-F03 has existing tests, ensure they still pass
