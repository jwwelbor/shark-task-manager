---
task_key: T-E04-F06-002
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F06-task-creation
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F01-006"]
estimated_time: 5 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F06-002.md
---

# Task: Key Generation & Validation

## Goal

Implement automatic task key generation with sequential numbering, comprehensive input validation for all task creation parameters, and dependency verification to ensure data integrity.

## Success Criteria

- [ ] Automatic key generation finds next available task number for a feature
- [ ] Key format: `T-<epic-key>-<feature-key>-<zero-padded-number>` (e.g., T-E01-F02-003)
- [ ] Numbers zero-padded to 3 digits (001, 002, ..., 099, 100, ..., 999)
- [ ] Concurrent creation handled (database locks prevent duplicate keys)
- [ ] Epic existence validation (raises error if epic doesn't exist)
- [ ] Feature existence validation (raises error if feature doesn't exist or doesn't belong to epic)
- [ ] Feature key normalization (F02 → E01-F02 when epic provided)
- [ ] Agent type validation (must be one of: frontend, backend, api, testing, devops, general)
- [ ] Priority validation (must be integer 1-10)
- [ ] Dependency validation (all referenced task keys must exist in database)
- [ ] Error messages are specific and actionable
- [ ] Maximum task count per feature enforced (999 tasks, raise error if exceeded)

## Implementation Guidance

### Overview

This task implements the core logic for generating unique task keys and validating all inputs before task creation. Proper key generation prevents conflicts and maintains consistent naming. Comprehensive validation ensures only valid tasks are created, preventing broken references and data integrity issues.

### Key Requirements

- **Key Generation Logic**: Per [PRD - Automatic Key Generation Requirements 5-9](../prd.md#automatic-key-generation)
  - Query database for highest task number in feature: `SELECT MAX(key) FROM tasks WHERE feature_id = ?`
  - Extract number from key (e.g., "T-E01-F02-042" → 42)
  - Increment by 1 and zero-pad to 3 digits: `f"{num:03d}"`
  - If no tasks exist for feature, start with "001"
  - If 999 tasks exist, raise error: "Error: Feature E01-F02 has reached maximum task count (999)"
  - Generate full key: `f"T-{epic_key}-{feature_key}-{number}"`

- **Concurrent Creation Safety**: Per [PRD - Requirement 9](../prd.md#automatic-key-generation)
  - Use database transaction with SELECT FOR UPDATE or similar locking
  - Ensure two simultaneous creates don't generate same key
  - Rely on database UNIQUE constraint as final safety net

- **Epic Validation**: Per [PRD - Requirement 10](../prd.md#input-validation)
  - Query epics table: `SELECT id FROM epics WHERE key = ?`
  - If not found, raise: "Error: Epic E99 does not exist. Use 'pm epic list' to see available epics."

- **Feature Validation**: Per [PRD - Requirement 11](../prd.md#input-validation)
  - Query features table: `SELECT id, epic_id FROM features WHERE key = ?`
  - Verify feature.epic_id matches provided epic
  - If feature not found: "Error: Feature E01-F99 does not exist"
  - If epic mismatch: "Error: Feature E01-F02 does not belong to epic E99"

- **Feature Key Normalization**: Per [PRD - Requirement 12](../prd.md#input-validation)
  - If user provides `--feature=F02`, prepend epic key: `E01-F02`
  - Accept both `--feature=F02` and `--feature=E01-F02` formats

- **Agent Type Validation**: Per [PRD - Requirement 13](../prd.md#input-validation)
  - Valid values: frontend, backend, api, testing, devops, general
  - Use validation from E04-F01 if available, or implement enum validation
  - Error: "Error: Invalid agent type 'invalid-agent'. Must be one of: frontend, backend, api, testing, devops, general"

- **Priority Validation**: Per [PRD - Requirement 14](../prd.md#input-validation)
  - Must be integer between 1 and 10 (inclusive)
  - Error: "Error: Priority must be between 1 and 10, got 15"

- **Dependency Validation**: Per [PRD - Requirements 15-16](../prd.md#input-validation)
  - Parse comma-separated list: `depends_on.split(',')`
  - For each task key, query: `SELECT key FROM tasks WHERE key = ?`
  - If not found: "Error: Dependency task T-E01-F99-001 does not exist"
  - Return validated list of task keys

### Files to Create/Modify

**New Files**:
- `pm/task_creation/__init__.py` - Task creation package
- `pm/task_creation/key_generator.py` - Key generation logic (~150 lines)
- `pm/task_creation/validators.py` - Input validation functions (~300 lines)
- `tests/unit/task_creation/test_key_generator.py` - Key generation tests (~200 lines)
- `tests/unit/task_creation/test_validators.py` - Validation tests (~250 lines)

**Modified Files**:
- `pm/__init__.py` - Export key generator and validators

### Integration Points

- **Database (E04-F01)**: Query epics, features, tasks tables for validation
- **Database Repositories (E04-F01)**: Use EpicRepository, FeatureRepository, TaskRepository for queries
- **Session Management (E04-F01)**: Use SessionFactory for database access
- **Task Creation Command (T-E04-F06-003)**: Command will call validators before creating task

### Key Generation Algorithm

```
1. Input: epic_key, feature_key
2. Normalize feature_key (prepend epic if needed)
3. Query: feature = get_feature_by_key(feature_key)
4. Query: max_key = SELECT MAX(key) FROM tasks WHERE feature_id = feature.id
5. If max_key is None:
     next_number = 1
   Else:
     Extract number from max_key (regex or split)
     next_number = extracted_number + 1
6. If next_number > 999:
     Raise error
7. Pad number: number_str = f"{next_number:03d}"
8. Build key: f"T-{epic_key}-{feature_key}-{number_str}"
9. Return key
```

### Validation Flow

```
1. Validate epic exists → get epic_id
2. Validate feature exists and belongs to epic → get feature_id
3. Validate agent type is in allowed list
4. Validate priority is in range 1-10
5. If depends_on provided:
     For each dependency:
       Validate task exists
6. Return validated data (epic_id, feature_id, validated_depends_on)
```

## Validation Gates

- **Key Generation Tests**: Per [PRD - Acceptance Criteria - Automatic Key Sequencing](../prd.md#automatic-key-sequencing)
  - Test first task in feature generates "001"
  - Test second task generates "002" (after "001" exists)
  - Test transition from "099" to "100" (handles 3-digit to 4-digit)
  - Test error when 999 tasks already exist
  - Test concurrent creation doesn't create duplicates (integration test)

- **Epic Validation Tests**: Per [PRD - Acceptance Criteria - Input Validation](../prd.md#input-validation)
  - Test valid epic passes
  - Test non-existent epic raises error with helpful message
  - Verify error message includes suggestion to run `pm epic list`

- **Feature Validation Tests**:
  - Test valid feature passes
  - Test non-existent feature raises error
  - Test feature belonging to wrong epic raises error
  - Test feature key normalization (F02 → E01-F02)

- **Agent Type Validation Tests**:
  - Test all 6 valid agent types pass
  - Test invalid agent type raises error
  - Verify error message lists all valid options

- **Priority Validation Tests**:
  - Test priorities 1-10 all pass
  - Test priority 0 raises error
  - Test priority 11 raises error
  - Test non-integer priority raises error

- **Dependency Validation Tests**: Per [PRD - Acceptance Criteria - Dependency Validation](../prd.md#dependency-validation)
  - Test valid single dependency passes
  - Test valid multiple dependencies pass (comma-separated)
  - Test non-existent dependency raises error
  - Test empty depends_on returns empty array

## Context & Resources

- **PRD**: [Task Creation & Templating PRD](../prd.md)
  - [Automatic Key Generation Requirements 5-9](../prd.md#automatic-key-generation)
  - [Input Validation Requirements 10-16](../prd.md#input-validation)
  - [Acceptance Criteria - Key Sequencing](../prd.md#automatic-key-sequencing)
  - [Acceptance Criteria - Input Validation](../prd.md#input-validation)
  - [Acceptance Criteria - Dependency Validation](../prd.md#dependency-validation)
- **Epic**: [E04 Task Management CLI](../../epic.md)
- **Database Schema**: Reference E04-F01 for table structures

## Notes for Agent

- **Zero Padding**: Use Python f-string format: `f"{number:03d}"` produces "001", "042", "999"
- **Number Extraction**: Extract number from existing key using regex: `r"T-[^-]+-[^-]+-(\d+)"` captures the number
- **Transaction Safety**: Wrap key generation in database transaction. Use SELECT FOR UPDATE if SQLite supports it, or rely on UNIQUE constraint + retry logic
- **Feature Key Formats**: Handle both "F02" and "E01-F02" formats. Normalize by prepending epic key if needed: `if not feature_key.startswith(epic_key): feature_key = f"{epic_key}-{feature_key}"`
- **Error Message Quality**: Include actionable suggestions in errors. Reference available commands users can run to fix the issue
- **Dependency Parsing**: Handle whitespace in dependency list: `[dep.strip() for dep in depends_on.split(',') if dep.strip()]`
- **Validator Pattern**: Create small, focused validation functions (validate_epic, validate_feature, validate_agent_type, etc.) that can be composed
- **Integration with Database**: Use repository pattern from E04-F01. Don't write raw SQL; use repository methods
- **Testing Edge Cases**: Test boundary conditions (0, 1, 10, 11 for priority; 000, 001, 999, 1000 for key numbers)
