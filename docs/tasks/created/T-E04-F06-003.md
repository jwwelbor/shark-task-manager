---
task_key: T-E04-F06-003
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F06-task-creation
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F06-001", "T-E04-F06-002", "T-E04-F02-001"]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F06-003.md
---

# Task: Task Creation Command Implementation

## Goal

Implement the `pm task create` CLI command that orchestrates validation, key generation, database insertion, template rendering, and file creation in a single atomic operation with proper error handling and output formatting.

## Success Criteria

- [ ] `pm task create` command registered with CLI framework (Click)
- [ ] Required flags implemented: --epic, --feature, --title, --agent
- [ ] Optional flags implemented: --description, --priority, --depends-on, --json
- [ ] Missing required flags raise descriptive errors with exit code 1
- [ ] Input validation executed before any database/file operations
- [ ] Task creation is atomic: database record AND file both created, or neither
- [ ] Database record created with all metadata per PRD requirements
- [ ] Task history record created with "Task created" entry
- [ ] Markdown file generated from template and saved to docs/tasks/todo/
- [ ] Human-readable output displays task key, file path, and next steps
- [ ] JSON output flag returns complete task object
- [ ] All error cases handled with clear messages and proper exit codes
- [ ] Integration with E04-F02 CLI framework (Rich formatting, error handling)
- [ ] Integration with E04-F05 folder management (atomic file operations)

## Implementation Guidance

### Overview

This task brings together all components to implement the complete task creation workflow. The command orchestrates validation, key generation, database operations, template rendering, and file creation. Atomicity is critical - if any step fails, all changes must be rolled back to prevent orphaned database records or files.

### Key Requirements

- **Command Signature**: Per [PRD - Task Creation Command Requirements 1-4](../prd.md#task-creation-command-pm-task-create)
  ```python
  @click.command('create')
  @click.option('--epic', required=True, help='Epic key (e.g., E01)')
  @click.option('--feature', required=True, help='Feature key (e.g., F02 or E01-F02)')
  @click.option('--title', required=True, help='Task title')
  @click.option('--agent', required=True, type=click.Choice(['frontend', 'backend', 'api', 'testing', 'devops', 'general']))
  @click.option('--description', default='', help='Detailed description')
  @click.option('--priority', default=5, type=click.IntRange(1, 10), help='Priority (1-10)')
  @click.option('--depends-on', default='', help='Comma-separated dependency task keys')
  @click.option('--json', is_flag=True, help='Output JSON instead of human-readable format')
  def task_create(epic, feature, title, agent, description, priority, depends_on, json):
      # Implementation
  ```

- **Workflow Steps**: Per [PRD - Requirements 5-36](../prd.md#functional-requirements)
  1. Validate all inputs (epic exists, feature exists, agent valid, priority valid, dependencies exist)
  2. Generate next task key (using key generator from T-E04-F06-002)
  3. Begin database transaction
  4. Insert task record into database
  5. Insert task_history record (status change: null → todo)
  6. Render template with task data (using template renderer from T-E04-F06-001)
  7. Write markdown file to docs/tasks/todo/{task-key}.md
  8. Commit database transaction
  9. Output success message or JSON

- **Database Record Creation**: Per [PRD - Requirements 17-18](../prd.md#database-record-creation)
  - Use TaskRepository.create() from E04-F01
  - Fields: feature_id, key, title, description, status="todo", agent_type, priority, depends_on (JSON array), file_path, created_at
  - Use database transaction for atomicity

- **Task History Record**: Per [PRD - Requirement 36](../prd.md#history-recording)
  - Use TaskHistoryRepository.create() from E04-F01
  - Fields: task_id, old_status=null, new_status="todo", agent=current_user, notes="Task created", timestamp=created_at

- **Atomic Creation**: Per [PRD - Requirements 30-33](../prd.md#atomic-creation)
  - Use TransactionalFileOperation from E04-F05 (if available)
  - Wrap database operations in transaction
  - If database fails, don't create file
  - If file creation fails, rollback database transaction
  - Both operations succeed together or fail together

- **Template Rendering**: Per [PRD - Requirements 25-29](../prd.md#markdown-file-creation)
  - Use template renderer from T-E04-F06-001
  - Select template based on agent type
  - Render with task data (key, title, description, epic, feature, agent_type, priority, depends_on, created_at)
  - Save to `docs/tasks/todo/{task-key}.md`
  - Use UTF-8 encoding
  - Error if file already exists (don't overwrite)

- **Command Output**: Per [PRD - Requirements 34-35](../prd.md#command-output)
  - Human-readable:
    ```
    Created task T-E01-F02-003: Build auth middleware
    File created at: docs/tasks/todo/T-E01-F02-003.md
    Start work with: pm task start T-E01-F02-003
    ```
  - JSON output (--json flag):
    ```json
    {
      "key": "T-E01-F02-003",
      "title": "Build auth middleware",
      "status": "todo",
      "file_path": "docs/tasks/todo/T-E01-F02-003.md",
      "epic": "E01",
      "feature": "E01-F02",
      "agent_type": "backend",
      "priority": 5,
      "depends_on": ["T-E01-F01-005"],
      "created_at": "2025-12-14T10:30:00Z"
    }
    ```

- **Error Handling**: Per [PRD - Non-Functional Requirements - Usability](../prd.md#non-functional-requirements)
  - Specific error messages with actionable suggestions
  - Example: "Epic E99 does not exist. Use 'pm epic list' to see available epics."
  - Exit code 1 on any error
  - Rollback all changes on error

### Files to Create/Modify

**New Files**:
- `pm/cli/task_commands.py` - Task-related CLI commands (~400 lines)
- `pm/task_creation/creator.py` - Task creation orchestration (~200 lines)
- `tests/unit/cli/test_task_commands.py` - Command tests (~300 lines)
- `tests/integration/test_task_creation.py` - End-to-end creation tests (~250 lines)

**Modified Files**:
- `pm/cli/main.py` - Register task create command
- `pm/__init__.py` - Export task creation components

### Integration Points

- **CLI Framework (E04-F02)**: Use Click decorators, Rich formatting, --json support pattern
- **Database (E04-F01)**: Use TaskRepository and TaskHistoryRepository for database operations
- **Folder Management (E04-F05)**: Use folder utilities to ensure docs/tasks/todo/ exists
- **Key Generator (T-E04-F06-002)**: Use key generation function for automatic numbering
- **Template Renderer (T-E04-F06-001)**: Use template rendering for markdown file generation
- **Validators (T-E04-F06-002)**: Use validation functions for all inputs

### Orchestration Flow

```
1. Parse CLI arguments (Click handles this)
2. Call validators:
     - validate_epic(epic) → epic_id
     - validate_feature(feature, epic) → feature_id, normalized_feature_key
     - validate_agent_type(agent)
     - validate_priority(priority)
     - validate_dependencies(depends_on) → validated_depends_on_list
3. Generate task key:
     - key = generate_task_key(epic, feature)
4. Begin transaction:
     - session.begin()
5. Create task record:
     - task = TaskRepository.create(
         feature_id=feature_id,
         key=key,
         title=title,
         description=description,
         status="todo",
         agent_type=agent,
         priority=priority,
         depends_on=validated_depends_on_list,
         file_path=f"docs/tasks/todo/{key}.md",
         created_at=datetime.utcnow()
       )
6. Create history record:
     - TaskHistoryRepository.create(
         task_id=task.id,
         old_status=None,
         new_status="todo",
         agent=current_user,
         notes="Task created",
         timestamp=task.created_at
       )
7. Render template:
     - markdown_content = render_template(
         agent_type=agent,
         key=key,
         title=title,
         description=description,
         epic=epic,
         feature=normalized_feature_key,
         agent_type=agent,
         priority=priority,
         depends_on=validated_depends_on_list,
         created_at=task.created_at
       )
8. Write file:
     - ensure_directory_exists("docs/tasks/todo/")
     - write_file(f"docs/tasks/todo/{key}.md", markdown_content)
9. Commit transaction:
     - session.commit()
10. Output result:
     - If --json: print(json.dumps(task.to_dict()))
     - Else: print success message with Rich formatting
```

### Error Scenarios

- **Validation Failure**: Validation error raised → Display error, exit 1, no database/file changes
- **Database Constraint Violation**: Duplicate key, foreign key violation → Rollback transaction, display error, exit 1
- **File Already Exists**: File exists at path → Rollback transaction, display error, exit 1
- **File Write Failure**: Permission error, disk full → Rollback transaction, display error, exit 1
- **Template Rendering Failure**: Template not found, rendering error → Display error, exit 1, no database/file changes

## Validation Gates

- **Command Registration**: Per [PRD - Acceptance Criteria - Basic Task Creation](../prd.md#basic-task-creation)
  - Command `pm task create` is available
  - Required flags are enforced by Click
  - Missing required flag shows error and exits with code 1

- **End-to-End Creation**: Per [PRD - Acceptance Criteria - Basic Task Creation](../prd.md#basic-task-creation)
  - Create task with all required flags
  - Verify database record exists
  - Verify file exists at correct path
  - Verify file contains correct frontmatter
  - Verify task appears in `pm task list` (if implemented)

- **Atomicity Tests**: Per [PRD - Acceptance Criteria - Atomic Creation](../prd.md#atomic-creation)
  - Test database fails → no file created
  - Test file creation fails → no database record exists
  - Test partial failure scenarios

- **Output Format Tests**: Per [PRD - Acceptance Criteria - JSON Output](../prd.md#json-output)
  - Test human-readable output format
  - Test --json flag produces valid JSON
  - Test JSON can be parsed with jq
  - Verify JSON contains all expected fields

- **Error Handling Tests**: Per [PRD - Acceptance Criteria - Input Validation](../prd.md#input-validation)
  - Test non-existent epic error
  - Test invalid agent type error
  - Test non-existent dependency error
  - Test missing required flag error
  - Verify all errors include actionable messages
  - Verify all errors exit with code 1

- **Integration Tests**: Test full workflow
  - Create task with minimal metadata
  - Create task with full metadata (description, priority, dependencies)
  - Create multiple tasks in sequence (verify numbering)
  - Create task with dependencies on previous tasks

## Context & Resources

- **PRD**: [Task Creation & Templating PRD](../prd.md)
  - [Task Creation Command Requirements 1-40](../prd.md#functional-requirements)
  - [Atomic Creation Requirements 30-33](../prd.md#atomic-creation)
  - [Command Output Requirements 34-35](../prd.md#command-output)
  - [All Acceptance Criteria](../prd.md#acceptance-criteria)
- **Epic**: [E04 Task Management CLI](../../epic.md)
- **CLI Framework**: Reference E04-F02 for Click patterns and Rich formatting
- **Database**: Reference E04-F01 for repository interfaces

## Notes for Agent

- **Click Integration**: Use Click's built-in validation where possible (IntRange, Choice). This reduces custom validation code
- **Transaction Management**: Use `with session.begin()` context manager for automatic commit/rollback on exception
- **File Path Construction**: Use pathlib.Path for cross-platform compatibility. Join paths with `/` operator: `Path("docs") / "tasks" / "todo" / f"{key}.md"`
- **Timestamp Format**: Use `datetime.utcnow().isoformat() + 'Z'` for ISO 8601 format with UTC indicator
- **Current User Detection**: For task history, use `os.getenv('USER')` or `os.getenv('USERNAME')` for current user. Default to "system" if not available
- **Rich Formatting**: Use Rich console for success messages. Use `[green]` for success, `[red]` for errors, `[blue]` for info
- **JSON Serialization**: Use `task.to_dict()` method from E04-F01 models. Ensure datetime objects are serialized as ISO 8601 strings
- **Testing Strategy**: Use pytest fixtures for database setup/teardown. Use temporary directories for file creation tests. Mock external dependencies (template renderer, validators) for unit tests; use real implementations for integration tests
- **Error Message Quality**: Follow pattern from existing E04-F01 tasks. Include specific values in errors: "Epic E99 does not exist" (not just "Epic not found")
- **Folder Creation**: Use E04-F05 utilities if available. Otherwise, use `Path.mkdir(parents=True, exist_ok=True)` to ensure directory exists
