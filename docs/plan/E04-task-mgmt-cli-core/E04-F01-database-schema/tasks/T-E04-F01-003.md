---
task_key: T-E04-F01-003
status: completed
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F01-002"]
estimated_time: 16 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F01-003.md
---

# PRP: Repository Layer - CRUD Operations

## Goal

Implement comprehensive repository classes for all four models (Epic, Feature, Task, TaskHistory) with complete CRUD operations, complex filtering, progress calculations, atomic status updates, and robust error handling with validation.

## Success Criteria

- [ ] EpicRepository with create, get_by_id, get_by_key, list_all, update, delete, calculate_progress methods
- [ ] FeatureRepository with create, get_by_id, get_by_key, list_by_epic, list_all, update, delete, calculate_progress, update_progress methods
- [ ] TaskRepository with create, get_by_id, get_by_key, list_all, list_by_feature, list_by_epic, filter_by_status, filter_by_agent_type, filter_by_priority, filter_combined, update, update_status (atomic), delete methods
- [ ] TaskHistoryRepository with create, list_by_task, list_recent methods
- [ ] All repository methods validate input using validation.py functions
- [ ] Foreign key violations caught and translated to IntegrityError with clear messages
- [ ] Unique constraint violations caught and translated to IntegrityError
- [ ] Progress calculations accurate for features and epics
- [ ] update_status() atomically updates task + creates history record + updates timestamps
- [ ] All repositories have comprehensive unit tests with >90% coverage
- [ ] Filtered queries use indexes (verified with EXPLAIN QUERY PLAN)

## Implementation Guidance

### Overview

This is the largest and most critical phase of the database layer implementation. You'll create the repository pattern that encapsulates all database access logic, providing type-safe, validated, and transactional operations for the entire application. Each repository must validate inputs, translate database exceptions to domain exceptions, and ensure data integrity.

### Key Requirements

- **EpicRepository**: Implement as specified in [Implementation Phases - Phase 3](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-3-repository-layer---crud-operations)
  - CRUD operations with key validation before insert/update
  - list_all() with optional status filter
  - calculate_progress() computes weighted average of feature progress values
  - delete() triggers CASCADE to delete all features and tasks

- **FeatureRepository**: Complex operations include
  - list_by_epic() filters features by parent epic_id
  - calculate_progress() computes (completed_tasks / total_tasks) × 100
  - update_progress() recalculates and caches progress_pct field
  - Atomic progress updates within same transaction as task changes

- **TaskRepository**: Most complex repository with
  - Multi-criteria filtering: filter_combined(status, epic_key, agent_type, max_priority)
  - update_status() atomically updates task.status, task.completed_at/started_at/blocked_at, creates TaskHistory record
  - list_by_epic() requires JOIN through features table
  - Dependencies validated (JSON format and optional task key existence)

- **TaskHistoryRepository**: Audit trail access
  - create() records every status change
  - list_by_task() retrieves full history for a task
  - list_recent() retrieves recent changes across all tasks

- **Error Handling**: Translate SQLAlchemy exceptions as specified in [Architecture - Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#error-handling-architecture)
  - SQLAlchemyIntegrityError → IntegrityError with descriptive message
  - Foreign key violations → "Task references non-existent feature"
  - Unique violations → "Task key T-E04-F01-001 already exists"
  - Generic SQL errors → DatabaseError

- **Validation Integration**: All create/update methods must
  - Validate keys using validation.py functions before database operation
  - Validate enums (status, priority, agent_type)
  - Validate ranges (priority 1-10, progress_pct 0.0-100.0)
  - Raise ValidationError with field name for precise error reporting

### Files to Create/Modify

**New Files**:
- `pm/database/repositories.py` - All repository implementations (~1500 lines)
- `tests/unit/database/test_repositories.py` - Comprehensive repository tests (~800 lines)

**Modified Files**:
- `pm/database/__init__.py` - Export all repository classes

### Integration Points

- **Models (Phase 1)**: Repositories query Epic, Feature, Task, TaskHistory ORM models
- **Session (Phase 2)**: Repositories receive session from SessionFactory.get_session()
- **Validation (Phase 1)**: Repositories use validate_epic_key(), validate_task_status(), etc.
- **Exceptions (Phase 1)**: Repositories raise ValidationError, IntegrityError, DatabaseError
- **CLI (E04-F02)**: CLI commands will receive repositories via dependency injection
- **Task Operations (E04-F03)**: Status transitions will use TaskRepository.update_status()

Reference [Architecture - Repository Layer](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#layer-4-repository-layer-data-access-logic) for integration patterns.

## Validation Gates

- **Unit Tests**: All tests in [Test Criteria - Repositories](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/09-test-criteria.md#4-repositories-testsunitdatabasetest_repositoriespy) passing
  - EpicRepository CRUD operations
  - EpicRepository validation error handling
  - EpicRepository calculate_progress() accuracy
  - FeatureRepository with list_by_epic filtering
  - FeatureRepository progress calculation and caching
  - TaskRepository filter_combined multi-criteria filtering
  - TaskRepository update_status atomic operation + history creation
  - TaskHistoryRepository audit trail access

- **Validation Integration**: Verify validation happens before database
  - Invalid epic key → ValidationError (not database error)
  - Invalid status enum → ValidationError (not CHECK constraint error)
  - Priority out of range → ValidationError (not CHECK constraint error)

- **Error Translation**: Verify SQLAlchemy errors translated correctly
  - Foreign key violation → IntegrityError with clear parent/child message
  - Unique constraint violation → IntegrityError with key name
  - Generic SQL error → DatabaseError

- **Progress Calculations**: Verify accuracy
  - Feature with 7/10 completed → progress_pct = 70.0
  - Feature with 0 tasks → progress_pct = 0.0
  - Epic with features [50%, 75%, 100%] → epic progress = 75.0

- **Atomic Operations**: Verify update_status atomicity
  - Status update + history creation in single transaction
  - Failure in history creation → status update rolled back
  - Task timestamps updated correctly (started_at, completed_at, blocked_at)

- **Index Usage**: Verify queries use indexes
  - Run `EXPLAIN QUERY PLAN SELECT * FROM tasks WHERE status = 'todo'`
  - Verify output shows `USING INDEX idx_tasks_status`
  - Verify JOINs use foreign key indexes

- **Coverage**: >90% line coverage for repositories.py
  - Run `pytest --cov=pm/database/repositories --cov-report=term-missing`
  - Verify all error paths covered
  - Verify all filtering combinations tested

## Context & Resources

- **Architecture**: [Repository Layer](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#layer-4-repository-layer-data-access-logic)
  - [Data Flow Patterns](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#data-flow-patterns)
  - [Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md#error-handling-architecture)
- **Data Design**: [Query Patterns](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#common-query-patterns)
  - [Foreign Key Relationships](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#foreign-key-relationships)
  - [Index Usage](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md#indexes)
- **Test Criteria**: [Repository Tests](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/09-test-criteria.md#4-repositories-testsunitdatabasetest_repositoriespy)
- **Implementation Phases**: [Phase 3 Details](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/08-implementation-phases.md#phase-3-repository-layer---crud-operations)

## Notes for Agent

- **Repository Pattern**: Each repository receives a Session instance via constructor. Methods use `self.session.query()` or `self.session.execute(select(...))` for queries.
- **Validation First**: Always validate inputs BEFORE attempting database operations. This gives clearer error messages than letting database constraints fail.
- **Error Translation**: Wrap all database operations in try/except blocks. Catch SQLAlchemyIntegrityError and translate to domain IntegrityError with helpful message.
- **Progress Calculation**: Features cache progress_pct to avoid repeated aggregation. Recalculate only when task status changes via update_progress() method.
- **Atomic Status Updates**: Use session.flush() instead of commit within update_status() to stay in transaction. Commit happens at context manager exit.
- **Query Optimization**: Use select() with explicit columns instead of query(Model).all() for better performance. Use .join() for related entities instead of lazy loading.
- **Timestamps**: When updating status to "in_progress" → set started_at. Status to "completed" → set completed_at. Status to "blocked" → set blocked_at.
- **Dependency Validation**: validate_depends_on() ensures JSON is valid array of task keys. Optionally verify referenced task IDs exist (see out-of-scope note in PRD).
- **Test Fixtures**: Use in_memory_session fixture from conftest.py for fast unit tests. Create fresh session per test for isolation.
