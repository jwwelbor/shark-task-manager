---
status: created
feature: /docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-16
assigned_agent: api-developer
dependencies: [T-E04-F07-001.md, T-E04-F07-003.md, T-E04-F07-004.md]
estimated_time: 12 hours
---

# Task: Sync Engine and Command Implementation

## Goal

Implement the complete synchronization orchestration engine and `pm sync` CLI command to synchronize task files with database, handling new imports, updates, conflicts, and optional cleanup in a transactional, efficient manner.

## Success Criteria

- [ ] SyncEngine orchestrates all sync phases (scan, parse, query, detect, resolve, update)
- [ ] Single transaction encompasses all database operations
- [ ] Dry-run mode previews changes without modifying database
- [ ] All conflict resolution strategies work correctly
- [ ] --create-missing flag auto-creates epics/features
- [ ] --cleanup flag deletes orphaned tasks
- [ ] Transaction rollback on errors works correctly
- [ ] SyncReport captures all operations and conflicts
- [ ] `pm sync` command with all flags implemented
- [ ] Sync processes 100 files in <10 seconds
- [ ] All validation gates pass

## Implementation Guidance

### Overview

Create the sync engine that coordinates all sync components and the CLI command that exposes it to users. The engine manages a single database transaction, processes files sequentially, handles errors gracefully, and generates comprehensive reports.

### Key Requirements

- Orchestrate sync phases in correct order - See [Architecture - SyncEngine](../02-architecture.md#syncengine)
- Implement transaction management with rollback safety - See [Architecture - Transaction Management](../02-architecture.md#transaction-management)
- Support dry-run mode (no database writes) - See [Contract - SyncEngine Interface](../01-interface-contracts.md#syncengine-interface)
- Implement all CLI flags correctly - See [Contract - Sync Command](../01-interface-contracts.md#sync-command)
- Generate detailed sync report - See [Backend Design - types.go](../04-backend-design.md#typesgo)

### Files to Create/Modify

**Backend**:
- `internal/sync/engine.go` - SyncEngine orchestrator implementation
- `internal/sync/types.go` - SyncOptions, SyncReport structs
- `internal/sync/report.go` - Report generation logic
- `internal/sync/engine_test.go` - Unit tests
- `internal/sync/integration_test.go` - Full sync integration tests
- `internal/cli/commands/sync.go` - Cobra command definition
- `internal/cli/commands/sync_test.go` - CLI integration tests

### Integration Points

- Uses FileScanner from Task 003
- Uses ConflictDetector and Resolver from Task 004
- Uses repository extensions from Task 001
- Uses existing TaskFileParser for frontmatter
- Creates task_history records for audit trail

Reference: [Architecture - SyncEngine Component](../02-architecture.md#syncengine)

## Validation Gates

**Linting & Type Checking**:
- Go code passes all linters
- Context usage correct throughout

**Unit Tests**:
- File scanning phase works correctly
- Frontmatter parsing handles valid and invalid YAML
- Bulk database queries efficient (GetByKeys)
- New tasks imported with correct default status (todo)
- Existing tasks updated only for metadata fields
- Conflicts detected and resolved correctly
- Transaction rollback on errors (test with intentional failure)
- Dry-run mode makes no database changes
- --create-missing creates epics/features as needed
- --cleanup deletes orphaned tasks

**Integration Tests**:
- Full `pm sync` with new tasks (import flow)
- Full `pm sync` with existing tasks (update flow)
- Sync with conflicts (all strategies tested)
- Sync with missing epic/feature (error without --create-missing)
- Transaction rollback on database error
- Context cancellation (Ctrl+C simulation)

**Performance Tests**:
- Sync 100 files in <10 seconds (PRD requirement)
- Memory usage reasonable (no memory leaks)

## Context & Resources

- **Architecture**: [SyncEngine Component](../02-architecture.md#syncengine)
- **Contracts**: [SyncEngine Interface](../01-interface-contracts.md#syncengine-interface)
- **Backend Design**: [engine.go](../04-backend-design.md#enginego)
- **Data Design**: [Transaction Patterns](../03-data-design.md#transaction-patterns)
- **Implementation Phases**: [Phase 5](../08-implementation-phases.md#phase-5-sync-engine--pm-sync-command)

## Notes for Agent

- Begin transaction early, defer rollback (safety net pattern)
- Use prepared statements from BulkCreate (from Task 001)
- Parse frontmatter with existing taskfile.ParseTaskFile function
- Build task keys list, bulk query with GetByKeys (Task 001)
- For new tasks: validate epic/feature exists, create Task model with status=todo
- For existing tasks: detect conflicts, resolve, update with UpdateMetadata
- Create task_history records: "Imported from file" or "Updated from file: title, file_path"
- Handle warnings gracefully (invalid YAML → skip file, add to warnings)
- Fatal errors → return immediately (transaction will rollback)
- Commit only if all operations successful and not dry-run
- Display human-readable report with conflict details
- Support JSON output for programmatic use
