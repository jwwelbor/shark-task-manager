---
task_key: T-E04-F07-002
status: created
feature: /docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-16
assigned_agent: api-developer
dependencies: []
estimated_time: 10 hours
---

# Task: Initialization Command Implementation

## Goal

Implement the `pm init` command to set up Shark CLI infrastructure by creating database schema, folder structure, configuration file, and task templates in an idempotent, user-friendly manner.

## Success Criteria

- [ ] `pm init` command creates database with correct schema
- [ ] Folder structure created (docs/plan/, templates/) with correct permissions
- [ ] Config file (.pmconfig.json) created with default values
- [ ] Task templates embedded and copied to templates/ folder
- [ ] Command is idempotent (safe to run multiple times)
- [ ] Non-interactive mode works (--non-interactive flag)
- [ ] Force mode overwrites existing config (--force flag)
- [ ] JSON output mode supported
- [ ] Init completes in <5 seconds
- [ ] All validation gates pass

## Implementation Guidance

### Overview

Create the `internal/init` package and `pm init` CLI command. The initializer orchestrates four main steps: database creation, folder setup, config file generation, and template installation. Emphasis on idempotency and atomic file writes for safety.

### Key Requirements

- Create Initializer orchestrator - See [Backend Design - Initializer Package](../04-backend-design.md#package-internalinit)
- Implement database creation with file permissions - See [Security Design - Database File Permissions](../06-security-design.md#database-file-permissions)
- Atomic config file writes (temp + rename) - See [Security Design - Atomic File Writes](../06-security-design.md#atomic-file-writes)
- Embed templates using go:embed - See [Backend Design - templates.go](../04-backend-design.md#templatego)
- CLI command with flag parsing - See [Backend Design - init.go](../04-backend-design.md#initgo)

### Files to Create/Modify

**Backend**:
- `internal/init/initializer.go` - Main orchestrator with Initialize() method
- `internal/init/database.go` - Database creation logic
- `internal/init/folders.go` - Folder creation logic
- `internal/init/config.go` - Config file generation
- `internal/init/templates.go` - Template embedding and copying
- `internal/init/types.go` - InitOptions, InitResult structs
- `internal/init/errors.go` - InitError type
- `internal/init/initializer_test.go` - Unit tests
- `internal/cli/commands/init.go` - Cobra command definition
- `internal/cli/commands/init_test.go` - CLI integration tests

### Integration Points

- Uses existing db.InitDB() for schema creation
- Integrates with global CLI config for JSON output
- Templates directory structure for task creation feature

Reference: [Architecture - Initializer](../02-architecture.md#initializer)

## Validation Gates

**Linting & Type Checking**:
- Go code passes all linters
- No unused imports or variables

**Unit Tests**:
- Database creation is idempotent (run twice, no error)
- Folder creation is idempotent (existing folders OK)
- Config prompt behavior tested (interactive vs non-interactive)
- Force flag overwrites existing config
- Template copying works correctly (count matches embedded)
- File permissions set correctly on Unix (600 for DB, 755 for folders)

**Integration Tests**:
- Full `pm init` command execution in temp directory
- JSON output format validated
- Non-interactive mode completes without prompts
- Re-running init doesn't fail or corrupt existing setup

**Performance Tests**:
- Init completes in <5 seconds (PRD requirement)

## Context & Resources

- **Architecture**: [Initializer Component](../02-architecture.md#initializer)
- **Contracts**: [Initializer Interface](../01-interface-contracts.md#initializer-interface)
- **Backend Design**: [init Package](../04-backend-design.md#package-internalinit)
- **Security Design**: [File Permissions](../06-security-design.md#database-file-permissions)
- **Implementation Phases**: [Phase 2](../08-implementation-phases.md#phase-2-initialization---pm-init-command)

## Notes for Agent

- Use go:embed for template files (compile-time embedding)
- Implement atomic config writes: write to .pmconfig.json.tmp, sync, rename
- Check file existence before creating (idempotency pattern)
- Set database file permissions to 600 on Unix (os.Chmod, check runtime.GOOS)
- Wrap errors with context (fmt.Errorf with %w)
- Display user-friendly success messages with next steps
- Handle user prompts gracefully (skip if --non-interactive or JSON mode)
- Test on both Unix and Windows if possible
