---
status: created
feature: /docs/plan/E04-task-mgmt-cli-core/E04-F07-initialization-sync
created: 2025-12-16
assigned_agent: api-developer
dependencies: []
estimated_time: 8 hours
---

# Task: Repository Extensions for Bulk Operations

## Goal

Extend existing repository interfaces with bulk operations and idempotent creation methods to support efficient synchronization of multiple tasks between filesystem and database.

## Success Criteria

- [ ] `TaskRepository.BulkCreate()` creates multiple tasks in single transaction
- [ ] `TaskRepository.GetByKeys()` retrieves tasks using efficient bulk query
- [ ] `TaskRepository.UpdateMetadata()` updates only metadata fields (preserves status/priority)
- [ ] `EpicRepository.CreateIfNotExists()` and `GetByKey()` implemented
- [ ] `FeatureRepository.CreateIfNotExists()` and `GetByKey()` implemented
- [ ] All new methods have comprehensive unit tests
- [ ] Performance benchmarks meet targets (100 tasks in <1s, 100 lookups in <100ms)
- [ ] All validation gates pass

## Implementation Guidance

### Overview

This task extends the existing repository layer with methods optimized for sync operations. The focus is on bulk operations (prepared statements, IN clauses) and idempotent creation (check-before-insert pattern) to enable efficient, safe synchronization.

### Key Requirements

- Extend TaskRepository with bulk operations - See [Backend Design - TaskRepository Extensions](../04-backend-design.md#taskrepository-extensions)
- Use prepared statements for BulkCreate efficiency - See [Architecture - Query Optimization](../02-architecture.md#query-optimization)
- Implement GetByKeys with IN clause for O(1) lookups - See [Contract - GetByKeys](../01-interface-contracts.md#taskrepository-extensions)
- UpdateMetadata must preserve database-only fields - See [Contract - UpdateMetadata](../01-interface-contracts.md#taskrepository-extensions)
- Implement idempotent epic/feature creation - See [Contract - CreateIfNotExists](../01-interface-contracts.md#epicrepository-extensions)

### Files to Create/Modify

**Backend**:
- `internal/repository/task_repository.go` - Add BulkCreate, GetByKeys, UpdateMetadata methods
- `internal/repository/epic_repository.go` - Add CreateIfNotExists, GetByKey methods
- `internal/repository/feature_repository.go` - Add CreateIfNotExists, GetByKey methods
- `internal/repository/task_repository_test.go` - Unit tests for new task methods
- `internal/repository/epic_repository_test.go` - Unit tests for epic methods
- `internal/repository/feature_repository_test.go` - Unit tests for feature methods

### Integration Points

- Existing repository interfaces (extend, don't break)
- Sync engine will use these methods for bulk operations
- Database transaction management via context.Context

Reference: [Architecture - Repository Extensions](../02-architecture.md#data-access-layer-extensions)

## Validation Gates

**Linting & Type Checking**:
- Go code passes `go vet` and `golangci-lint`
- No type errors or warnings

**Unit Tests**:
- BulkCreate validates all tasks before inserting
- BulkCreate uses single transaction (test rollback on error)
- GetByKeys handles missing keys gracefully (partial results)
- UpdateMetadata preserves status, priority, agent_type
- CreateIfNotExists is idempotent (concurrent test)
- All edge cases tested (empty inputs, nil values, errors)

**Performance Tests**:
- BulkCreate: 100 tasks in <1 second
- GetByKeys: 100 lookups in <100ms
- CreateIfNotExists: handles concurrent calls without duplicates

**Integration Tests**:
- Repository methods work with actual SQLite database
- Transaction rollback works correctly
- Foreign key constraints validated

## Context & Resources

- **Architecture**: [Data Access Layer Extensions](../02-architecture.md#data-access-layer-extensions)
- **Contracts**: [Repository Extension Contracts](../01-interface-contracts.md#repository-extension-contracts)
- **Backend Design**: [TaskRepository Extensions](../04-backend-design.md#taskrepository-extensions)
- **Data Design**: [Query Patterns](../03-data-design.md#query-patterns)

## Notes for Agent

- Follow existing repository patterns (error wrapping, context usage)
- Use prepared statements for BulkCreate (performance critical)
- GetByKeys should build dynamic IN clause based on input length
- UpdateMetadata SQL must exclude database-only fields explicitly
- CreateIfNotExists needs transaction to prevent race conditions
- Add comprehensive error messages for debugging
- Consider edge cases: empty slices, nil pointers, context cancellation
