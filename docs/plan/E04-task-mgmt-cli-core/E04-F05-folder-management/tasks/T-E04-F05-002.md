---
task_key: T-E04-F05-002
status: completed
feature: /home/jwwelbor/projects/ai-dev-team/docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F05-001]
estimated_time: 6 hours
file_path: /home/jwwelbor/projects/ai-dev-team/docs/tasks/completed/T-E04-F05-002.md
---

# Task: Atomic File Operations with Error Handling

## Goal

Implement atomic file move operations with comprehensive error handling, rollback support, and verification to ensure files are moved reliably between status folders without data loss or corruption.

## Success Criteria

- [ ] `move_task_file()` function moves files atomically using shutil.move()
- [ ] Source file verification before move
- [ ] Destination file verification after move
- [ ] Parent directory creation if needed
- [ ] Comprehensive error handling (FileNotFoundError, FileExistsError, PermissionError)
- [ ] Custom exception classes defined (FileOperationError, FileMoveError)
- [ ] All file operations complete in <50ms on SSD
- [ ] Unit tests cover all success and error scenarios

## Implementation Guidance

### Overview

This task implements the core file move operations that power the folder-based workflow. You'll create atomic file operations with comprehensive error handling and verification. The implementation must be robust against edge cases like missing files, permission errors, and filesystem issues.

### Key Requirements

- **Atomic Move Operation**: Implement file move as specified in [PRD - Atomic File Operations](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#atomic-file-operations)
  - Use shutil.move() for atomic operations
  - Verify source file exists before move
  - Verify destination file exists after move
  - Ensure source file deleted after successful move
  - Create parent directories automatically

- **Error Handling**: Implement comprehensive error handling as specified in [PRD - Error Handling](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#error-handling)
  - FileNotFoundError if source missing (with path in message)
  - FileExistsError if destination already exists (with path in message)
  - PermissionError for permission issues (with path in message)
  - OSError for other filesystem errors

- **Custom Exceptions**: Define exception hierarchy as specified in [Architecture - Error Classes](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#62-error-classes)
  - FileOperationError base class
  - FileMoveError with old_path, new_path, reason fields
  - Clear error messages with full paths

- **Verification**: Ensure data integrity
  - Check source file exists and is readable before move
  - Check destination file exists and is readable after move
  - Verify source file is gone after move (no duplicates)

### Files to Create/Modify

**New Files**:
- `pm/file_management/operations.py` - File move operations (~300 lines)
- `pm/file_management/exceptions.py` - Custom exception classes (~100 lines)

**Test Files**:
- `tests/unit/file_management/test_operations.py` - Unit tests (~400 lines)

### Integration Points

- **Task Operations** (E04-F03): Will call `move_task_file()` when task status changes
- **Validation & Repair** (T-E04-F05-003): Will use `move_task_file()` to fix mismatches
- **Folder Utilities** (T-E04-F05-001): Uses `get_file_path_for_status()` for path resolution

Reference [Architecture - Component Diagram](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#31-component-diagram) for integration pattern.

## Validation Gates

**Unit Tests**:
Reference [Architecture - Unit Tests](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#91-unit-tests) for specific test cases:
- Successful file move (verify source deleted, destination created)
- Source file missing raises FileNotFoundError with path
- Destination file exists raises FileExistsError
- Permission denied raises PermissionError
- Parent directory created automatically if missing
- File content preserved after move

**Error Scenarios**:
Reference [Architecture - Error Scenarios](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#61-error-scenarios) for edge cases:
- Scenario 2: Source file missing (manually deleted)
- Scenario 3: Destination file already exists (duplicate)
- Handle permission errors gracefully
- Handle disk full errors

**Performance**:
- Single file move completes in <50ms on local SSD
- No unnecessary filesystem calls

**Type Safety**:
- All functions typed with Path parameters
- Exception classes properly typed

## Context & Resources

- **Architecture**: [Core File Operations API](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#41-core-file-operations)
- **PRD**: [Atomic File Operations](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#atomic-file-operations)
- **Error Handling**: [Error Scenarios](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#61-error-scenarios)
- **Testing**: [Unit Test Requirements](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#91-unit-tests)

## Notes for Agent

- **Atomic Operations**: Use shutil.move() - it's atomic on same filesystem (all our folders are under docs/tasks/)
- **Verification Critical**: Always verify source exists before move, destination exists after move
- **Error Messages**: Include full paths in all exceptions for debugging
- **Parent Directories**: Use `new_path.parent.mkdir(parents=True, exist_ok=True)` to create parent dirs
- **No Retry Logic Yet**: This task implements basic moves - retry logic added in T-E04-F05-004
- **Test Coverage**: Aim for 100% coverage - file operations are critical infrastructure
