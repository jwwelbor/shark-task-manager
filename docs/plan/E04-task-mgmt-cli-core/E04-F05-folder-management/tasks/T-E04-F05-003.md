---
task_key: T-E04-F05-003
status: completed
feature: /home/jwwelbor/projects/ai-dev-team/docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F05-002]
estimated_time: 8 hours
file_path: /home/jwwelbor/projects/ai-dev-team/docs/tasks/completed/T-E04-F05-003.md
---

# Task: Validation & Repair System

## Goal

Implement the validation and repair system that detects inconsistencies between database task status and file locations, and provides automated repair capabilities to fix mismatches without manual intervention.

## Success Criteria

- [ ] `validate_folder_structure()` function scans all tasks and detects mismatches
- [ ] Optimized folder scanning (6 directory scans total, not N filesystem calls)
- [ ] `repair_mismatches()` function fixes wrong folder locations automatically
- [ ] Dry-run support (preview repairs without making changes)
- [ ] ValidationResult and RepairResult dataclasses defined
- [ ] Mismatch type detection (MISSING_FILE, WRONG_FOLDER)
- [ ] Validation of 1,000 tasks completes in <5 seconds
- [ ] Repair of 100 mismatches completes in <10 seconds
- [ ] Unit and integration tests validate all scenarios

## Implementation Guidance

### Overview

This task implements the safety net that ensures database and filesystem stay synchronized. You'll create an optimized validation system that scans folders efficiently, detects mismatches, and provides automated repair. The implementation must be fast enough for regular use and safe enough for unattended operation.

### Key Requirements

- **Validation Algorithm**: Implement optimized validation as specified in [Architecture - Validation Performance](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#82-validation-performance)
  - Scan all six folders once (not per-task lookups)
  - Build in-memory map of actual file locations
  - Query all tasks from database once
  - Compare expected vs actual locations in memory
  - Detect two mismatch types: MISSING_FILE, WRONG_FOLDER

- **Validation API**: Implement validation function as specified in [Architecture - Validation API](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#43-validation-api)
  - `validate_folder_structure()` returns ValidationResult
  - ValidationResult includes total_tasks, correct count, mismatches list
  - Each mismatch includes task_key, mismatch_type, expected_path, actual_path

- **Repair Logic**: Implement repair as specified in [PRD - Validation and Repair](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation-and-repair)
  - `repair_mismatches(dry_run=False)` fixes WRONG_FOLDER mismatches
  - MISSING_FILE mismatches cannot be auto-repaired (file is gone)
  - Update database file_path field after moving file
  - Return RepairResult with repaired count and failed list
  - Dry-run mode reports what would be fixed without changes

- **Data Models**: Define result dataclasses
  - ValidationResult: total_tasks, correct, mismatches
  - RepairResult: repaired, failed
  - Mismatch: task_key, mismatch_type, expected_path, actual_path, reason

### Files to Create/Modify

**New Files**:
- `pm/file_management/validation.py` - Validation and repair logic (~400 lines)
- `pm/file_management/models.py` - Result dataclasses (~100 lines)

**Test Files**:
- `tests/unit/file_management/test_validation.py` - Unit tests (~500 lines)
- `tests/integration/file_management/test_validation_integration.py` - Integration tests (~300 lines)

### Integration Points

- **CLI Commands** (T-E04-F05-005): `pm validate` command will call these functions
- **Sync Operations** (E04-F07): Will run validation after import operations
- **File Operations** (T-E04-F05-002): Uses `move_task_file()` to repair mismatches
- **Database** (E04-F01): Queries tasks and updates file_path field

Reference [Architecture - Integration with Sync](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#73-integration-with-e04-f07-syncimport) for sync integration pattern.

## Validation Gates

**Unit Tests**:
Reference [Architecture - Validation Tests](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#91-unit-tests) for specific test cases:
- Detect task with file in wrong folder
- Detect task with missing file
- All files in correct locations (validation passes)
- Repair moves file to correct folder
- Repair updates database file_path field
- Dry-run doesn't make changes
- Empty database returns valid result

**Integration Tests**:
- Validation with 100 tasks completes in <1 second
- Repair with 10 mismatches succeeds
- Repair handles file move failures gracefully
- Multiple mismatch types detected correctly

**Performance Benchmarks**:
Reference [PRD - Performance Requirements](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#non-functional-requirements):
- Validation of 1,000 tasks completes in <5 seconds
- Repair of 100 mismatches completes in <10 seconds
- No N+1 query patterns (verify with EXPLAIN)

**Acceptance Criteria**:
Reference [PRD - Validation Acceptance Criteria](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation) for specific scenarios to test.

## Context & Resources

- **Architecture**: [Validation API](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#43-validation-api)
- **Architecture**: [Optimized Validation Algorithm](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#82-validation-performance)
- **PRD**: [Validation and Repair Requirements](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation-and-repair)
- **PRD**: [Validation Acceptance Criteria](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/prd.md#validation)
- **Testing**: [Validation Tests](../../../docs/plan/E04-task-mgmt-cli-core/E04-F05-folder-management/02-architecture.md#91-unit-tests)

## Notes for Agent

- **Performance Critical**: Use optimized algorithm (scan folders once, not per-task). See architecture doc for implementation pattern.
- **Mismatch Types**: MISSING_FILE cannot be auto-repaired - report it for manual intervention. Only WRONG_FOLDER is auto-repairable.
- **Dry-Run Important**: Dry-run must show exactly what would be repaired without making changes - users need to preview repairs.
- **Database Updates**: After moving file, update task.file_path in database to reflect new location.
- **Memory Efficient**: Build file map in memory but don't load file contents - just scan directory entries.
- **Error Recovery**: If repair fails mid-process, continue with remaining mismatches and report failures in RepairResult.
- **os.scandir**: Use os.scandir() for efficient directory scanning (faster than os.listdir).
