---
task_key: T-E04-F02-004
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F02-002]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F02-004.md
---

# PRP: Error Handling & Exit Code System

## Goal

Implement comprehensive error handling with consistent exit codes, user-friendly error messages, exception translation, and verbose mode stack trace display. The system must catch all exceptions at the command level, display actionable error messages, and return appropriate exit codes for agents to detect failure types.

## Success Criteria

- [ ] Exit code constants defined (EXIT_SUCCESS=0, EXIT_USER_ERROR=1, EXIT_SYSTEM_ERROR=2, EXIT_VALIDATION_ERROR=3)
- [ ] Exception hierarchy mapped to exit codes
- [ ] Global exception handler decorator for Click commands
- [ ] User error messages are clear, actionable, and suggest next steps
- [ ] System error messages prompt user to run with --verbose for details
- [ ] Stack traces only shown in --verbose mode
- [ ] Logging configured to write to stderr (not stdout)
- [ ] Log level set based on --verbose flag (WARNING default, DEBUG with --verbose)
- [ ] All error messages use consistent format and color (red for errors)
- [ ] Error handling tested for all exception types from E04-F01 (DatabaseError, IntegrityError, ValidationError, etc.)

## Implementation Guidance

### Overview

This phase implements robust error handling that translates exceptions into user-friendly messages with appropriate exit codes. The system catches exceptions from the database layer (E04-F01), Click framework, and Python runtime, then formats them consistently for both human and agent consumption. The implementation must balance helpful error messages for developers with machine-parseable exit codes for agents.

### Key Requirements

- **Exit Code System**: Define standard exit codes (see [PRD - Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling))
  - 0: Success (command completed without errors)
  - 1: User error (invalid arguments, validation failure, resource not found)
  - 2: System error (database error, file not found, network error)
  - 3: Validation error (constraint violation, invalid state transition)
  - Define as constants in `pm/cli/errors/exit_codes.py`

- **Exception Translation**: Map exceptions to exit codes (see [PRD - Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling))
  - click.exceptions.MissingParameter → EXIT_USER_ERROR
  - click.exceptions.BadParameter → EXIT_USER_ERROR
  - DatabaseError (from E04-F01) → EXIT_SYSTEM_ERROR
  - IntegrityError (from E04-F01) → EXIT_SYSTEM_ERROR
  - ValidationError (from E04-F01) → EXIT_VALIDATION_ERROR
  - DatabaseNotFound (from E04-F01) → EXIT_USER_ERROR
  - Generic Exception → EXIT_SYSTEM_ERROR

- **Error Message Formatting**: Create consistent error messages (see [PRD - Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling))
  - User errors: "Error: Task T-E01-F01-001 does not exist. Use 'shark task list' to see available tasks."
  - System errors: "Error: Database error. Run with --verbose for details."
  - Validation errors: "Error: Cannot start task with status 'in_progress'. Task must be 'todo'."
  - Include suggested next steps (run another command, check input, etc.)
  - Use color utilities from Phase 2 (red for errors, yellow for warnings)

- **Global Exception Handler**: Implement decorator for all commands (see [PRD - Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling))
  - Decorator wraps all Click commands: `@handle_exceptions`
  - Catches all exceptions before Click's default handler
  - Logs full stack trace to stderr if --verbose
  - Formats error message and prints to stderr
  - Calls `sys.exit(exit_code)` with appropriate code
  - Preserves original exception context for debugging

- **Logging Configuration**: Set up logging for CLI (see [PRD - Logging](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#logging))
  - All logs go to stderr (stdout reserved for command output)
  - Default log level: WARNING (only important messages)
  - --verbose flag: Set log level to DEBUG
  - Log format: `[2025-12-14 10:30:45] DEBUG: Loading config from .pmconfig.json`
  - Use Python's logging module with custom formatter
  - Configure at CLI startup in main.py

- **Stack Trace Control**: Show traces only in verbose mode (see [PRD - Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling))
  - Normal mode: Show only error message
  - Verbose mode (--verbose): Show full stack trace with traceback.format_exc()
  - Include context: exception type, message, and call stack
  - Format traces for readability (use Rich for syntax highlighting if possible)

### Files to Create/Modify

**New Files**:
- `pm/cli/errors/__init__.py` - Error handling package
- `pm/cli/errors/exit_codes.py` - Exit code constants (~30 lines)
- `pm/cli/errors/handlers.py` - Exception handler decorator (~150 lines)
- `pm/cli/errors/formatters.py` - Error message formatting (~100 lines)
- `pm/cli/errors/logger.py` - Logging configuration (~80 lines)

**Modified Files**:
- `pm/cli/main.py` - Configure logging at startup, apply exception handler to root command
- `pm/cli/groups/*.py` - Apply @handle_exceptions decorator to all command functions

### Integration Points

- **CLI Core (Phase 1)**: Exception handler applied to all Click commands
- **Output Formatting (Phase 2)**: Error messages use color utilities (red for errors)
- **Configuration (Phase 3)**: Config loading errors use error formatter
- **Database Layer (E04-F01)**: Database exceptions (DatabaseError, ValidationError) translated to exit codes
- **Task Operations (E04-F03)**: Task command errors use global exception handler
- **Epic/Feature Queries (E04-F04)**: Query errors use global exception handler

Reference [PRD - User Story #5](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#must-have-user-stories) for error handling requirements.

## Validation Gates

- **Exit Codes**: Verify correct exit codes for all error types (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#exit-codes))
  - Successful command returns 0
  - Missing argument returns 1
  - Database connection error returns 2
  - Constraint violation returns 3
  - Test with Click's CliRunner and check `result.exit_code`

- **Error Messages**: Test message quality (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling))
  - Messages are clear and actionable
  - Suggest next steps (e.g., "Use 'shark task list' to see available tasks")
  - No technical jargon (avoid "NoneType", "SQL error 1234")
  - Include relevant context (task key, status, etc.)

- **Stack Trace Control**: Verify verbose mode behavior
  - Normal mode: Only error message shown
  - Verbose mode (--verbose): Full stack trace shown
  - Stack traces written to stderr (not stdout)
  - Traces formatted for readability

- **Logging**: Test logging configuration (see [PRD - Logging](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#logging))
  - Logs go to stderr only (stdout clean for piping)
  - Default log level is WARNING
  - --verbose flag sets DEBUG level
  - Log format matches specification

- **Exception Coverage**: Test all exception types
  - Click exceptions (MissingParameter, BadParameter, etc.)
  - Database exceptions from E04-F01
  - Python built-ins (FileNotFoundError, PermissionError, etc.)
  - Unexpected exceptions (generic Exception)

- **Agent Compatibility**: Verify agent can detect errors
  - Exit code 0 for success
  - Non-zero exit code for failures
  - Error message on stderr (stdout clean for JSON parsing)
  - JSON output not corrupted by error messages

## Context & Resources

- **PRD**: [Complete Product Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)
  - [Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling)
  - [Logging](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#logging)
  - [Exit Codes Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#exit-codes)
- **E04-F01 Exceptions**: Reference exception hierarchy from database layer
  - DatabaseError, IntegrityError, ValidationError, DatabaseNotFound, etc.
- **Python Logging**: [Official logging documentation](https://docs.python.org/3/library/logging.html)

## Notes for Agent

- **Decorator Pattern**: Create `@handle_exceptions` decorator that wraps Click command functions. Use `functools.wraps` to preserve function metadata for Click.
- **Exception Matching**: Use `isinstance()` checks to match exceptions to exit codes. Order matters: check specific exceptions before generic ones.
- **Context Preservation**: Use `sys.exc_info()` to get full exception context (type, value, traceback) for verbose mode.
- **Logging Setup**: Use `logging.basicConfig()` with custom formatter. Set level based on --verbose flag from Click context. Add stderr StreamHandler.
- **Error Message Templates**: Create message templates for common errors. Use string formatting to insert context (task key, expected values, etc.).
- **Click Integration**: Click has built-in exception handling. Use `ctx.invoke()` pattern or override Click's exception handling in main.py.
- **Testing**: Use Click's CliRunner to test commands. Check `result.exit_code`, `result.output`, and `result.stderr_bytes`. Mock database exceptions for coverage.
- **Performance**: Exception handling should add <10ms overhead. Use simple try/except without complex logic in hot path.
