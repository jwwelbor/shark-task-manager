---
task_key: T-E04-F02-001
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F01-006]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F02-001.md
---

# PRP: CLI Core Framework & Command Structure

## Goal

Implement the foundational Click-based CLI framework with hierarchical command structure (`shark <resource> <action>`), global flags (--json, --no-color, --verbose), and entry point configuration. This establishes the command routing infrastructure that all subsequent CLI features will build upon.

## Success Criteria

- [ ] Click application with hierarchical command groups registered
- [ ] Entry point `shark` command installed via pyproject.toml/setup.py
- [ ] Global flags (--json, --no-color, --verbose, --config) available on all commands
- [ ] Command structure supports `shark <resource> <action>` pattern
- [ ] Help text generation works for all command levels (`shark --help`, `shark task --help`, `shark task list --help`)
- [ ] Argument parsing with type validation and required/optional handling
- [ ] Boolean flags use Click syntax (--force/--no-force)
- [ ] Multi-value flags supported (--status=todo,in_progress)
- [ ] CLI startup time <300ms (measured from invocation to first code execution)
- [ ] Package installs successfully via `pip install -e .`

## Implementation Guidance

### Overview

This phase builds the Click-based command routing framework that serves as the foundation for all Shark CLI commands. The framework provides a consistent command structure, automatic help text generation, argument parsing, and global flags that all commands inherit. The implementation focuses on developer experience for command registration and user experience for command discovery and execution.

### Key Requirements

- **Command Structure**: Implement hierarchical commands as specified in [PRD - Functional Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#functional-requirements)
  - Root command group `shark` using `@click.group()`
  - Resource groups (task, epic, feature, config, sync, backup) as subgroups
  - Action commands (list, get, create, update, delete) within resource groups
  - Example hierarchy: `shark` → `task` (group) → `list` (command)

- **Global Flags**: Implement flags that all commands inherit (see [PRD - Global Flags](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#global-flags))
  - `--json`: Enable JSON output mode (stored in context)
  - `--no-color`: Disable ANSI color codes (stored in context)
  - `--verbose`: Enable debug logging (set log level)
  - `--config`: Specify custom config file path (default: .pmconfig.json)
  - All flags must be available at root level and inherited by subcommands

- **Argument Parsing**: Use Click decorators for all parameters (see [PRD - Argument Parsing](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#argument-parsing))
  - `@click.argument()` for required positional arguments
  - `@click.option()` for optional flags with defaults
  - Type validation via Click parameter types (str, int, Choice, etc.)
  - Custom validation for enum-based flags with helpful error messages
  - Support for multiple values (--status=todo --status=in_progress)

- **Entry Point Configuration**: Define console script in project configuration (see [PRD - Installation](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#installation))
  - pyproject.toml or setup.py with `shark` console script
  - Entry point function that initializes Click application
  - Dependencies: click, rich, sqlalchemy, alembic
  - Python version requirement: >=3.10

- **Help Text System**: Leverage Click's built-in help with enhancements (see [PRD - Help Text](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#help-text))
  - All commands use docstrings for descriptions
  - Include usage examples in docstrings
  - Related commands section in help text
  - Automatic flag documentation from Click decorators

### Files to Create/Modify

**New Files**:
- `pm/__init__.py` - Package root (if not exists)
- `pm/cli/__init__.py` - CLI package initialization
- `pm/cli/main.py` - Root Click application and entry point (~200 lines)
- `pm/cli/groups/__init__.py` - Command group definitions package
- `pm/cli/groups/task.py` - Task command group (placeholder for E04-F03)
- `pm/cli/groups/epic.py` - Epic command group (placeholder for E04-F04)
- `pm/cli/groups/feature.py` - Feature command group (placeholder for E04-F04)
- `pm/cli/groups/config.py` - Config command group (placeholder)
- `pyproject.toml` or `setup.py` - Package configuration with console script

**Configuration**:
- Entry point: `shark = pm.cli.main:cli`
- Dependencies: `click>=8.0`, `rich>=13.0`, `sqlalchemy>=2.0`, `alembic>=1.12`

### Integration Points

- **Database Layer (E04-F01)**: Framework will use SessionFactory in Phase 5 for database context
- **Output Formatting (Phase 2)**: Global --json flag sets output mode in context
- **Configuration (Phase 3)**: Global --config flag loads settings that override defaults
- **Error Handling (Phase 4)**: All commands will use error handlers defined in Phase 4
- **Task Operations (E04-F03)**: Task command group will be populated with CRUD commands
- **Epic/Feature Queries (E04-F04)**: Epic and Feature groups will be populated with query commands

Reference [PRD - User Stories](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#user-stories) for developer and agent personas.

## Validation Gates

- **Installation Test**: Run `pip install -e .` and verify `shark` command is available
  - `which shark` or `where shark` shows installed location
  - `shark --version` displays version (if implemented)
  - No import errors on startup

- **Command Registration**: Verify command hierarchy (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#command-registration))
  - `shark --help` lists all resource groups (task, epic, feature, config)
  - `shark task --help` lists task actions (list, get, create, update, delete placeholders)
  - Docstrings appear as command descriptions

- **Argument Parsing**: Test various argument combinations (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#argument-parsing))
  - Required arguments raise errors when missing
  - Optional flags accept values and apply defaults
  - Type validation rejects invalid inputs (e.g., non-integer for priority)
  - Enum flags suggest valid values on error

- **Global Flags**: Verify flag inheritance
  - `shark --verbose task list` enables debug logging
  - `shark task list --json` sets JSON mode in context
  - `shark --no-color task list` disables colors
  - CLI flags stored in Click context accessible to commands

- **Performance**: Measure startup time (see [PRD - Performance](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#non-functional-requirements))
  - `time shark --help` completes in <300ms
  - Help text rendering in <50ms
  - No unnecessary imports in entry point (lazy loading)

- **Help Text Quality**: Review help output
  - All commands have clear descriptions
  - Arguments and options documented
  - Examples provided for common commands
  - No placeholder or generic text

## Context & Resources

- **PRD**: [Complete Product Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)
  - [Functional Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#functional-requirements)
  - [User Stories](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#user-stories)
  - [Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#acceptance-criteria)
- **Click Documentation**: [Official Click Docs](https://click.palletsprojects.com/)
  - Command groups and nesting
  - Context passing
  - Decorators and parameters

## Notes for Agent

- **Click Groups**: Use `@click.group()` for resources (task, epic) and `@click.command()` for actions (list, get). Groups can be nested arbitrarily deep.
- **Context Object**: Initialize Click context with `ctx.obj = {}` in root command to store global state (json_mode, color_enabled, db_session, etc.).
- **Lazy Loading**: Import command groups lazily in main.py to keep startup time <300ms. Avoid importing heavy modules (Rich, SQLAlchemy) at package level.
- **Type Hints**: Use Click's built-in type converters (click.INT, click.Choice) rather than manual validation. Add Python type hints for IDE support.
- **Help Formatting**: Click automatically formats help text from docstrings. Use reStructuredText or Markdown for examples in docstrings.
- **Placeholder Commands**: Task/epic/feature groups should have placeholder commands that display "Not implemented" for now. E04-F03 and E04-F04 will replace placeholders with real implementations.
- **Testing Strategy**: Use Click's CliRunner for testing. Create simple smoke tests that verify command registration and help text rendering.
