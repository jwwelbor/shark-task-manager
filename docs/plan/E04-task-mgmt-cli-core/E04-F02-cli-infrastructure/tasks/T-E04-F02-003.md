---
task_key: T-E04-F02-003
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F02-001]
estimated_time: 6 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F02-003.md
---

# PRP: Configuration Management & User Defaults

## Goal

Implement .pmconfig.json configuration file system with loading, validation, merging with CLI flags, and default value management. The system must support user-configurable defaults (default_epic, default_agent, color_enabled, json_output) while allowing CLI flags to override config values.

## Success Criteria

- [ ] .pmconfig.json file format defined and documented (JSON schema)
- [ ] Configuration loader that reads and parses .pmconfig.json
- [ ] Validation for config file structure and value types
- [ ] Merge logic: CLI flags override config file, config file overrides hardcoded defaults
- [ ] Missing config file does not cause errors (silent fallback to defaults)
- [ ] Invalid JSON in config file raises clear, actionable error message
- [ ] Config validation command (`pm config validate`) implemented
- [ ] Config get/set commands for reading and updating config values
- [ ] Config initialization command (`pm config init`) creates default .pmconfig.json
- [ ] All configuration keys documented with examples
- [ ] Configuration loaded at CLI startup (before command execution)

## Implementation Guidance

### Overview

This phase implements the configuration management system that allows users to set default values for frequently used flags (like `--epic=E01` or `--agent=frontend`) in a .pmconfig.json file. The system loads configuration at startup, merges with CLI flags (flags take precedence), and provides commands for validating and managing the config file.

### Key Requirements

- **Configuration File Format**: Define .pmconfig.json structure (see [PRD - Configuration System](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-system))
  - JSON file in project root (same directory as .git or .pm directory)
  - Supported keys:
    - `default_epic` (string): Default epic key (e.g., "E01")
    - `default_agent` (string): Default agent type (e.g., "frontend", "backend")
    - `color_enabled` (boolean): Enable/disable colored output
    - `json_output` (boolean): Default to JSON output mode
  - Example:
    ```json
    {
      "default_epic": "E04",
      "default_agent": "general-purpose",
      "color_enabled": true,
      "json_output": false
    }
    ```

- **Configuration Loader**: Implement config file reading and parsing (see [PRD - Configuration System](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-system))
  - Function to locate .pmconfig.json (search current dir, then parent dirs up to root)
  - Parse JSON with error handling for invalid syntax
  - Return config dictionary or empty dict if file doesn't exist
  - No errors if config file is missing (just use defaults)
  - Cache loaded config for duration of command execution

- **Configuration Validation**: Implement config file validation (see [PRD - Configuration System](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-system))
  - Check all keys are recognized (warn on unknown keys)
  - Validate value types: default_epic (string), color_enabled (boolean), etc.
  - Validate epic key format matches pattern (E[0-9]{2})
  - Validate agent type is one of known types (frontend, backend, api-developer, etc.)
  - Provide clear error messages: "Expected 'default_epic' to be a string, got integer"

- **Merge Logic**: Implement precedence rules (see [PRD - Configuration System](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-system))
  - Hardcoded defaults (lowest priority)
  - Config file values (override defaults)
  - CLI flags (highest priority, override both)
  - Example: If config has `default_epic="E01"` but user runs `pm task list --epic=E02`, use "E02"
  - Store merged values in Click context for access by commands

- **Config Commands**: Implement config management subcommands
  - `pm config validate`: Validate .pmconfig.json and report errors
  - `pm config get [key]`: Display config value(s)
  - `pm config set <key> <value>`: Update config file with new value
  - `pm config init`: Create default .pmconfig.json with sample values

### Files to Create/Modify

**New Files**:
- `pm/cli/config/__init__.py` - Configuration package
- `pm/cli/config/loader.py` - Config file loading and parsing (~150 lines)
- `pm/cli/config/validator.py` - Config validation logic (~100 lines)
- `pm/cli/config/merger.py` - Merge config with CLI flags (~80 lines)
- `pm/cli/config/schema.py` - Config schema definition (constants, defaults) (~50 lines)
- `pm/cli/groups/config.py` - Config command group (~200 lines)
- `.pmconfig.json.example` - Example config file for documentation

**Modified Files**:
- `pm/cli/main.py` - Load config at startup, merge with CLI flags

### Integration Points

- **CLI Core (Phase 1)**: Config loaded at startup before command execution
- **Global Flags (Phase 1)**: CLI flags override config values during merge
- **Database Context (Phase 5)**: Config may specify database path in future
- **Task Operations (E04-F03)**: Commands use `default_epic` and `default_agent` from config
- **Epic/Feature Queries (E04-F04)**: Commands respect `default_epic` if no --epic flag provided

Reference [PRD - User Story #7](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#must-have-user-stories) for configuration use cases.

## Validation Gates

- **Configuration Loading**: Verify config file reading (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-loading))
  - Missing .pmconfig.json does not cause errors (uses defaults)
  - Valid .pmconfig.json is loaded and parsed correctly
  - Config values accessible via loader API
  - Invalid JSON raises clear error with line number

- **Configuration Validation**: Test validation logic (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-loading))
  - `pm config validate` reports success for valid config
  - `pm config validate` reports specific errors for invalid config
  - Unknown keys trigger warnings (not errors)
  - Type mismatches caught and reported

- **Merge Logic**: Test precedence rules (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-loading))
  - Config value used when no CLI flag provided
  - CLI flag overrides config value when both present
  - Hardcoded defaults used when no config and no CLI flag
  - Merged config accessible in Click context (`ctx.obj['config']`)

- **Config Commands**: Test config management
  - `pm config init` creates valid .pmconfig.json with defaults
  - `pm config get` displays all config values
  - `pm config get default_epic` displays single value
  - `pm config set default_epic E02` updates config file
  - `pm config validate` checks config without side effects

- **Error Messages**: Verify error clarity (see [PRD - Non-Functional Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#non-functional-requirements))
  - Invalid JSON: "Error: .pmconfig.json is not valid JSON: Unexpected token at line 5"
  - Type error: "Error: Expected 'default_epic' to be a string, got integer"
  - Unknown key: "Warning: Unknown config key 'unknwn_key'. Valid keys: default_epic, default_agent, color_enabled, json_output"

## Context & Resources

- **PRD**: [Complete Product Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)
  - [Configuration System](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-system)
  - [User Story #7](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#must-have-user-stories)
  - [Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#configuration-loading)
- **JSON Schema**: Consider using jsonschema library for validation
- **File Search**: Walk up directory tree from cwd to find .pmconfig.json

## Notes for Agent

- **Config File Location**: Search for .pmconfig.json starting from current working directory, then parent directories up to filesystem root or .git directory. Stop at first match.
- **JSON Parsing**: Use Python's `json.load()` with try/except for JSONDecodeError. Extract line number from exception for error messages.
- **Schema Definition**: Define config schema as Python dict with keys, types, and defaults. Use this for validation and merging.
- **Merge Algorithm**: `merged = {**DEFAULTS, **loaded_config, **cli_flags}` (dict unpacking). CLI flags extracted from Click context.
- **Config Commands**: Use Click's group/command structure. `pm config` is a group, `validate/get/set/init` are commands within that group.
- **File Modification**: For `pm config set`, read existing config, update key, write back with proper JSON formatting (indent=2). Preserve comments if possible (though JSON doesn't support comments natively).
- **Validation Logic**: Create validator functions for each config key. Compose into single validate_config() function that returns list of errors/warnings.
- **Testing**: Use temporary directories for config file tests. Test with valid/invalid/missing configs. Mock file system for edge cases.
