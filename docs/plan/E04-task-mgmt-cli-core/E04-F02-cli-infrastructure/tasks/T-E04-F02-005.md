---
task_key: T-E04-F02-005
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F02-001, T-E04-F02-004, T-E04-F01-002]
estimated_time: 6 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F02-005.md
---

# PRP: Database Context Integration & Session Management

## Goal

Integrate the database layer (E04-F01) with the CLI framework by implementing Click context-based session management, providing database sessions to commands via dependency injection, and ensuring automatic transaction lifecycle (commit on success, rollback on error, always close).

## Success Criteria

- [ ] Database session factory integrated with Click context
- [ ] Session created once per command invocation (not per subcommand)
- [ ] Session automatically closed after command completes (success or error)
- [ ] Transactions commit on successful command completion
- [ ] Transactions rollback on exceptions
- [ ] Database connection errors caught and converted to exit code 2
- [ ] Session accessible to commands via `ctx.obj['db']` or `ctx.obj.db`
- [ ] Session initialized before command execution, cleaned up after
- [ ] Database initialization (`init_database()`) integrated with CLI
- [ ] All database operations use context-provided session (no manual session creation in commands)

## Implementation Guidance

### Overview

This phase integrates the database layer from E04-F01 with the CLI framework from Phase 1. It provides database sessions to commands through Click's context object, ensuring proper transaction management and resource cleanup. Commands receive a ready-to-use database session without manually creating connections, and the framework automatically handles commit/rollback/close based on command success or failure.

### Key Requirements

- **Session Factory Integration**: Use SessionFactory from E04-F01 (see [PRD - Database Context Management](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#database-context-management))
  - Import SessionFactory from `pm.database.session` (E04-F01)
  - Create session in root command callback (before subcommand execution)
  - Store session in Click context: `ctx.obj['db'] = session`
  - Use context manager pattern for automatic cleanup

- **Click Context Setup**: Initialize context object in root command (see [PRD - Database Context Management](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#database-context-management))
  - Root command (`shark`) initializes `ctx.obj = {}` dict
  - Add database session to context before subcommand invocation
  - Pass context to all subcommands (Click does this automatically)
  - Commands access session via `@click.pass_context` decorator

- **Transaction Lifecycle**: Implement automatic commit/rollback (see [PRD - Database Context Management](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#database-context-management))
  - Session opened at start of command
  - Successful command completion triggers `session.commit()`
  - Exception during command triggers `session.rollback()`
  - Session always closed in finally block
  - Use Click's result callback or custom context manager

- **Database Initialization**: Integrate `init_database()` utility (see [PRD - Database Context Management](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#database-context-management))
  - Call `init_database()` on first command if database doesn't exist
  - Handle database not found errors gracefully
  - Provide `shark init` command for manual database initialization
  - Validate database schema version with Alembic

- **Error Handling**: Catch database connection errors (see [PRD - Error Handling](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#error-handling))
  - DatabaseNotFound → Suggest running `shark init`
  - DatabaseError → Exit code 2 (system error)
  - IntegrityError → Exit code 3 (validation error)
  - Use error handlers from Phase 4

### Files to Create/Modify

**New Files**:
- `pm/cli/database/__init__.py` - Database integration package
- `pm/cli/database/context.py` - Click context integration (~100 lines)
- `pm/cli/database/lifecycle.py` - Transaction lifecycle management (~80 lines)
- `pm/cli/commands/init.py` - Database initialization command (~50 lines)

**Modified Files**:
- `pm/cli/main.py` - Add database session to Click context at startup
- `pm/cli/groups/task.py` - Access session via `ctx.obj['db']` in task commands (placeholders)
- `pm/cli/groups/epic.py` - Access session via `ctx.obj['db']` in epic commands (placeholders)

### Integration Points

- **CLI Core (Phase 1)**: Uses Click context initialized in root command
- **Error Handling (Phase 4)**: Database errors caught by global exception handler
- **Database Layer (E04-F01)**: Uses SessionFactory, repositories, and exceptions from E04-F01
  - `from pm.database.session import SessionFactory`
  - `from pm.database.exceptions import DatabaseError, DatabaseNotFound`
  - `from pm.database.utils import init_database`
- **Task Operations (E04-F03)**: Task commands receive session via context
- **Epic/Feature Queries (E04-F04)**: Query commands receive session via context

Reference [PRD - User Story #8](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#must-have-user-stories) for database context requirements.

## Validation Gates

- **Session Creation**: Verify session lifecycle (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#database-context))
  - Session created once per command (not per subcommand)
  - Session accessible via `ctx.obj['db']`
  - Session is valid SQLAlchemy session object
  - Session connected to correct database file

- **Transaction Management**: Test commit/rollback behavior
  - Successful command commits transaction
  - Exception during command rolls back transaction
  - Session always closed (even on exception)
  - No database corruption after rollback
  - Changes persist after successful commit

- **Error Handling**: Test database error scenarios
  - Missing database file suggests running `shark init`
  - Database connection error returns exit code 2
  - Integrity constraint violation returns exit code 3
  - Error messages use format from Phase 4

- **Initialization**: Test `shark init` command
  - Creates database file if missing
  - Runs Alembic migrations to create schema
  - No errors on re-running (idempotent)
  - Database file has correct permissions (600 on Unix)

- **Command Integration**: Verify commands can use session
  - Placeholder task commands can query database via session
  - Commands can access repositories through session
  - No manual session creation needed in command code
  - Session cleanup happens automatically

## Context & Resources

- **PRD**: [Complete Product Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)
  - [Database Context Management](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#database-context-management)
  - [User Story #8](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#must-have-user-stories)
- **E04-F01 Database Layer**: Reference session management from database feature
  - SessionFactory class
  - Context managers for transactions
  - init_database() utility
  - Exception hierarchy
- **Click Context**: [Click documentation on context](https://click.palletsprojects.com/en/8.1.x/commands/#nested-handling-and-contexts)

## Notes for Agent

- **Context Initialization**: In root command (`shark`), add callback that sets `ctx.ensure_object(dict)`. This creates empty dict if not exists.
- **Session Injection**: Use Click's `@click.pass_context` decorator on command functions to receive context as first parameter. Access session with `ctx.obj['db']`.
- **Transaction Pattern**: Wrap command execution in try/except/finally:
  ```python
  try:
      result = command()
      session.commit()
      return result
  except Exception as e:
      session.rollback()
      raise
  finally:
      session.close()
  ```
- **Lazy Initialization**: Don't create session at CLI startup (slows down `shark --help`). Create session only when command needs database access.
- **Session Factory**: Use `SessionFactory.create_session()` from E04-F01. This returns context manager or session object depending on implementation.
- **Database Path**: Get database path from config (Phase 3) or use default from E04-F01. Allow `--db-path` flag to override.
- **Testing**: Use in-memory SQLite database (`:memory:`) for tests. Mock SessionFactory to return test session. Verify commit/rollback calls with mocks.
- **Performance**: Session creation should add <50ms to command startup. Measure with `time shark task list` (placeholder command).
