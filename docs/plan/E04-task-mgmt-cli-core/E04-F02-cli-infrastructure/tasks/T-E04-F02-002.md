---
task_key: T-E04-F02-002
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F02-001]
estimated_time: 10 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F02-002.md
---

# PRP: Output Formatting System - JSON & Rich Tables

## Goal

Implement dual output modes (JSON for agents, Rich tables for humans) with automatic format selection based on `--json` flag, terminal detection, and consistent serialization. The system must support colorized terminal output, table formatting with responsive column widths, and valid JSON with guaranteed schemas.

## Success Criteria

- [ ] JSON output module with serialization for all model types (Task, Epic, Feature, TaskHistory)
- [ ] Rich table formatter with customizable columns and styling
- [ ] Output context manager that selects format based on --json flag
- [ ] Color utilities that respect --no-color flag and terminal capabilities
- [ ] Terminal width detection and responsive table layout
- [ ] Text truncation for long fields (titles, descriptions) with ellipsis
- [ ] Empty result handling ({"results": [], "count": 0} for JSON, "No results found." for terminal)
- [ ] Table rendering for 100 rows completes in <200ms
- [ ] JSON serialization for 1000 tasks completes in <500ms
- [ ] All output goes to stdout, logs to stderr
- [ ] JSON output is valid and parseable by jq

## Implementation Guidance

### Overview

This phase implements the output formatting layer that translates data structures (ORM models, dictionaries) into human-readable terminal tables (using Rich) or machine-parseable JSON. The system must automatically select the appropriate format based on global flags, handle empty results gracefully, and optimize performance for large datasets.

### Key Requirements

- **JSON Output Module**: Implement JSON serialization utilities (see [PRD - Output Formatting](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#output-formatting))
  - Function to convert ORM models to dictionaries using `to_dict()` methods from E04-F01
  - Function to serialize lists of models to `{"results": [...], "count": N}` format
  - Handle special types: UUID (to string), datetime (ISO 8601), Enum (to value)
  - Pretty-print by default, compact with `--json-compact` flag
  - Guarantee consistent schema for each command output

- **Rich Table Formatter**: Implement terminal table rendering (see [PRD - Output Formatting](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#output-formatting))
  - Use Rich library for table creation and styling
  - Configurable columns (Key, Title, Status, Priority, Agent, etc.)
  - Color coding: status "completed" (green), "blocked" (red), "todo" (yellow)
  - Automatic column width adjustment based on terminal width
  - Truncate long text with "..." ellipsis to fit columns
  - Detect terminal width with Rich console
  - Ensure tables fit within 80-column terminals for accessibility

- **Output Context Manager**: Implement format selection logic (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#json-output))
  - Read `json_mode` flag from Click context
  - Provide unified interface: `with output_formatter(ctx) as fmt: fmt.display(data)`
  - Route to JSON serializer if `--json`, table formatter otherwise
  - Handle edge case: piped output (force JSON if not a tty)
  - Log warnings to stderr, output to stdout only

- **Color Utilities**: Implement colorization helpers (see [PRD - Colorized Output](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#colorized-output))
  - Respect `--no-color` flag from Click context
  - Detect terminal color support using Rich console capabilities
  - Define color scheme: success (green), error (red), warning (yellow), info (blue)
  - Strip ANSI codes when `--no-color` is set
  - Fallback to plain text if terminal doesn't support color

- **Empty Result Handling**: Consistent behavior for empty data (see [PRD - Output Formatting](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#output-formatting))
  - JSON mode: Return `{"results": [], "count": 0}`
  - Terminal mode: Display friendly message "No {resource} found." or "No tasks found matching filters."
  - Exit code 0 (success) for empty results (not an error)

### Files to Create/Modify

**New Files**:
- `pm/cli/output/__init__.py` - Output formatting package
- `pm/cli/output/json_formatter.py` - JSON serialization (~150 lines)
- `pm/cli/output/table_formatter.py` - Rich table rendering (~250 lines)
- `pm/cli/output/colors.py` - Color utilities and theme (~100 lines)
- `pm/cli/output/context.py` - Output context manager (~100 lines)
- `pm/cli/output/utils.py` - Text truncation, width detection (~80 lines)

**Modified Files**:
- `pm/cli/main.py` - Add --json-compact flag to root command

### Integration Points

- **CLI Core (Phase 1)**: Uses --json and --no-color flags from Click context
- **Database Layer (E04-F01)**: Calls `to_dict()` methods on ORM models for serialization
- **Error Handling (Phase 4)**: Error messages use color utilities (red for errors)
- **Task Operations (E04-F03)**: All task commands will use output formatter
- **Epic/Feature Queries (E04-F04)**: Epic and feature commands will use table formatter

Reference [PRD - User Stories #3 and #4](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#must-have-user-stories) for agent and developer personas.

## Validation Gates

- **JSON Format**: Verify JSON output structure (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#json-output))
  - Output is valid JSON parseable by `json.loads()` and `jq`
  - Schema matches expected format: `{"results": [...], "count": N}`
  - UUID fields are strings, not objects
  - Datetime fields are ISO 8601 strings
  - No NaN, Infinity, or other non-JSON values
  - Pretty-printed by default, compact with `--json-compact`

- **Table Format**: Verify terminal table rendering (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#table-formatting))
  - Tables display with correct columns (Key, Title, Status, Priority, Agent)
  - Column widths adjust to terminal width
  - Long titles truncated with "..." ellipsis
  - Tables fit within 80-column terminal without wrapping
  - No ANSI codes when `--no-color` is set

- **Colorization**: Test color behavior (see [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#colorized-output))
  - Status "completed" renders in green
  - Status "blocked" renders in red
  - Status "todo" renders in yellow
  - Colors disabled when `--no-color` flag is set
  - Plain text fallback when terminal doesn't support color

- **Performance**: Measure formatting speed (see [PRD - Performance](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#non-functional-requirements))
  - Table rendering for 100 rows in <200ms
  - JSON serialization for 1000 tasks in <500ms
  - No noticeable lag for typical result sets (10-50 items)
  - Terminal width detection in <10ms

- **Edge Cases**: Test boundary conditions
  - Empty results return correct format for mode
  - Single result displays properly in both modes
  - Very long titles (>200 chars) truncate correctly
  - Unicode characters in terminal (emoji, special chars)
  - Piped output (stdout to file or jq) forces JSON mode

- **Stream Separation**: Verify stdout/stderr usage
  - All command output goes to stdout only
  - All log messages (--verbose) go to stderr only
  - Piping stdout to jq works without log pollution

## Context & Resources

- **PRD**: [Complete Product Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)
  - [Output Formatting](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#output-formatting)
  - [Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md#acceptance-criteria)
- **Rich Documentation**: [Official Rich Docs](https://rich.readthedocs.io/)
  - Table creation and styling
  - Console and terminal detection
  - Color themes

## Notes for Agent

- **Rich Library**: Use `rich.table.Table` for table creation. Set `box=box.ROUNDED` for modern look, `show_header=True`, `header_style="bold"`.
- **Terminal Detection**: Use `rich.console.Console()` to detect terminal capabilities. Check `console.is_terminal` for tty detection.
- **Column Width**: Calculate column widths dynamically using `console.width`. Reserve space for borders/padding when distributing width.
- **Text Truncation**: Use `rich.text.Text.from_markup()` with `overflow="ellipsis"` for automatic truncation, or manually truncate with `text[:max_width-3] + "..."`.
- **JSON Serialization**: Use Python's `json.dumps()` with `indent=2` for pretty-print, `separators=(',', ':')` for compact. Create custom JSONEncoder for datetime/UUID if needed.
- **Color Scheme**: Define color constants in colors.py: `STATUS_COLORS = {"todo": "yellow", "in_progress": "blue", "completed": "green", "blocked": "red"}`. Use `rich.console.Console.print()` with color tags.
- **Performance**: Avoid row-by-row table construction. Build all rows first, then add to table in single call. Use generator expressions for large datasets.
- **Testing**: Create mock data (list of dicts) and test both JSON and table rendering. Verify output with regex for ANSI codes and JSON parsing.
