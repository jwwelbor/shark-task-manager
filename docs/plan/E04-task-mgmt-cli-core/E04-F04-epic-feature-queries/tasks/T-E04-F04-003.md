---
task_key: T-E04-F04-003
status: completed
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F04-001]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F04-003.md
---

# Task: Feature Query Commands

## Goal

Implement `pm feature list` and `pm feature get <feature-key>` CLI commands with filtering (--epic, --status), task status breakdown, and Rich table formatting.

## Success Criteria

- [ ] `pm feature list` command implemented with table output
- [ ] `pm feature list --epic=<key>` filter implemented
- [ ] `pm feature list --status=<status>` filter implemented
- [ ] `pm feature get <feature-key>` command implemented with task breakdown
- [ ] Task status breakdown displayed (e.g., "Completed: 7, In Progress: 2, Todo: 1")
- [ ] Rich tables formatted to fit 80-column terminal width
- [ ] Invalid filter values return exit code 1 with list of valid values
- [ ] Empty results show helpful messages (e.g., "No features found for Epic E01")
- [ ] Non-existent feature returns exit code 1 with error message
- [ ] Help text includes filter options and examples

## Implementation Guidance

### Overview

This phase implements the feature query commands that allow users to view all features (with filtering) or drill into specific feature details with task breakdown. Commands must support filtering by epic and status, display task status breakdown, and follow the same Rich formatting patterns as epic commands.

### Key Requirements

- **`pm feature list` Command**: See [PRD - Functional Requirements #14-20](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Returns all features from database
  - Table columns: Key | Title | Epic | Status | Progress | Tasks
  - Calls progress calculation service for each feature
  - Empty results: "No features found" (exit code 0)

- **`pm feature list --epic=<key>` Filter**: See [PRD - Functional Requirements #15](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Filter features by epic key (e.g., --epic=E01)
  - Empty results: "No features found for Epic E01" (exit code 0, not error)
  - Validate epic exists (optional: could filter silently)

- **`pm feature list --status=<status>` Filter**: See [PRD - Functional Requirements #16](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Filter features by status (draft, active, completed, archived)
  - Invalid status: exit code 1, message "Error: Invalid status. Must be one of: draft, active, completed, archived"
  - Use validation from E04-F01 (FeatureStatus enum)

- **`pm feature get <feature-key>` Command**: See [PRD - Functional Requirements #21-25](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Returns single feature by key (e.g., "E01-F02")
  - Displays feature metadata: key, title, epic, description, status, progress
  - Displays task status breakdown: "Completed: 5, In Progress: 2, Todo: 3, Blocked: 1"
  - Displays table of all tasks: Key | Title | Status | Priority | Agent
  - Non-existent feature: exit code 1, message "Error: Feature <key> does not exist"

- **Task Status Breakdown**: See [PRD - Functional Requirements #25](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Count tasks by status (completed, in_progress, todo, blocked, etc.)
  - Display as: "Status Breakdown: Completed: X, In Progress: Y, Todo: Z, Blocked: W"
  - Order by logical workflow (todo → in_progress → blocked → completed)

### Files to Create/Modify

**New Files**:
- `pm/cli/feature.py` - Feature command group and subcommands (~400 lines)
  - `@click.group()` for feature command group
  - `@feature.command()` for list subcommand
  - `@feature.command()` for get subcommand
  - Helper functions for filtering and status breakdown

**Modified Files**:
- `pm/cli/__init__.py` - Register feature command group with main CLI
- `pm/cli/main.py` - Import and add feature commands

**Test Files**:
- `tests/unit/cli/test_feature.py` - Unit tests for feature commands (~400 lines)
- `tests/integration/cli/test_feature_integration.py` - Integration tests (~200 lines)

### Integration Points

- **Progress Service** (T-E04-F04-001): Call progress calculation functions
  - Import from `pm.services.progress`
  - `calculate_feature_progress_by_key(feature_key)` for feature progress

- **E04-F01 Database**: Query Feature and Task models
  - Use repositories or ORM queries via session
  - Load feature with tasks (use `selectinload` for tasks relationship)
  - Filter by epic_id or status
  - Count tasks by status for breakdown

- **E04-F02 CLI Framework**: Follow existing patterns
  - Use Click decorators with options (@click.option for filters)
  - Validate filter values (status enum)
  - Rich table formatting
  - Appropriate exit codes

## Validation Gates

- **Acceptance Criteria Tests**: See [PRD - Acceptance Criteria - Feature Listing](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#feature-listing)
  - Given 10 features across 3 epics, `pm feature list --epic=E01` shows only E01 features
  - Given `pm feature list --status=active`, only active features displayed
  - Given no features match filters, "No features found for Epic E99" shown (exit code 0)

- **Acceptance Criteria Tests**: See [PRD - Acceptance Criteria - Feature Details](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#feature-details)
  - Given Feature E01-F02 with 10 tasks (7 completed, 2 in_progress, 1 todo):
    - Progress = 70%
    - Task breakdown: "Completed: 7, In Progress: 2, Todo: 1"
    - All 10 tasks listed in table
  - Given Feature E01-F99 does not exist, error message shown with exit code 1

- **Filter Validation Tests**:
  - `pm feature list --status=invalid` returns exit code 1 with valid options listed
  - `pm feature list --epic=E99` returns exit code 0 with "No features found" (empty result, not error)
  - Multiple filters work together (--epic=E01 --status=active)

- **Table Formatting Tests**:
  - Feature list table fits in 80 columns
  - Task list table fits in 80 columns
  - Status breakdown formatted clearly
  - Progress percentages right-aligned

## Context & Resources

- **PRD**: [Complete Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md)
  - [Functional Requirements #14-25](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements) - Feature command specifications
  - [Acceptance Criteria - Feature Listing](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#feature-listing)
  - [Acceptance Criteria - Feature Details](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#feature-details)
  - [User Stories #3-4, #9-10](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#user-stories) - Feature use cases

- **E04-F01 Database**: Feature and Task models, status enums
- **E04-F02 CLI Framework**: Command patterns and Click decorators
- **Progress Service**: Feature progress calculation from T-E04-F04-001

## Notes for Agent

- **Command Structure**: Use Click command groups. `pm feature list` and `pm feature get` are subcommands of the `feature` group.
- **Filter Implementation**: Use Click options with validation. `@click.option('--epic', help='Filter by epic key')` and `@click.option('--status', type=click.Choice(['draft', 'active', 'completed', 'archived']))`.
- **Status Breakdown**: Query tasks and count by status. Use SQL COUNT with GROUP BY for efficiency: `SELECT status, COUNT(*) FROM tasks WHERE feature_id = ? GROUP BY status`.
- **Empty Results**: Different messages for different filters. "No features found" vs "No features found for Epic E01" vs "No features found with status=active".
- **Task Loading**: Use `selectinload(Feature.tasks)` to eager-load tasks and avoid N+1 queries when displaying task table.
- **Table Columns**: Feature list shows epic key (not epic title) for compactness. Task count shows total number of tasks.
- **Testing**: Test all filter combinations. Test empty results. Test invalid filter values. Mock database for unit tests.
