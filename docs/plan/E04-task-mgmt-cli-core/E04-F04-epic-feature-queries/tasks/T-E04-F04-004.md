---
task_key: T-E04-F04-004
status: completed
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries
created: 2025-12-14
assigned_agent: general-purpose
dependencies: [T-E04-F04-002, T-E04-F04-003]
estimated_time: 4 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F04-004.md
---

# Task: JSON Output & Filtering

## Goal

Add --json flag to all epic and feature commands for machine-readable output, implement sorting support (--sort-by), and ensure JSON structure matches PRD specifications for AI agent consumption.

## Success Criteria

- [ ] `--json` flag implemented for all 4 commands (epic list, epic get, feature list, feature get)
- [ ] JSON output is valid and parseable
- [ ] JSON structure matches PRD specifications (see functional requirements)
- [ ] Epic get includes nested "features" array with full feature objects
- [ ] Feature get includes nested "tasks" array with full task objects
- [ ] jq queries work correctly (e.g., `shark epic get E01 --json | jq '.features[0].progress_pct'`)
- [ ] `--sort-by` flag implemented for list commands (sort by progress, status, key)
- [ ] JSON and table output show same data (consistency check)
- [ ] --json respects --epic and --status filters for feature list
- [ ] Help text documents JSON structure and sorting options

## Implementation Guidance

### Overview

This phase adds machine-readable JSON output to all epic and feature commands, enabling AI agents to query project structure programmatically. JSON output must be well-structured, consistent, and parseable. Sorting support allows users to prioritize by progress or status.

### Key Requirements

- **Epic List JSON**: See [PRD - Functional Requirements #4-6](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Structure: `{"results": [<epic objects>], "count": <integer>}`
  - Each epic object includes: id, key, title, description, status, priority, business_value, progress_pct, created_at, updated_at
  - Dates formatted as ISO 8601 strings
  - Progress as float (e.g., 75.3, not "75.3%")

- **Epic Get JSON**: See [PRD - Functional Requirements #11](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Structure: Single epic object with nested "features" array
  - Each feature includes: id, epic_id, key, title, description, status, progress_pct, task_count, created_at, updated_at
  - No wrapping object (just the epic object with features array)

- **Feature List JSON**: See [PRD - Functional Requirements #18-19](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Structure: `{"results": [<feature objects>], "count": <integer>}`
  - Each feature object includes: id, epic_id, key, title, description, status, progress_pct, task_count, created_at, updated_at
  - Respects --epic and --status filters

- **Feature Get JSON**: See [PRD - Functional Requirements #24](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements)
  - Structure: Single feature object with nested "tasks" array
  - Each task includes: id, feature_id, key, title, description, status, priority, assigned_agent, estimated_time, depends_on, file_path, created_at, updated_at, started_at, completed_at
  - Task status breakdown included as separate field (e.g., "status_breakdown": {"completed": 7, "in_progress": 2, "todo": 1})

- **Sorting Support**: See [PRD - User Stories #11](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#user-stories)
  - `--sort-by=progress` for epic/feature list (ascending or descending)
  - `--sort-by=status` for epic/feature list
  - `--sort-by=key` for default alphabetical order
  - Sorting works with both table and JSON output

### Files to Create/Modify

**New Files**:
- `pm/formatters/__init__.py` - Formatters package initialization
- `pm/formatters/json.py` - JSON serialization functions (~100 lines)
  - `format_epic_list_json(epics: List[Epic]) -> str`
  - `format_epic_get_json(epic: Epic, features: List[Feature]) -> str`
  - `format_feature_list_json(features: List[Feature]) -> str`
  - `format_feature_get_json(feature: Feature, tasks: List[Task]) -> str`

**Modified Files**:
- `pm/cli/epic.py` - Add --json flag and call JSON formatters
- `pm/cli/feature.py` - Add --json flag and call JSON formatters
- `pm/cli/epic.py` - Add --sort-by option to list command
- `pm/cli/feature.py` - Add --sort-by option to list command

**Test Files**:
- `tests/unit/formatters/test_json.py` - Unit tests for JSON formatters (~200 lines)
- `tests/integration/cli/test_json_output.py` - Integration tests for JSON commands (~200 lines)

### Integration Points

- **Epic/Feature Commands** (T-E04-F04-002, T-E04-F04-003): Add --json flag to existing commands
  - Check if --json flag is set
  - If set, call JSON formatter instead of table formatter
  - Output JSON to stdout

- **E04-F02 CLI Framework**: Integrate global --json flag if available
  - May already exist in E04-F02 (check global options)
  - If not, add as command-level option

- **ORM Models** (E04-F01): Use to_dict() methods for JSON serialization
  - Epic.to_dict(), Feature.to_dict(), Task.to_dict()
  - Add progress_pct and task_count fields to serialized output
  - Format dates as ISO 8601

## Validation Gates

- **Acceptance Criteria Tests**: See [PRD - Acceptance Criteria - JSON Output](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#json-output)
  - `shark epic get E01 --json` produces valid JSON
  - `shark epic get E01 --json | jq '.key'` extracts "E01"
  - `shark epic get E01 --json | jq '.features[0].progress_pct'` extracts feature progress
  - JSON structure matches PRD specifications exactly

- **Consistency Tests**:
  - Compare table and JSON output for same command
  - Verify same number of results
  - Verify same progress values
  - Verify same data fields

- **Sorting Tests**:
  - `shark epic list --sort-by=progress` returns epics in ascending progress order
  - `shark feature list --sort-by=status` returns features grouped by status
  - Sorting works with filters (--epic, --status)
  - JSON output respects sorting

- **Agent Consumption Tests**:
  - Parse JSON with Python json.loads()
  - Verify structure is navigable (no missing keys)
  - Verify data types are correct (floats for progress, ints for counts)
  - Verify nested arrays accessible

## Context & Resources

- **PRD**: [Complete Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md)
  - [Functional Requirements #4-6, 11, 18-19, 24](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#functional-requirements) - JSON specifications
  - [Acceptance Criteria - JSON Output](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#json-output)
  - [User Story #7](../docs/plan/E04-task-mgmt-cli-core/E04-F04-epic-feature-queries/prd.md#user-stories) - JSON for automation

- **E04-F01 Database**: ORM models with to_dict() methods
- **E04-F02 CLI Framework**: Global flag patterns

## Notes for Agent

- **JSON Structure**: Use Python's `json.dumps()` with `indent=2` for pretty-printing. Ensure valid JSON (no trailing commas, quoted keys).
- **Date Serialization**: Convert datetime objects to ISO 8601 strings: `created_at.isoformat()`.
- **Progress in JSON**: Return as float (75.3), not string ("75.3%"). Let consuming code format as needed.
- **Nested Objects**: For epic get, include full feature objects in "features" array. For feature get, include full task objects in "tasks" array.
- **Null Handling**: Use `null` for missing values (e.g., task.completed_at if not completed).
- **Sorting**: Apply sorting before serialization. Use Python's `sorted()` with key functions.
- **Testing with jq**: Include jq queries in integration tests to verify JSON is parseable and navigable.
- **Consistency**: Same data in table and JSON. Table is human-readable, JSON is machine-readable, but data must match.
