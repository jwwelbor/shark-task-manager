---
task_key: T-E04-F08-003
status: created
feature: /docs/plan/E04-task-mgmt-cli-core/E04-F08-distribution-release
created: 2025-12-17
assigned_agent: devops-engineer
dependencies: [T-E04-F08-002.md]
estimated_time: 6 hours
---

# Task: Package Manager Infrastructure

## Goal

Set up Homebrew tap and Scoop bucket repositories with proper authentication, then configure GoReleaser to automatically publish formulas/manifests to these repositories during releases.

## Success Criteria

- [ ] `homebrew-shark` GitHub repository created with proper structure
- [ ] `scoop-shark` GitHub repository created with proper structure
- [ ] Fine-grained Personal Access Tokens (PATs) generated with minimal permissions
- [ ] PATs stored in GitHub repository secrets
- [ ] `.goreleaser.yml` updated with Homebrew and Scoop configurations
- [ ] Configuration validated with `goreleaser check`
- [ ] README.md files created in both package manager repositories
- [ ] Token permissions scoped to contents:write only

## Implementation Guidance

### Overview

Create dedicated GitHub repositories for Homebrew tap and Scoop bucket, generate fine-grained PATs with minimal permissions, configure these as repository secrets, and update GoReleaser configuration to automatically publish package manager formulas/manifests during releases.

### Key Requirements

- **Repository Structure**: Create properly structured repositories for Homebrew (`Formula/` directory) and Scoop (`bucket/` directory) - See [Architecture - Package Manager Repositories](../02-architecture.md#package-manager-repositories)
- **Fine-Grained PATs**: Generate tokens with minimal permissions (contents:write only, scoped to specific repos) - See [Security - Token Security](../06-security-design.md#token-security)
- **Token Expiration**: Set 90-day expiration with calendar reminders for renewal - See [Security - Token Lifecycle](../06-security-design.md#token-lifecycle)
- **GoReleaser Integration**: Configure `brews:` and `scoops:` sections in `.goreleaser.yml` - See [Architecture - GoReleaser Package Managers](../02-architecture.md#package-manager-configuration)
- **Secure Storage**: Store PATs in GitHub repository secrets (never in code) - See [Security - Secret Management](../06-security-design.md#secret-management)

### Files to Create/Modify

**New Repositories** (create via GitHub UI):
- `github.com/jwwelbor/homebrew-shark` - Homebrew tap repository
- `github.com/jwwelbor/scoop-shark` - Scoop bucket repository

**Repository Contents**:
- `homebrew-shark/README.md` - Installation instructions for Homebrew users
- `homebrew-shark/Formula/.gitkeep` - Directory structure placeholder
- `scoop-shark/README.md` - Installation instructions for Scoop users
- `scoop-shark/bucket/.gitkeep` - Directory structure placeholder

**Configuration Updates**:
- `.goreleaser.yml` - Add `brews:` and `scoops:` sections

**GitHub Secrets** (create via repository settings UI):
- `HOMEBREW_TAP_TOKEN` - Fine-grained PAT for Homebrew tap
- `SCOOP_BUCKET_TOKEN` - Fine-grained PAT for Scoop bucket

### Integration Points

- **GitHub Actions**: Secrets accessible in workflow via `secrets.HOMEBREW_TAP_TOKEN` and `secrets.SCOOP_BUCKET_TOKEN`
- **GoReleaser**: Reads tokens from environment variables set by GitHub Actions
- **Package Repositories**: GoReleaser commits formulas/manifests to these repositories automatically
- **Main Repository**: Configuration lives in main Shark repository

Reference: [Architecture - Package Manager Integration](../02-architecture.md#package-manager-integration)

## Validation Gates

**Repository Structure Validation**:
- Clone both repositories locally
- Verify directory structures exist (`Formula/` and `bucket/`)
- Confirm README.md files are clear and helpful
- Check repositories are public (package managers require public repos)

**Token Validation**:
- Verify tokens have contents:write permission only
- Confirm tokens are scoped to specific repositories (not all repos)
- Verify 90-day expiration is set
- Test token works with curl to GitHub API (create/delete test file)

**Secret Validation**:
- Verify secrets created in main repository settings
- Confirm secrets are masked in workflow logs
- Test secrets are accessible in workflow (add temporary echo step if needed)

**Configuration Validation**:
- Run `goreleaser check` - must pass with no errors
- Verify Homebrew configuration includes macOS amd64 and arm64 only (not Windows)
- Verify Scoop configuration includes Windows amd64 only (not macOS/Linux)
- Confirm repository URLs are correct in config

Reference: [Test Criteria - Phase 3 Tests](../09-test-criteria.md#phase-3-package-manager-infrastructure)

## Context & Resources

- **Architecture**: [Package Manager Distribution](../02-architecture.md#package-manager-distribution)
- **Architecture**: [Repository Structure](../02-architecture.md#repository-structure)
- **Architecture**: [GoReleaser Package Config](../02-architecture.md#package-manager-configuration)
- **Security**: [Token Security Design](../06-security-design.md#token-security)
- **Security**: [Fine-Grained PAT Setup](../06-security-design.md#fine-grained-pat-configuration)
- **Security**: [Secret Management](../06-security-design.md#secret-management)
- **Implementation**: [Phase 3 Tasks](../08-implementation-phases.md#phase-3-package-manager-infrastructure)
- **Testing**: [Package Manager Tests](../09-test-criteria.md#distribution)

## Notes for Agent

- **Fine-Grained PATs**: Create via GitHub Settings → Developer Settings → Personal Access Tokens → Fine-grained tokens
- **Token Scope**: Select specific repositories only (homebrew-shark and scoop-shark respectively)
- **Token Permissions**: Enable "Contents" with "Read and Write" access ONLY (disable all other permissions)
- **Repository Naming**: Must follow Homebrew (`homebrew-*`) and Scoop (`scoop-*`) naming conventions
- **Formula Directory**: Homebrew requires `Formula/` directory (capital F)
- **Bucket Directory**: Scoop uses `bucket/` directory (lowercase b)
- **Public Repositories**: Both package manager repos must be public for users to access
- **Token Testing**: Use `curl` with token to verify it works before adding to secrets
- **Calendar Reminder**: Set calendar reminder 2 weeks before token expiration (90 days from creation)
