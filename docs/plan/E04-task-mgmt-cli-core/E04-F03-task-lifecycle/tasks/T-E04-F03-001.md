---
task_key: T-E04-F03-001
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F01-006", "T-E04-F02-001"]
estimated_time: 8 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F03-001.md
priority: 1
---

# PRP: Task Query Operations (list, get, next)

## Goal

Implement CLI commands for querying tasks with filtering, sorting, and intelligent task discovery. Enable both human developers and AI agents to efficiently find tasks using `pm task list`, `pm task get`, and `pm task next` commands with support for multiple filters, JSON output, and dependency validation.

## Success Criteria

- [ ] `pm task list` command implemented with filtering by status, epic, feature, agent, priority
- [ ] Multiple filter values supported (e.g., `--status=todo,in_progress`)
- [ ] Results displayed as formatted tables (human mode) or JSON (agent mode)
- [ ] `pm task get <task-key>` command retrieves single task with full details
- [ ] Dependency status included in task detail output
- [ ] `pm task next` command returns highest-priority available task
- [ ] Dependency validation excludes tasks with incomplete dependencies
- [ ] Empty results handled gracefully with appropriate messages
- [ ] All commands support `--json` flag for machine-readable output
- [ ] Query performance meets <100ms target for 1,000 tasks
- [ ] Comprehensive help text and examples for all commands
- [ ] 100% test coverage for query operations

## Implementation Guidance

### Overview

This phase implements the read-only task query operations that enable developers and agents to discover and inspect tasks. You'll create three primary commands: `pm task list` for filtered task queries, `pm task get` for retrieving specific task details, and `pm task next` for intelligent task discovery based on availability, priority, and dependencies.

### Key Requirements

- **Task List Command**: Implement as specified in [PRD - Task Listing](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-listing-pm-task-list)
  - Filter by status (single or multiple: `--status=todo,in_progress`)
  - Filter by epic (`--epic=E01`)
  - Filter by feature (`--feature=E01-F02`)
  - Filter by agent type (`--agent=frontend`)
  - Filter by priority (single or range: `--priority=1` or `--priority-min=1 --priority-max=3`)
  - Support `--blocked` flag to show only blocked tasks
  - Combine filters with AND logic
  - Return formatted table or JSON based on `--json` flag

- **Task Get Command**: Implement as specified in [PRD - Task Details](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-details-pm-task-get)
  - Accept task key as required argument
  - Return full task object with all fields
  - Include dependency status (whether each dependency is complete)
  - Exit with code 1 if task does not exist
  - Support both human-readable and JSON output

- **Task Next Command**: Implement as specified in [PRD - Task Discovery](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-discovery-pm-task-next)
  - Return highest-priority available task (priority 1 = highest)
  - Filter by `--agent` (optional): only return tasks matching agent_type
  - Filter by `--epic` (optional): only return tasks in specified epic
  - Exclude tasks with status other than "todo"
  - Exclude tasks with incomplete dependencies (dependencies not in "completed" or "archived" status)
  - Return empty result with message "No available tasks found" if no matches
  - Include task key, title, file_path, dependencies, dependency_status in output

- **Database Integration**: Use E04-F01 database layer
  - Import Task model from `pm.database.models`
  - Use SessionFactory from E04-F01 for database access
  - Use repository pattern for queries (reference E04-F01 architecture)
  - Build queries with SQLAlchemy filters
  - Apply indexes for optimal query performance

- **CLI Framework Integration**: Use E04-F02 infrastructure
  - Register commands using Click decorators
  - Use Rich for table formatting (human mode)
  - Use JSON serialization utilities (agent mode)
  - Apply consistent error handling with exit codes
  - Include comprehensive help text with examples

### Files to Create/Modify

**New Files**:
- `pm/cli/commands/task_queries.py` - Task query command implementations (~300 lines)
- `pm/services/task_query_service.py` - Business logic for task queries (~200 lines)
- `tests/unit/cli/test_task_queries.py` - Unit tests for CLI commands (~200 lines)
- `tests/unit/services/test_task_query_service.py` - Service layer tests (~250 lines)
- `tests/integration/test_task_query_commands.py` - End-to-end CLI tests (~150 lines)

**Modified Files**:
- `pm/cli/__init__.py` - Register task query commands
- `pm/cli/commands/__init__.py` - Export task query commands

### Integration Points

- **E04-F01 Database**: Uses Task model, SessionFactory, query methods from repositories
- **E04-F02 CLI Framework**: Uses Click command registration, Rich formatting, error handling patterns
- **Future E04-F05**: File paths returned in queries will be validated by folder management feature
- **Future E04-F03-002**: State transition commands will build on query operations

Reference [PRD - Integration with Other Features](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#integration-with-other-features) for coordination points.

## Validation Gates

- **Functional Tests**: Verify requirements from [PRD - Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-listing)
  - List filters work correctly (status, epic, feature, agent, priority)
  - Multiple filter values combine with AND logic
  - Empty results return appropriate messages
  - Task get returns full task details including dependency status
  - Task next returns highest-priority available task
  - Tasks with incomplete dependencies are excluded from next
  - Invalid task key returns exit code 1

- **Output Format Tests**: Verify both human and JSON modes
  - Human mode displays formatted tables with proper column alignment
  - JSON mode returns valid JSON with expected schema
  - Long titles truncate to fit terminal width
  - Empty results handled gracefully in both modes

- **Performance Tests**: Meet targets from [PRD - Performance Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#non-functional-requirements)
  - `pm task list` completes in <100ms for 1,000 tasks
  - `pm task next` completes in <50ms
  - Queries use database indexes (no full table scans)

- **Error Handling Tests**: Verify exit codes and messages
  - Missing task returns exit code 1 with actionable message
  - Invalid filter values show clear error messages
  - Database errors return exit code 2

- **Coverage**: 100% line coverage for query operations
  - Run `pytest --cov=pm/cli/commands/task_queries --cov=pm/services/task_query_service --cov-report=term-missing`

## Context & Resources

- **PRD**: [Task Lifecycle Operations PRD](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md)
  - [Task Listing Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-listing-pm-task-list)
  - [Task Details Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-details-pm-task-get)
  - [Task Discovery Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-discovery-pm-task-next)
  - [Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#acceptance-criteria)
- **E04-F01 Database**: [Database Schema Design](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/02-architecture.md)
- **E04-F02 CLI Framework**: [CLI Infrastructure PRD](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)

## Notes for Agent

- **Query Optimization**: Use SQLAlchemy filter chaining for multiple conditions: `query.filter(Task.status == "todo").filter(Task.epic == "E01")`
- **Dependency Checking**: For `pm task next`, join with dependency tasks and exclude if any dependency has status in ["todo", "in_progress", "blocked"]
- **Priority Sorting**: Sort by priority ASC (1 = highest priority) then by created_at ASC for deterministic ordering
- **Error Messages**: Make errors actionable - suggest `pm task list` when task not found, show valid status values when invalid status provided
- **JSON Schema**: Use Pydantic models or dataclasses for consistent JSON serialization (Task model likely has .dict() method)
- **Table Formatting**: Use Rich Table with columns: Key (12 chars), Title (30 chars), Status (15 chars), Priority (8 chars), Agent (15 chars)
- **Filter Parsing**: Click supports multiple values via `multiple=True` parameter or comma-separated parsing
- **Session Management**: Use Click context to access database session from E04-F02 framework
