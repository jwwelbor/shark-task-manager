---
task_key: T-E04-F03-002
status: todo
feature: /home/jwwelbor/.claude/docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle
created: 2025-12-14
assigned_agent: general-purpose
dependencies: ["T-E04-F03-001"]
estimated_time: 10 hours
file_path: /home/jwwelbor/.claude/docs/tasks/todo/T-E04-F03-002.md
priority: 1
---

# PRP: Core State Transition Operations (start, complete, approve)

## Goal

Implement the primary task lifecycle state transition commands that move tasks through the workflow: `shark task start` (todo → in_progress), `shark task complete` (in_progress → ready_for_review), and `shark task approve` (ready_for_review → completed). Each command validates state transitions, updates the database atomically, records history, and triggers file operations.

## Success Criteria

- [ ] `shark task start <task-key>` transitions task from "todo" to "in_progress"
- [ ] Start command sets started_at timestamp and assigned_agent
- [ ] `shark task complete <task-key>` transitions task from "in_progress" to "ready_for_review"
- [ ] Complete command accepts optional `--notes` flag for completion notes
- [ ] Complete command sets completed_at timestamp
- [ ] `shark task approve <task-key>` transitions task from "ready_for_review" to "completed"
- [ ] Approve command accepts optional `--notes` flag for approval notes
- [ ] All state transitions validated before execution (reject invalid transitions)
- [ ] Invalid state transitions return exit code 3 with clear error messages
- [ ] History records created for every status change with agent, timestamp, notes
- [ ] File operations triggered for each transition (via E04-F05 integration points)
- [ ] Feature progress calculation updated after each transition
- [ ] Transactions rollback on failure (database and file operations atomic)
- [ ] All commands complete in <200ms including database and file operations
- [ ] 100% test coverage for state transition operations

## Implementation Guidance

### Overview

This phase implements the core task lifecycle commands that agents and developers use to progress work through the system. You'll create three commands that handle the primary workflow: starting work on a task, marking it complete for review, and approving reviewed work. Each command must validate the current state, update the database atomically, record history, and coordinate with the file management system.

### Key Requirements

- **Task Start Command**: Implement as specified in [PRD - Task Start](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-start-pm-task-start)
  - Accept task key as required argument
  - Validate current status is "todo" (reject if not)
  - Update database: status = "in_progress", started_at = current UTC timestamp
  - Set assigned_agent to current user/agent identifier (from --agent flag, USER env var, or "unknown")
  - Record history: old_status="todo", new_status="in_progress", timestamp, agent
  - Trigger file move from todo/ to active/ (integration point for E04-F05)
  - Warn if task has incomplete dependencies but allow start
  - Update feature progress calculation
  - Display success message: "Task T-E01-F02-003 started. File moved to active/"

- **Task Complete Command**: Implement as specified in [PRD - Task Complete](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-complete-pm-task-complete)
  - Accept task key as required argument
  - Accept optional `--notes` flag to record completion notes
  - Validate current status is "in_progress" (reject if not)
  - Update database: status = "ready_for_review", completed_at = current UTC timestamp
  - Record history with completion notes if provided
  - Trigger file move from active/ to ready-for-review/
  - Update feature progress calculation
  - Display success message: "Task T-E01-F02-003 marked ready for review. File moved to ready-for-review/"

- **Task Approve Command**: Implement as specified in [PRD - Task Approve](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-approve-pm-task-approve)
  - Accept task key as required argument
  - Accept optional `--notes` flag to record approval notes
  - Validate current status is "ready_for_review" (reject if not)
  - Update database: status = "completed"
  - Record history with approval notes if provided
  - Trigger file move from ready-for-review/ to completed/
  - Update feature progress calculation (task now contributes to 100%)
  - Display success message: "Task T-E01-F02-003 approved and completed. File moved to completed/"

- **State Transition Validation**: Implement as specified in [PRD - State Transition Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#state-transition-validation)
  - Define valid transitions:
    - todo → in_progress (start)
    - in_progress → ready_for_review (complete)
    - ready_for_review → completed (approve)
  - Reject all other transitions with error: "Invalid state transition from <old_status> to <new_status>"
  - Validate transitions before database updates
  - Return exit code 3 for validation errors

- **History Recording**: Implement as specified in [PRD - History Recording](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#history-recording)
  - Every status change must create task_history record
  - Include: task_id, old_status, new_status, agent, notes, timestamp (UTC)
  - Record history atomically with status update (same transaction)
  - Derive agent identifier from: --agent flag, environment variable USER, or "unknown"

- **Atomic Transactions**: Implement as specified in [PRD - Atomic Transactions](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#atomic-transactions)
  - Database update and file operation must be atomic
  - If file operation fails, rollback database transaction
  - If database update fails, do not perform file operation
  - Display appropriate error message and exit code 2 on failure

### Files to Create/Modify

**New Files**:
- `pm/cli/commands/task_transitions.py` - State transition command implementations (~350 lines)
- `pm/services/task_transition_service.py` - Business logic for state transitions (~300 lines)
- `pm/services/state_validator.py` - State transition validation logic (~150 lines)
- `pm/services/history_service.py` - History recording service (~100 lines)
- `tests/unit/cli/test_task_transitions.py` - Unit tests for CLI commands (~250 lines)
- `tests/unit/services/test_task_transition_service.py` - Service layer tests (~300 lines)
- `tests/unit/services/test_state_validator.py` - State validation tests (~200 lines)
- `tests/integration/test_task_transition_commands.py` - End-to-end tests (~200 lines)

**Modified Files**:
- `pm/cli/__init__.py` - Register state transition commands
- `pm/cli/commands/__init__.py` - Export state transition commands
- `pm/database/models.py` - May need to add history model if not in E04-F01

### Integration Points

- **E04-F01 Database**: Uses Task and TaskHistory models, SessionFactory, repository methods
- **E04-F02 CLI Framework**: Uses Click command registration, error handling, exit codes
- **E04-F05 Folder Management**: Calls file move functions (create stub/mock for now if not implemented)
  - `move_task_file(task_key, from_folder, to_folder)` - to be implemented in E04-F05
  - For now, create integration point that logs the intended move
- **E04-F03-001**: Uses query service to retrieve task before updating

Reference [PRD - Integration with Other Features](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#integration-with-other-features) for coordination requirements.

## Validation Gates

- **State Transition Tests**: Verify from [PRD - Task Start Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-start)
  - Task with status="todo" can be started successfully
  - Task with status="in_progress" cannot be started (invalid transition)
  - Task with status="completed" cannot be started (invalid transition)
  - Started_at timestamp is set correctly
  - Assigned_agent is recorded
  - History record is created

- **Complete Command Tests**: Verify from [PRD - Task Complete Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-complete)
  - Task with status="in_progress" can be completed
  - Task with status="todo" cannot be completed (shows clear error)
  - Completed_at timestamp is set
  - Notes are recorded in history when provided
  - File move is triggered to ready-for-review/

- **Approve Command Tests**: Verify from [PRD - Task Approve Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-approve)
  - Task with status="ready_for_review" can be approved
  - Task with other statuses cannot be approved
  - Approval notes are recorded in history
  - File move is triggered to completed/
  - Feature progress is recalculated

- **History Recording Tests**: Verify from [PRD - History Recording Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#history-recording)
  - Every status change creates exactly one history record
  - History includes task_id, old_status, new_status, agent, timestamp
  - Optional notes are recorded when provided
  - Timestamps are in UTC format

- **Transaction Atomicity Tests**: Verify from [PRD - Atomic Transactions Acceptance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#atomic-transactions)
  - If file operation fails, database transaction is rolled back
  - Task status remains unchanged after failed transaction
  - No history record is created on rollback
  - Error message displayed with exit code 2

- **Performance Tests**: Meet targets from [PRD - Performance](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#non-functional-requirements)
  - Status update commands complete in <200ms (including database + file operations)

- **Coverage**: 100% line coverage for state transition operations
  - Run `pytest --cov=pm/cli/commands/task_transitions --cov=pm/services/task_transition_service --cov=pm/services/state_validator --cov-report=term-missing`

## Context & Resources

- **PRD**: [Task Lifecycle Operations PRD](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md)
  - [Task Start Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-start-pm-task-start)
  - [Task Complete Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-complete-pm-task-complete)
  - [Task Approve Requirements](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#task-approve-pm-task-approve)
  - [State Transition Validation](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#state-transition-validation)
  - [History Recording](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#history-recording)
  - [Acceptance Criteria](../docs/plan/E04-task-mgmt-cli-core/E04-F03-task-lifecycle/prd.md#acceptance-criteria)
- **E04-F01 Database**: [Database Schema](../docs/plan/E04-task-mgmt-cli-core/E04-F01-database-schema/03-data-design.md)
- **E04-F02 CLI Framework**: [CLI Infrastructure](../docs/plan/E04-task-mgmt-cli-core/E04-F02-cli-infrastructure/prd.md)

## Notes for Agent

- **State Machine Pattern**: Create a state transition map dictionary: `VALID_TRANSITIONS = {("todo", "in_progress"): "start", ("in_progress", "ready_for_review"): "complete", ...}`
- **Agent Identification**: Derive agent from: 1) --agent CLI flag, 2) os.environ.get("USER"), 3) "unknown"
- **UTC Timestamps**: Use `datetime.utcnow()` for all timestamp fields
- **Transaction Pattern**: Use database session context manager with try/except/finally for atomic operations
- **File Operation Stub**: If E04-F05 not implemented, create stub function that logs intended file move: `logger.info(f"Would move {task_key} from {from_folder} to {to_folder}")`
- **Progress Calculation**: E04-F01 likely has a method to recalculate feature progress - call after each state change
- **Validation Errors**: Use exit code 3 specifically for state transition validation failures (distinct from user errors)
- **Success Messages**: Be specific about what changed: status, file location, timestamps set
- **Dependency Warning**: For `shark task start`, check if dependencies are incomplete and warn: "Warning: Task has incomplete dependencies but proceeding with start."
