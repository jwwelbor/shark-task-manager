---
task_key: T-E06-F04-004
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F04-incremental-sync-engine
created: 2025-12-17
assigned_agent: backend
dependencies: [T-E06-F04-003]
estimated_time: 8 hours
---

# Task: Integration, Testing, and Performance Validation

## Goal

Integrate incremental sync components into E04-F07 sync engine, maintain backward compatibility with full scans, implement comprehensive test coverage including performance benchmarks, and validate the complete incremental sync workflow achieves <2 seconds for 1-10 file changes and <5 seconds for 100 file changes.

## Success Criteria

- [ ] E04-F07 sync engine supports --incremental flag
- [ ] Backward compatibility: sync without flag performs full scan as before
- [ ] All incremental components integrated: filtering, conflict detection, resolution
- [ ] Transaction boundaries maintained (atomic sync with rollback)
- [ ] Sync report enhanced with incremental statistics
- [ ] Integration tests: first sync, incremental sync, conflict scenarios
- [ ] Performance benchmarks: 1-10 files <2s, 100 files <5s, 500 files <30s
- [ ] Documentation updated with incremental sync usage

## Implementation Guidance

### Overview

Modify `internal/sync/engine.go` to orchestrate the incremental sync workflow: get last_sync_time, apply file filtering, detect conflicts, apply resolution strategy, commit transaction, update last_sync_time. Ensure the integration maintains E04-F07's transaction safety and error handling while adding the new incremental capabilities.

### Key Requirements

- **Workflow Integration**: last_sync_time → filter → parse → conflict → resolve → commit → update_time - See [PRD - FR-001 through FR-050](../prd.md#functional-requirements)
- **Backward Compatibility**: Non-incremental sync behaves exactly as E04-F07 - See [PRD - FR-053](../prd.md#integration-with-existing-sync)
- **Transaction Safety**: All DB ops in single transaction with rollback - See [PRD - FR-030 through FR-037](../prd.md#transaction-safety-and-atomicity)
- **Performance**: Meet timing requirements for various file counts - See [PRD - REQ-NF-001](../prd.md#performance)
- **Error Recovery**: Individual file errors don't abort entire sync - See [PRD - FR-048](../prd.md#error-handling-and-edge-cases)

### Files to Create/Modify

**Modified Files**:
- `internal/sync/engine.go` - Orchestrate incremental sync workflow
- `internal/sync/report.go` - Add incremental stats to sync report
- `cmd/shark/commands/sync.go` - Wire up --incremental flag

**New Files**:
- `internal/sync/integration_test.go` - End-to-end incremental sync tests
- `internal/sync/benchmark_test.go` - Performance benchmarks
- `docs/user-guide/incremental-sync.md` - User documentation

**Test Coverage**:
- First sync (no last_sync_time): performs full scan, sets timestamp
- Incremental sync (3 files changed): processes only 3 files
- Conflict scenario: detects and resolves with --strategy flag
- Performance benchmarks for 10, 100, 500, 1000 files

### Validation Gates

- [ ] First sync on new project: full scan, last_sync_time set
- [ ] Incremental sync, no changes: reports 0 files changed in <1s
- [ ] Incremental sync, 5 files changed: processes 5 files in <2s
- [ ] Incremental sync, 100 files changed: processes 100 files in <5s
- [ ] Incremental sync, 500 files changed: processes 500 files in <30s
- [ ] Conflict detected with file-wins: DB updated, conflict logged
- [ ] Sync with --force-full-scan: ignores last_sync_time, scans all files
- [ ] Transaction rollback: last_sync_time not updated, retry works
- [ ] Backward compatibility: sync without --incremental still works

### Integration Points

- **E04-F07 Sync Engine**: Core integration, maintains existing contracts
- **Config System**: Last sync time tracking from T-E06-F04-001
- **File Filtering**: Incremental filter from T-E06-F04-002
- **Conflict System**: Detection and resolution from T-E06-F04-003
- **Reporting**: Enhanced sync report for T-E06-F05

### Notes for Agent

- Preserve E04-F07 transaction logic exactly (critical for data integrity)
- Update sync report format incrementally (add fields, don't remove)
- Performance benchmarks should use realistic file distributions (not just empty files)
- Consider adding --benchmark flag to run performance test on user's codebase
- Document migration path: users can immediately use --incremental, it's opt-in
- Ensure --dry-run works with --incremental (preview without last_sync_time update)
