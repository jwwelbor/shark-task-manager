---
task_key: T-E06-F04-001
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F04-incremental-sync-engine
created: 2025-12-17
assigned_agent: backend
dependencies: []
estimated_time: 6 hours
---

# Task: Last Sync Time Tracking and Configuration

## Goal

Implement the last_sync_time tracking mechanism that records sync completion timestamps in .sharkconfig.json, validates timestamp format, and provides accessors for the sync engine to determine which files need processing during incremental syncs.

## Success Criteria

- [ ] ConfigManager extended to read/write last_sync_time field
- [ ] Timestamp format validation (RFC3339 with timezone)
- [ ] UpdateLastSyncTime() method updates config after successful sync
- [ ] GetLastSyncTime() returns parsed time.Time or nil if not set
- [ ] Atomic config file updates (write to temp, rename)
- [ ] Invalid timestamp handling (log error, treat as nil, perform full scan)
- [ ] Unit tests cover timestamp parsing, updates, and error cases
- [ ] Integration test: sync → last_sync_time set → next sync uses timestamp

## Implementation Guidance

### Overview

Extend the existing config system in `internal/config/` to support last_sync_time tracking. Add fields to the config struct, implement read/write methods with validation, and ensure atomic file updates to prevent corruption. This provides the foundation for incremental sync change detection.

### Key Requirements

- **Timestamp Recording**: Write RFC3339 timestamp to .sharkconfig.json after successful sync - See [PRD - FR-001](../prd.md#last-sync-time-tracking)
- **Format Validation**: Validate RFC3339 format with timezone on load - See [PRD - FR-047](../prd.md#error-handling-and-edge-cases)
- **Atomic Updates**: Use temp file + rename pattern to prevent corruption - See [Architecture - Config Management](../02-architecture.md#configuration-management)
- **Error Handling**: Invalid timestamps treated as nil (triggers full scan) - See [PRD - FR-047](../prd.md#error-handling-and-edge-cases)
- **Backward Compatibility**: Missing last_sync_time field handled gracefully - See [PRD - FR-006](../prd.md#incremental-file-filtering)

### Files to Create/Modify

**Modified Files**:
- `internal/config/config.go` - Add LastSyncTime field to Config struct
- `internal/config/manager.go` - Add UpdateLastSyncTime(), GetLastSyncTime() methods
- `internal/config/manager_test.go` - Add timestamp tracking tests

**Configuration Schema**:
```json
{
  "last_sync_time": "2025-12-17T14:30:45-08:00",
  // ... existing config fields
}
```

### Validation Gates

- [ ] Load config with valid last_sync_time: parses to time.Time correctly
- [ ] Load config without last_sync_time: returns nil, no error
- [ ] Load config with invalid timestamp: logs error, returns nil
- [ ] UpdateLastSyncTime(): writes RFC3339 timestamp to config file
- [ ] Atomic update: concurrent reads during write see old or new, never partial
- [ ] File write failure: returns error, doesn't corrupt existing config
- [ ] Timestamp includes timezone: can compare across systems correctly

### Integration Points

- **Sync Engine**: Calls GetLastSyncTime() before scanning files
- **Incremental Filter**: Uses returned timestamp for mtime comparison (T-E06-F04-002)
- **Sync Completion**: Calls UpdateLastSyncTime() after transaction commit

### Notes for Agent

- Use time.RFC3339 constant for parsing/formatting
- Store timezone to handle daylight saving and multi-timezone teams
- Atomic file update: write to .sharkconfig.json.tmp, then os.Rename()
- Consider adding --reset-sync-time flag for troubleshooting
- Config file permissions should be preserved during update (stat → chmod)
