---
task_key: T-E06-F04-002
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F04-incremental-sync-engine
created: 2025-12-17
assigned_agent: backend
dependencies: [T-E06-F04-001]
estimated_time: 8 hours
---

# Task: Incremental File Filtering Implementation

## Goal

Implement mtime-based file filtering that compares each file's modification time against last_sync_time, creates a filtered file list of only changed files, and provides --force-full-scan override for validation scenarios, achieving <100ms overhead for 500 file trees.

## Success Criteria

- [ ] IncrementalFilter implementation with mtime comparison logic
- [ ] Handles new files (not in database) correctly (always include)
- [ ] Filesystem timestamp precision handled (nanosecond vs second precision)
- [ ] Clock skew tolerance (±60 seconds) implemented
- [ ] --force-full-scan flag bypasses incremental filtering
- [ ] Automatic fallback to full scan when last_sync_time is nil
- [ ] Performance validated: <100ms overhead for 500 files
- [ ] Unit tests cover mtime comparison, clock skew, edge cases

## Implementation Guidance

### Overview

Create `internal/sync/incremental.go` that implements file filtering based on modification times. The filter receives a list of candidate files and last_sync_time, stats each file to get mtime, compares against the threshold, and returns only files that need processing. This significantly reduces I/O for large documentation trees.

### Key Requirements

- **Mtime Comparison**: Compare file.ModTime() > last_sync_time - See [PRD - FR-007 through FR-015](../prd.md#incremental-file-filtering)
- **New File Detection**: Files not in database always included regardless of mtime - See [PRD - FR-011](../prd.md#incremental-file-filtering)
- **Clock Skew**: Allow ±60 second tolerance, warn if >60 seconds - See [PRD - FR-045](../prd.md#error-handling-and-edge-cases)
- **Force Full Scan**: --force-full-scan flag ignores mtime, processes all files - See [PRD - FR-012](../prd.md#incremental-file-filtering)
- **Performance**: Minimize syscalls, stat files efficiently - See [PRD - REQ-NF-001](../prd.md#performance)

### Files to Create/Modify

**New Files**:
- `internal/sync/incremental.go` - IncrementalFilter implementation
- `internal/sync/incremental_test.go` - Filtering and performance tests

**Modified Files**:
- `internal/sync/engine.go` - Apply incremental filter before parsing
- `cmd/shark/commands/sync.go` - Add --incremental and --force-full-scan flags

### Validation Gates

- [ ] File mtime > last_sync_time: included in filtered list
- [ ] File mtime <= last_sync_time: excluded from filtered list
- [ ] File mtime == last_sync_time + 30 seconds (clock skew): included, no warning
- [ ] File mtime in future (>60 seconds ahead): included, warning logged
- [ ] New file (not in database): included regardless of mtime
- [ ] --force-full-scan: all files included, mtime ignored
- [ ] last_sync_time is nil: all files included (fallback to full scan)
- [ ] Performance: 500 files filtered in <100ms

### Integration Points

- **Config System**: Gets last_sync_time from T-E06-F04-001
- **Sync Engine**: Receives filtered file list, processes only changed files
- **Database**: Queries to determine if file is new (not in tasks table)
- **Conflict Detection**: Provides changed file list to T-E06-F04-003

### Notes for Agent

- Use os.Stat() to get file.ModTime(), handle symlinks correctly
- Filesystem precision varies: Linux nanosecond, FAT 2-second - normalize comparison
- Batch database queries for "is new file" checks (single query for all files)
- Consider using filepath.Walk() with early termination for performance
- Log incremental stats: total files scanned, files changed, files skipped
- Future mtime warning should suggest checking system clock sync (NTP)
