---
task_key: T-E06-F04-003
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F04-incremental-sync-engine
created: 2025-12-17
assigned_agent: backend
dependencies: [T-E06-F04-002]
estimated_time: 10 hours
---

# Task: Conflict Detection and Resolution System

## Goal

Implement conflict detection that identifies when both database records and filesystem files have been modified since last sync, supports three resolution strategies (file-wins, db-wins, manual), generates detailed conflict reports, and ensures transactional safety during resolution.

## Success Criteria

- [ ] ConflictDetector identifies conflicts: file.mtime > last_sync AND db.updated_at > last_sync AND metadata differs
- [ ] Three resolution strategies implemented: file-wins, db-wins, manual
- [ ] Conflict report shows: file path, field, old value, new value, resolution applied
- [ ] Manual mode prompts user interactively for each conflict
- [ ] Resolution applied within transaction (atomic with full sync)
- [ ] Fields checked: title, description, status, priority, agent_type
- [ ] Unit tests cover all conflict scenarios and resolution strategies
- [ ] Integration test: concurrent file+DB changes detected and resolved

## Implementation Guidance

### Overview

Create `internal/sync/conflicts.go` that detects and resolves conflicts between filesystem and database changes. For each changed file, query the database record's updated_at timestamp, compare against last_sync_time, and if both modified, compare actual metadata fields to detect real conflicts (timestamp changes alone aren't conflicts if values match).

### Key Requirements

- **Conflict Detection**: Compare file.mtime, db.updated_at, and metadata - See [PRD - FR-016 through FR-022](../prd.md#conflict-detection)
- **Resolution Strategies**: file-wins (default), db-wins, manual - See [PRD - FR-023 through FR-029](../prd.md#conflict-resolution-strategies)
- **Detailed Reporting**: Log old/new values, resolution applied - See [PRD - FR-041](../prd.md#conflict-reporting)
- **Transaction Safety**: All resolutions in single transaction - See [PRD - FR-030 through FR-037](../prd.md#transaction-safety-and-atomicity)
- **Dry-Run Support**: Detect conflicts without applying resolution - See [PRD - FR-043 through FR-044](../prd.md#dry-run-mode)

### Files to Create/Modify

**New Files**:
- `internal/sync/conflicts.go` - ConflictDetector and ConflictResolver
- `internal/sync/conflicts_test.go` - Conflict detection and resolution tests
- `internal/sync/strategies.go` - Resolution strategy implementations

**Modified Files**:
- `internal/sync/engine.go` - Integrate conflict detection before task update
- `cmd/shark/commands/sync.go` - Add --strategy flag (file-wins, db-wins, manual)

### Validation Gates

- [ ] File modified, DB not modified: no conflict (file update applied)
- [ ] File not modified, DB modified: no conflict (skip file, DB current)
- [ ] Both modified, metadata identical: no conflict (timestamps updated only)
- [ ] Both modified, title differs: conflict detected
- [ ] file-wins strategy: DB updated with file metadata
- [ ] db-wins strategy: DB unchanged, file not modified
- [ ] manual strategy: prompts user, applies selected resolution
- [ ] Conflict report: shows field, old value, new value, resolution
- [ ] Transaction rollback: failed resolution leaves DB unchanged

### Integration Points

- **Incremental Filter**: Receives changed file list from T-E06-F04-002
- **Database**: Queries tasks.updated_at to detect DB-side changes
- **Sync Engine**: Applies resolution strategy before committing transaction
- **Reporting**: Provides conflict details to T-E06-F05 sync report

### Notes for Agent

- Conflict detection requires reading DB record for each changed file (batch query)
- Only check fields that exist in file frontmatter (don't check internal fields)
- Manual mode needs terminal I/O: use bufio.Scanner for user input
- Consider adding --detect-conflicts flag for conflict-only dry-run
- Resolution timestamp: record in conflict log for audit trail
- Clock skew can cause false positives: use Â±60 second buffer zone
