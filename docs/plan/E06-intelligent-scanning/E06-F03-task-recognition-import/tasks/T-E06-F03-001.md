---
task_key: T-E06-F03-001
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F03-task-recognition-import
created: 2025-12-17
assigned_agent: backend
dependencies: []
estimated_time: 8 hours
---

# Task: Pattern Registry and Configuration System

## Goal

Implement the configurable pattern registry that loads task file patterns from .sharkconfig.json, validates regex syntax and capture groups, and provides pattern matching interface for the sync engine.

## Success Criteria

- [ ] PatternRegistry struct created with pattern loading from config
- [ ] Regex compilation and caching implemented
- [ ] Named capture group validation (task_key, number, slug, epic_id, feature_id)
- [ ] Pattern precedence ordering (first-match-wins)
- [ ] Default patterns for standard, numbered, and PRP formats included
- [ ] Pattern validation errors provide actionable messages with examples
- [ ] Unit tests cover all pattern types and validation scenarios
- [ ] Integration with .sharkconfig.json working

## Implementation Guidance

### Overview

Create the `internal/patterns/registry.go` package that manages task file pattern matching. The registry loads patterns from configuration, validates them at startup, compiles regex patterns for performance, and exposes a matching interface that the sync engine will use. This provides the foundation for flexible task file recognition.

### Key Requirements

- **Pattern Configuration**: Read `patterns.task.file` array from .sharkconfig.json - See [PRD - REQ-F-001](../prd.md#req-f-001-configurable-task-pattern-definitions)
- **Regex Validation**: Validate pattern syntax and required capture groups at config load - See [PRD - REQ-F-003](../prd.md#req-f-003-pattern-validation-on-configuration-load)
- **Named Capture Groups**: Support task_key (full key), number (sequence), slug (descriptor), epic_id, feature_id extraction - See [PRD - REQ-F-002](../prd.md#req-f-002-named-capture-groups-for-component-extraction)
- **Pattern Precedence**: Evaluate patterns in array order, return first match - See [PRD - REQ-F-004](../prd.md#req-f-004-pattern-precedence-and-fallback)
- **Performance**: Compile regex once at load, cache for reuse - See [Architecture - Pattern Matching](../02-architecture.md#pattern-matching-engine)

### Files to Create/Modify

**New Files**:
- `internal/patterns/registry.go` - PatternRegistry implementation
- `internal/patterns/registry_test.go` - Comprehensive unit tests
- `internal/patterns/types.go` - Pattern struct, MatchResult struct
- `internal/config/patterns.go` - Pattern config schema additions

**Modified Files**:
- `.sharkconfig.json` - Add default task patterns configuration

### Validation Gates

- [ ] Run pattern registry unit tests: all pass
- [ ] Load .sharkconfig.json with valid patterns: success
- [ ] Load config with invalid regex: clear error with pattern name and issue
- [ ] Load config with missing capture groups: error lists missing groups
- [ ] Match standard task format (T-E##-F##-###.md): extracts task_key
- [ ] Match numbered format (##-name.md): extracts number
- [ ] Match PRP format (name.prp.md): extracts slug
- [ ] Pattern precedence: first pattern matches, remaining skipped

### Integration Points

- **Config System**: Extends .sharkconfig.json schema with patterns section
- **Sync Engine**: Provides MatchTaskFile() interface for E04-F07 sync
- **Metadata Extraction**: Passes MatchResult to Task Recognition (T-E06-F03-002)

### Notes for Agent

- Use Go's regexp package with named capture groups: `(?P<name>...)`
- Default patterns should match 90% of real-world task file naming
- Validation errors must be actionable (show example of correct pattern)
- Consider adding --skip-pattern-validation flag for advanced users
- Pattern compilation is one-time cost at startup, optimize for runtime speed
