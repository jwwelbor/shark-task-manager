---
task_key: T-E06-F03-004
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F03-task-recognition-import
created: 2025-12-17
assigned_agent: backend
dependencies: [T-E06-F03-002, T-E06-F03-003]
estimated_time: 10 hours
---

# Task: Integration with Sync Engine and Testing

## Goal

Integrate the pattern registry, metadata extractor, and key generator with the existing E04-F07 sync engine, replacing hardcoded pattern matching with the configurable system, and implement comprehensive test coverage including end-to-end sync tests with multiple task file formats.

## Success Criteria

- [ ] E04-F07 sync engine refactored to use PatternRegistry.MatchTaskFile()
- [ ] Metadata extraction integrated into task file parsing workflow
- [ ] Key generation triggered for PRP files during sync
- [ ] Transaction boundaries preserved (all imports atomic)
- [ ] Backward compatibility maintained (existing T-E##-F##-### files still work)
- [ ] Sync report shows pattern match statistics
- [ ] Integration tests cover: standard format, numbered format, PRP format, mixed formats
- [ ] Performance validated: 1000 task files sync in <5 seconds

## Implementation Guidance

### Overview

Modify the existing `internal/sync/engine.go` to use the new pattern matching infrastructure. Replace the hardcoded regex with PatternRegistry calls, integrate MetadataExtractor for all task files, conditionally invoke KeyGenerator for PRP files, and ensure the entire workflow maintains transaction safety and incremental sync compatibility.

### Key Requirements

- **Sync Engine Integration**: Replace scanTaskFiles() pattern matching with registry - See [PRD - REQ-F-013](../prd.md#req-f-013-sync-engine-integration)
- **Pattern Match Flow**: Try patterns in order, use first match, log unmatched files - See [PRD - REQ-F-004](../prd.md#req-f-004-pattern-precedence-and-fallback)
- **Transaction Safety**: All task imports in single transaction with rollback - See [PRD - REQ-NF-004](../prd.md#req-nf-004-pattern-matching-error-isolation)
- **Error Recovery**: File-level errors don't abort entire sync - See [PRD - REQ-NF-005](../prd.md#req-nf-005-file-level-error-recovery)
- **Performance**: Pattern matching <1ms per file, total sync <5s for 1000 files - See [PRD - REQ-NF-001](../prd.md#req-nf-001-pattern-matching-performance)

### Files to Create/Modify

**Modified Files**:
- `internal/sync/engine.go` - Integrate pattern registry and metadata extraction
- `internal/sync/scanner.go` - Call pattern matching and key generation
- `internal/sync/report.go` - Add pattern match statistics to sync report

**New Files**:
- `internal/sync/integration_test.go` - End-to-end sync tests with multiple formats
- `test/fixtures/task-files/` - Test fixtures for each pattern type

**Test Coverage**:
- Unit tests for each component (pattern, metadata, keygen) already in their packages
- Integration tests here focus on complete sync workflow

### Validation Gates

- [ ] Sync directory with 10 standard tasks (T-E##-F##-###.md): all imported
- [ ] Sync directory with 5 numbered tasks (##-name.md): all imported with generated keys
- [ ] Sync directory with 3 PRP files (name.prp.md): keys generated and written to frontmatter
- [ ] Sync mixed directory (standard + numbered + PRP): all imported correctly
- [ ] Sync with pattern mismatch file: logged as warning, other files imported
- [ ] Sync with invalid frontmatter: logged as error, file skipped, other files imported
- [ ] Sync with orphaned PRP file (missing feature): clear error, other files imported
- [ ] Performance test: 1000 task files sync in <5 seconds

### Integration Points

- **E04-F07 Sync Engine**: Core integration point, maintains existing contract
- **TaskRepository**: Uses existing Create() and Update() methods
- **FeatureRepository**: Validates epic/feature exist during key generation
- **Config System**: Loads patterns from .sharkconfig.json at sync start

### Notes for Agent

- Preserve existing sync engine transaction logic (don't break E04-F07 behavior)
- Update sync report to show: files scanned, matched (by pattern), skipped, generated keys
- Consider adding --verbose flag to log which pattern matched each file
- Ensure incremental sync (E06-F04) compatibility: pattern matching works with mtime filtering
- Test with actual E04 task files to ensure backward compatibility
- Pattern compilation happens once at sync start, not per-file (performance critical)
