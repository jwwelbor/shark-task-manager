---
task_key: T-E06-F03-002
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F03-task-recognition-import
created: 2025-12-17
assigned_agent: backend
dependencies: [T-E06-F03-001]
estimated_time: 8 hours
---

# Task: Multi-Source Metadata Extraction System

## Goal

Implement priority-based metadata extraction that pulls task title and description from frontmatter (priority 1), filename (priority 2), or H1 heading (priority 3), with intelligent fallbacks and clear warning messages when metadata is missing or incomplete.

## Success Criteria

- [ ] TaskMetadataExtractor implemented with 3-tier extraction priority
- [ ] Frontmatter parser handles YAML syntax errors gracefully
- [ ] Filename-based title extraction converts hyphens to Title Case
- [ ] H1 heading extraction removes common prefixes (Task:, PRP:, TODO:)
- [ ] Description extraction from markdown body (first paragraph, 500 char limit)
- [ ] Warning logs for missing title (use "Untitled Task" placeholder)
- [ ] Unit tests cover all extraction sources and edge cases
- [ ] Integration test with real task file examples from E04

## Implementation Guidance

### Overview

Create the `internal/parser/metadata.go` package that handles intelligent metadata extraction from task files. The extractor tries multiple sources in priority order, applying transformations appropriate to each source (filename cleanup, heading prefix removal), and always succeeds with reasonable defaults even when metadata is incomplete.

### Key Requirements

- **Title Extraction Priority**: Frontmatter title → Filename descriptor → H1 heading → "Untitled Task" - See [PRD - REQ-F-005](../prd.md#req-f-005-multi-source-task-title-extraction)
- **Description Extraction**: Frontmatter description → First paragraph after frontmatter/H1 → Empty string - See [PRD - REQ-F-006](../prd.md#req-f-006-multi-source-task-description-extraction)
- **Frontmatter Parsing**: Handle YAML frontmatter with optional fields and validation - See [PRD - REQ-F-007](../prd.md#req-f-007-frontmatter-field-parsing)
- **Filename Cleanup**: Remove task key/number prefix, convert hyphens to spaces, Title Case
- **Error Handling**: Log warnings for missing metadata, never skip file import - See [Backend Design - Error Recovery](../04-backend-design.md#error-recovery)

### Files to Create/Modify

**New Files**:
- `internal/parser/metadata.go` - MetadataExtractor implementation
- `internal/parser/metadata_test.go` - Comprehensive extraction tests
- `internal/parser/frontmatter.go` - YAML frontmatter parser
- `internal/parser/frontmatter_test.go` - Frontmatter parsing tests

**Modified Files**:
- `internal/sync/scanner.go` - Use MetadataExtractor for task parsing

### Validation Gates

- [ ] Extract title from frontmatter: exact match
- [ ] Extract title from filename "T-E04-F02-001-implement-caching.md": "Implement Caching"
- [ ] Extract title from H1 "# Task: Implement Caching": "Implement Caching" (prefix removed)
- [ ] Missing title from all sources: returns "Untitled Task" with warning logged
- [ ] Extract description from frontmatter: exact match
- [ ] Extract description from markdown body: first paragraph, max 500 chars
- [ ] Invalid YAML frontmatter: logs error, continues with fallback extraction
- [ ] Empty frontmatter fields: falls back to next extraction source

### Integration Points

- **Pattern Registry**: Receives MatchResult from T-E06-F03-001 with extracted components
- **Sync Engine**: Provides extracted metadata for TaskRepository.Create()
- **Task Key Generation**: Coordinates with T-E06-F03-003 for PRP files

### Notes for Agent

- Use gopkg.in/yaml.v3 for frontmatter parsing (robust YAML support)
- Filename extraction must handle both "T-E##-F##-###.md" and "###-name.md" formats
- H1 extraction should be case-insensitive for prefix matching
- First paragraph extraction stops at blank line or next heading
- Log warnings at appropriate level (missing title = WARN, missing description = DEBUG)
