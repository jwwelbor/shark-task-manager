---
task_key: T-E06-F03-003
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F03-task-recognition-import
created: 2025-12-17
assigned_agent: backend
dependencies: [T-E06-F03-001]
estimated_time: 10 hours
---

# Task: Automatic Task Key Generation for PRP Files

## Goal

Implement fuzzy task key generation for PRP files that lack explicit task keys by inferring epic/feature from file path, querying the database for the next sequence number, generating the key in T-E##-F##-### format, and writing it back to the file's frontmatter for future syncs.

## Success Criteria

- [ ] Path parser extracts epic and feature keys from directory structure
- [ ] Database query finds MAX(sequence) for feature to calculate next number
- [ ] Task key generator creates properly formatted keys (T-E##-F##-###)
- [ ] Frontmatter writer adds/updates task_key field atomically
- [ ] Transaction safety ensures no duplicate sequence numbers on concurrent runs
- [ ] Orphaned file detection (epic/feature not in database) with clear error
- [ ] Unit tests cover path parsing, key generation, and edge cases
- [ ] Integration test with real PRP file creates and imports successfully

## Implementation Guidance

### Overview

Create the `internal/keygen/generator.go` package that handles automatic task key generation for PRP files. The generator parses file paths to extract parent epic/feature, validates they exist in the database, queries for the next available sequence number using a transaction, generates the formatted key, and updates the file's frontmatter with the generated key.

### Key Requirements

- **Path-Based Inference**: Extract epic and feature from path structure `{docs_root}/{epic}/{feature}/tasks/{file}` - See [PRD - REQ-F-010](../prd.md#req-f-010-epic-and-feature-inference-from-path)
- **Sequence Generation**: Query database for MAX(task_sequence) WHERE feature_key=X, increment - See [PRD - REQ-F-008](../prd.md#req-f-008-automatic-task-key-generation-for-prp-files)
- **Frontmatter Update**: Write task_key to YAML frontmatter, preserve other fields - See [PRD - REQ-F-009](../prd.md#req-f-009-frontmatter-update-with-generated-keys)
- **Transaction Safety**: Use database transaction to prevent race conditions - See [PRD - REQ-NF-006](../prd.md#req-nf-006-transactional-task-key-generation)
- **Error Handling**: Detect orphaned files (missing epic/feature), fail with clear message - See [Backend Design - Validation](../04-backend-design.md#validation-system)

### Files to Create/Modify

**New Files**:
- `internal/keygen/generator.go` - TaskKeyGenerator implementation
- `internal/keygen/generator_test.go` - Key generation tests
- `internal/keygen/path_parser.go` - Path structure parser
- `internal/keygen/frontmatter_writer.go` - Atomic frontmatter updates

**Modified Files**:
- `internal/sync/scanner.go` - Call KeyGenerator for PRP files without task_key
- `internal/repository/task_repository.go` - Add GetMaxSequenceForFeature() query

### Validation Gates

- [ ] Parse path "docs/plan/E04-task-mgmt/E04-F02-cli/tasks/auth.prp.md": epic=E04, feature=E04-F02
- [ ] Query database for feature E04-F02: max sequence=5, next=6
- [ ] Generate key: "T-E04-F02-006"
- [ ] Write frontmatter: task_key field added, other fields preserved
- [ ] Concurrent key generation: no duplicate sequences (transaction isolation)
- [ ] Orphaned file (feature not in DB): error message with suggestion
- [ ] Invalid path structure: error with expected format explanation
- [ ] Frontmatter write failure: log warning, continue sync (in-memory key used)

### Integration Points

- **Pattern Registry**: Detects PRP pattern from T-E06-F03-001, signals key generation needed
- **Metadata Extractor**: Receives generated key from this component
- **Sync Engine**: Coordinates key generation before TaskRepository.Create()
- **Database**: FeatureRepository and TaskRepository for validation and sequence queries

### Notes for Agent

- Use database transactions with appropriate isolation level (READ COMMITTED minimum)
- Atomic file updates: write to temp file, then rename (POSIX atomic operation)
- Handle filesystem errors gracefully (permission denied, disk full, read-only)
- Consider batch key generation for multiple PRP files in same feature (single query)
- Generated key should be returned to caller AND written to file for future syncs
- Path validation must handle both relative and absolute paths robustly
