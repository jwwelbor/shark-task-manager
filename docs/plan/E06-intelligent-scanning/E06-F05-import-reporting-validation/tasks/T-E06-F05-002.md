---
task_key: T-E06-F05-002
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F05-import-reporting-validation
created: 2025-12-17
assigned_agent: backend
dependencies: []
estimated_time: 10 hours
---

# Task: Import Validation Command Implementation

## Goal

Implement the `shark validate` command that verifies database integrity after import by checking file path existence, epic/feature/task foreign key relationships, detecting orphaned records, identifying broken references, and generating detailed reports with corrective action suggestions.

## Success Criteria

- [ ] `shark validate` command implemented with validation checks
- [ ] File path existence check: all epics/features/tasks file_path point to real files
- [ ] Relationship integrity check: features reference existing epics, tasks reference existing features
- [ ] Orphaned record detection: identify records with missing parents
- [ ] Broken reference detection: invalid epic_key or feature_key values
- [ ] Validation summary report: entities validated, failures found by category
- [ ] Corrective action suggestions: specific fix for each failure
- [ ] Exit code: 0 for success, 1 for validation failures
- [ ] JSON output support for programmatic validation

## Implementation Guidance

### Overview

Create `cmd/shark/commands/validate.go` that implements the validation command. The validator queries database entities, checks file paths against filesystem, validates foreign key relationships, and generates a comprehensive report of issues found with specific suggestions for fixing each issue.

### Key Requirements

- **File Path Checks**: Validate all file_path fields point to existing files - See [PRD - FR-010](../prd.md#validation-command)
- **Relationship Integrity**: Validate epic_key and feature_key foreign keys - See [PRD - FR-011](../prd.md#validation-command)
- **Orphan Detection**: Find features without epics, tasks without features - See [PRD - FR-012](../prd.md#validation-command)
- **Validation Summary**: Report total checked, failures by type - See [PRD - FR-013](../prd.md#validation-command)
- **Corrective Actions**: Suggest re-scan, manual fix, or delete for each failure - See [PRD - FR-014](../prd.md#validation-command)

### Files to Create/Modify

**New Files**:
- `cmd/shark/commands/validate.go` - Validate command implementation
- `internal/validation/validator.go` - Validation logic and checks
- `internal/validation/validator_test.go` - Validation tests
- `internal/validation/report.go` - Validation report generation

**Test Coverage**:
- File path validation: detect missing files, suggest re-scan
- Relationship validation: detect orphaned features and tasks
- Broken reference detection: invalid keys, typos
- Validation report: correct counts, suggestions

### Validation Gates

- [ ] All file paths exist: validation succeeds, exit code 0
- [ ] 3 missing file paths: validation fails, reports 3 broken paths, exit code 1
- [ ] 2 orphaned features: validation reports missing epic_keys, suggests fixes
- [ ] 5 orphaned tasks: validation reports missing feature_keys
- [ ] Broken epic_key "E99": validation detects invalid key, suggests checking typo
- [ ] Validation summary: "Checked 150 entities, found 10 failures (3 paths, 7 orphans)"
- [ ] JSON output: valid JSON with structured failure objects
- [ ] Performance: validate 1000 entities in <1 second

### Integration Points

- **Database**: Queries epics, features, tasks tables for validation
- **Filesystem**: Checks file existence using os.Stat()
- **Reporting**: Uses validation report formatters similar to scan reports
- **CLI**: Standard command pattern like other shark commands

### Notes for Agent

- Use batch queries for efficiency (single query per entity type)
- File path validation: handle absolute and relative paths correctly
- Distinguish between "file moved" (suggest path update) and "file deleted" (suggest record deletion)
- Orphan detection: check epic_key/feature_key exist in respective tables
- Corrective suggestions should be specific: "shark epic delete E99" not "fix this"
- Consider adding --fix flag for auto-correction (future enhancement, not required)
