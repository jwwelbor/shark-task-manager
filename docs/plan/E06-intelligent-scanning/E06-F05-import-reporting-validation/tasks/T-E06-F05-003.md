---
task_key: T-E06-F05-003
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F05-import-reporting-validation
created: 2025-12-17
assigned_agent: backend
dependencies: [T-E06-F05-001]
estimated_time: 6 hours
---

# Task: Enhanced Sync Reporting and Dry-Run Mode

## Goal

Enhance the sync command to support dry-run mode that executes the complete scan workflow but skips database commit, generates identical reports as real runs, clearly indicates dry-run in output, and supports combining with other flags (--output=json, --verbose, --detect-conflicts).

## Success Criteria

- [ ] --dry-run flag implemented for sync command
- [ ] Full workflow executes: discovery, parsing, validation, conflict detection
- [ ] Database transaction rolled back (no changes persist)
- [ ] Report generation identical to real run (same warnings, errors, counts)
- [ ] Dry-run indicator: header and footer in CLI output, field in JSON
- [ ] Combinable flags: --dry-run --output=json works correctly
- [ ] Unit tests for dry-run transaction rollback
- [ ] Integration test: dry-run then real run produces same results

## Implementation Guidance

### Overview

Modify `internal/sync/engine.go` to support dry-run mode. The key is executing the entire workflow including transaction BEGIN...END but calling tx.Rollback() instead of tx.Commit() when --dry-run is active. Report generation happens before rollback, so it sees the "would-be" state.

### Key Requirements

- **Full Workflow Execution**: Discovery, parsing, validation all execute - See [PRD - FR-019](../prd.md#dry-run-mode)
- **Transaction Rollback**: Database changes not persisted - See [PRD - FR-020](../prd.md#dry-run-mode)
- **Identical Reports**: Same warnings, errors, counts as real run - See [PRD - FR-021](../prd.md#dry-run-mode)
- **Dry-Run Indicator**: Clear indication in output - See [PRD - FR-022](../prd.md#dry-run-mode)
- **Combinable Flags**: Works with --output=json, --verbose, --detect-conflicts - See [PRD - FR-023](../prd.md#dry-run-mode)

### Files to Create/Modify

**Modified Files**:
- `internal/sync/engine.go` - Add dry-run mode support
- `cmd/shark/commands/sync.go` - Add --dry-run flag
- `internal/reporting/formatters.go` - Add dry-run indicator to output

**Test Coverage**:
- Dry-run executes full workflow without DB changes
- Dry-run report matches real run report
- Dry-run + JSON output works correctly
- Dry-run transaction rollback verified

### Validation Gates

- [ ] --dry-run executes full scan workflow
- [ ] --dry-run generates complete report with all warnings/errors
- [ ] --dry-run rollback: no database changes persist
- [ ] --dry-run indicator: "DRY RUN MODE: No database changes made" in output
- [ ] --dry-run --output=json: JSON includes "dry_run": true field
- [ ] --dry-run --detect-conflicts: detects conflicts without resolving
- [ ] Run dry-run then real sync: real sync imports all files successfully
- [ ] Dry-run performance: same as real run (rollback is fast)

### Integration Points

- **Sync Engine**: Core integration for transaction handling
- **Reporting**: Dry-run indicator in both CLI and JSON formats
- **Config System**: Does NOT update last_sync_time in dry-run mode
- **Transaction System**: Uses rollback instead of commit

### Notes for Agent

- Generate report before rollback (report needs transaction state)
- Dry-run mode doesn't update last_sync_time (next sync processes same files)
- Transaction isolation: rollback must be complete (not just uncommitted)
- CLI output: print dry-run indicator at start and end (clear framing)
- JSON output: add "dry_run": true field at top level for easy checking
- Dry-run is valuable for previewing complex imports before committing
