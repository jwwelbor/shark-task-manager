---
task_key: T-E06-F02-004
status: todo
feature: /docs/plan/E06-intelligent-scanning/E06-F02-epic-feature-discovery
created: 2025-12-17
assigned_agent: backend
dependencies: []
estimated_time: 8 hours
---

# Task: Conflict Detection and Resolution

---

## Goal

Implement conflict detection logic that identifies discrepancies between epic-index.md and folder structure, and resolution strategies that apply configured precedence rules to resolve conflicts.

## What to Build

Create conflict detection and resolution components that compare index-based and folder-based discoveries and apply resolution strategies.

**Core Components**:

1. **ConflictDetector** (`internal/discovery/conflict_detector.go`):
   - Compare IndexEpics with FolderEpics (match by epic key)
   - Compare IndexFeatures with FolderFeatures (match by feature key)
   - Detect epics in index but not in folders (broken references)
   - Detect epics in folders but not in index (undocumented)
   - Detect features with mismatched parent epics
   - Generate detailed Conflict records for each issue

2. **ConflictResolver** (`internal/discovery/conflict_resolver.go`):
   - Apply index-precedence strategy (index wins, ignore folder-only items)
   - Apply folder-precedence strategy (folder wins, ignore index-only items)
   - Apply merge strategy (combine both sources, index metadata preferred)
   - Generate resolution action logs
   - Build final DiscoveredEpic/DiscoveredFeature lists

3. **Conflict Reporting**:
   - Structured Conflict type with: type, key, path, resolution, suggestion
   - Detailed conflict descriptions for user understanding
   - Actionable suggestions for resolving conflicts

## Why This Matters

Real-world projects often have discrepancies between documented structure (index) and actual folders (work-in-progress, obsolete folders). Intelligent conflict resolution enables smooth migration without forcing perfect consistency.

## Success Criteria

- [ ] ConflictDetector detects all conflict types from PRD FR-008
- [ ] Correctly identifies epics in index but not folders
- [ ] Correctly identifies epics in folders but not index
- [ ] Detects feature parent epic mismatches
- [ ] ConflictResolver implements all three strategies
- [ ] Index-precedence: skips folder-only items
- [ ] Folder-precedence: skips index-only items
- [ ] Merge: combines both sources intelligently
- [ ] Generates actionable conflict reports
- [ ] Unit tests cover all conflict scenarios
- [ ] Resolution logs are clear and detailed

## Implementation Guidance

**Reference Design Documents**:
- PRD FR-008: Index vs. Folder Conflict Detection
- PRD FR-009: Conflict Resolution Strategies
- PRD FR-010: Conflict Reporting
- Backend Design (`04-backend-design.md`): ConflictDetector and ConflictResolver

**Key Algorithms**:
- Build maps of IndexEpics and FolderEpics by key for fast lookup
- Iterate through both maps to find items in one but not the other
- For matches, compare metadata (parent epic, file paths)
- Apply strategy-specific logic to build final discovered items list

**Files to Create**:
- `internal/discovery/conflict_detector.go`
- `internal/discovery/conflict_resolver.go`
- `internal/discovery/conflict_detector_test.go`
- `internal/discovery/conflict_resolver_test.go`

## Validation Requirements

- Test scenarios:
  - Epic in index, not in folder (broken reference)
  - Epic in folder, not in index (undocumented)
  - Feature in wrong epic folder (parent mismatch)
  - Mixed conflicts across epics/features
- Verify each strategy produces correct final list
- Check conflict report clarity and actionability
- Validate suggestion quality

## Dependencies

**Depends On**: T-E06-F02-001 (Core types), T-E06-F02-002 (Index parser), T-E06-F02-003 (Folder scanner)

**Blocks**: T-E06-F02-005 (Discovery orchestrator)

## Estimated Effort

5-6 hours

## Agent Type

backend

## Priority

High (P2)

## Notes for Implementation

- Conflict detection should be pure logic (no side effects)
- Resolution should be deterministic (same inputs â†’ same outputs)
- Log resolution decisions for transparency
- Consider performance: use maps for O(1) lookups
- Ensure merge strategy handles edge cases (both sources have different metadata)
- Default to index metadata in merge strategy (index is "source of truth")
