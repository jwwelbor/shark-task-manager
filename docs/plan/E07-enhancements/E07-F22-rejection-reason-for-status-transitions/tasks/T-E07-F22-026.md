---
key: T-E07-F22-026
title: Add rejection reason validation to UpdateStatus
epic: E07
feature: E07-F22
agent: backend
status: ready_for_code_review
priority: 3
dependencies: []
created_at: 2026-01-16T20:10:51Z
---

# Task: Add rejection reason validation to UpdateStatus

## Goal

Add validation to the `UpdateStatus` repository method to enforce that rejection reasons are provided when a task undergoes a backward transition (moving back to earlier phases in the workflow), enabling the feature requirement to require reasons for task rejections.

## Success Criteria

- [x] Backward transitions require a non-empty reason (rejection reason)
- [x] Forward transitions do not require a reason
- [x] Empty or whitespace-only reasons are rejected for backward transitions
- [x] --force flag bypasses reason requirement
- [x] Error messages clearly indicate the reason requirement
- [x] All comprehensive tests passing

## Implementation Guidance

### Overview

When a task is rejected and sent backward in the workflow (e.g., from `ready_for_code_review` to `in_progress`), we need to capture WHY it was rejected. The UpdateStatus method in TaskRepository needs to validate:

1. Detect if the transition is backward (using IsBackwardTransition from workflow config)
2. For backward transitions, require a non-empty reason in the `notes` parameter
3. Allow the --force flag to bypass this requirement
4. Forward transitions should not require a reason

### Key Implementation Details

**Backward Transition Detection**:
- Use `workflow.IsBackwardTransition(currentStatus, newStatus)` to determine direction
- Workflow config contains status phases (planning, development, review, qa, approval, done)
- Lower phase order = earlier in workflow; higher order = later in workflow

**Validation Logic**:
```go
if isBackward {
    // Backward transitions require a non-empty reason
    if notes == nil || strings.TrimSpace(*notes) == "" {
        return fmt.Errorf("rejection reason required for backward transition from %s to %s: use --reason flag or use --force to bypass", currentStatus, newStatus)
    }
}
```

**Where to Add**:
- Location: `internal/repository/task_repository.go`, method `UpdateStatusForced`
- Position: After workflow transition validation, before database update
- Only applies when `force=false` (forced transitions bypass all validation)

### Files Modified

- `internal/repository/task_repository.go` - Add rejection reason validation to UpdateStatusForced

### Integration Points

- Validates workflow transitions (existing functionality)
- Uses WorkflowConfig.IsBackwardTransition to determine transition direction
- Maintains backward compatibility (workflow-aware only if config exists)
- Force flag already exists and bypasses all validation

## Test Results

All tests passing:
- ✅ Backward transition without reason fails with error message
- ✅ Backward transition with reason succeeds
- ✅ Backward transition with force flag bypasses reason requirement
- ✅ Forward transition without reason succeeds
- ✅ Empty reason string fails for backward transition
- ✅ Whitespace-only reason fails for backward transition

## Implementation Notes

1. **Workflow Awareness**: The validation only applies if a WorkflowConfig is present on the repository
2. **Force Bypass**: When `force=true`, reason validation is skipped (as intended)
3. **Error Messages**: Clear, actionable error messages guide users to provide reasons
4. **Backward Compatibility**: Existing code paths without workflow config are unaffected

## Related Feature Requirements

- [Feature PRD - REQ-F-002: Rejection Reason Requirement](../feature.md#requirements)
- [Feature PRD - Story 1: Code Review Rejection](../feature.md#user-stories)

