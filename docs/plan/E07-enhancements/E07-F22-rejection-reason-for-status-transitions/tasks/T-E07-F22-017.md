---
key: T-E07-F22-017
title: Add reason flag validation to task update command
epic: E07
feature: E07-F22
agent: backend
status: todo
priority: 3
dependencies: [T-E07-F22-016]
created_at: 2026-01-16T06:36:56Z
estimated_time: 4 hours
---

# Task: Add reason flag validation to task update command

## Goal

Enhance the task update command to require `--reason` flag for backward status transitions, providing clear error messages when missing, while allowing `--force` flag to bypass the requirement.

## Success Criteria

- [ ] `--reason` flag added to task update command
- [ ] `--force` flag added to bypass reason requirement
- [ ] Backward transitions without reason return clear error
- [ ] Forward transitions allow optional reason (no requirement)
- [ ] Error messages include helpful examples
- [ ] CLI tests validate reason enforcement

## Implementation Guidance

### Overview

When a task is sent backward in workflow (e.g., from review back to development), the CLI must require the user to provide a rejection reason. This creates accountability and provides developers with context about what needs fixing.

### Key Requirements

1. **CLI Flag Addition** - See [Feature PRD - CLI Syntax](../feature.md#cli-syntax)
   - Add `--reason` string flag to task update command
   - Add `--force` boolean flag to bypass validation
   - Flags work with existing --status flag

2. **Validation Logic** - See [Feature PRD - REQ-F-002](../feature.md#requirements)
   - Call isBackwardTransition() from T-E07-F22-016
   - If backward AND no reason AND no force: return error
   - Forward transitions: reason is optional
   - Same-phase transitions: reason is optional

3. **Error Messages** - See [Feature PRD - Error Story 1](../feature.md#edge-case--error-stories)
   - Explain reason is required for backward transitions
   - Show example command with --reason flag
   - Mention --force as bypass option
   - Use user-friendly language

### Files to Create/Modify

**CLI Command**:
- `internal/cli/commands/task_update.go` - Add flags and validation logic
- May need to create this file if it doesn't exist (check for existing task status commands)

**CLI Tests**:
- `internal/cli/commands/task_update_test.go` - Unit tests with mocks

### Integration Points

- **isBackwardTransition()** (T-E07-F22-016) - Detects if transition is backward
- **Task Repository** (existing) - Will be enhanced in T-E07-F22-018
- **Error Handling** (existing) - Use consistent error patterns

## Validation Gates

**CLI Functionality**:
- Backward transition + no reason + no force = error
- Backward transition + reason = success
- Backward transition + force = success (no reason needed)
- Forward transition + no reason = success

**Error Messages**:
- Clear explanation of why command failed
- Example showing correct syntax
- Mention of --force flag as alternative

**Unit Tests**:
- Test all validation scenarios
- Test with mocked repository (NO real database)
- Test error message formatting

## Context & Resources

**Feature Requirements**:
- [Feature PRD - CLI Syntax](../feature.md#cli-syntax)
- [Feature PRD - REQ-F-002: Rejection Reason Requirement](../feature.md#requirements)
- [Feature PRD - Error Story 1](../feature.md#edge-case--error-stories)

**Existing Patterns**:
- Review existing task commands in `internal/cli/commands/`
- Follow flag patterns from task start/complete commands
- Use error formatting from other CLI commands

## Notes for Agent

- **Command Location**: Check if task update command exists; may need to extend task start/complete/approve commands
- **CLI Testing**: Use MOCKED repositories (rule: never use real database in CLI tests)
- **Error Format**: Follow existing CLI error patterns for consistency
- **Validation Placement**: Validate BEFORE calling repository methods
- **User Experience**: Error messages should be helpful, not punitive
