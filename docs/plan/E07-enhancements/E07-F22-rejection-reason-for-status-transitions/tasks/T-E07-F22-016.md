---
agent: backend
created_at: 2026-01-16T06:36:46Z
epic: E07
estimated_time: 3 hours
feature: E07-F22
key: T-E07-F22-016
priority: 2
status: todo
task_key: T-E07-F22-003
title: Implement backward transition detection logic
---

# Task: Implement backward transition detection logic

## Goal

Create a utility function that detects backward status transitions by comparing workflow phases, enabling the system to require rejection reasons when tasks move backward in the development lifecycle.

## Success Criteria

- [ ] `isBackwardTransition()` function implemented with clear logic
- [ ] Function correctly identifies backward transitions using phase order
- [ ] Handles special statuses (blocked, on_hold, cancelled) correctly
- [ ] Unit tests cover all phase transitions (forward, backward, same-phase)
- [ ] Function is reusable across all status transition operations

## Implementation Guidance

### Overview

The feature needs to automatically detect when a status change represents a "rejection" (moving backward in workflow) versus normal progression. This is done by comparing the workflow phases of the current and new statuses.

### Key Requirements

1. **Phase Order Mapping** - See [Feature PRD - Backward Transition Detection](../feature.md#backward-transition-detection)
   - Define phase hierarchy: planning < development < review < qa < approval < done
   - Special phase "any" (0) for statuses like blocked, on_hold
   - Use numeric ordering for simple comparison

2. **Backward Detection Logic** - See [Feature PRD - REQ-F-001](../feature.md#requirements)
   - Compare phase order: new phase < current phase = backward
   - Ignore transitions from/to "any" phase (these aren't rejections)
   - Same-phase transitions are NOT backward (e.g., in_development → ready_for_code_review)

3. **Workflow Config Integration**
   - Read phase metadata from `.sharkconfig.json` status_metadata
   - Support custom workflows (not hardcoded to specific statuses)
   - Handle missing phase metadata gracefully

### Files to Create/Modify

**New Utility**:
- `internal/validation/workflow.go` - Create isBackwardTransition() function
- `internal/validation/workflow_test.go` - Unit tests for all scenarios

**Dependencies**:
- `internal/config/config.go` - Read workflow configuration (already exists)
- `.sharkconfig.json` - Workflow phase definitions (already exists)

### Integration Points

- **Task Update Command** (T-E07-F22-017) - Will call this function to validate transitions
- **Workflow Config** (existing) - Reads phase definitions from status_metadata
- **Status Transition Logic** (existing) - Called before any status change

## Validation Gates

**Logic Correctness**:
- Returns true for backward transitions (review → development)
- Returns false for forward transitions (development → review)
- Returns false for same-phase transitions
- Returns false for special status transitions (blocked, cancelled)

**Unit Tests**:
- Test all phase combinations (7 phases × 7 phases = 49 cases)
- Test special statuses correctly handled
- Test missing phase metadata handled gracefully
- Test custom workflow configurations

**Integration**:
- Works with all status transitions in shark
- No performance impact (simple phase comparison)

## Context & Resources

**Feature Requirements**:
- [Feature PRD - Backward Transition Detection](../feature.md#backward-transition-detection)
- [Feature PRD - REQ-F-001: Backward Transition Detection](../feature.md#requirements)
- [Feature PRD - Workflow Config Example](../feature.md#workflow-configuration)

**Existing Patterns**:
- Review existing workflow config loading in `internal/config/config.go`
- Check how status metadata is accessed in feature get command
- Follow validation pattern in `internal/validation/` directory

## Notes for Agent

- **Simple Logic**: This is pure logic, no database or external dependencies
- **Phase Hierarchy**: planning(1) < development(2) < review(3) < qa(4) < approval(5) < done(6), special="any"(0)
- **Not Rejections**: blocked/unblock, same-phase moves, cancelled/reopen
- **Testing**: Table-driven tests work well here - test matrix of all phase pairs
- **Reusability**: Design for reuse - any status transition can call this function
