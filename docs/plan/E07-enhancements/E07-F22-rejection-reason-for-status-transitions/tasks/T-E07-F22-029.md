
---
key: T-E07-F22-029
title: Add config option require_rejection_reason
epic: E07
feature: E07-F22
agent: backend
status: todo
priority: 6
dependencies: []
created_at: 2026-01-16T20:10:50Z
---

# Task: Add config option require_rejection_reason

## Goal

Add `require_rejection_reason` boolean config option to `.sharkconfig.json`, allowing teams to enable/disable rejection reason requirements based on their workflow needs.

## Implementation Details

### Update Config Struct

File: `internal/config/config.go`

```go
type Config struct {
    Database               DatabaseConfig              `json:"database"`
    StatusFlow             map[string][]string         `json:"status_flow"`
    StatusMetadata         map[string]StatusMetadata   `json:"status_metadata"`
    SpecialStatuses        map[string][]string         `json:"special_statuses"`
    RequireRejectionReason bool                        `json:"require_rejection_reason"` // NEW FIELD
}
```

### Default Configuration

File: `internal/config/defaults.go`

Set sensible default (false for backward compatibility):

```go
func DefaultConfig() *Config {
    return &Config{
        RequireRejectionReason: false, // Default: optional (backward compatible)
        StatusFlow: map[string][]string{
            // ... existing status flow
        },
        StatusMetadata: map[string]StatusMetadata{
            // ... existing status metadata
        },
    }
}
```

### Config Validation

File: `internal/config/validation.go`

```go
func (c *Config) Validate() error {
    // Existing validation...

    // Validate require_rejection_reason is a boolean (already enforced by JSON unmarshaling)
    // No additional validation needed for boolean flag

    // If require_rejection_reason is enabled, ensure progress_weight exists
    if c.RequireRejectionReason {
        for status, meta := range c.StatusMetadata {
            if meta.ProgressWeight == 0 {
                return fmt.Errorf(
                    "require_rejection_reason enabled but status '%s' has no progress_weight defined",
                    status,
                )
            }
        }
    }

    return nil
}
```

## Configuration Examples

### Example 1: Rejection Reason Required (Recommended)

File: `.sharkconfig.json`

```json
{
  "require_rejection_reason": true,
  "status_flow": {
    "draft": ["ready_for_refinement", "cancelled"],
    "in_development": ["ready_for_code_review", "blocked"],
    "ready_for_code_review": ["in_code_review", "in_development"],
    "completed": []
  },
  "status_metadata": {
    "draft": {
      "color": "gray",
      "phase": "planning",
      "progress_weight": 0.10
    },
    "in_development": {
      "color": "yellow",
      "phase": "development",
      "progress_weight": 0.50
    },
    "ready_for_code_review": {
      "color": "magenta",
      "phase": "review",
      "progress_weight": 0.85
    },
    "completed": {
      "color": "green",
      "phase": "done",
      "progress_weight": 1.0
    }
  }
}
```

**Behavior:** Backward transitions REQUIRE rejection reason. Forward transitions do not.

### Example 2: Rejection Reason Optional (Default)

File: `.sharkconfig.json`

```json
{
  "require_rejection_reason": false,
  "status_flow": {
    // ... status flow
  },
  "status_metadata": {
    // ... status metadata with progress_weight
  }
}
```

**Behavior:** Rejection reason is optional for all transitions. Users can still provide it voluntarily.

### Example 3: Minimal Config (Uses Default)

If `require_rejection_reason` is omitted, default to `false`:

File: `.sharkconfig.json`

```json
{
  "status_flow": {
    // ... status flow
  }
}
```

**Behavior:** Same as `require_rejection_reason: false`.

## Implementation Steps

1. Add `RequireRejectionReason bool` field to `Config` struct
2. Set default value to `false` in `DefaultConfig()`
3. Add validation to ensure `progress_weight` exists when feature enabled
4. Update config loading to parse boolean field
5. Test config parsing with valid/invalid values
6. Document config option in README

## Acceptance Criteria

- [ ] `RequireRejectionReason` field exists in `Config` struct
- [ ] Field is optional (defaults to `false`)
- [ ] Field parsed correctly from `.sharkconfig.json`
- [ ] Validation ensures `progress_weight` exists when enabled
- [ ] Invalid JSON values (non-boolean) rejected with clear error
- [ ] Config hot-reload works (no restart needed)

## Testing Requirements

### Unit Tests

File: `internal/config/config_test.go`

```go
func TestConfig_RequireRejectionReason_DefaultValue(t *testing.T) {
    cfg := DefaultConfig()

    if cfg.RequireRejectionReason != false {
        t.Errorf("expected default RequireRejectionReason to be false, got: %v", cfg.RequireRejectionReason)
    }
}

func TestConfig_RequireRejectionReason_Parsing(t *testing.T) {
    tests := []struct {
        name    string
        json    string
        want    bool
        wantErr bool
    }{
        {
            name:    "explicitly true",
            json:    `{"require_rejection_reason": true}`,
            want:    true,
            wantErr: false,
        },
        {
            name:    "explicitly false",
            json:    `{"require_rejection_reason": false}`,
            want:    false,
            wantErr: false,
        },
        {
            name:    "omitted (default)",
            json:    `{}`,
            want:    false, // Default value
            wantErr: false,
        },
        {
            name:    "invalid type (string)",
            json:    `{"require_rejection_reason": "yes"}`,
            want:    false,
            wantErr: true,
        },
        {
            name:    "invalid type (number)",
            json:    `{"require_rejection_reason": 1}`,
            want:    false,
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            var cfg Config
            err := json.Unmarshal([]byte(tt.json), &cfg)

            if (err != nil) != tt.wantErr {
                t.Errorf("Unmarshal() error = %v, wantErr %v", err, tt.wantErr)
                return
            }

            if !tt.wantErr && cfg.RequireRejectionReason != tt.want {
                t.Errorf("RequireRejectionReason = %v, want %v", cfg.RequireRejectionReason, tt.want)
            }
        })
    }
}

func TestConfig_Validate_RequiresProgressWeight(t *testing.T) {
    // Config with require_rejection_reason enabled but missing progress_weight
    cfg := &Config{
        RequireRejectionReason: true,
        StatusMetadata: map[string]StatusMetadata{
            "draft": {
                ProgressWeight: 0.10,
            },
            "in_development": {
                // Missing progress_weight
            },
        },
    }

    err := cfg.Validate()
    if err == nil {
        t.Fatal("expected error when progress_weight missing but require_rejection_reason enabled")
    }

    if !strings.Contains(err.Error(), "progress_weight") {
        t.Errorf("expected error to mention progress_weight, got: %v", err)
    }
}

func TestConfig_Validate_ProgressWeightOptional_WhenDisabled(t *testing.T) {
    // Config with require_rejection_reason disabled - progress_weight optional
    cfg := &Config{
        RequireRejectionReason: false,
        StatusMetadata: map[string]StatusMetadata{
            "draft": {
                // progress_weight optional when feature disabled
            },
        },
    }

    err := cfg.Validate()
    if err != nil {
        t.Errorf("Validate() should not require progress_weight when feature disabled, got: %v", err)
    }
}
```

### Integration Tests

File: `internal/config/config_integration_test.go`

```go
func TestConfig_LoadFromFile_RequireRejectionReason(t *testing.T) {
    // Create temp config file
    tmpfile, err := os.CreateTemp("", "sharkconfig-*.json")
    if err != nil {
        t.Fatal(err)
    }
    defer os.Remove(tmpfile.Name())

    // Write config with require_rejection_reason
    configJSON := `{
        "require_rejection_reason": true,
        "status_metadata": {
            "draft": {"progress_weight": 0.10},
            "in_development": {"progress_weight": 0.50}
        }
    }`

    if _, err := tmpfile.Write([]byte(configJSON)); err != nil {
        t.Fatal(err)
    }
    tmpfile.Close()

    // Load config
    cfg, err := LoadConfig(tmpfile.Name())
    if err != nil {
        t.Fatalf("LoadConfig() failed: %v", err)
    }

    // Verify
    if !cfg.RequireRejectionReason {
        t.Error("expected RequireRejectionReason to be true")
    }
}
```

## Documentation Updates

### README.md Section

Add section documenting the new config option:

```markdown
## Configuration

### Rejection Reason Requirement

Control whether rejection reasons are required for backward transitions:

```json
{
  "require_rejection_reason": true
}
```

**When enabled:**
- Backward transitions (decreasing progress_weight) REQUIRE `--rejection-reason` flag
- Forward transitions do not require rejection reason
- Automatically detects backward transitions using `progress_weight`

**When disabled (default):**
- Rejection reason is optional for all transitions
- Users can still provide rejection reason voluntarily
- Backward compatible with existing workflows

**Example:**

```bash
# With require_rejection_reason: true
shark task update E07-F22-001 --status=in_development \
  --rejection-reason="Failed code review"

# With require_rejection_reason: false
shark task update E07-F22-001 --status=in_development
```

## Notes

- **Default: false** for backward compatibility
- **Validation:** Ensures `progress_weight` defined when feature enabled
- **Hot-Reload:** Config changes take effect immediately (no restart)
- **JSON Strict:** Only boolean values accepted (true/false)
