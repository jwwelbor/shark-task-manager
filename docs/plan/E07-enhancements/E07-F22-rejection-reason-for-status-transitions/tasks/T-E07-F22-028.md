---
agent: backend
created_at: 2026-01-16T20:10:50Z
dependencies:
    - T-E07-F22-027
epic: E07
feature: E07-F22
key: T-E07-F22-028
priority: 5
status: todo
task_key: T-E07-F22-015
title: Add rejection reason to task history display
---


# Task: Add rejection reason to task history display

## Goal

Update CLI commands (`shark task get`, `shark task history`) to display rejection reasons from task_history entries, making rejection feedback immediately visible to developers.

## Implementation Details

### Update task get Command

File: `internal/cli/commands/task_get.go`

Add rejection reason display to task details:

```go
func runTaskGet(cmd *cobra.Command, args []string) error {
    ctx := cmd.Context()
    taskKey := args[0]

    repoDb, err := cli.GetDB(ctx)
    if err != nil {
        return err
    }

    taskRepo := repository.NewTaskRepository(repoDb)
    task, err := taskRepo.GetByKey(ctx, taskKey)
    if err != nil {
        return err
    }

    // Get task history
    historyRepo := repository.NewTaskHistoryRepository(repoDb)
    history, err := historyRepo.GetByTaskID(ctx, task.ID)
    if err != nil {
        return fmt.Errorf("failed to get task history: %w", err)
    }

    // JSON output
    if cli.GlobalConfig.JSON {
        output := map[string]interface{}{
            "task":    task,
            "history": history,
        }
        return cli.OutputJSON(output)
    }

    // Human-readable output
    printTaskDetails(task)

    // Show most recent rejection (if any)
    if mostRecentRejection := findMostRecentRejection(history); mostRecentRejection != nil {
        fmt.Println()
        cli.Warning("Last Rejection")
        fmt.Printf("  Reason: %s\n", mostRecentRejection.RejectionReason)
        fmt.Printf("  Rejected at: %s\n", mostRecentRejection.ChangedAt.Format("2006-01-02 15:04:05"))
        fmt.Printf("  Rejected from: %s\n", mostRecentRejection.FromStatus)
        if mostRecentRejection.Agent != "" {
            fmt.Printf("  Rejected by: %s\n", mostRecentRejection.Agent)
        }
    }

    return nil
}

// findMostRecentRejection returns the most recent history entry with a rejection reason
func findMostRecentRejection(history []*models.TaskHistory) *models.TaskHistory {
    for _, h := range history {
        if h.RejectionReason != "" {
            return h // History is ordered DESC by changed_at
        }
    }
    return nil
}
```

### Add task history Command

File: `internal/cli/commands/task_history.go`

```go
package commands

import (
    "fmt"
    "strings"

    "github.com/spf13/cobra"

    "shark-task-manager/internal/cli"
    "shark-task-manager/internal/repository"
)

var taskHistoryCmd = &cobra.Command{
    Use:   "history <task-key>",
    Short: "Show task status history",
    Long: `Display the complete status transition history for a task.

Shows all status changes, rejection reasons, notes, and timestamps.`,
    Args:  cobra.ExactArgs(1),
    RunE:  runTaskHistory,
}

func init() {
    taskCmd.AddCommand(taskHistoryCmd)
}

func runTaskHistory(cmd *cobra.Command, args []string) error {
    ctx := cmd.Context()
    taskKey := args[0]

    repoDb, err := cli.GetDB(ctx)
    if err != nil {
        return err
    }

    // Get task
    taskRepo := repository.NewTaskRepository(repoDb)
    task, err := taskRepo.GetByKey(ctx, taskKey)
    if err != nil {
        return err
    }

    // Get history
    historyRepo := repository.NewTaskHistoryRepository(repoDb)
    history, err := historyRepo.GetByTaskID(ctx, task.ID)
    if err != nil {
        return err
    }

    // JSON output
    if cli.GlobalConfig.JSON {
        return cli.OutputJSON(history)
    }

    // Human-readable output
    fmt.Printf("Task History: %s - %s\n", task.Key, task.Title)
    fmt.Println(strings.Repeat("=", 60))

    if len(history) == 0 {
        cli.Info("No history entries found")
        return nil
    }

    for i, h := range history {
        fmt.Printf("\n%d. %s → %s\n", len(history)-i, h.FromStatus, h.ToStatus)
        fmt.Printf("   Changed at: %s\n", h.ChangedAt.Format("2006-01-02 15:04:05"))

        if h.Agent != "" {
            fmt.Printf("   Agent: %s\n", h.Agent)
        }

        if h.RejectionReason != "" {
            cli.Warning(fmt.Sprintf("   Rejection: %s", h.RejectionReason))
        }

        if h.Notes != "" {
            fmt.Printf("   Notes: %s\n", h.Notes)
        }
    }

    return nil
}
```

## CLI Output Examples

### Example 1: task get with Rejection

```bash
$ shark task get E07-F22-001

Task: E07-F22-001
Title: Implement JWT validation
Status: in_development (50% complete)
Priority: 5
Agent: backend
Created: 2026-01-15 10:00:00
Updated: 2026-01-16 14:30:00

⚠ Last Rejection
  Reason: Missing error handling for edge cases. Added TODO comments in code.
  Rejected at: 2026-01-16 14:30:00
  Rejected from: ready_for_code_review
  Rejected by: reviewer-agent-001
```

### Example 2: task history

```bash
$ shark task history E07-F22-001

Task History: E07-F22-001 - Implement JWT validation
============================================================

3. ready_for_code_review → in_development
   Changed at: 2026-01-16 14:30:00
   Agent: reviewer-agent-001
   ⚠ Rejection: Missing error handling for edge cases

2. in_development → ready_for_code_review
   Changed at: 2026-01-16 12:00:00
   Agent: developer-agent-001

1. todo → in_development
   Changed at: 2026-01-15 10:00:00
   Agent: developer-agent-001
```

### Example 3: JSON Output

```bash
$ shark task get E07-F22-001 --json

{
  "task": {
    "id": 123,
    "key": "E07-F22-001",
    "title": "Implement JWT validation",
    "status": "in_development",
    ...
  },
  "history": [
    {
      "id": 3,
      "task_id": 123,
      "from_status": "ready_for_code_review",
      "to_status": "in_development",
      "rejection_reason": "Missing error handling for edge cases",
      "agent": "reviewer-agent-001",
      "changed_at": "2026-01-16T14:30:00Z"
    },
    {
      "id": 2,
      "task_id": 123,
      "from_status": "in_development",
      "to_status": "ready_for_code_review",
      "agent": "developer-agent-001",
      "changed_at": "2026-01-16T12:00:00Z"
    }
  ]
}
```

## Implementation Steps

1. Update `task get` command to fetch and display last rejection
2. Create `task history` command to show full history
3. Implement `findMostRecentRejection()` helper function
4. Add rejection highlighting (warning color) in output
5. Add timestamp formatting for rejection display
6. Ensure JSON output includes all rejection data
7. Test with tasks that have/don't have rejections

## Acceptance Criteria

- [ ] `shark task get` shows "Last Rejection" section if rejection exists
- [ ] Last rejection includes reason, timestamp, from_status, agent
- [ ] `shark task history` command displays all history entries
- [ ] History entries show rejection reasons prominently (warning color)
- [ ] History entries ordered chronologically (most recent first)
- [ ] JSON output includes all rejection_reason fields
- [ ] Tasks without rejections display normally (no error)
- [ ] Empty rejection reasons not displayed (omitted)

## Testing Requirements

### Manual Testing

```bash
# Create test task
shark task create E07 F22 "Test task" --agent=backend

# Move through workflow
shark task update T-E07-F22-001 --status=in_development
shark task update T-E07-F22-001 --status=ready_for_code_review

# Reject with reason
shark task update T-E07-F22-001 --status=in_development \
  --rejection-reason="Missing tests"

# View task details (should show rejection)
shark task get T-E07-F22-001

# View full history
shark task history T-E07-F22-001

# JSON output
shark task get T-E07-F22-001 --json
shark task history T-E07-F22-001 --json
```

### CLI Tests

File: `internal/cli/commands/task_get_test.go`

```go
func TestFindMostRecentRejection(t *testing.T) {
    tests := []struct {
        name     string
        history  []*models.TaskHistory
        wantNil  bool
        wantID   int64
    }{
        {
            name: "recent rejection exists",
            history: []*models.TaskHistory{
                {ID: 3, RejectionReason: "Failed code review", ChangedAt: time.Now()},
                {ID: 2, RejectionReason: "", ChangedAt: time.Now().Add(-time.Hour)},
                {ID: 1, RejectionReason: "Old rejection", ChangedAt: time.Now().Add(-2 * time.Hour)},
            },
            wantNil: false,
            wantID:  3,
        },
        {
            name: "no rejections",
            history: []*models.TaskHistory{
                {ID: 2, RejectionReason: "", ChangedAt: time.Now()},
                {ID: 1, RejectionReason: "", ChangedAt: time.Now().Add(-time.Hour)},
            },
            wantNil: true,
        },
        {
            name:    "empty history",
            history: []*models.TaskHistory{},
            wantNil: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            result := findMostRecentRejection(tt.history)

            if tt.wantNil {
                if result != nil {
                    t.Errorf("expected nil, got rejection: %v", result)
                }
            } else {
                if result == nil {
                    t.Fatal("expected rejection, got nil")
                }
                if result.ID != tt.wantID {
                    t.Errorf("expected ID %d, got %d", tt.wantID, result.ID)
                }
            }
        })
    }
}
```

## Notes

- **User Experience:** Prominently display rejection feedback
- **Most Recent First:** Show latest rejection in task get (developers need this immediately)
- **Full History Available:** `task history` shows complete audit trail
- **Color Coding:** Use warning color (yellow) for rejection reasons
- **JSON Complete:** All fields included for machine processing
