---
agent: backend
created_at: 2026-01-16T06:37:17Z
dependencies:
    - T-E07-F22-018
epic: E07
estimated_time: 6 hours
feature: E07-F22
key: T-E07-F22-019
priority: 5
status: todo
task_key: T-E07-F22-006
title: Display rejection history in task get command
---

# Task: Display rejection history in task get command

## Goal

Implement `GetRejectionHistory()` repository method and enhance `shark task get` command to display rejection history section with formatted output for both terminal and JSON modes.

## Success Criteria

- [ ] GetRejectionHistory() method implemented in TaskNoteRepository
- [ ] Query efficiently retrieves rejection notes with metadata
- [ ] Terminal output shows rejection history section with formatting
- [ ] JSON output includes rejection_history array
- [ ] Display shows timestamp, rejector, transition, reason, and optional document
- [ ] Only displayed when rejections exist (no empty section)

## Implementation Guidance

### Overview

Developers need to see why their tasks were rejected before starting fixes. The task get command must fetch rejection history from notes and display it prominently with clear formatting.

### Key Requirements

1. **Repository Method** - See [Feature PRD - Repository Layer](../feature.md#repository-layer)
   - Method: GetRejectionHistory(ctx, taskID) ‚Üí ([]*RejectionHistoryEntry, error)
   - Query joins task_notes with metadata
   - Ordered chronologically (most recent first)
   - Parses metadata JSON into struct

2. **Terminal Output** - See [Feature PRD - Terminal Output Mock](../feature.md#terminal-output-mock)
   - Section header: "‚ö†Ô∏è  REJECTION HISTORY (N rejections)"
   - Visual separators between rejection entries
   - Show: timestamp, rejector, status transition, reason text
   - Show document path if present: "üìÑ Related Document: {path}"

3. **JSON Output** - See [Feature PRD - JSON Output Mock](../feature.md#json-output-mock)
   - Add rejection_history array to task response
   - Each entry: id, timestamp, from_status, to_status, rejected_by, reason, reason_document, history_id
   - Empty array if no rejections (not null)

### Files to Create/Modify

**Repository**:
- `internal/repository/task_note_repository.go` - Add GetRejectionHistory method
- Define RejectionHistoryEntry struct for return type

**CLI Command**:
- `internal/cli/commands/task_get.go` - Add rejection history display logic
- Format terminal output with colors and symbols
- Add to JSON response structure

### Integration Points

- **Task Get Command** (existing) - Enhanced with rejection history section
- **Task Notes Repository** (T-E07-F22-018) - Queries rejection notes
- **Output Formatting** (existing) - Use CLI color/formatting utilities

## Validation Gates

**Repository Method**:
- Returns rejection notes ordered by timestamp (desc)
- Metadata JSON correctly parsed into struct
- Returns empty slice if no rejections (not error)
- Query performance < 100ms for 10 rejections

**Terminal Display**:
- Rejection section only shown when rejections exist
- Formatting is clear and readable
- Colors work with --no-color flag
- Long reasons are not truncated in get command (full display)

**JSON Output**:
- rejection_history array present in response
- All rejection fields populated correctly
- Document path shown when present, null when absent

## Context & Resources

**Feature Requirements**:
- [Feature PRD - Repository Layer](../feature.md#repository-layer)
- [Feature PRD - REQ-F-004: Rejection History Display](../feature.md#requirements)
- [Feature PRD - Terminal Output Mock](../feature.md#terminal-output-mock)
- [Feature PRD - JSON Output Mock](../feature.md#json-output-mock)

**Existing Patterns**:
- Review task get command formatting
- Use existing color utilities from CLI package
- Follow JSON response patterns from other commands

## Notes for Agent

- **Query Performance**: Use the index on (note_type, task_id) from T-E07-F22-015
- **JSON Parsing**: Use json.Unmarshal() to parse metadata JSON from database
- **Empty State**: Return empty array, not error, when no rejections exist
- **Terminal Formatting**: Use emoji symbols (‚ö†Ô∏è üìÑ) and separator lines for visual clarity
- **Testing**: Mock repository in CLI tests; use real DB in repository tests
