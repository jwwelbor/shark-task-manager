---
agent: backend
created_at: 2026-01-16T06:37:49Z
dependencies:
    - T-E07-F22-019
epic: E07
estimated_time: 5 hours
feature: E07-F22
key: T-E07-F22-022
priority: 8
status: todo
task_key: T-E07-F22-009
title: Add rejection indicators to task list command
---

# Task: Add rejection indicators to task list command

## Goal

Enhance `shark task list` command to show warning symbols (⚠️) for tasks with rejections, add rejection_count and last_rejection_at to JSON output, helping teams prioritize fixing rejected tasks.

## Success Criteria

- [ ] Tasks with rejections show ⚠️ symbol in terminal output
- [ ] Terminal shows rejection count next to task key
- [ ] JSON output includes rejection_count field
- [ ] JSON output includes last_rejection_at timestamp
- [ ] Query performance not degraded (efficient count query)
- [ ] --has-rejections filter flag added (optional)

## Implementation Guidance

### Overview

Task list is the primary view for task management. Adding rejection indicators helps teams quickly identify tasks needing attention and prioritize fixes.

### Key Requirements

1. **Terminal Display** - See [Feature PRD - REQ-F-007](../feature.md#requirements)
   - Show ⚠️ symbol before task key if rejections exist
   - Display rejection count: "T-E07-F01-003 ⚠️(2)" 
   - Count should be subtle, not overwhelming

2. **JSON Enhancement** - See [Feature PRD - REQ-F-007](../feature.md#requirements)
   - Add rejection_count: int field (0 if no rejections)
   - Add last_rejection_at: timestamp field (null if no rejections)
   - Maintain backward compatibility (additive change)

3. **Query Optimization**
   - Count rejections efficiently (LEFT JOIN or subquery)
   - Use index on (note_type, task_id) from T-E07-F22-015
   - Avoid N+1 query problem (count all tasks at once)

4. **Optional Filter** (should-have)
   - Add --has-rejections flag to filter tasks with rejections
   - Helps teams focus on fixing rejected tasks

### Files to Create/Modify

**Repository**:
- `internal/repository/task_repository.go` - Enhance List() to include rejection counts
- Add rejection count to TaskListResponse struct
- Use efficient SQL query (JOIN or subquery)

**CLI Command**:
- `internal/cli/commands/task_list.go` - Display rejection indicators
- Add --has-rejections filter flag
- Format terminal output with symbols

### Integration Points

- **Task List Command** (existing) - Enhanced with rejection data
- **Task Notes** (T-E07-F22-018) - Count rejection notes per task
- **Output Formatting** (existing) - Use CLI formatting utilities

## Validation Gates

**Query Performance**:
- List performance not degraded with rejection counts
- Query uses index on (note_type, task_id)
- No N+1 query pattern (single query for all counts)

**Terminal Display**:
- ⚠️ symbol displays correctly in terminals
- Rejection count is visible but not intrusive
- --no-color flag works correctly

**JSON Output**:
- rejection_count field present for all tasks
- last_rejection_at present (null if no rejections)
- Backward compatible (existing JSON parsers not broken)

**Filter Functionality** (optional):
- --has-rejections flag filters correctly
- Works with other filters (epic, feature, status)

## Context & Resources

**Feature Requirements**:
- [Feature PRD - REQ-F-007: Rejection Indicators](../feature.md#requirements)
- [Feature PRD - Story 4](../feature.md#user-stories)

**Existing Patterns**:
- Review task list repository query structure
- Use existing JSON response patterns
- Follow filter flag patterns from other list commands

## Notes for Agent

- **Query Efficiency**: Use LEFT JOIN or subquery to count rejections in single query
- **Index Usage**: Ensure query uses idx_task_notes_type_task index
- **Symbol Display**: ⚠️ is Unicode; ensure terminal compatibility
- **Backward Compatibility**: Additive changes only; existing API consumers not broken
- **Testing**: Verify performance with 100+ tasks and varied rejection counts
