---
key: T-E07-F22-020
title: Implement document linking with reason-doc flag
epic: E07
feature: E07-F22
agent: backend
status: todo
priority: 6
dependencies: [T-E07-F22-018]
created_at: 2026-01-16T06:37:27Z
estimated_time: 4 hours
---

# Task: Implement document linking with reason-doc flag

## Goal

Add `--reason-doc` flag to task update command, validate document exists, create task_documents link with link_type="rejection_reason", and store path in rejection note metadata.

## Success Criteria

- [ ] --reason-doc flag added to task update command
- [ ] Document path validation (file must exist)
- [ ] Creates task_documents link with link_type="rejection_reason"
- [ ] Document path stored in rejection note metadata
- [ ] Error handling for non-existent documents
- [ ] CLI tests validate document linking

## Implementation Guidance

### Overview

Complex rejections often require detailed documentation (bug reports, code review documents). The --reason-doc flag allows linking these documents to rejection notes for developer reference.

### Key Requirements

1. **CLI Flag** - See [Feature PRD - CLI Syntax](../feature.md#cli-syntax)
   - Add --reason-doc string flag (path to document)
   - Works alongside --reason flag
   - Path relative to project root or absolute

2. **Document Validation** - See [Feature PRD - Error Story 2](../feature.md#edge-case--error-stories)
   - Check file exists before accepting
   - Clear error if path invalid or file missing
   - Suggest verifying file path

3. **Document Linking** - See [Feature PRD - REQ-F-005](../feature.md#requirements)
   - Create record in task_documents table (if exists)
   - link_type = "rejection_reason"
   - Store document path in rejection note metadata
   - Atomic: document link + rejection note in same transaction

### Files to Create/Modify

**CLI Command**:
- `internal/cli/commands/task_update.go` - Add --reason-doc flag and validation
- Validate file exists using os.Stat()

**Repository** (if task_documents table exists):
- `internal/repository/task_document_repository.go` - Link document to task
- If table doesn't exist, only store path in metadata (phase 1)

### Integration Points

- **CreateRejectionNote()** (T-E07-F22-018) - Passes document path to metadata
- **Task Documents** (may exist from E10-F03) - Link document if table exists
- **File System** (existing) - Validate document path

## Validation Gates

**Document Validation**:
- Accepts valid file paths (relative and absolute)
- Rejects non-existent files with clear error
- Error message shows the attempted path

**Document Linking**:
- Document path stored in rejection note metadata
- If task_documents exists: link record created
- Link appears in rejection history display

**Error Handling**:
- User-friendly error for missing documents
- Validates path before creating rejection note
- Transaction rollback if document validation fails after note created

## Context & Resources

**Feature Requirements**:
- [Feature PRD - CLI Syntax](../feature.md#cli-syntax)
- [Feature PRD - REQ-F-005: Document Linking](../feature.md#requirements)
- [Feature PRD - Error Story 2](../feature.md#edge-case--error-stories)

**Existing Patterns**:
- Check if task_documents table exists (E10-F03 feature)
- Use os.Stat() for file validation
- Follow transaction patterns from T-E07-F22-018

## Notes for Agent

- **File Validation**: Use os.Stat(path) to check file exists
- **Path Handling**: Support both relative (to project root) and absolute paths
- **Optional Feature**: task_documents table may not exist; store path in metadata regardless
- **Transaction Safety**: Validate document BEFORE beginning transaction
- **Error Messages**: Follow existing CLI error formatting patterns
