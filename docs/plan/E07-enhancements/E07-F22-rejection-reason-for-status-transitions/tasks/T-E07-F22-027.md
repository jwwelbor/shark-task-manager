
---
key: T-E07-F22-027
title: Add CLI flag --rejection-reason
epic: E07
feature: E07-F22
agent: backend
status: todo
priority: 4
dependencies: [T-E07-F22-026]
created_at: 2026-01-16T20:10:50Z
---

# Task: Add CLI flag --rejection-reason

## Goal

Add `--rejection-reason` flag to the `shark task update` command, enabling users to provide rejection reasons when transitioning tasks backward in the workflow.

## Implementation Details

### Create task update Command

File: `internal/cli/commands/task_update.go`

```go
package commands

import (
    "errors"
    "fmt"
    "os"

    "github.com/spf13/cobra"

    "shark-task-manager/internal/cli"
    "shark-task-manager/internal/repository"
)

var (
    taskUpdateStatus         string
    taskUpdateRejectionReason string
    taskUpdateNotes          string
    taskUpdateAgent          string
)

var taskUpdateCmd = &cobra.Command{
    Use:   "update <task-key>",
    Short: "Update task properties",
    Long: `Update task properties such as status.

When transitioning backward in the workflow (e.g., from code review to development),
a rejection reason is required if the config has require_rejection_reason: true.

Examples:
  # Update status
  shark task update E07-F01-001 --status=in_development

  # Backward transition with rejection reason
  shark task update E07-F01-001 --status=in_development \
    --rejection-reason="Missing error handling for edge cases"

  # Forward transition (no rejection reason needed)
  shark task update E07-F01-001 --status=ready_for_code_review`,
    Args:  cobra.ExactArgs(1),
    RunE:  runTaskUpdate,
}

func init() {
    taskUpdateCmd.Flags().StringVar(&taskUpdateStatus, "status", "", "New status")
    taskUpdateCmd.Flags().StringVar(&taskUpdateRejectionReason, "rejection-reason", "", "Reason for backward transition (required for rejections)")
    taskUpdateCmd.Flags().StringVar(&taskUpdateNotes, "notes", "", "Additional notes")
    taskUpdateCmd.Flags().StringVar(&taskUpdateAgent, "agent", "", "Agent identifier")

    taskCmd.AddCommand(taskUpdateCmd)
}

func runTaskUpdate(cmd *cobra.Command, args []string) error {
    ctx := cmd.Context()
    taskKey := args[0]

    // Require at least one flag
    if taskUpdateStatus == "" {
        return fmt.Errorf("at least one update flag required (--status)")
    }

    // Get database
    repoDb, err := cli.GetDB(ctx)
    if err != nil {
        return fmt.Errorf("failed to get database: %w", err)
    }

    taskRepo := repository.NewTaskRepository(repoDb)

    // Build update options
    opts := repository.UpdateStatusOptions{
        RejectionReason: taskUpdateRejectionReason,
        Notes:           taskUpdateNotes,
        Agent:           taskUpdateAgent,
    }

    // Update status
    err = taskRepo.UpdateStatus(ctx, taskKey, taskUpdateStatus, opts)
    if err != nil {
        // Check if rejection reason required
        var rejErr *repository.RejectionReasonRequiredError
        if errors.As(err, &rejErr) {
            // User-friendly error message
            cli.Error("Rejection reason required")
            fmt.Fprintf(os.Stderr, "\n")
            fmt.Fprintf(os.Stderr, "Transitioning from %s (%.0f%% complete) to %s (%.0f%% complete) moves backward in the workflow.\n",
                rejErr.FromStatus, rejErr.FromProgress,
                rejErr.ToStatus, rejErr.ToProgress)
            fmt.Fprintf(os.Stderr, "\n")
            fmt.Fprintf(os.Stderr, "Please provide a reason using --rejection-reason flag:\n")
            fmt.Fprintf(os.Stderr, "\n")
            fmt.Fprintf(os.Stderr, "  shark task update %s --status=%s --rejection-reason=\"<reason>\"\n",
                taskKey, taskUpdateStatus)
            fmt.Fprintf(os.Stderr, "\n")
            fmt.Fprintf(os.Stderr, "Example reasons:\n")
            fmt.Fprintf(os.Stderr, "  - Missing unit tests for new functionality\n")
            fmt.Fprintf(os.Stderr, "  - Insufficient error handling for edge cases\n")
            fmt.Fprintf(os.Stderr, "  - Code quality issues found in review\n")
            fmt.Fprintf(os.Stderr, "  - Browser compatibility issues in Safari\n")
            fmt.Fprintf(os.Stderr, "\n")
            os.Exit(1)
        }

        // Other errors
        return fmt.Errorf("failed to update task status: %w", err)
    }

    // Output success
    if cli.GlobalConfig.JSON {
        return cli.OutputJSON(map[string]interface{}{
            "task_key":         taskKey,
            "status":           taskUpdateStatus,
            "rejection_reason": taskUpdateRejectionReason,
            "notes":            taskUpdateNotes,
            "agent":            taskUpdateAgent,
        })
    }

    cli.Success(fmt.Sprintf("Task %s updated to %s", taskKey, taskUpdateStatus))

    if taskUpdateRejectionReason != "" {
        cli.Info(fmt.Sprintf("Rejection reason: %s", taskUpdateRejectionReason))
    }

    return nil
}
```

### Update Existing Status Commands

The existing commands (`task start`, `task complete`, etc.) may need to be updated to use the new `UpdateStatusOptions` structure if they don't already.

File: `internal/cli/commands/task.go`

Example for `task start`:

```go
func runTaskStart(cmd *cobra.Command, args []string) error {
    ctx := cmd.Context()
    taskKey := args[0]

    repoDb, err := cli.GetDB(ctx)
    if err != nil {
        return err
    }

    taskRepo := repository.NewTaskRepository(repoDb)

    opts := repository.UpdateStatusOptions{
        Agent: startAgent, // From --agent flag if provided
    }

    err = taskRepo.UpdateStatus(ctx, taskKey, "in_progress", opts)
    if err != nil {
        return err
    }

    // Output success...
}
```

## CLI Usage Examples

### Example 1: Backward Transition with Rejection Reason

```bash
# Task is in ready_for_code_review status
$ shark task get E07-F22-001
Task: E07-F22-001 - Implement JWT validation
Status: ready_for_code_review (85% complete)

# Attempt backward transition without reason = ERROR
$ shark task update E07-F22-001 --status=in_development

Error: Rejection reason required

Transitioning from ready_for_code_review (85% complete) to in_development (50% complete) moves backward in the workflow.

Please provide a reason using --rejection-reason flag:

  shark task update E07-F22-001 --status=in_development --rejection-reason="<reason>"

Example reasons:
  - Missing unit tests for new functionality
  - Insufficient error handling for edge cases
  - Code quality issues found in review
  - Browser compatibility issues in Safari

# Backward transition with reason = SUCCESS
$ shark task update E07-F22-001 --status=in_development \
  --rejection-reason="Missing error handling for edge cases"
✓ Task E07-F22-001 updated to in_development
ℹ Rejection reason: Missing error handling for edge cases
```

### Example 2: Forward Transition (No Rejection Reason)

```bash
# Task is in_development
$ shark task get E07-F22-001
Task: E07-F22-001 - Implement JWT validation
Status: in_development (50% complete)

# Forward transition works without rejection reason
$ shark task update E07-F22-001 --status=ready_for_code_review
✓ Task E07-F22-001 updated to ready_for_code_review
```

### Example 3: JSON Output

```bash
$ shark task update E07-F22-001 --status=in_development \
  --rejection-reason="Missing tests" --json

{
  "task_key": "E07-F22-001",
  "status": "in_development",
  "rejection_reason": "Missing tests",
  "notes": "",
  "agent": ""
}
```

## Implementation Steps

1. Create `task_update.go` command file
2. Add `--rejection-reason`, `--status`, `--notes`, `--agent` flags
3. Implement error handling for `RejectionReasonRequiredError`
4. Create user-friendly error messages with examples
5. Add JSON output support
6. Update existing status commands to use `UpdateStatusOptions`
7. Write tests for command

## Acceptance Criteria

- [ ] `shark task update <key> --status=<status>` command works
- [ ] `--rejection-reason` flag accepts string values
- [ ] `--notes` flag accepts additional notes
- [ ] `--agent` flag accepts agent identifier
- [ ] Error message displayed when rejection reason required
- [ ] Error message includes progress percentages
- [ ] Error message provides example command
- [ ] Success message shows rejection reason when provided
- [ ] JSON output includes all fields
- [ ] Backward transitions without rejection reason fail gracefully
- [ ] Forward transitions work without rejection reason

## Testing Requirements

### Manual Testing

```bash
# Test 1: Backward transition without reason (should fail)
shark task update E07-F22-001 --status=in_development

# Test 2: Backward transition with reason (should succeed)
shark task update E07-F22-001 --status=in_development \
  --rejection-reason="Code review failed"

# Test 3: Forward transition without reason (should succeed)
shark task update E07-F22-001 --status=ready_for_code_review

# Test 4: JSON output
shark task update E07-F22-001 --status=in_development \
  --rejection-reason="Test" --json

# Test 5: With notes and agent
shark task update E07-F22-001 --status=in_development \
  --rejection-reason="Test" --notes="Additional info" --agent="test-agent"
```

### CLI Tests

File: `internal/cli/commands/task_update_test.go`

```go
func TestTaskUpdateCommand_RequiresRejectionReason(t *testing.T) {
    // Setup mock repository that returns RejectionReasonRequiredError
    mockRepo := &MockTaskRepository{
        UpdateStatusFunc: func(ctx context.Context, key, status string, opts repository.UpdateStatusOptions) error {
            if opts.RejectionReason == "" {
                return &repository.RejectionReasonRequiredError{
                    TaskKey:      key,
                    FromStatus:   "ready_for_code_review",
                    ToStatus:     status,
                    FromProgress: 85.0,
                    ToProgress:   50.0,
                }
            }
            return nil
        },
    }

    // Test without rejection reason
    err := mockRepo.UpdateStatus(context.Background(), "E07-F22-001", "in_development", repository.UpdateStatusOptions{})

    if err == nil {
        t.Fatal("expected error when rejection reason missing")
    }

    var rejErr *repository.RejectionReasonRequiredError
    if !errors.As(err, &rejErr) {
        t.Fatalf("expected RejectionReasonRequiredError, got: %T", err)
    }

    // Test with rejection reason
    err = mockRepo.UpdateStatus(context.Background(), "E07-F22-001", "in_development", repository.UpdateStatusOptions{
        RejectionReason: "Code review failed",
    })

    if err != nil {
        t.Fatalf("UpdateStatus should succeed with rejection reason: %v", err)
    }
}
```

## Notes

- **User Experience:** Error messages include examples to guide users
- **Progress Visibility:** Error shows percentage complete for both statuses
- **Helpful Examples:** Suggest common rejection reasons in error message
- **Backward Compatible:** Existing commands continue working
- **JSON Support:** All output formats supported
