---
key: T-E07-F22-018
title: Create rejection note with metadata in repository
epic: E07
feature: E07-F22
agent: backend
status: todo
priority: 4
dependencies: [T-E07-F22-015, T-E07-F22-017]
created_at: 2026-01-16T06:37:07Z
estimated_time: 5 hours
---

# Task: Create rejection note with metadata in repository

## Goal

Implement `CreateRejectionNote()` repository method to atomically create task notes with note_type=rejection, storing metadata that links to history records and optionally includes document paths.

## Success Criteria

- [ ] CreateRejectionNote() method implemented in TaskNoteRepository
- [ ] Creates task_note with note_type="rejection"
- [ ] Populates metadata JSON with history_id, from_status, to_status, document_path
- [ ] Created within same transaction as status update
- [ ] Repository tests validate creation and metadata structure
- [ ] Returns created note with ID populated

## Implementation Guidance

### Overview

When a task is rejected (backward status transition), we need to create a specialized task note that captures the rejection context. This note links to the task history record and optionally references detailed rejection documents.

### Key Requirements

1. **Repository Method Signature** - See [Feature PRD - Repository Layer](../feature.md#repository-layer)
   - Method: CreateRejectionNote(ctx, taskID, historyID, fromStatus, toStatus, reason, rejectedBy, documentPath)
   - Returns: (*models.TaskNote, error)
   - All parameters required except documentPath (nullable)

2. **Metadata Structure** - See [Feature PRD - Database Schema](../feature.md#database-schema)
   - JSON fields: history_id (int64), from_status (string), to_status (string), document_path (string, optional)
   - Store as JSON string in metadata column
   - Use encoding/json package for marshaling

3. **Transaction Safety** - See [Feature PRD - REQ-F-003](../feature.md#requirements)
   - Accept *sql.Tx parameter for transaction context
   - Method should not begin/commit transactions (caller handles this)
   - Rollback-safe: no side effects if transaction rolls back

### Files to Create/Modify

**Repository**:
- `internal/repository/task_note_repository.go` - Add CreateRejectionNote method
- `internal/models/task_note.go` - May need to add metadata field to TaskNote model

**Repository Tests**:
- `internal/repository/task_note_repository_test.go` - Integration tests with real DB
- Test with valid metadata, null document_path, JSON marshaling

### Integration Points

- **Task Update Flow** (T-E07-F22-017) - CLI calls this after validating backward transition
- **Task History** (existing) - Metadata links rejection note to history record
- **Task Repository** (existing) - Status update and rejection note creation happen in same transaction

## Validation Gates

**Repository Method**:
- Creates task_note record with correct note_type
- Metadata JSON is valid and parseable
- Returns note with populated ID
- Works within transaction context

**Repository Tests**:
- Test creation with all fields populated
- Test creation with NULL document_path
- Test JSON metadata structure matches schema
- Test transaction rollback doesn't persist note

**Data Integrity**:
- Foreign key constraints enforced (task_id must exist)
- metadata column stores valid JSON
- history_id in metadata links to valid history record

## Context & Resources

**Feature Requirements**:
- [Feature PRD - Repository Layer](../feature.md#repository-layer)
- [Feature PRD - REQ-F-003: Rejection Note Creation](../feature.md#requirements)
- [Feature PRD - Database Schema](../feature.md#database-schema)

**Existing Patterns**:
- Review TaskNoteRepository existing methods for patterns
- Follow transaction handling from other repository methods
- Use JSON marshaling patterns from existing code

## Notes for Agent

- **Transaction Context**: Method receives tx *sql.Tx from caller; does NOT create its own transaction
- **JSON Metadata**: Use json.Marshal() for metadata struct â†’ string conversion
- **Testing**: Use REAL database for repository tests (see testing architecture rules)
- **Cleanup**: Repository tests must clean up test data (DELETE after test)
- **Error Wrapping**: Wrap errors with fmt.Errorf("failed to create rejection note: %w", err)
