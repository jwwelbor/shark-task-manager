---
key: T-E07-F22-015
title: Add metadata column to task_notes table
epic: E07
feature: E07-F22
agent: backend
status: todo
priority: 1
created_at: 2026-01-16T06:36:37Z
estimated_time: 2 hours
---

# Task: Add metadata column to task_notes table

## Goal

Extend the `task_notes` table with a `metadata` JSON column to store structured data for rejection notes, including history_id, status transitions, and optional document paths. This enables rich rejection history tracking without creating new tables.

## Success Criteria

- [ ] `metadata` TEXT column added to task_notes table (stores JSON)
- [ ] Index created on (note_type, task_id) for efficient rejection note queries
- [ ] Migration is idempotent and safe to run multiple times
- [ ] Database auto-migration runs successfully during shark startup
- [ ] Existing task_notes records continue working with NULL metadata

## Implementation Guidance

### Overview

The task_notes table needs a flexible metadata field to store JSON data specific to rejection notes. This avoids creating separate tables while maintaining query performance through proper indexing.

### Key Requirements

1. **Schema Extension** - See [Feature PRD - Database Schema](../feature.md#database-schema)
   - Add `metadata TEXT` column to task_notes table
   - Column should accept NULL for non-rejection notes
   - JSON structure will include: history_id, from_status, to_status, document_path

2. **Index Creation** - See [Feature PRD - REQ-NF-001](../feature.md#non-functional-requirements)
   - Create composite index on (note_type, task_id)
   - Improves query performance for fetching rejection history
   - Target: < 100ms query time for tasks with up to 10 rejections

3. **Migration Safety**
   - Use `IF NOT EXISTS` clauses for idempotency
   - Check if column exists before adding
   - No data migration needed (new column starts NULL)

### Files to Create/Modify

**Database Migration**:
- `internal/db/db.go` - Add migration in InitDB() function
- Check existing migration pattern in same file for consistency

**No repository changes needed** - metadata column is passive until CreateRejectionNote uses it (Task T-E07-F22-018).

### Integration Points

- **Task Notes Repository** (internal/repository/task_note_repository.go) - Will use metadata column in T-E07-F22-018
- **Task History** (existing) - metadata will link rejection notes to history records
- **Backward Compatibility** - Existing task notes continue working (metadata is NULL)

## Validation Gates

**Database Schema**:
- Column exists with correct type (TEXT for JSON storage)
- Column accepts NULL values
- Index exists and is used in query plans

**Migration Testing**:
- Migration runs successfully on fresh database
- Migration runs successfully on database with existing task_notes
- No errors when inserting task_notes with/without metadata

**Performance**:
- Query performance meets target (<100ms) when index is used
- Verify with EXPLAIN QUERY PLAN in SQLite

## Context & Resources

**Feature Requirements**:
- [Feature PRD - Database Schema](../feature.md#database-schema)
- [Feature PRD - REQ-F-003: Rejection Note Creation](../feature.md#requirements)
- [Feature PRD - REQ-NF-001: Performance](../feature.md#non-functional-requirements)

**Existing Patterns**:
- Review existing migrations in `internal/db/db.go`
- Follow auto-migration pattern used for other schema changes
- Use SQLite's `ALTER TABLE IF NOT EXISTS` pattern

## Notes for Agent

- **Migration Pattern**: Follow the auto-migration style in InitDB() - check if column exists before adding
- **JSON Storage**: SQLite stores JSON as TEXT; no special JSON column type needed
- **Index Naming**: Use `idx_task_notes_type_task` for consistency with existing indexes
- **Testing**: Test both fresh init and migration from existing database
- **No Breaking Changes**: Existing code continues working; metadata is NULL until explicitly set