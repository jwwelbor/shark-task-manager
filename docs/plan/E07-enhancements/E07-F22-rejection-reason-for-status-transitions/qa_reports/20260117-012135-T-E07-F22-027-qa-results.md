# QA Results: T-E07-F22-027 - Add CLI flag --rejection-reason

**Date:** 2026-01-17 01:21:35
**Task:** T-E07-F22-027
**QA Agent:** QA
**Status:** ❌ FAILED (New Issue Found)

---

## Test Summary

| Category | Status | Details |
|----------|--------|---------|
| Bug #1: Repository Parameter Check | ✅ FIXED | Line 881 now checks `rejectionReason` instead of `notes` |
| Bug #2: Test Compilation (line 82) | ✅ FIXED | Now has 7 parameters: `nil, nil, nil, true` |
| Bug #3: Test Compilation (line 180) | ✅ FIXED | Now has 7 parameters: `nil, nil, nil, false` |
| Tests Compile | ✅ PASS | All tests compile successfully |
| Tests Pass | ✅ PASS | All 7 test functions pass |
| Manual Testing | ❌ FAIL | Database constraint error prevents feature from working |

**Overall Result:** FAILED - New critical issue discovered during manual testing

---

## Previous Bugs - All Fixed ✅

### Bug #1: Repository Parameter Check (FIXED)
**File:** `internal/repository/task_repository.go`
**Line:** 883

**Previous Issue:**
```go
// WRONG:
if notes == nil || strings.TrimSpace(*notes) == "" {
```

**Current Implementation:**
```go
// CORRECT:
if rejectionReason == nil || strings.TrimSpace(*rejectionReason) == "" {
```

**Verification:** ✅ Code review confirms fix is correct

---

### Bug #2: Test Compilation Error Line 82 (FIXED)
**File:** `internal/cli/commands/task_update_status_test.go`
**Line:** 82

**Previous Issue:**
```go
// Missing rejectionReason parameter (6 args instead of 7)
err = taskRepo.UpdateStatusForced(ctx, task.ID, newStatus, nil, nil, true)
```

**Current Implementation:**
```go
// Correct with all 7 parameters
err = taskRepo.UpdateStatusForced(ctx, task.ID, newStatus, nil, nil, nil, true)
```

**Verification:** ✅ Tests compile and pass

---

### Bug #3: Test Compilation Error Line 180 (FIXED)
**File:** `internal/cli/commands/task_update_status_test.go`
**Line:** 180

**Previous Issue:**
```go
// Missing rejectionReason parameter (6 args instead of 7)
err = taskRepo.UpdateStatusForced(ctx, task.ID, invalidStatus, nil, nil, false)
```

**Current Implementation:**
```go
// Correct with all 7 parameters
err = taskRepo.UpdateStatusForced(ctx, task.ID, invalidStatus, nil, nil, nil, false)
```

**Verification:** ✅ Tests compile and pass

---

## Test Results

### Unit Tests
```bash
$ go test -v ./internal/cli/commands -run TestTaskUpdate
=== RUN   TestTaskUpdate_PriorityAndDependencies
--- PASS: TestTaskUpdate_PriorityAndDependencies (0.05s)
=== RUN   TestTaskUpdate_WithStatusFlag
--- PASS: TestTaskUpdate_WithStatusFlag (0.00s)
=== RUN   TestTaskUpdate_WithStatusFlag_InvalidTransition
--- PASS: TestTaskUpdate_WithStatusFlag_InvalidTransition (0.00s)
=== RUN   TestTaskUpdateCommand_Exists
--- PASS: TestTaskUpdateCommand_Exists (0.00s)
=== RUN   TestTaskUpdateCommand_OrderFlag
--- PASS: TestTaskUpdateCommand_OrderFlag (0.00s)
=== RUN   TestTaskUpdateCommand_StatusFlag
--- PASS: TestTaskUpdateCommand_StatusFlag (0.00s)
=== RUN   TestTaskUpdateCommand_ReasonFlag
--- PASS: TestTaskUpdateCommand_ReasonFlag (0.00s)
PASS
```

**Result:** ✅ All 7 tests pass

---

## Manual Testing

### Test 1: Forward Transition Without Reason (Should Succeed)
**Command:**
```bash
./bin/shark task update T-E07-F22-027 --status ready_for_code_review
```

**Result:** ✅ PASS
```
SUCCESS Task T-E07-F22-027 updated successfully
```

---

### Test 2: Backward Transition Without Reason (Should Fail)
**Command:**
```bash
# Move task to in_qa first
./bin/shark task update T-E07-F22-027 --status in_qa

# Try backward transition without reason
./bin/shark task update T-E07-F22-027 --status in_development
```

**Result:** ✅ PASS (Correctly rejects)
```
ERROR Error: reason is required for backward status transitions
INFO Use --reason to provide a reason, or use --force to bypass this requirement
INFO Example: shark task update T-E07-F22-027 --status in_development --reason "Reason for transition"
```

**Analysis:** Error message is clear, helpful, and provides example command

---

### Test 3: Backward Transition WITH Reason (Should Succeed)
**Command:**
```bash
./bin/shark task update T-E07-F22-027 --status in_development \
  --reason "QA found bugs: repository parameter check, test compilation errors"
```

**Result:** ❌ FAIL
```
ERROR Error: Failed to update task status: failed to create rejection note:
failed to create rejection note: failed to insert into database:
CHECK constraint failed: note_type IN (
    'comment',
    'decision',
    'blocker',
    'solution',
    'reference',
    'implementation',
    'testing',
    'future',
    'question'
)
```

**Analysis:** Code attempts to create a note with type "rejection", but database schema doesn't allow this note type.

---

### Test 4: Force Flag (Should Succeed)
**Command:**
```bash
./bin/shark task update T-E07-F22-027 --status in_development --force
```

**Result:** ✅ PASS
```
WARNING ⚠️  Forced transition from in_qa to in_development (bypassed workflow validation)
SUCCESS Task T-E07-F22-027 updated successfully
```

---

## New Critical Issue Found

### Issue #4: Database Schema Constraint for Rejection Notes (BLOCKER)

**Severity:** CRITICAL
**Impact:** Feature completely broken - cannot record rejection reasons

**Problem:**
The code attempts to create a note with type "rejection" when a backward transition occurs with a reason, but the database CHECK constraint only allows these note types:
- comment
- decision
- blocker
- solution
- reference
- implementation
- testing
- future
- question

**Error Message:**
```
CHECK constraint failed: note_type IN (
    'comment',
    'decision',
    'blocker',
    'solution',
    'reference',
    'implementation',
    'testing',
    'future',
    'question'
)
```

**Location:**
Database schema constraint in `tasks_notes` table (or similar)

**Root Cause:**
Mismatch between application code (which expects "rejection" note type) and database schema (which doesn't allow it)

**Fix Required:**
Either:
1. Add "rejection" to the allowed note types in database schema, OR
2. Use existing note type (e.g., "comment" or "blocker") for rejection reasons

**Recommendation:**
Option 1 is better - add "rejection" to allowed note types to maintain semantic clarity.

---

## Acceptance Criteria Validation

### ✅ PASSED Criteria

1. ✅ `shark task update <key> --status=<status>` command works
2. ✅ `--reason` flag accepts string values
3. ✅ Error message displayed when rejection reason required
4. ✅ Error message provides example command
5. ✅ Backward transitions without rejection reason fail gracefully
6. ✅ Forward transitions work without rejection reason
7. ✅ Tests compile successfully
8. ✅ All tests pass

### ❌ FAILED Criteria

9. ❌ **Backward transitions WITH rejection reason fail** - Database constraint error
10. ❌ **Rejection reason cannot be stored** - Database doesn't allow "rejection" note type
11. ⚠️ **JSON output mixed with human-readable output** - Minor issue, success message prints before JSON

---

## Required Fix

### Fix #4: Add "rejection" to Allowed Note Types (CRITICAL)

**Database Schema:**
Add "rejection" to the CHECK constraint for note_type column.

**Example SQL Migration:**
```sql
-- Find the table with note_type constraint (likely tasks_notes or similar)
-- Update CHECK constraint to include 'rejection'

ALTER TABLE tasks_notes DROP CONSTRAINT note_type_check;
ALTER TABLE tasks_notes ADD CONSTRAINT note_type_check
    CHECK (note_type IN (
        'comment',
        'decision',
        'blocker',
        'solution',
        'reference',
        'implementation',
        'testing',
        'future',
        'question',
        'rejection'  -- ADD THIS
    ));
```

**Alternative Fix (if schema cannot be changed):**
Modify application code to use existing note type (e.g., "comment") instead of "rejection":

```go
// Find where "rejection" note type is used and change to "comment"
noteType := "comment" // Instead of "rejection"
```

---

## Re-Test Requirements

After fix is applied:

1. ✅ Verify database migration runs successfully
2. ✅ Test backward transition with reason (should succeed and store reason)
3. ✅ Verify rejection reason is stored in notes table with type "rejection"
4. ✅ Test `task get` shows rejection history
5. ✅ Verify JSON output doesn't mix with human-readable messages

---

## Summary of Work Done

**Fixes Verified:**
- ✅ Repository checks correct parameter (rejectionReason, not notes)
- ✅ Test line 82 has correct parameter count
- ✅ Test line 180 has correct parameter count
- ✅ All tests compile and pass
- ✅ Error messages are clear and helpful
- ✅ Forward transitions work
- ✅ Backward transitions correctly require reason
- ✅ Force flag works as expected

**New Issue Discovered:**
- ❌ Database schema doesn't allow "rejection" note type
- ❌ Prevents feature from working end-to-end

---

## Recommendation

**DO NOT APPROVE** - New critical issue must be fixed first.

**Next Steps:**
1. Developer adds "rejection" to database schema note_type constraint
2. Developer runs migration to update schema
3. QA re-tests backward transition with rejection reason
4. Verify rejection reason is stored correctly
5. If all tests pass, approve for deployment

**Estimated Fix Time:** 15-30 minutes (add migration, test)

---

## QA Sign-Off

**QA Agent:** QA
**Date:** 2026-01-17 01:21:35
**Decision:** ❌ REJECT - Return to development
**Blocker:** Database schema constraint prevents rejection note creation
**Priority:** HIGH - Critical feature functionality blocked

**Positive Note:** All 3 previous bugs were fixed correctly! Tests pass. Error messages are excellent. The only remaining issue is a database schema mismatch.

**Transition:** `ready_for_qa` → `in_development` (with rejection reason: "Database schema doesn't allow 'rejection' note type - prevents feature from working")
