# QA Report: T-E07-F22-028 - Add rejection reason to task history display

**Task:** T-E07-F22-028
**Date:** 2026-01-17
**QA Agent:** Claude Sonnet 4.5
**Status:** FAILED ❌

## Summary

QA testing for task T-E07-F22-028 "Add rejection reason to task history display" has **FAILED**. The rejection history display feature cannot work because the underlying functionality to store rejection reasons in the database is not functioning.

## Test Environment

- Database: shark-tasks.db (local SQLite)
- CLI Version: Current build from bin/shark
- Test Task: T-E07-F05-008 (created specifically for testing)

## Test Scenario

Created a test task and performed two backward status transitions with rejection reasons:

1. **First rejection:** `in_approval` → `ready_for_development` with reason "Missing error handling on line 67"
2. **Second rejection:** `in_approval` → `ready_for_qa` with reason "Found 3 critical bugs during final approval review"

## Expected Behavior

1. Rejection reasons should be stored in `task_history` table's `rejection_reason` column
2. `shark task get <task-key>` should display rejection history in terminal format
3. `shark task get <task-key> --json` should include `rejection_history` array with rejection details

## Actual Behavior

1. ❌ Rejection reasons are **NOT stored** in database - `rejection_reason` column is NULL
2. ❌ Terminal output shows no rejection history
3. ❌ JSON output has empty `rejection_history` array: `[]`

## Database Evidence

```sql
SELECT id, old_status, new_status, rejection_reason, timestamp 
FROM task_history 
WHERE task_id = (SELECT id FROM tasks WHERE key = 'T-E07-F05-008') 
  AND old_status = 'in_approval';
```

**Result:**
```
265|in_approval|ready_for_development||2026-01-17 05:22:13
273|in_approval|ready_for_qa||2026-01-17 05:22:13
```

The `rejection_reason` column is NULL (empty field between last two pipes).

## Root Cause

The `task update` command with `--status` and `--reason` flags is **not persisting the rejection reason** to the `task_history.rejection_reason` column. The backend code that handles status transitions is not saving the rejection reason.

## Test Commands Used

```bash
# Backward transition with rejection reason
./bin/shark task update T-E07-F05-008 --status=ready_for_development \
  --reason="Missing error handling on line 67"

# Verify rejection history
./bin/shark task get T-E07-F05-008 --json | jq '.rejection_history'
# Returns: []
```

## Impact

- **Critical**: The feature is non-functional
- Users cannot see why tasks were rejected
- No feedback loop for developers to understand rejection reasons
- Audit trail for task rejections is incomplete

## Blocking Issues

- [ ] `task update --status --reason` does not store rejection_reason in database
- [ ] Rejection history query returns empty results
- [ ] Display code cannot show rejections that don't exist in database

## Recommendations

### Immediate Fix Required

1. **Fix backend status update code** to persist `rejection_reason` when `--reason` flag is provided
2. **Verify database schema** has `rejection_reason` column (confirmed: exists)
3. **Test data flow:** Command line flag → Repository method → SQL INSERT → Database

### Code Review Needed

File locations to investigate:
- `internal/cli/commands/task.go` - Task update command handler (line ~2351 uses --reason flag)
- `internal/repository/task_repository.go` - UpdateStatusForced method
- SQL INSERT/UPDATE statements for task_history table

### After Fix

1. Re-run this test scenario
2. Verify rejection_reason is populated in database
3. Verify terminal output shows rejection history
4. Verify JSON output includes rejection_history array with data
5. Test with `task reopen` command (which has --reason-doc support)

## Test Artifacts

- Test task: T-E07-F05-008
- Test script: test_rejection_history_display.sh
- Database query results: Documented above

## Conclusion

**FAIL**: Cannot approve T-E07-F22-028 until the underlying rejection reason storage feature is fixed. The display code may be correct, but it cannot display data that isn't being saved.

**Next Action:** Create a blocker task to fix rejection reason persistence in task status updates.
