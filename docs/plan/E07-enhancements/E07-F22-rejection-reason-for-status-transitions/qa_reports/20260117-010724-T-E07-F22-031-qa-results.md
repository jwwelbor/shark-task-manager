# QA Results: T-E07-F22-031 - Test Timeline Rejection Display

**Task**: T-E07-F22-031 - Test Timeline Rejection Display
**Feature**: E07-F22 - Rejection Reason for Status Transitions
**QA Date**: 2026-01-17
**QA Agent**: qa-agent
**Status**: ❌ FAIL

---

## Executive Summary

The timeline rejection display feature **FAILS** acceptance criteria. While rejection reasons are successfully stored in the database, the `shark task timeline` command does NOT display them due to a **data source mismatch** between storage and retrieval layers.

**Critical Finding**: Rejection reasons are stored in `task_history.rejection_reason` but the timeline command attempts to retrieve them from `task_notes` table, resulting in empty rejection history.

---

## Test Environment

- **Database**: shark-tasks.db (local SQLite)
- **Shark Version**: Latest (main branch)
- **Test Task**: T-E15-F01-001 (created for testing)
- **Workflow Config**: .sharkconfig.json with status_flow configured

---

## Test Execution

### Test Case 1: Create Task with Rejection History

**Steps**:
1. Created epic E15 "QA Test Epic"
2. Created feature E15-F01 "QA Test Feature"
3. Created task T-E15-F01-001 "Test task for rejection display"
4. Progressed task through workflow: draft → ready_for_refinement → in_refinement → ready_for_development → in_development → ready_for_code_review
5. Rejected task from code review:
   ```bash
   ./bin/shark task update T-E15-F01-001 --status=in_development \
     --reason="Missing error handling for database.Query() on line 67 in user_repository.go. Add null check and return error to caller."
   ```
6. Progressed task again: ready_for_code_review → in_code_review → ready_for_qa → in_qa
7. Rejected task from QA:
   ```bash
   ./bin/shark task update T-E15-F01-001 --status=in_development \
     --reason="Tests fail on edge case: empty user input. Add validation in user_controller.go. See test failure log for details."
   ```

**Expected Result**:
- Rejection reasons stored in database
- `shark task timeline` displays rejections with ⚠️ symbol
- Rejection reasons shown inline (truncated to 80 chars)

**Actual Result**:
✅ Rejection reasons successfully stored in database (verified via SQLite query)
❌ Timeline does NOT display rejection events
❌ No ⚠️ symbols shown
❌ No rejection reasons visible

---

### Test Case 2: Database Verification

**Query**:
```sql
SELECT id, old_status, new_status, rejection_reason, timestamp
FROM task_history
WHERE task_id = (SELECT id FROM tasks WHERE key = 'T-E15-F01-001')
  AND rejection_reason IS NOT NULL
ORDER BY timestamp;
```

**Result**:
```
1408|ready_for_code_review|in_development|Missing error handling for database.Query() on line 67 in user_repository.go. Add null check and return error to caller.|2026-01-17 07:05:34
1414|in_qa|in_development|Tests fail on edge case: empty user input. Add validation in user_controller.go. See test failure log for details.|2026-01-17 07:05:43
```

✅ **Database storage is working correctly** - Both rejections are stored with reasons in `task_history.rejection_reason`

---

### Test Case 3: Timeline Display Test

**Command**:
```bash
./bin/shark task timeline T-E15-F01-001
```

**Expected Output** (per feature requirements):
```
Timeline:
  2026-01-17 07:05  Status: ready_for_code_review → in_development
        ⚠️ Rejected by code-reviewer
        Reason: Missing error handling for database.Query() on line 67 in user_repository.go...
  ...
  2026-01-17 07:05  Status: in_qa → in_development
        ⚠️ Rejected by qa-agent
        Reason: Tests fail on edge case: empty user input. Add validation in user_controller.go...
```

**Actual Output**:
```
Timeline:
  2026-01-17 07:05  Created
  2026-01-17 07:05  Status: → draft (jwwelbor)
  2026-01-17 07:05  Status: draft → ready_for_refinement
  2026-01-17 07:05  Status: ready_for_refinement → in_refinement
  2026-01-17 07:05  Status: in_refinement → ready_for_development
  2026-01-17 07:05  Status: ready_for_development → in_development
  2026-01-17 07:05  Status: in_development → ready_for_code_review
  2026-01-17 07:05  Status: ready_for_code_review → in_development
  2026-01-17 07:05  Status: in_development → ready_for_code_review
  2026-01-17 07:05  Status: ready_for_code_review → in_code_review
  2026-01-17 07:05  Status: in_code_review → ready_for_qa
  2026-01-17 07:05  Status: ready_for_qa → in_qa
  2026-01-17 07:05  Status: in_qa → in_development
```

❌ **No rejection indicators visible**
❌ **No ⚠️ symbols**
❌ **No rejection reasons displayed**

---

### Test Case 4: JSON Timeline Output

**Command**:
```bash
./bin/shark task timeline T-E15-F01-001 --json
```

**Expected**: JSON array including rejection events with `event_type: "rejection"`, `reason`, and `reason_document` fields

**Actual**: JSON array with only `event_type: "status"` entries, no rejection events

❌ **JSON output does not include rejection events**

---

## Root Cause Analysis

### Code Investigation

**File**: `internal/cli/commands/task_note.go`

**Lines 329-334** (Timeline command):
```go
// Get rejection history and add rejection events to timeline
rejections, err := noteRepo.GetRejectionHistory(ctx, task.ID)
if err != nil {
    // Log error but don't fail - rejection history is optional
    cli.Warning(fmt.Sprintf("Failed to get rejection history: %v", err))
}
```

**Problem**: Timeline calls `noteRepo.GetRejectionHistory()` which queries `task_notes` table:

**File**: `internal/repository/task_note_repository.go`

```go
func (r *TaskNoteRepository) GetRejectionHistory(ctx context.Context, taskID int64) ([]*RejectionHistoryEntry, error) {
    query := `
        SELECT id, created_at, content, created_by, metadata
        FROM task_notes
        WHERE task_id = ? AND note_type = ?
        ORDER BY id DESC
    `
    rows, err := r.db.QueryContext(ctx, query, taskID, models.NoteTypeRejection)
    // ...
}
```

**However**, rejection reasons are actually stored in `task_history.rejection_reason`:

**File**: `internal/repository/task_history_repository.go`

```go
func (r *TaskHistoryRepository) GetRejectionHistoryForTask(ctx context.Context, taskID int64) ([]*models.TaskHistory, error) {
    query := `
        SELECT id, task_id, old_status, new_status, agent, notes, rejection_reason, timestamp
        FROM task_history
        WHERE task_id = ? AND rejection_reason IS NOT NULL
        ORDER BY timestamp DESC
    `
    // ...
}
```

### The Mismatch

1. **Storage**: `shark task update --status=X --reason="..."` stores rejection in `task_history.rejection_reason` ✅
2. **Retrieval**: `shark task timeline` calls `noteRepo.GetRejectionHistory()` which queries `task_notes` ❌
3. **Result**: Empty rejection history returned, no rejections displayed

---

## Affected Features

Based on feature requirements (E07-F22 feature.md):

### ❌ Story 6: Timeline Integration (FAIL)
**Acceptance Criteria**:
- [ ] ❌ `shark task timeline` shows rejection events
- [ ] ❌ Rejection events highlighted with ⚠ symbol
- [ ] ❌ Inline reason display (truncated if > 80 chars)
- [ ] ❌ Link to document shown if present

**Status**: NONE of the acceptance criteria are met

### ✅ REQ-F-003: Rejection Note Creation (PARTIAL PASS)
- [x] ✅ Rejection reason stored (in task_history, not task_notes)
- [x] ✅ Metadata includes from_status, to_status
- [ ] ❌ NOT stored as task_note with note_type='rejection' (as designed)

---

## Acceptance Criteria Validation

### Feature Requirements (from feature.md)

**Story 6 - REQ-F-006: Timeline Integration**

| Criterion | Status | Notes |
|-----------|--------|-------|
| `shark task timeline` shows rejection events | ❌ FAIL | Events not displayed |
| Rejection events highlighted with ⚠ symbol | ❌ FAIL | Symbol not shown |
| Inline reason display (truncated if > 80 chars) | ❌ FAIL | Reason not displayed |
| Link to document shown if present | ❌ FAIL | Document indicator not shown |

**Overall Status**: 0/4 criteria met (0%)

---

## Impact Assessment

**Severity**: HIGH

**Impact**:
- Developers cannot see rejection reasons in timeline view
- QA agents' feedback is invisible in the timeline
- Violates Story 6 acceptance criteria completely
- Reduces feature value by ~40% (timeline view is key user interface)

**User Stories Affected**:
- Story 2: Developer viewing rejection reasons (timeline is one of the primary interfaces)
- Story 6: Timeline integration (completely broken)

**Workflow Impact**:
- Developers must use `shark task get` to see rejections (workaround exists)
- Timeline view provides incomplete history
- AI agents relying on timeline for context miss rejection information

---

## Recommended Fix

### Option 1: Use TaskHistoryRepository (Simplest)

Change `internal/cli/commands/task_note.go` line 330 to use `TaskHistoryRepository`:

```go
// BEFORE (broken)
rejections, err := noteRepo.GetRejectionHistory(ctx, task.ID)

// AFTER (fixed)
historyRepo := repository.NewTaskHistoryRepository(repoDb)
historyRejections, err := historyRepo.GetRejectionHistoryForTask(ctx, task.ID)
```

Then transform `[]*models.TaskHistory` to `[]*RejectionHistoryEntry` format for timeline display.

**Pros**:
- Minimal code change
- Uses existing working storage
- Matches actual implementation

**Cons**:
- Deviates from original design (task_notes storage)

### Option 2: Implement Dual Storage (Original Design)

Store rejection as BOTH:
1. `task_history.rejection_reason` (for audit trail)
2. `task_notes` with `note_type='rejection'` (for retrieval)

**Pros**:
- Matches original feature design
- Allows querying rejections via note system

**Cons**:
- More complex
- Duplicate data storage
- Requires transaction to keep in sync

---

## Recommendation

**Option 1** (use TaskHistoryRepository) is recommended because:
1. It's the simplest fix (< 20 lines of code)
2. Rejection reasons are already stored correctly in task_history
3. Maintains single source of truth
4. Can be implemented and tested in < 1 hour

---

## Test Data Cleanup

Test entities created:
- Epic: E15 "QA Test Epic"
- Feature: E15-F01 "QA Test Feature"
- Task: T-E15-F01-001 "Test task for rejection display"

**Action**: These test entities can be deleted after bug fix verification.

---

## QA Decision

**Status**: ❌ **FAIL**

**Reason**: Critical functionality (timeline rejection display) is completely broken due to data source mismatch between storage and retrieval.

**Next Steps**:
1. Task should be rejected back to `in_development`
2. Developer should implement Option 1 fix (use TaskHistoryRepository)
3. Re-test after fix with same test cases
4. Verify all 4 Story 6 acceptance criteria pass

**Blocker**: This blocks completion of E07-F22 feature as timeline integration is a must-have story.

---

## Additional Notes

- The timeline display code (lines 350-406) is actually well-implemented with proper ⚠️ formatting
- The bug is purely in data retrieval layer (wrong repository method called)
- Fix is straightforward and low-risk
- No schema changes required

**Estimated Fix Time**: 1-2 hours (including testing)

---

**QA Agent**: qa-agent
**Report Generated**: 2026-01-17 01:07:24
