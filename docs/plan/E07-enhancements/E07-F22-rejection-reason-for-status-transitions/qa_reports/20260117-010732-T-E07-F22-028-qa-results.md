# QA Results: T-E07-F22-028 - Add rejection reason to task history display

**QA Agent:** qa-agent
**Date:** 2026-01-17 01:07:32
**Task:** T-E07-F22-028
**Status:** FAILED ❌

## Executive Summary

The task history display correctly shows rejection reasons, but the task get command has a critical bug that prevents it from displaying rejection history.

## Test Results

### ✅ PASS: `shark task history` Command

**Test:** Verify task history displays rejection reasons prominently

**Steps:**
1. Created test task: T-E07-F22-032
2. Moved task through workflow: draft → ready_for_refinement → in_refinement → ready_for_development → in_development → ready_for_code_review
3. Rejected task with reason: `shark task update T-E07-F22-032 --status in_development --reason "Missing error handling for edge cases. Added TODO comments in code."`
4. Viewed history: `shark task history T-E07-F22-032`

**Expected:** Rejection reason displayed prominently in red

**Actual:** ✅ Rejection reason displayed correctly:
```
├─ 2026-01-17 07:06:12 ready_for_code_review → in_development (just now)
│  Rejection: Missing error handling for edge cases. Added TODO comments in code.
```

**Notes:** Color coding works correctly (red for rejection)

---

### ✅ PASS: JSON Output includes rejection_reason

**Test:** Verify JSON output includes all rejection_reason fields

**Command:** `shark task history T-E07-F22-032 --json`

**Expected:** JSON includes rejection_reason field

**Actual:** ✅ Correct JSON output:
```json
{
  "timestamp": "2026-01-17T07:06:12Z",
  "relative_age": "15 seconds ago",
  "old_status": "ready_for_code_review",
  "new_status": "in_development",
  "rejection_reason": "Missing error handling for edge cases. Added TODO comments in code."
}
```

---

### ❌ FAIL: `shark task get` Last Rejection Display

**Test:** Verify task get shows "Last Rejection" section if rejection exists

**Command:** `shark task get T-E07-F22-032`

**Expected:** Should display:
```
⚠️  REJECTION HISTORY (1 rejections)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[2026-01-17 07:06:12] Rejected by <agent>
ready_for_code_review → in_development

Reason:
Missing error handling for edge cases. Added TODO comments in code.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**Actual:** ❌ No rejection history displayed

**Root Cause:** Bug in implementation - `task get` command fetches rejection history from `task_notes` table via `noteRepo.GetRejectionHistory()`, but the rejection_reason is stored in `task_history` table, not `task_notes`.

**Evidence:**
```sql
-- task_history has the rejection_reason
SELECT timestamp, old_status, new_status, rejection_reason
FROM task_history
WHERE task_id = (SELECT id FROM tasks WHERE key = 'T-E07-F22-032')
ORDER BY id DESC LIMIT 1;

Result: 2026-01-17 07:06:12|ready_for_code_review|in_development|Missing error handling for edge cases...

-- task_notes is empty
SELECT COUNT(*) FROM task_notes
WHERE task_id = (SELECT id FROM tasks WHERE key = 'T-E07-F22-032');

Result: 0
```

**Fix Required:** Update `internal/cli/commands/task.go` lines 683-691 to fetch rejection history from task_history instead of task_notes.

Current code:
```go
// Get rejection history
noteRepo := repository.NewTaskNoteRepository(repoDb)
rejectionHistory, err := noteRepo.GetRejectionHistory(ctx, task.ID)
```

Should be:
```go
// Get rejection history from task_history
historyRepo := repository.NewTaskHistoryRepository(repoDb)
historyEntries, err := historyRepo.GetHistoryByTaskID(ctx, task.ID)
// Filter for entries with non-empty rejection_reason
```

---

## Acceptance Criteria Results

| Criterion | Status | Notes |
|-----------|--------|-------|
| `shark task get` shows "Last Rejection" section if rejection exists | ❌ FAIL | Implementation queries wrong table |
| Last rejection includes reason, timestamp, from_status, agent | ❌ FAIL | Not displayed due to table mismatch |
| `shark task history` command displays all history entries | ✅ PASS | Works correctly |
| History entries show rejection reasons prominently (warning color) | ✅ PASS | Red color displayed correctly |
| History entries ordered chronologically (most recent first) | ✅ PASS | Correct ordering |
| JSON output includes all rejection_reason fields | ✅ PASS | Field present in JSON |
| Tasks without rejections display normally (no error) | ✅ PASS | No errors observed |
| Empty rejection reasons not displayed (omitted) | ✅ PASS | Empty reasons not shown |

**Overall: 6/8 criteria met (75%)**

## Critical Bug

**Bug:** `task get` command cannot display rejection history because it queries `task_notes` table instead of `task_history` table.

**Severity:** High - Core feature of this task is non-functional

**Impact:** Developers cannot see rejection feedback in task details, defeating the purpose of the feature

**Recommendation:** Block approval until fixed

## Files Reviewed

- ✅ `internal/cli/commands/task_history.go` - Correctly implemented
- ❌ `internal/cli/commands/task.go` (lines 683-691, 829-849) - Bug in runTaskGet function
- ✅ `internal/repository/task_note_repository.go` - GetRejectionHistory queries wrong table
- ✅ Database schema - rejection_reason field exists in task_history table

## Test Coverage

Manual testing performed:
- ✅ Task history command (human-readable output)
- ✅ Task history command (JSON output)
- ❌ Task get command (human-readable output) - FAILED
- ❌ Task get command (JSON output) - FAILED (empty rejection_history array)

## Recommendations

1. **Fix bug in task.go:** Update runTaskGet to fetch from task_history instead of task_notes
2. **Add integration test:** Create test that verifies task get displays rejection history
3. **Re-test after fix:** Verify all acceptance criteria pass

## QA Status: FAILED

**Reason:** Critical bug prevents core feature from working

**Next Steps:**
1. Create bug fix task
2. Update task get implementation
3. Re-run QA tests
4. Verify all acceptance criteria pass
