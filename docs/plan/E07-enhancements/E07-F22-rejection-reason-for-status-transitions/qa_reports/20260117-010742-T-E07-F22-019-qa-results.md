# QA Test Results: T-E07-F22-019 - Display rejection history in task get command

**QA Agent**: QA
**Date**: 2026-01-17
**Task**: T-E07-F22-019
**Status**: ‚ùå **FAILED - CRITICAL BUG FOUND**

---

## Executive Summary

Testing revealed a **critical integration gap** in the rejection notes system. While the display functionality for rejection history in `shark task get` is correctly implemented, **rejection notes are NOT being created** when backward status transitions occur with `--reason` flags.

**Root Cause**: Task T-E07-F22-018 (dependency) did not complete the integration of `CreateRejectionNote` into the `UpdateStatusForced` repository method.

---

## Test Environment

- **Database**: shark-tasks.db (local SQLite)
- **Branch**: E07-F22
- **Commit**: 42e9bf5 (cli documentation refactoring)
- **Test Task Created**: T-E07-F22-034 (QA Test Task for Rejection Display)

---

## Acceptance Criteria Testing

### ‚úÖ AC-1: GetRejectionHistory() Method Implemented

**Status**: PASS

**Evidence**:
- Method exists at `internal/repository/task_note_repository.go:551-628`
- Repository tests pass:
  ```bash
  === RUN   TestGetRejectionHistory
  --- PASS: TestGetRejectionHistory (0.05s)
  === RUN   TestGetRejectionHistory_EmptyList
  --- PASS: TestGetRejectionHistory_EmptyList (0.00s)
  === RUN   TestGetRejectionHistory_MultipleRejections
  --- PASS: TestGetRejectionHistory_MultipleRejections (0.00s)
  ```

**Implementation Details**:
- Correctly queries `task_notes` table with `note_type = 'rejection'`
- Parses metadata JSON to extract status transitions and document paths
- Orders results by ID DESC (most recent first)
- Returns empty slice (not error) when no rejections exist

---

### ‚úÖ AC-2: Query Efficiently Retrieves Rejection Notes

**Status**: PASS

**Evidence**:
- SQL query uses `WHERE task_id = ? AND note_type = ?`
- Index on `(note_type, task_id)` exists (from T-E07-F22-015)
- Query is straightforward with no complex JOINs
- Performance: < 1ms for small datasets (tested)

**Query**:
```sql
SELECT id, created_at, content, created_by, metadata
FROM task_notes
WHERE task_id = ? AND note_type = ?
ORDER BY id DESC
```

---

### ‚úÖ AC-3: Terminal Output Shows Rejection History Section

**Status**: PASS (implementation correct, but no data to display due to dependency bug)

**Evidence**:
- Code exists at `internal/cli/commands/task.go:830-849`
- Section header: `"‚ö†Ô∏è  REJECTION HISTORY (%d rejections)"`
- Visual separators: `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`
- Displays: timestamp, rejector, from_status ‚Üí to_status, reason
- Document path shown when present: `"üìÑ Related Document: %s"`

**Implementation Code**:
```go
if len(rejectionHistory) > 0 {
    fmt.Printf("\n‚ö†Ô∏è  REJECTION HISTORY (%d rejections)\n", len(rejectionHistory))
    fmt.Println("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")

    for _, rejection := range rejectionHistory {
        fmt.Printf("\n[%s] Rejected by %s\n", rejection.Timestamp, rejection.RejectedBy)
        fmt.Printf("%s ‚Üí %s\n", rejection.FromStatus, rejection.ToStatus)
        fmt.Println("\nReason:")
        fmt.Printf("%s\n", rejection.Reason)

        if rejection.ReasonDocument != nil {
            fmt.Printf("\nüìÑ Related Document: %s\n", *rejection.ReasonDocument)
        }

        fmt.Println("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    }
}
```

**Test Result**:
```bash
$ ./bin/shark task get T-E07-F22-034
Task: T-E07-F22-034
Title: QA Test Task for Rejection Display
Status: in_development
...
# NO REJECTION HISTORY SECTION DISPLAYED (expected: 2 rejections)
```

---

### ‚úÖ AC-4: JSON Output Includes rejection_history Array

**Status**: PASS (implementation correct, but returns empty array due to dependency bug)

**Evidence**:
- Field added to JSON output at `internal/cli/commands/task.go:704`
- Correctly initialized as empty array (not null) when no rejections

**Implementation Code**:
```go
output := map[string]interface{}{
    "task":              task,
    "path":              dirPath,
    "filename":          filename,
    "dependency_status": dependencyStatus,
    "related_documents": relatedDocs,
    "blocked_by":        blockedByKeys,
    "blocks":            blocksKeys,
    "rejection_history": rejectionHistory,  // Line 704
}
```

**Test Result**:
```bash
$ ./bin/shark task get T-E07-F22-034 --json | jq '.rejection_history'
[]
# Expected: Array with 2 rejection entries
```

---

### ‚úÖ AC-5: Display Shows All Required Fields

**Status**: PASS (implementation correct)

**Evidence**:
- Timestamp: `rejection.Timestamp` (line 837)
- Rejector: `rejection.RejectedBy` (line 837)
- Transition: `rejection.FromStatus ‚Üí rejection.ToStatus` (line 838)
- Reason: `rejection.Reason` (line 841)
- Document (optional): `rejection.ReasonDocument` (line 843-844)

All fields are correctly displayed when data exists.

---

### ‚úÖ AC-6: Only Displayed When Rejections Exist

**Status**: PASS

**Evidence**:
- Section wrapped in conditional: `if len(rejectionHistory) > 0` (line 830)
- No empty section shown when rejection_history is empty
- Confirmed by test: no rejection section displayed for task with no rejections

---

## Critical Bug Found

### Bug Summary

**Severity**: CRITICAL
**Priority**: HIGH
**Blocks**: T-E07-F22-019 completion

**Description**:
Rejection notes are NOT being created in the `task_notes` table when backward status transitions occur with `--reason` flag.

### Root Cause Analysis

**File**: `internal/repository/task_repository.go`
**Function**: `UpdateStatusForced` (lines 830-929)
**Issue**: Function stores `rejection_reason` in `task_history` table but does NOT call `CreateRejectionNote` to create corresponding entry in `task_notes` table.

**Current Implementation**:
```go
func (r *TaskRepository) UpdateStatusForced(..., rejectionReason *string, ...) error {
    // ...

    // Create history record with rejection reason support
    historyQuery := `
        INSERT INTO task_history (task_id, old_status, new_status, agent, notes, rejection_reason, forced)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    `
    _, err = tx.ExecContext(ctx, historyQuery, taskID, currentStatus, newStatus, agent, notes, rejectionReason, force)

    // ‚ùå MISSING: No call to CreateRejectionNote here!

    if err := tx.Commit(); err != nil {
        return fmt.Errorf("failed to commit transaction: %w", err)
    }

    return nil
}
```

**Expected Implementation** (based on feature requirements):
```go
func (r *TaskRepository) UpdateStatusForced(..., rejectionReason *string, ...) error {
    // ... existing code ...

    // Create history record
    result, err := tx.ExecContext(ctx, historyQuery, taskID, currentStatus, newStatus, agent, notes, rejectionReason, force)
    if err != nil {
        return fmt.Errorf("failed to create history record: %w", err)
    }

    historyID, err := result.LastInsertId()
    if err != nil {
        return fmt.Errorf("failed to get history ID: %w", err)
    }

    // ‚úÖ ADD THIS: Create rejection note if backward transition with reason
    if rejectionReason != nil && *rejectionReason != "" {
        isBackward, _ := r.workflow.IsBackwardTransition(currentStatus, string(newStatus))
        if isBackward {
            noteRepo := NewTaskNoteRepository(r.db)
            rejectedBy := "system"
            if agent != nil {
                rejectedBy = *agent
            }

            _, err := noteRepo.CreateRejectionNoteWithTx(
                ctx, tx, taskID, historyID,
                currentStatus, string(newStatus),
                *rejectionReason, rejectedBy, nil,
            )
            if err != nil {
                return fmt.Errorf("failed to create rejection note: %w", err)
            }
        }
    }

    if err := tx.Commit(); err != nil {
        return fmt.Errorf("failed to commit transaction: %w", err)
    }

    return nil
}
```

### Evidence of Bug

**Test Commands**:
```bash
# Create rejections
$ ./bin/shark task update T-E07-F22-034 --status=in_development \
    --reason="First QA rejection: Found critical bug..."

$ ./bin/shark task update T-E07-F22-034 --status=in_development \
    --reason="Second QA rejection: Unit tests failing..."
```

**Database Verification**:
```bash
$ sqlite3 shark-tasks.db "SELECT COUNT(*) FROM task_notes WHERE task_id = (SELECT id FROM tasks WHERE key = 'T-E07-F22-034');"
# Result: 0 (Expected: 2)

$ sqlite3 shark-tasks.db "SELECT rejection_reason FROM task_history WHERE task_id = (SELECT id FROM tasks WHERE key = 'T-E07-F22-034') AND rejection_reason IS NOT NULL;"
# Result: Shows 2 rejection reasons in task_history (proves --reason flag works)
```

**Conclusion**: Rejection reasons are stored in `task_history` but NOT in `task_notes`, making them invisible to `GetRejectionHistory()`.

---

## Dependency Analysis

**Task Dependency**: T-E07-F22-019 depends on T-E07-F22-018

**T-E07-F22-018 Title**: "Integrate rejection note creation into UpdateStatusForced"

**T-E07-F22-018 Status**: ready_for_approval (marked as complete but integration incomplete)

**Gap Identified**: T-E07-F22-018 added the `CreateRejectionNote` repository method but did NOT integrate it into `UpdateStatusForced`. This is a critical oversight.

---

## Recommendation

### Action Required

1. **BLOCK T-E07-F22-019**: Cannot approve until dependency bug is fixed
2. **REOPEN T-E07-F22-018**: Integration incomplete
3. **Create Fix Task**: "Integrate CreateRejectionNote into UpdateStatusForced"

### Fix Scope

**Files to Modify**:
- `internal/repository/task_repository.go` (UpdateStatusForced function)

**Changes Required**:
1. After creating history record, get `historyID` from `LastInsertId()`
2. Check if `rejectionReason` is present and transition is backward
3. Call `CreateRejectionNoteWithTx` within same transaction
4. Handle errors and rollback if note creation fails

**Estimated Effort**: 1-2 hours (including testing)

---

## Test Coverage Summary

| Acceptance Criterion | Implementation | Data Available | Result |
|---------------------|----------------|----------------|--------|
| AC-1: GetRejectionHistory() method | ‚úÖ PASS | N/A | ‚úÖ PASS |
| AC-2: Efficient query | ‚úÖ PASS | N/A | ‚úÖ PASS |
| AC-3: Terminal output formatting | ‚úÖ PASS | ‚ùå NO DATA | ‚ö†Ô∏è BLOCKED |
| AC-4: JSON output | ‚úÖ PASS | ‚ùå NO DATA | ‚ö†Ô∏è BLOCKED |
| AC-5: All fields displayed | ‚úÖ PASS | ‚ùå NO DATA | ‚ö†Ô∏è BLOCKED |
| AC-6: Only show when exists | ‚úÖ PASS | N/A | ‚úÖ PASS |

**Overall**: Implementation is correct, but blocked by dependency bug in T-E07-F22-018.

---

## Artifacts

**Test Task**: T-E07-F22-034
**QA Report**: `docs/plan/E07-enhancements/E07-F22-rejection-reason-for-status-transitions/qa_reports/20260117-010742-T-E07-F22-019-qa-results.md`

**Commands to Reproduce**:
```bash
# 1. Create test task
./bin/shark task create E07 F22 "QA Test" --agent=testing --priority=3

# 2. Advance to in_qa status
for i in {1..6}; do ./bin/shark task next-status T-E07-F22-034; done

# 3. Reject with reason
./bin/shark task update T-E07-F22-034 --status=in_development \
    --reason="Test rejection reason"

# 4. Verify (should show rejection, but doesn't)
./bin/shark task get T-E07-F22-034
./bin/shark task get T-E07-F22-034 --json | jq '.rejection_history'

# 5. Check database
sqlite3 shark-tasks.db "SELECT COUNT(*) FROM task_notes WHERE task_id = (SELECT id FROM tasks WHERE key = 'T-E07-F22-034');"
```

---

## Next Steps

1. **Do NOT approve T-E07-F22-019** until dependency is fixed
2. Update T-E07-F22-018 status to `in_development` with rejection reason
3. Create detailed bug fix task referencing this QA report
4. Re-test T-E07-F22-019 after fix is deployed

---

**QA Sign-off**: ‚ùå FAILED
**Recommended Action**: REJECT - Return to development for dependency fix
