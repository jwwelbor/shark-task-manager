# Code Review: T-E07-F22-020 - Implement document linking with reason-doc flag

**Reviewer:** TechLead Agent
**Date:** 2026-01-16
**Status:** ❌ **REJECTED** - Implementation Incomplete

---

## Summary

The implementation adds the `--reason-doc` flag to `task approve` and `task reopen` commands but **does not actually use the flag**. The flag is declared but never read or processed in the command handlers.

## Critical Issues

### 1. **Flag declared but never used** (BLOCKER)
**File:** `internal/cli/commands/task.go`

**Lines 2112, 2124:**
```go
taskApproveCmd.Flags().String("reason-doc", "", "Path to document containing rejection reason...")
taskReopenCmd.Flags().String("reason-doc", "", "Path to document containing rejection reason...")
```

**Problem:** The flags are declared but:
- Never read with `cmd.Flags().GetString("reason-doc")`
- Never validated
- Never passed to repository layer
- Never stored in rejection note metadata

**Expected behavior:**
```go
// In runTaskApprove and runTaskReopen
reasonDoc, _ := cmd.Flags().GetString("reason-doc")

// Validate document path if provided
if reasonDoc != "" {
    if err := ValidateRejectionReasonDocPath(reasonDoc); err != nil {
        return fmt.Errorf("invalid document path: %w", err)
    }

    // Verify file exists
    projectRoot, _ := pathresolver.FindProjectRoot()
    fullPath := filepath.Join(projectRoot, reasonDoc)
    if _, err := os.Stat(fullPath); os.IsNotExist(err) {
        return fmt.Errorf("document not found: %s", reasonDoc)
    }
}
```

### 2. **Missing metadata integration** (BLOCKER)
**Task requirement:** Store document path in rejection note metadata

**Problem:** No code to:
- Build metadata JSON with document path
- Pass metadata to `CreateRejectionNote()` repository method
- Link document to task (if document repository exists)

**Expected behavior:**
```go
// Build metadata if document path provided
var metadata string
if reasonDoc != "" {
    metadata = BuildRejectionReasonMetadata(reasonDoc)
}

// Pass to repository
err := noteRepo.CreateRejectionNote(ctx, task.ID, reason, metadata)
```

### 3. **Test compilation errors** (HIGH)
**File:** `internal/cli/commands/notes_search_test.go`

**Errors:**
```
MockTaskRepository redeclared in this block
m.GetByIDFunc undefined (type *MockTaskRepository has no field or method GetByIDFunc)
```

**Impact:** Tests cannot run, preventing validation of existing functionality.

**Cause:** Conflicting mock repository definitions between test files.

---

## Missing Implementation

### What was implemented:
✅ Flag declaration on `task approve` and `task reopen` commands
✅ Validator function `ValidateRejectionReasonDocPath()` in `validators_reason_doc.go`
✅ Helper function `BuildRejectionReasonMetadata()` in test file
✅ Mock repository for document linking tests
✅ Test cases for path validation

### What was NOT implemented:
❌ Reading the `--reason-doc` flag value in command handlers
❌ Validating document path before processing
❌ Verifying file exists on filesystem
❌ Building metadata JSON with document path
❌ Passing metadata to `CreateRejectionNote()` repository method
❌ Linking document to task (if document table exists)
❌ Integration tests showing end-to-end document linking

---

## Required Changes

### 1. Implement flag handling in `runTaskApprove()`

**File:** `internal/cli/commands/task.go` (around line 1705)

Add after force flag handling:
```go
// Get rejection reason and document path
reason, _ := cmd.Flags().GetString("reason")
reasonDoc, _ := cmd.Flags().GetString("reason-doc")

// Validate document path if provided
if reasonDoc != "" {
    if err := ValidateRejectionReasonDocPath(reasonDoc); err != nil {
        return fmt.Errorf("invalid document path: %w", err)
    }

    // Verify file exists
    projectRoot, _ := pathresolver.FindProjectRoot()
    fullPath := filepath.Join(projectRoot, reasonDoc)
    if _, err := os.Stat(fullPath); os.IsNotExist(err) {
        return fmt.Errorf("document not found: %s\nPlease verify the file path and try again", reasonDoc)
    }
}

// Build metadata if document path provided
var metadata string
if reasonDoc != "" {
    metadata = BuildRejectionReasonMetadata(reasonDoc)
}

// Create rejection note with metadata
noteRepo := repository.NewTaskNoteRepository(dbWrapper)
if err := noteRepo.CreateRejectionNote(ctx, task.ID, reason, metadata); err != nil {
    return fmt.Errorf("failed to create rejection note: %w", err)
}

// If document repository exists, link document to task
// (This would be optional if documents table doesn't exist yet)
```

### 2. Implement flag handling in `runTaskReopen()`

**File:** `internal/cli/commands/task.go` (around line 1930)

Same pattern as above - add document path handling.

### 3. Move `BuildRejectionReasonMetadata()` to production code

**Current location:** `task_reason_doc_test.go` (test helper)
**New location:** `validators_reason_doc.go` (production code)

This function is needed by the command handlers, not just tests.

### 4. Fix test compilation errors

**File:** `internal/cli/commands/notes_search_test.go`

- Remove duplicate `MockTaskRepository` definition
- Use existing mock from `mock_task_repository.go`
- Fix method name conflicts (`GetByIDFunc` vs existing interface)

---

## Test Gaps

### Unit tests exist for:
✅ Flag presence verification
✅ Path validation (relative, no traversal, no absolute)
✅ Mock document repository operations
✅ Metadata JSON formatting

### Missing integration tests:
❌ End-to-end: `task approve --reason-doc=path/to/doc.md`
❌ Verification that document path is stored in task note metadata
❌ Verification that file existence is checked
❌ Error handling when document path is invalid
❌ Error handling when document file doesn't exist

---

## Recommendations

### Immediate (Required for approval):
1. **Implement flag reading** in `runTaskApprove()` and `runTaskReopen()`
2. **Add document path validation** before creating rejection note
3. **Build and pass metadata** to `CreateRejectionNote()` repository method
4. **Move helper functions** from test to production code
5. **Fix test compilation errors** in `notes_search_test.go`

### Follow-up (Nice to have):
- Add integration test showing full document linking workflow
- Consider adding file existence check to validator (currently done in command handler)
- Document the metadata JSON schema for rejection notes
- Add example showing how to query rejection notes with document links

---

## Architecture Compliance

### ✅ Follows existing patterns:
- Flag declaration syntax matches other commands
- Validator function follows naming convention
- Mock repository matches existing test patterns

### ❌ Deviates from patterns:
- Incomplete flag handling (declared but not used)
- Metadata building logic split between test and production
- Missing error context wrapping for file existence checks

---

## Severity Assessment

**Overall:** ⚠️ **CRITICAL** - Core functionality not implemented

**Breaking issues:**
- Flag has no effect (declared but unused)
- Document path never validated or stored
- Feature PRD requirements not met

**Impact:**
- Users cannot link rejection documents to tasks
- `--reason-doc` flag silently ignored
- Test compilation broken

---

## Decision

**Status:** ❌ **REJECTED**

**Reason:** Core feature requirement (REQ-F-005: Document Linking) not implemented. Flag exists but has no functionality.

**Next steps:**
1. Developer must implement flag reading and document path processing
2. Fix test compilation errors
3. Add integration tests
4. Re-submit for code review

**Estimated rework:** 2-3 hours

---

## Success Criteria for Re-Submission

- [ ] `--reason-doc` flag is read from command line
- [ ] Document path is validated (relative, no traversal)
- [ ] File existence is verified on filesystem
- [ ] Document path is stored in rejection note metadata as JSON
- [ ] All tests compile and pass
- [ ] Error messages guide users when document path is invalid or file missing
- [ ] Integration test demonstrates end-to-end workflow

---

**Code review completed: 2026-01-16 20:29:45 UTC**
