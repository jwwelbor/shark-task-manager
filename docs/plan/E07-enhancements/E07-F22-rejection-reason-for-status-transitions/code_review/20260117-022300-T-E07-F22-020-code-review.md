# Code Review: T-E07-F22-020 - Implement document linking with reason-doc flag

**Review Date:** 2026-01-17 08:23:00
**Reviewer:** TechLead Agent
**Task:** T-E07-F22-020
**Status:** ❌ FAILED - Critical Bug in task next-status command

---

## Executive Summary

The implementation has **ONE CRITICAL BUG** remaining:

**BUG**: `shark task next-status` non-force path calls `UpdateStatus` with wrong parameters, causing document path to be stored in the wrong field.

**Evidence:**
```bash
# Command executed:
shark task next-status T-E07-F22-020 --status=in_development \
  --reason="Testing next-status rejection with document" \
  --reason-doc="docs/plan/.../code-review.md"

# Result in database (WRONG):
{
  "rejected_by": "Testing next-status rejection with document",  # reason in wrong field
  "reason": "docs/plan/.../code-review.md",                      # document in wrong field
  "reason_document": null                                         # should be here!
}

# Expected result:
{
  "rejected_by": "system",
  "reason": "Testing next-status rejection with document",
  "reason_document": "docs/plan/.../code-review.md"
}
```

**Verdict:** REJECT - Fix parameter order in task next-status

---

## What Works ✅

### 1. task update command (100% working)

**File:** `internal/cli/commands/task.go` (line 2479)

```go
err = workflowRepo.UpdateStatusForced(ctx, task.ID, newStatus, nil, nil, rejectionReasonPtr, documentPath, force)
```

**Test verification:**
```bash
shark task update T-E07-F22-020 --status=in_development \
  --reason="Testing backward transition with document" \
  --reason-doc="docs/plan/.../code-review.md"

# Result (CORRECT):
{
  "reason": "Testing backward transition with document",
  "reason_document": "docs/plan/.../code-review.md"
}
```

✅ Document path properly stored
✅ Reason text properly stored
✅ All parameters in correct order

### 2. task next-status FORCE path (100% working)

**File:** `internal/cli/commands/task_next_status.go` (line 337)

```go
err = taskRepo.UpdateStatusForced(ctx, task.ID, models.TaskStatus(targetStatus), nil, nil, rejectionReasonPtr, documentPath, true)
```

✅ Uses UpdateStatusForced with all parameters
✅ Passes documentPath in correct position (6th parameter)

---

## What Doesn't Work ❌

### Bug: task next-status NON-FORCE path

**Severity:** CRITICAL
**Impact:** Document paths not stored correctly when using non-force transitions

**Location:** `internal/cli/commands/task_next_status.go` (line 339)

**Current code (WRONG):**
```go
} else {
    err = taskRepo.UpdateStatus(ctx, task.ID, models.TaskStatus(targetStatus), rejectionReasonPtr, documentPath)
}
```

**UpdateStatus signature:**
```go
func (r *TaskRepository) UpdateStatus(ctx context.Context, taskID int64, newStatus models.TaskStatus, agent *string, notes *string) error
```

**Parameter mapping (WRONG):**
- Parameter 3 (`agent`): Receives `rejectionReasonPtr` ❌ (should be agent or nil)
- Parameter 4 (`notes`): Receives `documentPath` ❌ (should be notes or nil)

**Result:**
- `rejectionReasonPtr` goes into `agent` field in UpdateStatusForced call
- `documentPath` goes into `notes` field in UpdateStatusForced call
- Both end up in wrong database fields

---

## Root Cause Analysis

**The problem:** `UpdateStatus` has an old signature that doesn't support `rejectionReason` and `documentPath` as separate parameters.

**Old signature (5 parameters):**
```go
UpdateStatus(ctx, taskID, newStatus, agent, notes) error
```

**New signature needed (7 parameters):**
```go
UpdateStatus(ctx, taskID, newStatus, agent, notes, rejectionReason, documentPath) error
```

**Current workaround in UpdateStatus:**
```go
func (r *TaskRepository) UpdateStatus(..., agent *string, notes *string) error {
    // Passes notes as BOTH notes AND rejectionReason
    return r.UpdateStatusForced(ctx, taskID, newStatus, agent, notes, notes, nil, false)
}
```

This workaround doesn't support separate `rejectionReason` and `documentPath`.

---

## Required Fix

### Option 1: Update UpdateStatus signature (RECOMMENDED)

**Change:**
```go
// OLD
func (r *TaskRepository) UpdateStatus(ctx context.Context, taskID int64, newStatus models.TaskStatus, agent *string, notes *string) error

// NEW
func (r *TaskRepository) UpdateStatus(ctx context.Context, taskID int64, newStatus models.TaskStatus, agent *string, notes *string, rejectionReason *string, documentPath *string) error
```

**Update implementation:**
```go
func (r *TaskRepository) UpdateStatus(ctx context.Context, taskID int64, newStatus models.TaskStatus, agent *string, notes *string, rejectionReason *string, documentPath *string) error {
    return r.UpdateStatusForced(ctx, taskID, newStatus, agent, notes, rejectionReason, documentPath, false)
}
```

**Update call site (task_next_status.go line 339):**
```go
err = taskRepo.UpdateStatus(ctx, task.ID, models.TaskStatus(targetStatus), nil, nil, rejectionReasonPtr, documentPath)
```

**Impact:** Requires updating ALL callers of UpdateStatus (check with grep)

### Option 2: Always use UpdateStatusForced (SIMPLER)

**Change task_next_status.go line 339:**
```go
// OLD
err = taskRepo.UpdateStatus(ctx, task.ID, models.TaskStatus(targetStatus), rejectionReasonPtr, documentPath)

// NEW
err = taskRepo.UpdateStatusForced(ctx, task.ID, models.TaskStatus(targetStatus), nil, nil, rejectionReasonPtr, documentPath, false)
```

**Impact:** Minimal - only changes one line in one file

---

## Testing Plan

### Test 1: Verify task next-status stores document path correctly

```bash
# 1. Move task to ready_for_code_review
shark task next-status T-E07-F22-020 --status=ready_for_code_review

# 2. Test rejection with document
shark task next-status T-E07-F22-020 --status=in_development \
  --reason="Code review found issues" \
  --reason-doc="docs/plan/.../code-review.md"

# 3. Verify document stored correctly
shark task get T-E07-F22-020 --json | jq '.rejection_history[0]'

# Expected output:
{
  "reason": "Code review found issues",
  "reason_document": "docs/plan/.../code-review.md"
}
```

### Test 2: Verify backward compatibility

```bash
# Test without --reason-doc flag
shark task next-status T-E07-F22-020 --status=ready_for_code_review

shark task next-status T-E07-F22-020 --status=in_development \
  --reason="No document provided"

# Verify: reason_document should be null, reason should be present
shark task get T-E07-F22-020 --json | jq '.rejection_history[0]'
```

### Test 3: Check other UpdateStatus callers

```bash
# Find all callers
grep -rn "\.UpdateStatus(" internal/

# Verify none are affected by signature change
# If using Option 2 (always use UpdateStatusForced), this is not needed
```

---

## Recommendation

**Use Option 2: Always use UpdateStatusForced**

**Rationale:**
1. **Minimal change**: Only one line to fix
2. **No breaking changes**: Doesn't affect other callers
3. **Consistent**: Both force and non-force paths use same method
4. **Clear intent**: Explicit parameters make code easier to understand

**Implementation:**

```diff
File: internal/cli/commands/task_next_status.go (line 339)

  if force {
      err = taskRepo.UpdateStatusForced(ctx, task.ID, models.TaskStatus(targetStatus), nil, nil, rejectionReasonPtr, documentPath, true)
  } else {
-     err = taskRepo.UpdateStatus(ctx, task.ID, models.TaskStatus(targetStatus), rejectionReasonPtr, documentPath)
+     err = taskRepo.UpdateStatusForced(ctx, task.ID, models.TaskStatus(targetStatus), nil, nil, rejectionReasonPtr, documentPath, false)
  }
```

**Estimated fix time:** 5 minutes

---

## Files Reviewed

- ✅ `internal/repository/task_repository.go` - UpdateStatusForced (CORRECT)
- ✅ `internal/repository/task_note_repository.go` - CreateRejectionNoteWithTx (CORRECT)
- ✅ `internal/cli/commands/task.go` - runTaskUpdate (WORKING)
- ❌ `internal/cli/commands/task_next_status.go` - performTransition (BUG FOUND - line 339)

---

## Review Checklist

- [x] Repository layer properly accepts documentPath parameter ✅
- [x] Document path correctly stored in metadata when provided ✅
- [x] Document path validation implemented (format check) ✅
- [x] File existence validation implemented ✅
- [x] task update stores document path correctly ✅
- [ ] task next-status stores document path correctly ❌ BUG (non-force path)
- [x] task next-status force path stores document path correctly ✅
- [x] --reason-doc flag registered on all commands ✅
- [ ] No parameter ordering bugs ❌ FAILED (line 339)

**Overall Assessment: 8/9 items complete (89%)**

---

**Code Review Result:** ❌ REJECT

**Primary Reason:** Critical bug in task next-status non-force path - wrong parameter order

**Action:** Fix line 339 in task_next_status.go to use UpdateStatusForced with correct parameters

**Estimated Fix Time:** 5 minutes

**Next Review:** Re-test after fix to verify document paths stored correctly
