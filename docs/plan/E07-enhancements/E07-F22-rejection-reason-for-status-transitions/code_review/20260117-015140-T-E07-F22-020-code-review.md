# Code Review: T-E07-F22-020 - Implement document linking with reason-doc flag

**Reviewer:** TechLead Agent
**Date:** 2026-01-17 01:51:40
**Task:** T-E07-F22-020
**Status:** REJECTED - Implementation Incomplete

## Summary

The implementation adds the `--reason-doc` flag to CLI commands and validates document paths, but **fails to pass the document path to the repository layer**, making it non-functional. The document path is validated and checked for existence in the CLI but is not stored in rejection note metadata or linked to tasks.

## Critical Issues (Must Fix)

### 1. Document Path Not Passed to Repository ❌

**Location:** `internal/repository/task_repository.go:949-952`

**Issue:** The `UpdateStatusForced` method validates the document path in CLI but passes `nil` instead of the document path to `CreateRejectionNoteWithTx`:

```go
_, err := noteRepo.CreateRejectionNoteWithTx(
    ctx, tx, taskID, historyID,
    currentStatus, string(newStatus),
    *rejectionReason, rejectedBy, nil,  // <-- Should be documentPath, not nil
)
```

**Expected:**
- CLI should extract the `reasonDocFlag` value
- Pass it through the call chain: CLI → Repository → CreateRejectionNoteWithTx
- Store in rejection note metadata

**Impact:** The entire feature is non-functional. Document paths are never stored even when provided.

**Fix Required:**
1. Add `documentPath *string` parameter to `UpdateStatusForced` signature
2. Update all callers of `UpdateStatusForced` to pass document path
3. Pass `documentPath` to `CreateRejectionNoteWithTx` instead of `nil`
4. Update CLI commands (approve, reopen, update) to pass `reasonDocFlag` value

### 2. Missing Integration Test Coverage ❌

**Location:** `internal/cli/commands/task_reason_doc_test.go`

**Issue:** Tests only verify:
- Flag exists on commands
- Path validation logic
- Mock repository behavior
- Metadata JSON structure

**Missing:**
- End-to-end test with real repository
- Verification that document path is actually stored in database
- Verification that document path appears in rejection note metadata
- Verification that rejection history displays document link

**Impact:** Feature appears to work based on unit tests, but is broken in practice.

**Fix Required:**
1. Add repository integration test in `internal/repository/task_note_repository_test.go`
2. Verify document path is stored in `task_notes.metadata`
3. Verify metadata contains `{"reason_doc_path": "path/to/doc.md"}`
4. Add CLI integration test that exercises full workflow

### 3. UpdateStatusForced Signature Needs Document Path Parameter ❌

**Location:** Multiple files

**Issue:** The method signature is:
```go
func (r *TaskRepository) UpdateStatusForced(
    ctx context.Context,
    taskID int64,
    newStatus models.TaskStatus,
    agent *string,
    notes *string,
    rejectionReason *string,
    force bool
) error
```

Needs to be:
```go
func (r *TaskRepository) UpdateStatusForced(
    ctx context.Context,
    taskID int64,
    newStatus models.TaskStatus,
    agent *string,
    notes *string,
    rejectionReason *string,
    documentPath *string,  // <-- ADD THIS
    force bool
) error
```

**Affected Files:**
- `internal/repository/task_repository.go` (definition)
- `internal/cli/commands/task.go` (3 call sites: approve, reopen, update)
- Any other callers of `UpdateStatusForced`

**Impact:** Breaking API change that must cascade through all callers.

## Design Issues

### 4. CLI Validates Document But Doesn't Use It ⚠️

**Location:** `internal/cli/commands/task.go:1781-1803, 2070-2090, 2437-2455`

**Issue:** The CLI code:
1. Reads `--reason-doc` flag ✅
2. Validates path format ✅
3. Checks file exists ✅
4. **Does nothing with the validated path** ❌

**Code:**
```go
reasonDocFlag, _ := cmd.Flags().GetString("reason-doc")
if reasonDocFlag != "" {
    if err := ValidateRejectionReasonDocPath(reasonDocFlag); err != nil {
        cli.Error(fmt.Sprintf("Invalid document path: %s", err.Error()))
        os.Exit(1)
    }

    // Check file exists
    fullPath := filepath.Join(projectRoot, reasonDocFlag)
    if _, err := os.Stat(fullPath); os.IsNotExist(err) {
        cli.Error(fmt.Sprintf("Document not found: %s", reasonDocFlag))
        os.Exit(1)
    }
    // reasonDocFlag is never used after this!
}

// Later: calls repository with nil document path
repo.UpdateStatusForced(ctx, task.ID, models.TaskStatusCompleted,
    &agent, notes, rejectionReason, force)  // No documentPath!
```

**Fix Required:**
Convert `reasonDocFlag` to pointer and pass to repository:
```go
var documentPath *string
if reasonDocFlag != "" {
    // ... validation ...
    documentPath = &reasonDocFlag
}

repo.UpdateStatusForced(ctx, task.ID, models.TaskStatusCompleted,
    &agent, notes, rejectionReason, documentPath, force)
```

## Positive Aspects ✅

### 1. Validation Logic is Correct
- Path traversal prevention (blocks `..`)
- Absolute path rejection
- Empty path detection
- Clear error messages

### 2. Document Path Storage in Metadata
The `CreateRejectionNote` method correctly stores document path in metadata:
```go
if documentPath != nil && *documentPath != "" {
    metadata.DocumentPath = *documentPath
}
```

### 3. Flag Registration
All three commands correctly register the `--reason-doc` flag:
- `taskApproveCmd`
- `taskReopenCmd`
- `taskUpdateCmd`

### 4. Test Structure is Good
Tests are well-organized with:
- Table-driven test patterns
- Clear test names
- Edge case coverage (traversal attacks, absolute paths)

## Required Changes Summary

### High Priority (Blocking)
1. **Add `documentPath *string` parameter to `UpdateStatusForced`**
   - Update signature in `task_repository.go`
   - Update all call sites (approve, reopen, update commands)
   - Pass to `CreateRejectionNoteWithTx` instead of `nil`

2. **Update CLI commands to pass document path**
   - Extract `reasonDocFlag` as pointer
   - Pass to `UpdateStatusForced` calls

3. **Add integration tests**
   - Repository test verifying document path storage
   - CLI test verifying end-to-end workflow
   - Verify metadata JSON structure in database

### Medium Priority
4. **Update ReopenTaskForced signature**
   - Add `documentPath *string` parameter
   - Pass through to `UpdateStatusForced`

5. **Add regression test**
   - Verify backward compatibility (nil documentPath works)
   - Verify optional flag behavior

## Verification Checklist

Before marking complete:
- [ ] `UpdateStatusForced` accepts `documentPath *string` parameter
- [ ] CLI commands extract and pass `reasonDocFlag` value
- [ ] Repository stores document path in `task_notes.metadata`
- [ ] Integration test verifies document path in database
- [ ] Rejection history shows document link
- [ ] Manual test: `shark task reopen <key> --reason="Failed review" --reason-doc="docs/review.md"`
- [ ] Verify metadata: `SELECT metadata FROM task_notes WHERE note_type='rejection' ORDER BY id DESC LIMIT 1;`
- [ ] Metadata contains: `{"history_id": X, "from_status": "...", "to_status": "...", "document_path": "docs/review.md"}`

## Recommended Fix Order

1. **Step 1:** Update `UpdateStatusForced` signature (add `documentPath *string`)
2. **Step 2:** Update `task.go` CLI commands to extract and pass document path
3. **Step 3:** Add repository integration test
4. **Step 4:** Run all tests and verify
5. **Step 5:** Manual verification with real database

## Test Execution Results

```bash
$ go test -v ./internal/cli/commands -run ".*ReasonDoc.*"
# All tests PASS but don't test integration
```

**False positive:** Tests pass because they only verify:
- Flag exists
- Validation works
- Mocks work

Tests do NOT verify that document path reaches the database.

## Conclusion

**Status: REJECTED**

The implementation is incomplete. While the CLI validation is correct, the document path is never passed to the repository layer, making the feature non-functional. The developer must:

1. Add `documentPath` parameter to repository methods
2. Update CLI to pass the validated document path
3. Add integration tests to prevent regression
4. Verify document path is stored in database metadata

**Estimated time to fix:** 2-3 hours

**Return to:** `ready_for_development` status with `bug_fix: true` context
