# Code Review: T-E07-F22-029 - Add config option require_rejection_reason

**Reviewer:** tech-lead
**Date:** 2026-01-16 21:56
**Commit:** 31226d0c4bd4b1db071db2d2c2cec35da27bc77f
**Status:** ‚ùå **REJECTED - Implementation Incomplete**

---

## Summary

The config option `require_rejection_reason` was successfully added to the workflow configuration schema and parser, with comprehensive test coverage. However, **the config option is not actually being used** in the validation logic that enforces rejection reason requirements. This is a critical implementation gap that makes the feature non-functional.

---

## Issues Found

### üî¥ CRITICAL: Config Option Not Used in Validation

**Location:** `internal/validation/workflow.go:109-129`

**Problem:**
The `ValidateReasonForStatusTransition` function does NOT check the `workflow.RequireRejectionReason` config option. It always requires rejection reasons for backward transitions, regardless of the config setting.

**Current Code:**
```go
func ValidateReasonForStatusTransition(newStatus, currentStatus, reason string, force bool, workflow *config.WorkflowConfig) error {
	// If no status change is requested, no validation needed
	if newStatus == "" {
		return nil
	}

	// If force is true, bypass validation
	if force {
		return nil
	}

	// Check if this is a backward transition
	if IsBackwardTransition(currentStatus, newStatus, workflow) {
		// Backward transitions require a non-empty reason
		if reason == "" {
			return ErrReasonRequired  // ‚ùå Always requires reason, ignores config!
		}
	}

	return nil
}
```

**Expected Behavior:**
The function should check `workflow.RequireRejectionReason` before enforcing the requirement:

```go
func ValidateReasonForStatusTransition(newStatus, currentStatus, reason string, force bool, workflow *config.WorkflowConfig) error {
	// If no status change is requested, no validation needed
	if newStatus == "" {
		return nil
	}

	// If force is true, bypass validation
	if force {
		return nil
	}

	// Check if this is a backward transition
	if IsBackwardTransition(currentStatus, newStatus, workflow) {
		// Check if rejection reasons are required by config
		// Default to true if workflow is nil (backward compatibility)
		requireReason := true
		if workflow != nil {
			requireReason = workflow.RequireRejectionReason
		}

		// Only require reason if config enables it
		if requireReason && reason == "" {
			return ErrReasonRequired
		}
	}

	return nil
}
```

**Impact:**
- Setting `require_rejection_reason: false` in `.sharkconfig.json` has **no effect**
- Users cannot disable rejection reason enforcement even when they explicitly configure it
- The feature is completely non-functional as implemented

---

### ‚ö†Ô∏è MINOR: Missing Test Coverage for Validation Logic

**Location:** `internal/validation/workflow_test.go`

**Problem:**
While the config parsing and default value tests exist (in `internal/config/workflow_test.go`), there are **no tests** verifying that the `RequireRejectionReason` config option is actually used during validation.

**Missing Test Cases:**
1. `workflow.RequireRejectionReason = true` ‚Üí backward transition without reason ‚Üí should fail
2. `workflow.RequireRejectionReason = false` ‚Üí backward transition without reason ‚Üí should pass
3. `workflow == nil` ‚Üí backward transition without reason ‚Üí should fail (default behavior)

**Recommendation:**
Add tests in `internal/validation/workflow_test.go`:

```go
func TestValidateReasonForStatusTransition_ConfigRespected(t *testing.T) {
	tests := []struct {
		name           string
		workflow       *config.WorkflowConfig
		currentStatus  string
		newStatus      string
		reason         string
		force          bool
		expectError    bool
	}{
		{
			name: "require_rejection_reason=true requires reason",
			workflow: &config.WorkflowConfig{
				RequireRejectionReason: true,
				StatusMetadata: map[string]config.StatusMetadata{
					"in_development": {Phase: "development"},
					"ready_for_code_review": {Phase: "review"},
				},
			},
			currentStatus: "ready_for_code_review",
			newStatus:     "in_development",
			reason:        "",
			force:         false,
			expectError:   true,
		},
		{
			name: "require_rejection_reason=false allows no reason",
			workflow: &config.WorkflowConfig{
				RequireRejectionReason: false,
				StatusMetadata: map[string]config.StatusMetadata{
					"in_development": {Phase: "development"},
					"ready_for_code_review": {Phase: "review"},
				},
			},
			currentStatus: "ready_for_code_review",
			newStatus:     "in_development",
			reason:        "",
			force:         false,
			expectError:   false,
		},
		{
			name:          "nil workflow defaults to requiring reason",
			workflow:      nil,
			currentStatus: "ready_for_code_review",
			newStatus:     "in_development",
			reason:        "",
			force:         false,
			expectError:   true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			err := ValidateReasonForStatusTransition(tt.newStatus, tt.currentStatus, tt.reason, tt.force, tt.workflow)
			if (err != nil) != tt.expectError {
				t.Errorf("expected error=%v, got error=%v", tt.expectError, err)
			}
		})
	}
}
```

---

## What Works Well

### ‚úÖ Config Schema & Parsing

The config option is properly defined in the `WorkflowConfig` struct with:
- Clear documentation explaining purpose
- Custom `UnmarshalJSON` to default to `true`
- Proper JSON tag: `json:"require_rejection_reason"`

### ‚úÖ Default Workflow

The `DefaultWorkflow()` function correctly sets `RequireRejectionReason: true` for backward compatibility.

### ‚úÖ Parser Integration

The `LoadWorkflowConfig` function correctly includes `require_rejection_reason` when parsing from `.sharkconfig.json`.

### ‚úÖ Test Coverage for Config Parsing

Comprehensive tests exist for:
- Default unmarshaling behavior (true when omitted)
- Explicit true/false values in JSON
- Loading from `.sharkconfig.json` files
- Default workflow initialization

All config parsing tests pass (12/12).

---

## Code Quality Assessment

### Coding Standards: ‚úÖ PASS
- Follows Go naming conventions
- Proper error handling patterns
- Good use of comments and documentation
- Consistent with existing codebase patterns

### Test Quality: ‚ö†Ô∏è PARTIAL
- Config parsing tests are excellent
- **Missing validation logic tests** (critical gap)
- No integration tests verifying end-to-end behavior

### Architecture: ‚ö†Ô∏è PARTIAL
- Config schema is well-designed
- **Validation layer doesn't use the config** (critical gap)
- Separation of concerns is good otherwise

### Documentation: ‚úÖ PASS
- Clear comments in workflow_schema.go
- Example JSON in documentation
- Commit message is descriptive

---

## Required Changes

### üî¥ CRITICAL (Must Fix Before Approval)

1. **Update `ValidateReasonForStatusTransition` to check config option**
   - File: `internal/validation/workflow.go`
   - Add logic to check `workflow.RequireRejectionReason` before enforcing requirement
   - Handle `nil` workflow with safe default (true)

2. **Add validation tests for config option**
   - File: `internal/validation/workflow_test.go`
   - Test `RequireRejectionReason = true` enforces requirement
   - Test `RequireRejectionReason = false` allows no reason
   - Test `nil` workflow defaults to requiring reason

3. **Add integration test**
   - Verify end-to-end behavior with config file
   - Test `shark task update` with `require_rejection_reason: false`
   - Confirm backward transition succeeds without reason when disabled

---

## Testing Verification

### Current Test Status

**Config Package Tests:** ‚úÖ All Passing (12/12)
```bash
go test ./internal/config -v
```

**Validation Package Tests:** ‚ö†Ô∏è Missing critical coverage
```bash
# Need to add tests for ValidateReasonForStatusTransition config usage
```

### Required Testing

Before approval, verify:
1. ‚úÖ Config parsing tests pass
2. ‚ùå Validation logic tests (need to add)
3. ‚ùå Integration test with `.sharkconfig.json` (need to add)

---

## Recommendation

**‚ùå REJECT - Return to Development**

**Reason:** Critical implementation gap. The config option exists but is not used in validation logic, making the feature non-functional.

**Next Steps:**
1. Update `ValidateReasonForStatusTransition` to check `workflow.RequireRejectionReason`
2. Add comprehensive validation tests
3. Add integration test with config file
4. Re-submit for code review

**Estimated Fix Time:** 30-45 minutes

---

## Positive Notes

Despite the critical issue, the implementation shows:
- ‚úÖ Excellent config schema design
- ‚úÖ Comprehensive config parsing tests
- ‚úÖ Good documentation and code quality
- ‚úÖ Proper backward compatibility with default value

The fix is straightforward and well-defined. With the validation logic update and additional tests, this will be a solid feature.

---

## Reference

**Task:** T-E07-F22-029
**Commit:** 31226d0c4bd4b1db071db2d2c2cec35da27bc77f
**Files Changed:**
- `internal/config/workflow_parser.go` (9 lines)
- `internal/config/workflow_schema.go` (3 lines)
- `internal/config/workflow_test.go` (6 lines)

**Files Requiring Changes:**
- `internal/validation/workflow.go` (add config check)
- `internal/validation/workflow_test.go` (add tests)
