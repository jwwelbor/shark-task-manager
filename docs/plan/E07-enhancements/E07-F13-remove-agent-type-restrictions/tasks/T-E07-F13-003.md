---
agent: backend
created_at: 2026-01-01T06:56:42Z
epic: E07
feature: E07-F13
key: T-E07-F13-003
priority: 8
status: in_refinement
task_key: T-E07-F13-009
title: Update template renderer to handle unknown agent types gracefully
---

# Task: Update template renderer to handle unknown agent types gracefully

## Goal

Enable the template renderer to gracefully handle custom (unknown) agent types by always falling back to the general template when an agent-specific template doesn't exist. This ensures backward compatibility while supporting user-defined agent types.

## Business Requirements

### Current Behavior Analysis

The template system currently:
1. Validates agent types against a hardcoded list (frontend, backend, api, testing, devops, general)
2. `Render()` method validates agent type **before** loading templates (lines 41-43 in renderer.go)
3. `RenderWithSelection()` skips validation but still only loads known agent types
4. `LoadTemplate()` falls back to "general" template if agent-specific template not found
5. Fails early with validation error for unknown agent types in `Render()`

### Required Graceful Handling Behavior

**Requirement 1: Remove Pre-Validation from Render()**
- The `Render()` method must NOT validate agent types before template loading
- Remove lines 41-43 from `internal/templates/renderer.go`
- Allow any agent type string to proceed to template loading

**Requirement 2: Fallback to General Template**
- When a custom agent type is provided (e.g., "code-reviewer", "database-architect")
- Attempt to load `task-{agentType}.md` first
- If not found, fall back to `task-general.md` automatically
- This behavior already exists in `LoadTemplate()` (lines 46-53, 60-67)

**Requirement 3: Error Handling Only for Missing General Template**
- Return error ONLY if both the specific template AND the general template are missing
- This should be extremely rare (system misconfiguration)
- Error message: "template not found: task-{agentType}.md (and fallback to general template failed)"

### Backward Compatibility

**Existing Templates (Must Continue to Work):**
- `task-frontend.md` → Used for agent_type="frontend"
- `task-backend.md` → Used for agent_type="backend"
- `task-api.md` → Used for agent_type="api"
- `task-testing.md` → Used for agent_type="testing"
- `task-devops.md` → Used for agent_type="devops"
- `task-general.md` → Used for agent_type="general" OR as fallback

**Custom Agent Types (New Behavior):**
- `agent_type="code-reviewer"` → Falls back to `task-general.md`
- `agent_type="database-architect"` → Falls back to `task-general.md`
- `agent_type="ui-designer"` → Falls back to `task-general.md`

**User-Provided Custom Templates (Advanced Use Case):**
- Users can create `templates/task-code-reviewer.md` in their project
- System will use custom template for `agent_type="code-reviewer"`
- If custom template exists, no fallback needed
- This requires `Loader` to be initialized with custom `templateDir`

## Implementation Details

### Changes Required

**File: `internal/templates/renderer.go`**

1. **Remove validation from Render() method (lines 40-43):**
   ```go
   // REMOVE THIS:
   // Validate agent type
   if err := models.ValidateAgentType(string(agentType)); err != nil {
       return "", fmt.Errorf("failed to load template: %w", err)
   }
   ```

2. **Rely on LoadTemplate() fallback behavior:**
   - No changes needed to `LoadTemplate()` - it already implements fallback
   - The method already tries agent-specific template first
   - Falls back to general template if agent-specific not found
   - Returns error only if both are missing

3. **Update RenderWithSelection() if needed:**
   - Currently doesn't validate agent type (good)
   - Verify it properly handles custom agent types with fallback

### Default Values and Fallbacks

| Scenario | Behavior |
|----------|----------|
| Known agent type (frontend, backend, etc.) | Load agent-specific template |
| Custom agent type with matching template file | Load custom template |
| Custom agent type without template file | Fall back to general template |
| Empty agent type string | Fall back to general template |
| General template missing | Return error (system misconfiguration) |

### Error Messages

**Success Cases:**
- No user-facing messages (silent success)
- Template rendered successfully

**Error Cases:**
- Template file not found AND general template missing: `"template not found: task-{agentType}.md (and fallback to general template failed)"`
- Template parse error: `"failed to parse template: {error details}"`
- Template execution error: `"failed to execute template: {error details}"`

## Acceptance Criteria

### Functional Requirements

- [ ] Template renderer accepts any non-empty agent type string
- [ ] Known agent types (frontend, backend, api, testing, devops) still use their specific templates
- [ ] Unknown agent types automatically fall back to general template
- [ ] Empty agent type defaults to general template
- [ ] Custom templates (if provided by user) are loaded correctly
- [ ] No breaking changes to existing task creation workflows

### Edge Cases Covered

- [ ] Agent type with special characters (hyphens, underscores): "code-reviewer", "ui_designer"
- [ ] Agent type that doesn't match any template file: falls back to general
- [ ] Agent type is empty string: falls back to general
- [ ] General template is missing: returns clear error message
- [ ] Custom template directory provided: loads custom templates correctly
- [ ] Embedded templates vs filesystem templates: both work with fallback

### Non-Functional Requirements

- [ ] No performance degradation (template loading is already cached)
- [ ] Error messages are clear and actionable
- [ ] Backward compatible with all existing templates
- [ ] No changes required to task creation commands

## Testing Requirements

### Unit Tests Required

**Test File: `internal/templates/renderer_test.go`**

1. **Test: Render with known agent type**
   - Given: agent_type="backend"
   - When: Render() is called
   - Then: `task-backend.md` template is used

2. **Test: Render with unknown agent type (fallback)**
   - Given: agent_type="code-reviewer"
   - When: Render() is called
   - Then: `task-general.md` template is used (no error)

3. **Test: Render with empty agent type**
   - Given: agent_type=""
   - When: Render() is called
   - Then: `task-general.md` template is used

4. **Test: Render with custom template directory**
   - Given: Custom template directory with `task-custom-agent.md`
   - And: agent_type="custom-agent"
   - When: Render() is called
   - Then: Custom template is loaded

5. **Test: RenderWithSelection with unknown agent type**
   - Given: agent_type="database-architect"
   - And: No custom template path
   - When: RenderWithSelection() is called
   - Then: Falls back to `task-general.md`

6. **Test: Error when general template missing**
   - Given: General template doesn't exist
   - And: Agent-specific template doesn't exist
   - When: Render() is called
   - Then: Error is returned with clear message

### Integration Tests

- [ ] Create task with custom agent type via CLI
- [ ] Verify task file is created with general template content
- [ ] Verify no validation errors occur for custom agent types

## Dependencies

- **Depends on:** T-E07-F13-001 (Update ValidateAgentType to accept any non-empty string)
- **Blocks:** T-E07-F13-004 (Verify task creation validator works with custom agent types)

## Success Metrics

- All existing tasks with known agent types continue to work
- New tasks with custom agent types are created successfully
- Zero validation errors for unknown agent types
- Template fallback happens silently without user intervention

## Notes

### Design Decisions

1. **Silent Fallback:** We intentionally do NOT warn users when falling back to general template. This is because:
   - Custom agent types are expected and valid
   - Users may not care about custom templates
   - Warning would clutter output and confuse users

2. **General Template as Default:** The general template is designed to be comprehensive and suitable for any agent type

3. **No Template Creation:** This task does NOT include creating additional templates for custom agent types. Users can provide their own if desired.

4. **Validation Removal:** We're removing validation from renderer but keeping it in the models layer (T-E07-F13-001 updates that validation to accept any string)

### Trade-offs

**Pros:**
- Flexible: supports any agent type
- Simple: no complex logic or configuration
- Backward compatible: existing templates work unchanged

**Cons:**
- Silent failures: users won't know if they misspell an agent type (will just get general template)
- No autocomplete hints: unknown agent types won't have IDE support

### Migration Notes

- Existing tasks are unaffected
- No database migration required
- No configuration changes required
- Deployment can be done without downtime
