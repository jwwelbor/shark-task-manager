
---
key: T-E07-F11-005
title: Generate and store slug during feature creation
epic: E07
feature: E07-F11
agent: backend
status: todo
priority: 9
depends_on: ["T-E07-F11-003"]
created_at: 2025-12-30T07:00:00Z
related-docs:
  - docs/plan/E07-enhancements/E07-F11-slug-architecture-improvement/feature-overview.md
  - internal/slug/slug.go
---

# Task: Generate and store slug during feature creation

## Goal

Modify feature creation logic to automatically generate and store slug values in the database when new features are created. This mirrors the epic implementation and ensures consistency across all entity types.

## Implementation Details

### Files to Modify

**1. `internal/models/feature.go`**
- Add `Slug` field to Feature struct:
  ```go
  type Feature struct {
      // ... existing fields ...
      Slug *string `json:"slug,omitempty" db:"slug"`
      // ... rest of fields ...
  }
  ```

**2. `internal/repository/feature_repository.go`**
- Modify `Create()` method to:
  - Generate slug from feature title using `slug.Generate(feature.Title)`
  - Store slug in database during INSERT
  - Update SQL query to include slug column

**3. `internal/cli/commands/feature.go`**
- Ensure feature creation commands flow through repository Create() method
- No direct changes needed if using repository pattern correctly

### Implementation Steps

1. **Add Slug field to Feature model** (`internal/models/feature.go`):
   - Type: `*string` (nullable pointer for backward compatibility)
   - JSON tag: `json:"slug,omitempty"`
   - DB tag: `db:"slug"`

2. **Update Feature repository Create method** (`internal/repository/feature_repository.go`):
   ```go
   import "shark-task-manager/internal/slug"

   func (r *FeatureRepository) Create(ctx context.Context, feature *Feature) error {
       // Generate slug from title
       generatedSlug := slug.Generate(feature.Title)
       feature.Slug = &generatedSlug

       // Update INSERT query to include slug column
       query := `INSERT INTO features (key, epic_id, title, description, slug, ...)
                 VALUES (?, ?, ?, ?, ?, ...)`

       // Execute with slug value
       result, err := r.db.ExecContext(ctx, query, feature.Key, feature.EpicID, feature.Title, feature.Description, feature.Slug, ...)
       // ... rest of implementation
   }
   ```

3. **Test the implementation**:
   - Create new feature via CLI
   - Verify slug is generated correctly
   - Verify slug is stored in database
   - Verify slug appears in JSON output

## Acceptance Criteria

- [ ] Feature struct has Slug field defined
- [ ] Feature creation generates slug from title using `slug.Generate()`
- [ ] Generated slug is stored in database features.slug column
- [ ] Feature JSON output includes slug field
- [ ] Existing features (with NULL slug) continue to work
- [ ] Unit tests pass for feature repository Create method
- [ ] Integration test: `shark feature create --epic=E## "Test Feature"` stores slug in database

## Testing Requirements

### Unit Tests

- [ ] Feature model serialization/deserialization with slug field
- [ ] Feature repository Create() generates and stores slug
- [ ] Slug generation handles unicode titles correctly
- [ ] Slug generation handles special characters correctly

### Integration Tests

- [ ] Create feature via CLI and verify slug in database:
  ```bash
  ./bin/shark feature create --epic=E01 "Test Feature Title"
  sqlite3 shark-tasks.db "SELECT key, title, slug FROM features WHERE title='Test Feature Title';"
  # Expected: E##-F##, Test Feature Title, test-feature-title
  ```

### Manual Testing

```bash
# 1. Create feature with simple title
./bin/shark feature create --epic=E01 "Simple Feature" --json

# Expected output includes: "slug": "simple-feature"

# 2. Verify in database
sqlite3 shark-tasks.db "SELECT key, title, slug FROM features ORDER BY id DESC LIMIT 1;"

# 3. Create feature with complex title
./bin/shark feature create --epic=E01 "User Authentication (OAuth2)" --json

# Expected slug: "user-authentication-oauth2"
```

## Dependencies

- **Prerequisite**: T-E07-F11-003 (slug column migration) MUST be complete
- **Uses**: `internal/slug/slug.go` for slug generation logic
- **Modifies**: Feature model, Feature repository
- **Similar to**: T-E07-F11-004 (epic slug storage) - follow same pattern

## Notes

- Slug is generated automatically - users CANNOT provide custom slugs
- Slug is immutable once created - title changes do NOT update slug
- Slug can be NULL for backward compatibility with existing features
- Use `slug.Generate()` function - do NOT reimplement slug logic
- Follow existing repository patterns for transaction handling
- Maintain backward compatibility - existing code should not break
- Implementation should mirror epic slug storage for consistency
