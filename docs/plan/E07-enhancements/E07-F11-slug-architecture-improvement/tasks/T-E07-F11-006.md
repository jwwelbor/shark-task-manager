
---
key: T-E07-F11-006
title: Generate and store slug during task creation
epic: E07
feature: E07-F11
agent: backend
status: todo
priority: 9
depends_on: ["T-E07-F11-003"]
created_at: 2025-12-30T07:00:01Z
related-docs:
  - docs/plan/E07-enhancements/E07-F11-slug-architecture-improvement/feature-overview.md
  - internal/slug/slug.go
---

# Task: Generate and store slug during task creation

## Goal

Modify task creation logic to automatically generate and store slug values in the database when new tasks are created. This completes the slug storage implementation across all entity types (epic, feature, task).

## Implementation Details

### Files to Modify

**1. `internal/models/task.go`**
- Add `Slug` field to Task struct:
  ```go
  type Task struct {
      // ... existing fields ...
      Slug *string `json:"slug,omitempty" db:"slug"`
      // ... rest of fields ...
  }
  ```

**2. `internal/repository/task_repository.go`**
- Modify `Create()` method to:
  - Generate slug from task title using `slug.Generate(task.Title)`
  - Store slug in database during INSERT
  - Update SQL query to include slug column

**3. `internal/cli/commands/task.go`**
- Ensure task creation commands flow through repository Create() method
- No direct changes needed if using repository pattern correctly

### Implementation Steps

1. **Add Slug field to Task model** (`internal/models/task.go`):
   - Type: `*string` (nullable pointer for backward compatibility)
   - JSON tag: `json:"slug,omitempty"`
   - DB tag: `db:"slug"`
   - **Important**: Task struct is large - add slug field in logical grouping with Key and Title

2. **Update Task repository Create method** (`internal/repository/task_repository.go`):
   ```go
   import "shark-task-manager/internal/slug"

   func (r *TaskRepository) Create(ctx context.Context, task *Task) error {
       // Generate slug from title
       generatedSlug := slug.Generate(task.Title)
       task.Slug = &generatedSlug

       // Update INSERT query to include slug column
       query := `INSERT INTO tasks (key, feature_id, title, description, slug, status, ...)
                 VALUES (?, ?, ?, ?, ?, ?, ...)`

       // Execute with slug value
       result, err := r.db.ExecContext(ctx, query, task.Key, task.FeatureID, task.Title, task.Description, task.Slug, task.Status, ...)
       // ... rest of implementation
   }
   ```

3. **Test the implementation**:
   - Create new task via CLI
   - Verify slug is generated correctly
   - Verify slug is stored in database
   - Verify slug appears in JSON output

## Acceptance Criteria

- [ ] Task struct has Slug field defined
- [ ] Task creation generates slug from title using `slug.Generate()`
- [ ] Generated slug is stored in database tasks.slug column
- [ ] Task JSON output includes slug field
- [ ] Existing tasks (with NULL slug) continue to work
- [ ] Unit tests pass for task repository Create method
- [ ] Integration test: `shark task create --epic=E## --feature=F## "Test Task"` stores slug in database

## Testing Requirements

### Unit Tests

- [ ] Task model serialization/deserialization with slug field
- [ ] Task repository Create() generates and stores slug
- [ ] Slug generation handles unicode titles correctly
- [ ] Slug generation handles special characters correctly

### Integration Tests

- [ ] Create task via CLI and verify slug in database:
  ```bash
  ./bin/shark task create --epic=E01 --feature=F01 "Test Task Title"
  sqlite3 shark-tasks.db "SELECT key, title, slug FROM tasks WHERE title='Test Task Title';"
  # Expected: T-E##-F##-###, Test Task Title, test-task-title
  ```

### Manual Testing

```bash
# 1. Create task with simple title
./bin/shark task create --epic=E01 --feature=F01 "Simple Task" --json

# Expected output includes: "slug": "simple-task"

# 2. Verify in database
sqlite3 shark-tasks.db "SELECT key, title, slug FROM tasks ORDER BY id DESC LIMIT 1;"

# 3. Create task with complex title
./bin/shark task create --epic=E01 --feature=F01 "Fix Bug: Memory Leak in Worker Pool" --json

# Expected slug: "fix-bug-memory-leak-in-worker-pool"
```

## Dependencies

- **Prerequisite**: T-E07-F11-003 (slug column migration) MUST be complete
- **Uses**: `internal/slug/slug.go` for slug generation logic
- **Modifies**: Task model, Task repository
- **Similar to**: T-E07-F11-004, T-E07-F11-005 - follow same pattern

## Notes

- Slug is generated automatically - users CANNOT provide custom slugs
- Slug is immutable once created - title changes do NOT update slug
- Slug can be NULL for backward compatibility with existing tasks
- Use `slug.Generate()` function - do NOT reimplement slug logic
- Follow existing repository patterns for transaction handling
- Maintain backward compatibility - existing code should not break
- Implementation should mirror epic and feature slug storage for consistency
- Task struct is larger than Epic/Feature - ensure slug field is placed logically
