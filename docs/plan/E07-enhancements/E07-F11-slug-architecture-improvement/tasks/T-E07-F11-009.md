
---
key: T-E07-F11-009
title: Replace PathBuilder with PathResolver in all commands
epic: E07
feature: E07-F11
agent: backend
status: todo
priority: 8
depends_on: ["T-E07-F11-008"]
created_at: 2025-12-30T07:00:17Z
---

# Task: Replace PathBuilder with PathResolver in all commands

## Goal

Replace all instances of PathBuilder with the new PathResolver in CLI commands (epic.go, feature.go, task.go) to leverage database-first path resolution instead of file-system-based slug computation.

**Key Benefit**: This change enables database-first path resolution, improving performance by querying the database (0.1ms) instead of reading files and computing slugs (1ms), achieving a 10x performance improvement.

## Scope

### Files to Modify

1. **internal/cli/commands/epic.go** (Line 397)
   - Replace `pathBuilder := utils.NewPathBuilder(projectRoot)` with PathResolver
   - Update epic creation flow to use PathResolver.ResolveEpicPath()

2. **internal/cli/commands/feature.go** (Line 480)
   - Replace `pathBuilder := utils.NewPathBuilder(projectRoot)` with PathResolver
   - Update feature creation flow to use PathResolver.ResolveFeaturePath()

3. **internal/cli/commands/task.go** (Line 461)
   - Replace `pathBuilder := utils.NewPathBuilder(projectRoot)` with PathResolver
   - Update task creation flow to use PathResolver.ResolveTaskPath()

4. **internal/cli/commands/get_path_display_test.go** (Lines 134, 254, 387)
   - Update test mocks to use PathResolver interfaces
   - Ensure tests still pass with new implementation

5. **internal/taskcreation/creator.go**
   - Replace PathBuilder usage with PathResolver
   - Update task creation service layer

## Implementation Details

### Dependency Injection Pattern

PathResolver requires repository dependencies. For each command:

```go
// OLD (PathBuilder - file-based)
pathBuilder := utils.NewPathBuilder(projectRoot)
epicPath := pathBuilder.ResolveEpicPath(epicKey, filename, customFolderPath)

// NEW (PathResolver - database-first)
epicRepo := repository.NewEpicRepository(db)
featureRepo := repository.NewFeatureRepository(db)
taskRepo := repository.NewTaskRepository(db)
pathResolver := pathresolver.NewPathResolver(epicRepo, featureRepo, taskRepo, projectRoot)
epicPath, err := pathResolver.ResolveEpicPath(ctx, epicKey)
if err != nil {
    return fmt.Errorf("failed to resolve epic path: %w", err)
}
```

### Command-Specific Changes

**Epic Commands:**
- epic create: Inject PathResolver, use ResolveEpicPath(ctx, epicKey)
- epic get: Update path resolution calls
- epic list: Update path display logic

**Feature Commands:**
- feature create: Inject PathResolver, use ResolveFeaturePath(ctx, featureKey)
- feature get: Update path resolution calls
- feature list: Update path display logic

**Task Commands:**
- task create: Inject PathResolver, use ResolveTaskPath(ctx, taskKey)
- task get: Update path resolution calls
- task list: Update path display logic

### Error Handling

PathResolver methods return `(string, error)` unlike PathBuilder which only returned `string`. Update all call sites to:

1. Check for errors
2. Return descriptive error messages
3. Log errors appropriately

Example:
```go
path, err := pathResolver.ResolveEpicPath(ctx, epicKey)
if err != nil {
    return fmt.Errorf("failed to resolve epic path for %s: %w", epicKey, err)
}
```

## Acceptance Criteria

- [ ] All PathBuilder instances in epic.go replaced with PathResolver
- [ ] All PathBuilder instances in feature.go replaced with PathResolver
- [ ] All PathBuilder instances in task.go replaced with PathResolver
- [ ] All PathBuilder instances in taskcreation/creator.go replaced with PathResolver
- [ ] Repository dependencies properly injected in all commands
- [ ] Error handling added for all PathResolver calls
- [ ] Context passed correctly to all PathResolver methods
- [ ] All existing CLI commands work correctly with PathResolver
- [ ] Path resolution respects precedence: filename > custom_folder_path > default
- [ ] No regressions in command functionality

## Testing Requirements

### Unit Tests

- [ ] Update get_path_display_test.go to use PathResolver mocks
- [ ] All command tests pass with PathResolver
- [ ] Error handling tests for path resolution failures
- [ ] Test path precedence order (filename > custom > default)

### Integration Tests

- [ ] Create epic with default path - verify correct path resolution
- [ ] Create epic with custom folder path - verify inheritance
- [ ] Create feature with inherited path - verify feature path
- [ ] Create feature with override path - verify override works
- [ ] Create task - verify task path includes feature base path
- [ ] Test all commands with database-backed PathResolver

### Manual Testing Checklist

- [ ] Run `shark epic create` and verify path
- [ ] Run `shark feature create` and verify path
- [ ] Run `shark task create` and verify path
- [ ] Run `shark epic get` and verify path display
- [ ] Run `shark feature get` and verify path display
- [ ] Run `shark task get` and verify path display
- [ ] Verify custom folder paths work correctly
- [ ] Verify filename overrides work correctly

## Migration Strategy

1. **Phase 1: Add PathResolver alongside PathBuilder**
   - Inject PathResolver in commands
   - Keep PathBuilder imports temporarily
   - Update one command at a time

2. **Phase 2: Switch to PathResolver**
   - Replace PathBuilder calls with PathResolver calls
   - Add error handling
   - Test each command thoroughly

3. **Phase 3: Remove PathBuilder references**
   - Remove PathBuilder imports
   - Clean up unused code (deferred to T-E07-F11-015)
   - Verify no regressions

## Dependencies

- **Requires**: T-E07-F11-008 (PathResolver implementation) - âœ… COMPLETED
- **Blocks**: T-E07-F11-010 (Performance testing)
- **Related**: T-E07-F11-015 (PathBuilder deprecation and removal)

## Notes

- PathResolver requires database connection - ensure db is initialized before PathResolver creation
- PathResolver uses context.Context for cancellation support - pass ctx from command handlers
- PathResolver queries database once per resolution - more efficient than PathBuilder's file operations
- This task focuses on integration; PathBuilder deprecation happens in T-E07-F11-015
- Follow existing error handling patterns in commands
- Maintain backward compatibility - users should not notice any functional changes
