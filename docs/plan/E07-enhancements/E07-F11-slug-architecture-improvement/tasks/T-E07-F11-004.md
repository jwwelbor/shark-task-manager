
---
key: T-E07-F11-004
title: Generate and store slug during epic creation
epic: E07
feature: E07-F11
agent: backend
status: todo
priority: 9
depends_on: ["T-E07-F11-003"]
created_at: 2025-12-30T06:59:58Z
related-docs:
  - docs/plan/E07-enhancements/E07-F11-slug-architecture-improvement/feature-overview.md
  - internal/slug/slug.go
---

# Task: Generate and store slug during epic creation

## Goal

Modify epic creation logic to automatically generate and store slug values in the database when new epics are created. This ensures the database becomes the single source of truth for slug metadata.

## Implementation Details

### Files to Modify

**1. `internal/models/epic.go`**
- Add `Slug` field to Epic struct:
  ```go
  type Epic struct {
      // ... existing fields ...
      Slug *string `json:"slug,omitempty" db:"slug"`
      // ... rest of fields ...
  }
  ```

**2. `internal/repository/epic_repository.go`**
- Modify `Create()` method to:
  - Generate slug from epic title using `slug.Generate(epic.Title)`
  - Store slug in database during INSERT
  - Update SQL query to include slug column

**3. `internal/cli/commands/epic.go`**
- Ensure epic creation commands flow through repository Create() method
- No direct changes needed if using repository pattern correctly

### Implementation Steps

1. **Add Slug field to Epic model** (`internal/models/epic.go`):
   - Type: `*string` (nullable pointer for backward compatibility)
   - JSON tag: `json:"slug,omitempty"`
   - DB tag: `db:"slug"`

2. **Update Epic repository Create method** (`internal/repository/epic_repository.go`):
   ```go
   import "shark-task-manager/internal/slug"

   func (r *EpicRepository) Create(ctx context.Context, epic *Epic) error {
       // Generate slug from title
       generatedSlug := slug.Generate(epic.Title)
       epic.Slug = &generatedSlug

       // Update INSERT query to include slug column
       query := `INSERT INTO epics (key, title, description, slug, ...)
                 VALUES (?, ?, ?, ?, ...)`

       // Execute with slug value
       result, err := r.db.ExecContext(ctx, query, epic.Key, epic.Title, epic.Description, epic.Slug, ...)
       // ... rest of implementation
   }
   ```

3. **Test the implementation**:
   - Create new epic via CLI
   - Verify slug is generated correctly
   - Verify slug is stored in database
   - Verify slug appears in JSON output

## Acceptance Criteria

- [ ] Epic struct has Slug field defined
- [ ] Epic creation generates slug from title using `slug.Generate()`
- [ ] Generated slug is stored in database epics.slug column
- [ ] Epic JSON output includes slug field
- [ ] Existing epics (with NULL slug) continue to work
- [ ] Unit tests pass for epic repository Create method
- [ ] Integration test: `shark epic create "Test Epic"` stores slug in database

## Testing Requirements

### Unit Tests

- [ ] Epic model serialization/deserialization with slug field
- [ ] Epic repository Create() generates and stores slug
- [ ] Slug generation handles unicode titles correctly
- [ ] Slug generation handles special characters correctly

### Integration Tests

- [ ] Create epic via CLI and verify slug in database:
  ```bash
  ./bin/shark epic create "Test Epic Title"
  sqlite3 shark-tasks.db "SELECT key, title, slug FROM epics WHERE title='Test Epic Title';"
  # Expected: E##, Test Epic Title, test-epic-title
  ```

### Manual Testing

```bash
# 1. Create epic with simple title
./bin/shark epic create "Simple Title" --json

# Expected output includes: "slug": "simple-title"

# 2. Verify in database
sqlite3 shark-tasks.db "SELECT key, title, slug FROM epics ORDER BY id DESC LIMIT 1;"

# 3. Create epic with complex title
./bin/shark epic create "Fix Bug: API Endpoint (v2)" --json

# Expected slug: "fix-bug-api-endpoint-v2"
```

## Dependencies

- **Prerequisite**: T-E07-F11-003 (slug column migration) MUST be complete
- **Uses**: `internal/slug/slug.go` for slug generation logic
- **Modifies**: Epic model, Epic repository

## Notes

- Slug is generated automatically - users CANNOT provide custom slugs
- Slug is immutable once created - title changes do NOT update slug
- Slug can be NULL for backward compatibility with existing epics
- Use `slug.Generate()` function - do NOT reimplement slug logic
- Follow existing repository patterns for transaction handling
- Maintain backward compatibility - existing code should not break
