---
agent: backend
created_at: 2025-12-19T19:26:39Z
depends_on:
    - T-E07-F09-003
epic: E07
feature: E07-F09
key: T-E07-F09-004
priority: 9
status: todo
task_key: T-E07-F09-009
title: Sync Discovery Integration
---

# Task: Sync Discovery Integration

## Goal

Update the sync command to discover epics, features, and tasks in custom folder locations and synchronize `custom_folder_path` values between filesystem frontmatter and database.

## Success Criteria

- [ ] Sync discovers epics with custom_folder_path in frontmatter
- [ ] Sync discovers features in custom path locations (inherited from epic)
- [ ] Sync discovers tasks in custom path locations (inherited from feature/epic)
- [ ] Frontmatter parser extracts custom_folder_path from epic/feature files
- [ ] Sync updates database custom_folder_path from file frontmatter
- [ ] Sync writes custom_folder_path to frontmatter when creating/updating files
- [ ] Conflict resolution handles file vs. database custom_folder_path differences
- [ ] Sync scans multiple locations based on parent custom paths
- [ ] PathBuilder used for consistent path resolution
- [ ] Backward compatibility: Default-path items continue to sync correctly

## Implementation Guidance

### Overview: Sync Integration is Critical

**Reference**: `prd.md` Section 4 "Phase 4: Sync Integration (Discovery & Synchronization)"

The PRD explicitly states: "This phase is foundational to the system. Without sync integration, custom paths only work for new CLI-created items and won't discover existing files or handle manual reorganization."

Sync must:
- Discover items in custom locations (not just `docs/plan/`)
- Parse `custom_folder_path` from frontmatter
- Update database with discovered custom paths
- Handle conflict resolution (file wins vs. database wins)

### Epic Discovery Updates

**Files to Modify**:
- `internal/sync/discovery.go` or `internal/discovery/` package
- `internal/taskfile/` (frontmatter parsing)

**Reference**: `prd.md` Section 3.8 "Sync Command" and `04-backend-design.md`

**What to Implement**:
1. **Scan beyond `docs/plan/`**: Sync currently scans default location only. Update to scan the entire project for epic files.
2. **Parse custom_folder_path from frontmatter**: When discovering an epic, extract `custom_folder_path` field from YAML.
3. **Store in database**: Call `epicRepo.Create()` or `epicRepo.Update()` with `custom_folder_path` value.
4. **Build custom path map**: During discovery, build an in-memory map of epic keys → custom_folder_path for feature discovery.

**Frontmatter Parsing**:
- Epic frontmatter includes `custom_folder_path: docs/custom/path` (optional)
- If field is absent or empty, treat as NULL (default behavior)

### Feature Discovery Updates

**Reference**: `prd.md` Section 3.8 "Sync Command"

**What to Implement**:
1. **Look in multiple locations**: For each epic, scan for features in:
   - `<epic-custom-path>/<epic-key>/*/feature.md` (if epic has custom path)
   - `docs/plan/<epic-key>/*/feature.md` (default location)
2. **Parse custom_folder_path from frontmatter**: Extract from feature frontmatter
3. **Resolve precedence**: Feature custom_folder_path > epic custom_folder_path > default
4. **Store in database**: Update `Feature.CustomFolderPath` with discovered value

**Discovery Algorithm** (from PRD):
```
For each epic file discovered:
  - Parse custom_folder_path from frontmatter
  - Store in database
  - Look for features in: <epic-custom-path>/<epic-key>/* AND default location

For each feature file discovered:
  - Parse custom_folder_path from frontmatter
  - Resolve parent epic's custom_folder_path
  - Look for tasks in multiple locations based on precedence
```

### Task Discovery Updates

**Reference**: `prd.md` Section 3.8 "Sync Command"

**What to Implement**:
1. **Multi-location scanning**: For each feature, scan for tasks in:
   - `<feature-custom-path>/<feature-key>/tasks/*.md` (if feature has custom path)
   - `<epic-custom-path>/<epic-key>/<feature-key>/tasks/*.md` (if epic has custom path)
   - `docs/plan/<epic-key>/<feature-key>/tasks/*.md` (default)
2. **Use PathBuilder**: Call `PathBuilder.ResolveTaskPath()` to determine expected location
3. **Handle explicit file_path**: Tasks with `file_path` field (E07-F05) override inherited paths

**Note**: Tasks don't have `custom_folder_path` field. Their location is determined by parent feature/epic custom paths.

### Frontmatter Parsing Extensions

**Files to Modify**:
- `internal/taskfile/` (frontmatter parser)

**What to Add**:
- Parse `custom_folder_path` field from epic frontmatter
- Parse `custom_folder_path` field from feature frontmatter
- Write `custom_folder_path` to frontmatter when creating/updating epic/feature files

**Frontmatter Format** (from PRD Section 3.3):

Epic:
```yaml
---
epic_key: E09
title: Q1 2025 Roadmap
custom_folder_path: docs/roadmap/2025-q1
---
```

Feature:
```yaml
---
feature_key: E09-F01
epic_key: E09
title: User Growth
custom_folder_path: docs/roadmap/2025-q1/user-growth
---
```

### Conflict Resolution

**Reference**: `prd.md` Section 3.8 "Sync Command"

**What to Implement**:
Handle cases where file `custom_folder_path` ≠ database `custom_folder_path`:
- **`--strategy=file-wins`**: Update database from file frontmatter
- **`--strategy=db-wins`**: Update file frontmatter from database
- **Default**: Warn user and skip update (require explicit strategy)

**Conflict Scenarios**:
- File has `custom_folder_path`, database has NULL → Update database
- File has NULL, database has `custom_folder_path` → Update file
- Both have values but they differ → Apply strategy or warn

### PathBuilder Integration

**Reference**: `02-architecture.md` "Sync Command (Discovery Integration)"

Sync should use PathBuilder for consistency:
- When discovering a file, resolve its expected path using PathBuilder
- Verify discovered file location matches expected path
- If mismatch, handle as moved file (update database with actual location)

## Validation Gates

- [ ] Manual test: Create epic with custom path, run sync, verify database has custom_folder_path
- [ ] Manual test: Manually create epic.md with custom_folder_path in frontmatter, run sync, verify database updated
- [ ] Manual test: Feature inherits epic's custom path after sync
- [ ] Manual test: Moved files (manually reorganized) are discovered after sync
- [ ] Integration test: `TestSync_DiscoverEpicWithCustomPath`
- [ ] Integration test: `TestSync_DiscoverFeatureInheritingEpicPath`
- [ ] Integration test: `TestSync_DiscoverTasksInCustomPaths`
- [ ] Integration test: `TestSync_ConflictResolution_CustomPath`
- [ ] Verify existing default-path items still sync correctly (regression test)
- [ ] Performance test: Sync with custom paths completes in reasonable time

## Context & Resources

**Design Documents**:
- Primary: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/prd.md` (Section 3.8, Section 4 Phase 4)
- Architecture: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/02-architecture.md` (Sync section)
- Backend design: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/04-backend-design.md`

**Codebase References**:
- Sync command: `internal/cli/commands/sync.go`
- Discovery logic: `internal/sync/discovery.go` or `internal/discovery/`
- Frontmatter parsing: `internal/taskfile/` (YAML parsing)
- PathBuilder: `internal/utils/path_builder.go` (created in Task 002)

**Test Scenarios**:
- PRD Section 5.3 "End-to-End Scenarios" - Scenario 4 details sync testing

## Notes for Agent

**Critical Importance**:
This task is marked as **CRITICAL** in the PRD. Without sync integration:
- Only CLI-created items work with custom paths
- Manually reorganized files are not discovered
- Users cannot import existing documentation into custom paths
- Feature is incomplete and unusable for manual workflows

**Key Considerations**:
- Sync must scan entire project, not just `docs/plan/` (security: still validate paths)
- Build in-memory map of epic/feature custom paths during discovery (avoid repeated queries)
- Use PathBuilder for all path resolution (consistency)
- Frontmatter is source of truth for custom_folder_path during sync

**Edge Cases**:
- Epic has custom_folder_path but file moved → Update database with actual location
- Feature has no custom_folder_path but epic does → Feature inherits (NULL in DB)
- Multiple epics in same custom folder → Valid use case, allow it

**Performance Considerations**:
- Cache parent custom_folder_path lookups (avoid N+1 queries)
- Build path map once during discovery phase
- Scan multiple locations in parallel if possible
- Target: Sync with custom paths < 2x slower than default sync

**Backward Compatibility**:
- Default-path items (custom_folder_path = NULL) must continue to work
- Sync must not break existing workflows
- Test with mixed scenarios (some custom, some default paths)
