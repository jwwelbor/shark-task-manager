---
agent: backend
created_at: 2025-12-19T19:26:28Z
depends_on:
    - T-E07-F09-001
epic: E07
feature: E07-F09
key: T-E07-F09-002
priority: 9
status: todo
task_key: T-E07-F09-007
title: Path Validation and Builder Service
---

# Task: Path Validation and Builder Service

## Goal

Create the PathBuilder service and path validation functions that centralize all custom folder path resolution logic with security-first validation to prevent path traversal attacks.

## Success Criteria

- [ ] `PathBuilder` service created in `internal/utils/path_builder.go`
- [ ] Path validation functions in `internal/utils/path_validation.go`
- [ ] `ResolveEpicPath()` method implements precedence logic
- [ ] `ResolveFeaturePath()` method implements inheritance
- [ ] `ResolveTaskPath()` method implements full inheritance chain
- [ ] `ValidateFolderPath()` prevents security vulnerabilities
- [ ] Repository methods added: `GetCustomFolderPath()` for epic and feature
- [ ] Comprehensive unit tests for all path scenarios
- [ ] All validation edge cases covered

## Implementation Guidance

### PathBuilder Service

**New File**: `internal/utils/path_builder.go`

**Reference**: `04-backend-design.md` section "PathBuilder Service"

Create a service that encapsulates path resolution logic:
- **Constructor**: `NewPathBuilder(projectRoot string) *PathBuilder`
- **Method**: `ResolveEpicPath(epicKey, filename, customFolderPath)` → absolute path
- **Method**: `ResolveFeaturePath(epicKey, featureKey, filename, featureCustomPath, epicCustomPath)` → absolute path
- **Method**: `ResolveTaskPath(epicKey, featureKey, taskKey, filename, featureCustomPath, epicCustomPath)` → absolute path

**Precedence Logic** (from highest to lowest):
1. Explicit `filename` parameter (exact override)
2. Entity's own `customFolderPath`
3. Parent's `customFolderPath` (for features/tasks)
4. Default path structure

Each method must validate paths before returning using `ValidateFolderPath()`.

### Path Validation Functions

**New File**: `internal/utils/path_validation.go`

**Reference**: `04-backend-design.md` section "Path Validation Functions"

Implement security validation:
- **Function**: `ValidateFolderPath(path, projectRoot string) (absPath, relPath string, err error)`

**Validation Rules**:
- Reject absolute paths (must start with relative path)
- Reject paths containing `..` (path traversal prevention)
- Verify resolved path stays within projectRoot boundaries
- Normalize paths (remove trailing slashes, clean `./`)
- Return both absolute and relative paths

**Error Types to Define**:
- `ErrAbsolutePath` - path starts with `/`
- `ErrPathTraversal` - path contains `..`
- `ErrPathOutsideProject` - resolved path escapes project root
- `ErrEmptyPath` - path is empty or whitespace

### Repository Method Extensions

**Files to Modify**:
- `internal/repository/epic_repository.go`
- `internal/repository/feature_repository.go`

Add methods to retrieve custom folder paths:
- `GetCustomFolderPath(ctx context.Context, key string) (*string, error)`

These methods query the database for the custom_folder_path column. Return nil if the value is NULL (default behavior).

**Reference**: `04-backend-design.md` section "Repository Methods"

## Validation Gates

- [ ] Unit tests for PathBuilder cover all precedence scenarios (see PRD Section 5.1)
- [ ] Path validation tests reject security violations
- [ ] Path validation tests accept valid relative paths
- [ ] Test epic path resolution: default, custom, filename override
- [ ] Test feature path resolution: inherits epic, overrides with own, filename override
- [ ] Test task path resolution: full inheritance chain works
- [ ] Edge case: empty string treated as NULL
- [ ] Edge case: trailing slashes normalized
- [ ] Performance: path resolution < 1ms (negligible overhead)

## Context & Resources

**Design Documents**:
- Primary: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/04-backend-design.md`
- Security validation: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/prd.md` (Section 3.5)
- Test scenarios: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/prd.md` (Section 5)

**Codebase References**:
- Similar validation: `internal/patterns/validator.go` (existing pattern validation)
- Repository pattern: `internal/repository/epic_repository.go` (existing methods)
- Path handling: Go standard library `filepath` package

**Test Coverage Requirements**:
- See PRD Section 5.1 "Unit Tests" for complete test case list
- PathBuilder tests: `internal/utils/path_builder_test.go`
- Validation tests: `internal/utils/path_validation_test.go`

## Notes for Agent

**Key Considerations**:
- PathBuilder is a pure function (no side effects) - highly testable
- All paths must be validated before use (defense in depth)
- NULL parameters represent "use default" behavior
- Service uses pointer semantics (`*string`) to distinguish NULL from empty string

**Security Focus**:
- Multi-layer validation: CLI validates, PathBuilder validates again
- Whitelist approach: Only relative paths within project root allowed
- No symbolic link following (resolve paths before validation)

**Design Patterns**:
- **Strategy Pattern**: Different resolution logic for epic/feature/task
- **Null Object Pattern**: NULL parameters trigger default behavior
- **Dependency Injection**: ProjectRoot injected via constructor

**Performance**:
- Path resolution is pure computation (no I/O) - very fast
- String operations and path manipulation are O(1) or O(n) where n = path length
- Target: < 1ms per resolution call
