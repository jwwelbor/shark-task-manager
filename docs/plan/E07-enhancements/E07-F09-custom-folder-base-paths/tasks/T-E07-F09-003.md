---
agent: backend
created_at: 2025-12-19T19:26:33Z
depends_on:
    - T-E07-F09-002
epic: E07
feature: E07-F09
key: T-E07-F09-003
priority: 8
status: todo
task_key: T-E07-F09-008
title: CLI Command Integration
---

# Task: CLI Command Integration

## Goal

Integrate the `--path` flag into `epic create` and `feature create` commands, connecting CLI input to PathBuilder service for custom folder path resolution.

## Success Criteria

- [ ] `--path` flag added to `epic create` command
- [ ] `--path` flag added to `feature create` command
- [ ] Epic creation validates and stores custom_folder_path
- [ ] Feature creation inherits parent epic's custom path
- [ ] Feature creation can override epic's custom path with own --path
- [ ] Task creation updated to query parent custom paths
- [ ] CLI help text documents --path flag with examples
- [ ] Error messages clear and actionable for path validation failures
- [ ] Integration tests verify end-to-end path inheritance

## Implementation Guidance

### Epic Create Command

**File to Modify**: `internal/cli/commands/epic.go`

**Reference**: `04-backend-design.md` section "epic create"

Add `--path` flag to the command:
- **Flag name**: `--path` (string, optional)
- **Description**: "Custom base folder path for this epic and children. Relative to project root."
- **Validation**: Call `ValidateFolderPath(path, projectRoot)` if provided
- **Usage**: Pass validated path to PathBuilder and set in Epic struct

**Flow**:
1. Parse `--path` flag value
2. If provided, validate using `ValidateFolderPath()`
3. Create PathBuilder instance with projectRoot
4. Call `pathBuilder.ResolveEpicPath(epicKey, nil, customFolderPath)`
5. Set `Epic.CustomFolderPath` to validated path (store in DB)
6. Create epic.md file at resolved path
7. Write `custom_folder_path` to frontmatter YAML

### Feature Create Command

**File to Modify**: `internal/cli/commands/feature.go`

**Reference**: `04-backend-design.md` section "feature create"

Add `--path` flag and parent path lookup:
- **Flag name**: `--path` (string, optional)
- **Parent lookup**: Query parent epic's `custom_folder_path` using `epicRepo.GetCustomFolderPath(ctx, epicKey)`
- **Precedence**: Feature --path > Epic custom_folder_path > default

**Flow**:
1. Parse `--epic` and `--path` flags
2. Fetch parent epic's `custom_folder_path` from database
3. If feature `--path` provided, validate it
4. Create PathBuilder instance
5. Call `pathBuilder.ResolveFeaturePath(epicKey, featureKey, nil, featureCustomPath, epicCustomPath)`
6. Set `Feature.CustomFolderPath` if --path was provided (NULL otherwise for inheritance)
7. Create feature.md file at resolved path
8. Write `custom_folder_path` to frontmatter if set

### Task Create Command Updates

**File to Modify**: `internal/cli/commands/task.go`

**Reference**: `04-backend-design.md` section "task create (Modified)"

Update path resolution to use parent custom paths:
- **No new flags** - tasks use existing `--filename` for overrides
- **New logic**: Query feature and epic custom_folder_path before resolving
- **PathBuilder call**: `ResolveTaskPath(epicKey, featureKey, taskKey, filename, featureCustomPath, epicCustomPath)`

**Flow**:
1. Parse existing flags (--epic, --feature, --filename)
2. Fetch parent feature's `custom_folder_path`
3. Fetch parent epic's `custom_folder_path` (if feature has none)
4. Call PathBuilder with parent paths
5. Create task.md at resolved path (no frontmatter change for tasks)

### Error Handling

**Reference**: `04-backend-design.md` section "Error Handling"

Provide clear error messages for all validation failures:
- Absolute path: "Error: path must be relative to project root, got absolute path: {path}"
- Path traversal: "Error: invalid path: contains '..' (path traversal not allowed)"
- Outside project: "Error: path validation failed: resolves outside project root"

Use exit code 1 for validation failures.

### Help Text and Examples

Update command help text to include `--path` flag:

**Epic create help**:
```
--path string    Custom base folder path for this epic and children (relative to project root)

Examples:
  shark epic create "Q1 2025 Goals" --path="docs/roadmap/2025-q1"
  shark epic create "Platform Services" --path="docs/products/platform"
```

**Feature create help**:
```
--path string    Custom base folder path for this feature and child tasks (overrides epic's path)

Examples:
  shark feature create --epic=E04 "Phase 1 Core" --path="docs/plan/E04-auth/phase-1"
  shark feature create --epic=E09 "OAuth Module" --path="docs/roadmap/2025-q1/modules/oauth"
```

## Validation Gates

- [ ] Manual test: `shark epic create "Test Epic" --path="docs/test"` creates file at correct location
- [ ] Manual test: Feature inherits epic's custom path without --path flag
- [ ] Manual test: Feature overrides epic's custom path with own --path
- [ ] Manual test: Task inherits from feature or epic custom path
- [ ] Manual test: Invalid paths rejected with clear error messages
- [ ] Integration tests for epic creation with custom path
- [ ] Integration tests for feature creation with path inheritance/override
- [ ] Integration tests for task creation with inherited paths
- [ ] Verify `--help` output includes --path flag documentation

## Context & Resources

**Design Documents**:
- Primary: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/04-backend-design.md`
- CLI examples: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/prd.md` (Section 3.1)
- Test scenarios: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/prd.md` (Section 5.2, 5.3)

**Codebase References**:
- Epic create command: `internal/cli/commands/epic.go`
- Feature create command: `internal/cli/commands/feature.go`
- Task create command: `internal/cli/commands/task.go`
- Existing `--filename` flag: Review for similar pattern (E07-F08)
- PathBuilder service: `internal/utils/path_builder.go` (created in Task 002)

**Integration Test Files**:
- `internal/cli/commands/epic_test.go`
- `internal/cli/commands/feature_test.go`
- `internal/cli/commands/task_test.go`

## Notes for Agent

**Key Considerations**:
- `--path` sets the base folder; PathBuilder appends entity structure
- Feature `--path` fully replaces epic's custom path (no concatenation)
- Tasks don't have `--path` flag; they use parent custom paths automatically
- NULL custom_folder_path means inherit from parent or use default

**CLI Patterns**:
- Follow existing flag patterns (lowercase with hyphens)
- Reuse validation approach from `--filename` flag (E07-F08)
- Consistent error message format across all commands

**Frontmatter Updates**:
- Epic frontmatter: Add `custom_folder_path: {path}` if set
- Feature frontmatter: Add `custom_folder_path: {path}` if set
- Task frontmatter: No changes (tasks use `file_path` only)

**Performance**:
- PathBuilder calls are fast (< 1ms)
- Database lookups for parent paths are indexed (< 2ms)
- Minimal CLI overhead (< 5ms total)
