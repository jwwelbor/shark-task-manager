---
task_key: T-E07-F09-001
epic_key: E07
feature_key: E07-F09
title: Database Schema Extension
status: todo
priority: 9
agent_type: backend
depends_on: []
---

# Task: Database Schema Extension

## Goal

Extend the SQLite database schema to support custom folder base paths for epics and features by adding `custom_folder_path` columns and indexes to both tables.

## Success Criteria

- [ ] `custom_folder_path` column added to `epics` table (TEXT, nullable)
- [ ] `custom_folder_path` column added to `features` table (TEXT, nullable)
- [ ] Indexes created for both custom_folder_path columns
- [ ] Epic and Feature Go models updated with new field
- [ ] Schema creation function in `internal/db/db.go` updated
- [ ] All existing tests pass with new schema
- [ ] Database migration documented for existing installations

## Implementation Guidance

### Database Schema Changes

**Reference**: `03-data-design.md` sections "Schema Definition" and "Indexing Strategy"

Add the `custom_folder_path` column to both tables:
- **Type**: TEXT (nullable)
- **Purpose**: Stores custom base folder path for this entity and its children
- **NULL semantics**: NULL indicates default behavior (backward compatible)
- **Difference from `file_path`**: `file_path` is exact file location; `custom_folder_path` is base folder for children

Create btree indexes on both columns:
- Supports sync discovery (find all items with custom paths)
- Enables collision detection during creation
- Sparse index (most values NULL) - efficient storage

### Model Updates

**Files to Modify**:
- `internal/models/epic.go` - Add `CustomFolderPath *string` field with db tag
- `internal/models/feature.go` - Add `CustomFolderPath *string` field with db tag

**Reference**: `03-data-design.md` section "Entity Diagram"

Use pointer type (`*string`) to represent nullable column. NULL means use default path resolution.

### Schema Creation

**File to Modify**: `internal/db/db.go`

Update the `createSchema()` function to include:
- ALTER TABLE statements for new columns (if tables exist)
- CREATE INDEX statements for both custom_folder_path columns
- Use `IF NOT EXISTS` for idempotent migrations

**Reference**: `03-data-design.md` section "Migration Strategy"

### Repository Updates

**Files to Modify**:
- `internal/repository/epic_repository.go` - Update Create method to handle CustomFolderPath
- `internal/repository/feature_repository.go` - Update Create method to handle CustomFolderPath

Ensure INSERT statements include the new column. No need to add GetCustomFolderPath methods yet (that's Task 002).

## Validation Gates

- [ ] Run `make test-db` - database tests pass
- [ ] Verify `shark init` creates schema with new columns
- [ ] Check SQLite schema: `.schema epics` and `.schema features` show custom_folder_path
- [ ] Verify indexes exist: `.indexes epics` shows idx_epics_custom_folder_path
- [ ] Confirm NULL values are handled correctly in repository Create methods
- [ ] All existing unit tests pass (no regressions)

## Context & Resources

**Design Documents**:
- Primary: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/03-data-design.md`
- Supporting: `docs/plan/E07-enhancements/E07-F09-custom-folder-base-paths/prd.md` (Section 3.4)

**Codebase References**:
- Database initialization: `internal/db/db.go:50-150` (createSchema function)
- Epic model: `internal/models/epic.go`
- Feature model: `internal/models/feature.go`
- Example indexes: Search for "CREATE INDEX" in db.go

**Similar Patterns**:
- The `file_path` column (E07-F08) follows the same nullable TEXT pattern
- Review how `file_path` was added for consistency

## Notes for Agent

**Key Considerations**:
- NULL values are intentional (default behavior) - ensure pointer semantics work
- Indexes improve query performance but add negligible overhead due to sparse data
- Backward compatibility: Existing records automatically NULL (default paths)
- Migration is non-breaking: New columns are optional

**Edge Cases**:
- Ensure empty string is treated as NULL (normalize before insert)
- Validate that indexes don't bloat (sparse index optimization)
- Confirm CASCADE DELETE still works with new columns

**Performance**:
- Column addition is instant (SQLite ALTER TABLE)
- Index creation is fast (< 100ms for typical dataset)
- No impact on existing queries (columns nullable)
