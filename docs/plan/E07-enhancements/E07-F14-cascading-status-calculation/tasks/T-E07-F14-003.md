---
agent: backend
created_at: 2026-01-01T19:35:37Z
depends_on:
    - T-E07-F14-001
epic: E07
feature: E07-F14
key: T-E07-F14-003
priority: 8
related-docs:
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/data-models.md
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/test-plan.md
status: todo
task_key: T-E07-F14-015
title: Add GetTaskStatusBreakdown method to FeatureRepository
---

# Task: Add GetTaskStatusBreakdown method to FeatureRepository

## Goal

Add a repository method that returns a count of tasks grouped by status for a given feature, enabling efficient status derivation.

## Requirements

### Functional Requirements

- [ ] Add `GetTaskStatusBreakdown(ctx, featureID) (map[TaskStatus]int, error)`
- [ ] Return counts for all task statuses
- [ ] Return empty map if feature has no tasks
- [ ] Single query aggregation (no N+1)

### Non-Functional Requirements

- [ ] Query completes in < 10ms for features with 100+ tasks
- [ ] Uses existing database indexes
- [ ] Thread-safe

## Implementation Plan

### Steps

1. [ ] Add method signature to FeatureRepository
2. [ ] Implement SQL aggregation query
3. [ ] Add repository test with real database
4. [ ] Ensure proper error handling

### Technical Approach

Location: `internal/repository/feature_repository.go`

```go
// GetTaskStatusBreakdown returns task counts grouped by status for a feature
func (r *FeatureRepository) GetTaskStatusBreakdown(ctx context.Context, featureID int64) (map[models.TaskStatus]int, error) {
    query := `
        SELECT status, COUNT(*) as count
        FROM tasks
        WHERE feature_id = ?
        GROUP BY status
    `

    rows, err := r.db.QueryContext(ctx, query, featureID)
    if err != nil {
        return nil, fmt.Errorf("failed to get task status breakdown: %w", err)
    }
    defer rows.Close()

    breakdown := make(map[models.TaskStatus]int)
    for rows.Next() {
        var status string
        var count int
        if err := rows.Scan(&status, &count); err != nil {
            return nil, fmt.Errorf("failed to scan row: %w", err)
        }
        breakdown[models.TaskStatus(status)] = count
    }

    return breakdown, nil
}
```

## Deliverables

- [ ] Method in `internal/repository/feature_repository.go`
- [ ] Test in `internal/repository/feature_repository_test.go`

## Acceptance Criteria

- [ ] Returns correct counts for each status
- [ ] Returns empty map for features with no tasks
- [ ] Uses single SQL query (no N+1)
- [ ] Repository tests pass with real database

## Testing Strategy

From test-plan.md section 3.1:

```go
func TestFeatureRepository_GetTaskStatusBreakdown(t *testing.T) {
    // Create feature with 5 tasks: 2 todo, 1 in_progress, 2 completed
    // Verify breakdown returns correct counts
}
```

## Dependencies

- T-E07-F14-001: Needs status_override column for full feature model

## Notes

- Uses existing idx_tasks_feature_id index
- Consider adding composite index idx_tasks_feature_status for optimization
- See `data-models.md` Query section for SQL reference
