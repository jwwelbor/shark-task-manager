---
agent: backend
created_at: 2026-01-01T19:35:37Z
depends_on:
    - T-E07-F14-001
epic: E07
feature: E07-F14
key: T-E07-F14-004
priority: 8
related-docs:
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/data-models.md
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/prd.md
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/test-plan.md
status: todo
task_key: T-E07-F14-016
title: Add status override methods to FeatureRepository
---

# Task: Add status override methods to FeatureRepository

## Goal

Add repository methods to get/set the status_override flag and conditionally update feature status only when not overridden.

## Requirements

### Functional Requirements

- [ ] Add `GetStatusOverride(ctx, featureID) (bool, error)`
- [ ] Add `SetStatusOverride(ctx, featureID, override bool) error`
- [ ] Add `UpdateStatusIfNotOverridden(ctx, featureID, status) (bool, error)`
- [ ] UpdateStatusIfNotOverridden returns true if update was applied

### Non-Functional Requirements

- [ ] Atomic operations
- [ ] Return false (not error) when override prevents update
- [ ] Update StatusOverride field in Feature model

## Implementation Plan

### Steps

1. [ ] Update Feature model to include StatusOverride field
2. [ ] Add GetStatusOverride method
3. [ ] Add SetStatusOverride method
4. [ ] Add UpdateStatusIfNotOverridden method
5. [ ] Add repository tests for all methods

### Technical Approach

Location: `internal/repository/feature_repository.go`

```go
// GetStatusOverride returns whether the feature has manual status override
func (r *FeatureRepository) GetStatusOverride(ctx context.Context, featureID int64) (bool, error) {
    var override bool
    err := r.db.QueryRowContext(ctx,
        `SELECT COALESCE(status_override, 0) FROM features WHERE id = ?`,
        featureID,
    ).Scan(&override)
    if err != nil {
        return false, fmt.Errorf("failed to get status override: %w", err)
    }
    return override, nil
}

// SetStatusOverride sets the manual override flag for a feature
func (r *FeatureRepository) SetStatusOverride(ctx context.Context, featureID int64, override bool) error {
    _, err := r.db.ExecContext(ctx,
        `UPDATE features SET status_override = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`,
        override, featureID,
    )
    if err != nil {
        return fmt.Errorf("failed to set status override: %w", err)
    }
    return nil
}

// UpdateStatusIfNotOverridden updates status only if override is false
// Returns true if update was applied, false if skipped due to override
func (r *FeatureRepository) UpdateStatusIfNotOverridden(ctx context.Context, featureID int64, status models.FeatureStatus) (bool, error) {
    result, err := r.db.ExecContext(ctx,
        `UPDATE features
         SET status = ?, updated_at = CURRENT_TIMESTAMP
         WHERE id = ? AND (status_override = 0 OR status_override IS NULL)`,
        status, featureID,
    )
    if err != nil {
        return false, fmt.Errorf("failed to update status: %w", err)
    }

    rowsAffected, _ := result.RowsAffected()
    return rowsAffected > 0, nil
}
```

Also update Feature model in `internal/models/feature.go`:

```go
type Feature struct {
    // ... existing fields ...
    StatusOverride bool `json:"status_override" db:"status_override"`
}
```

## Deliverables

- [ ] Updated Feature model with StatusOverride field
- [ ] Three new methods in FeatureRepository
- [ ] Repository tests for override behavior

## Acceptance Criteria

- [ ] GetStatusOverride returns false for new features
- [ ] SetStatusOverride toggles the override flag
- [ ] UpdateStatusIfNotOverridden returns false when override is true
- [ ] UpdateStatusIfNotOverridden applies update when override is false
- [ ] All repository tests pass

## Testing Strategy

From test-plan.md section 3.1:

```go
func TestFeatureRepository_StatusOverride(t *testing.T) {
    t.Run("default_override_is_false", func(t *testing.T) {...})
    t.Run("set_override_to_true", func(t *testing.T) {...})
    t.Run("update_skipped_when_override_true", func(t *testing.T) {...})
    t.Run("update_applied_when_override_false", func(t *testing.T) {...})
}
```

## Dependencies

- T-E07-F14-001: Requires status_override column to exist

## Notes

- Conditional update is key to preventing override from being ignored
- Use COALESCE for NULL handling on existing records
- See `data-models.md` for query specifications
