---
agent: qa
created_at: 2026-01-01T19:35:37Z
depends_on:
    - T-E07-F14-003
    - T-E07-F14-004
    - T-E07-F14-005
epic: E07
feature: E07-F14
key: T-E07-F14-011
priority: 5
related-docs:
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/test-plan.md
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/data-models.md
status: todo
task_key: T-E07-F14-023
title: Add repository tests for status override and breakdown methods
---

# Task: Add repository tests for status override and breakdown methods

## Goal

Create comprehensive repository tests that verify the new status-related methods work correctly with the real database.

## Requirements

### Functional Requirements

- [ ] Test GetTaskStatusBreakdown with various task distributions
- [ ] Test GetFeatureStatusBreakdown with various feature distributions
- [ ] Test GetStatusOverride, SetStatusOverride, UpdateStatusIfNotOverridden
- [ ] Test migration adds column correctly

### Non-Functional Requirements

- [ ] Use real database (per CLAUDE.md testing guidelines)
- [ ] Clean up test data before and after tests
- [ ] Isolated tests that don't affect other test data

## Implementation Plan

### Steps

1. [ ] Create feature_status_test.go in repository package
2. [ ] Add TestFeatureRepository_GetTaskStatusBreakdown
3. [ ] Add TestFeatureRepository_StatusOverride
4. [ ] Add TestEpicRepository_GetFeatureStatusBreakdown
5. [ ] Add migration test in db package

### Technical Approach

Location: `internal/repository/feature_status_test.go`

```go
func TestFeatureRepository_StatusOverride(t *testing.T) {
    ctx := context.Background()
    database := test.GetTestDB()
    db := NewDB(database)
    featureRepo := NewFeatureRepository(db)
    epicRepo := NewEpicRepository(db)

    // Cleanup before test
    _, _ = database.ExecContext(ctx, "DELETE FROM features WHERE key LIKE 'E99-%'")
    _, _ = database.ExecContext(ctx, "DELETE FROM epics WHERE key = 'E99'")

    // Create test data
    epic := &models.Epic{Key: "E99", Title: "Test Epic", Status: models.EpicStatusActive, Priority: models.PriorityMedium}
    require.NoError(t, epicRepo.Create(ctx, epic))

    feature := &models.Feature{EpicID: epic.ID, Key: "E99-F01", Title: "Test Feature", Status: models.FeatureStatusDraft}
    require.NoError(t, featureRepo.Create(ctx, feature))

    t.Run("default_override_is_false", func(t *testing.T) {
        override, err := featureRepo.GetStatusOverride(ctx, feature.ID)
        assert.NoError(t, err)
        assert.False(t, override)
    })

    t.Run("set_override_to_true", func(t *testing.T) {
        err := featureRepo.SetStatusOverride(ctx, feature.ID, true)
        assert.NoError(t, err)

        override, err := featureRepo.GetStatusOverride(ctx, feature.ID)
        assert.NoError(t, err)
        assert.True(t, override)
    })

    t.Run("update_skipped_when_override_true", func(t *testing.T) {
        updated, err := featureRepo.UpdateStatusIfNotOverridden(ctx, feature.ID, models.FeatureStatusActive)
        assert.NoError(t, err)
        assert.False(t, updated) // Should be skipped

        f, _ := featureRepo.GetByID(ctx, feature.ID)
        assert.Equal(t, models.FeatureStatusDraft, f.Status) // Unchanged
    })

    // Cleanup
    defer database.ExecContext(ctx, "DELETE FROM features WHERE id = ?", feature.ID)
    defer database.ExecContext(ctx, "DELETE FROM epics WHERE id = ?", epic.ID)
}
```

## Deliverables

- [ ] `internal/repository/feature_status_test.go`
- [ ] `internal/repository/epic_status_test.go`
- [ ] `internal/db/migration_status_override_test.go`

## Acceptance Criteria

- [ ] All repository methods tested with real database
- [ ] Test data cleaned up before and after tests
- [ ] Tests isolated from production data
- [ ] All tests pass with `make test`

## Testing Strategy

Test cases from test-plan.md section 3.1:

**GetTaskStatusBreakdown:**
- Feature with no tasks returns empty map
- Feature with 5 tasks (2 todo, 1 in_progress, 2 completed) returns correct counts

**StatusOverride:**
- Default override is false
- Set override to true
- Update skipped when override true
- Update applied when override false

**Migration:**
- Column added when missing
- Migration idempotent (safe to run multiple times)
- Existing data preserved

## Dependencies

- T-E07-F14-003: GetTaskStatusBreakdown method
- T-E07-F14-004: Status override methods
- T-E07-F14-005: GetFeatureStatusBreakdown method

## Notes

- Follow project testing patterns from CLAUDE.md
- Use test.GetTestDB() for database connection
- Clean up test data in t.Cleanup() or defer statements
