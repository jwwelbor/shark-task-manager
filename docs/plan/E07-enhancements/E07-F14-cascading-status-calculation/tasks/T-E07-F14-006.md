---
agent: backend
created_at: 2026-01-01T19:35:37Z
depends_on:
    - T-E07-F14-002
    - T-E07-F14-003
    - T-E07-F14-004
    - T-E07-F14-005
epic: E07
feature: E07-F14
key: T-E07-F14-006
priority: 7
related-docs:
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/data-models.md
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/status-calculation-rules.md
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/test-plan.md
status: todo
task_key: T-E07-F14-018
title: Create StatusCalculationService with cascade logic
---

# Task: Create StatusCalculationService with cascade logic

## Goal

Create a service that orchestrates status calculation and cascade propagation, using the repository methods and derivation logic to update parent entity statuses.

## Requirements

### Functional Requirements

- [ ] Create `StatusCalculationService` struct with repository dependencies
- [ ] Implement `RecalculateFeatureStatus(ctx, featureID) (*StatusChangeResult, error)`
- [ ] Implement `RecalculateEpicStatus(ctx, epicID) (*StatusChangeResult, error)`
- [ ] Implement `PropagateTaskChange(ctx, taskID) ([]StatusChangeResult, error)`
- [ ] Respect status_override when updating features

### Non-Functional Requirements

- [ ] All cascading updates in single transaction
- [ ] Service testable with mocked repositories
- [ ] Returns detailed change results for logging/audit

## Implementation Plan

### Steps

1. [ ] Create `internal/status/service.go`
2. [ ] Implement constructor with repository injection
3. [ ] Implement RecalculateFeatureStatus
4. [ ] Implement RecalculateEpicStatus
5. [ ] Implement PropagateTaskChange (cascade from task -> feature -> epic)
6. [ ] Add service tests with mocked repositories

### Technical Approach

Location: `internal/status/service.go`

```go
package status

import (
    "context"
    "shark-task-manager/internal/models"
    "shark-task-manager/internal/repository"
)

type StatusCalculationService struct {
    db          *repository.DB
    epicRepo    *repository.EpicRepository
    featureRepo *repository.FeatureRepository
    taskRepo    *repository.TaskRepository
}

func NewStatusCalculationService(
    db *repository.DB,
    epicRepo *repository.EpicRepository,
    featureRepo *repository.FeatureRepository,
    taskRepo *repository.TaskRepository,
) *StatusCalculationService {
    return &StatusCalculationService{
        db:          db,
        epicRepo:    epicRepo,
        featureRepo: featureRepo,
        taskRepo:    taskRepo,
    }
}

// RecalculateFeatureStatus derives and applies status from tasks
func (s *StatusCalculationService) RecalculateFeatureStatus(ctx context.Context, featureID int64) (*StatusChangeResult, error) {
    // 1. Get task status breakdown
    // 2. Derive status using deriveFeatureStatus()
    // 3. Update if not overridden using UpdateStatusIfNotOverridden()
    // 4. Return change result
}

// PropagateTaskChange cascades status update from task through hierarchy
func (s *StatusCalculationService) PropagateTaskChange(ctx context.Context, taskID int64) ([]StatusChangeResult, error) {
    // 1. Get task to find featureID
    // 2. RecalculateFeatureStatus for the feature
    // 3. Get feature to find epicID
    // 4. RecalculateEpicStatus for the epic
    // 5. Return all change results
}
```

## Deliverables

- [ ] `internal/status/service.go`
- [ ] `internal/status/service_test.go` with mocked repositories

## Acceptance Criteria

- [ ] RecalculateFeatureStatus correctly derives status
- [ ] RecalculateFeatureStatus respects override flag
- [ ] RecalculateEpicStatus correctly derives status
- [ ] PropagateTaskChange cascades through full hierarchy
- [ ] All operations return detailed StatusChangeResult
- [ ] Service tests pass with mocked dependencies

## Testing Strategy

From test-plan.md section 2.2:

```go
func TestStatusCalculationService_ApplyFeatureStatus(t *testing.T) {
    t.Run("updates_status_when_not_overridden", ...)
    t.Run("skips_update_when_overridden", ...)
    t.Run("no_change_when_status_matches", ...)
}

func TestStatusCalculationService_PropagateTaskChange(t *testing.T) {
    t.Run("cascades_through_hierarchy", ...)
}
```

## Dependencies

- T-E07-F14-002: Derivation logic functions
- T-E07-F14-003: GetTaskStatusBreakdown method
- T-E07-F14-004: Status override methods
- T-E07-F14-005: GetFeatureStatusBreakdown method

## Notes

- This is the main orchestration layer
- Uses dependency injection for testability
- All operations should be transactional
- See `test-plan.md` section 2.2 for mock patterns
