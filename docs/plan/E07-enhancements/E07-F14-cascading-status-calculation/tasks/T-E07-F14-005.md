---
agent: backend
created_at: 2026-01-01T19:35:37Z
depends_on:
    - T-E07-F14-001
epic: E07
feature: E07-F14
key: T-E07-F14-005
priority: 8
related-docs:
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/data-models.md
    - docs/plan/E07-enhancements/E07-F14-cascading-status-calculation/status-calculation-rules.md
status: todo
task_key: T-E07-F14-017
title: Add GetFeatureStatusBreakdown method to EpicRepository
---

# Task: Add GetFeatureStatusBreakdown method to EpicRepository

## Goal

Add a repository method that returns a count of features grouped by status for a given epic, enabling efficient epic status derivation.

## Requirements

### Functional Requirements

- [ ] Add `GetFeatureStatusBreakdown(ctx, epicID) (map[FeatureStatus]int, error)`
- [ ] Return counts for all feature statuses
- [ ] Return empty map if epic has no features
- [ ] Single query aggregation (no N+1)

### Non-Functional Requirements

- [ ] Query completes in < 10ms for epics with 50+ features
- [ ] Uses existing database indexes
- [ ] Thread-safe

## Implementation Plan

### Steps

1. [ ] Add method signature to EpicRepository
2. [ ] Implement SQL aggregation query
3. [ ] Add repository test with real database
4. [ ] Ensure proper error handling

### Technical Approach

Location: `internal/repository/epic_repository.go`

```go
// GetFeatureStatusBreakdown returns feature counts grouped by status for an epic
func (r *EpicRepository) GetFeatureStatusBreakdown(ctx context.Context, epicID int64) (map[models.FeatureStatus]int, error) {
    query := `
        SELECT status, COUNT(*) as count
        FROM features
        WHERE epic_id = ?
        GROUP BY status
    `

    rows, err := r.db.QueryContext(ctx, query, epicID)
    if err != nil {
        return nil, fmt.Errorf("failed to get feature status breakdown: %w", err)
    }
    defer rows.Close()

    breakdown := make(map[models.FeatureStatus]int)
    for rows.Next() {
        var status string
        var count int
        if err := rows.Scan(&status, &count); err != nil {
            return nil, fmt.Errorf("failed to scan row: %w", err)
        }
        breakdown[models.FeatureStatus(status)] = count
    }

    return breakdown, nil
}
```

## Deliverables

- [ ] Method in `internal/repository/epic_repository.go`
- [ ] Test in `internal/repository/epic_repository_test.go`

## Acceptance Criteria

- [ ] Returns correct counts for each status
- [ ] Returns empty map for epics with no features
- [ ] Uses single SQL query (no N+1)
- [ ] Repository tests pass with real database

## Testing Strategy

```go
func TestEpicRepository_GetFeatureStatusBreakdown(t *testing.T) {
    // Create epic with 4 features: 1 draft, 2 active, 1 completed
    // Verify breakdown returns correct counts
}
```

## Dependencies

- T-E07-F14-001: For consistency with feature model updates

## Notes

- Uses existing idx_features_epic_id index
- Consider adding composite index idx_features_epic_status for optimization
- Similar pattern to GetTaskStatusBreakdown in FeatureRepository
