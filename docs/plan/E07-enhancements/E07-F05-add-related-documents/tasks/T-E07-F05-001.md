---
agent: general
created_at: 2025-12-20T06:14:44Z
epic: E07
feature: E07-F05
key: T-E07-F05-001
priority: 1
status: todo
task_key: T-E07-F05-001
title: Design and implement documents database schema
---

# Task: Design and implement documents database schema

## Goal

Create SQLite schema for managing documents and their relationships to epics, features, and tasks. Implement automatic migrations and indexes for optimal query performance.

## Requirements

### Functional Requirements

- [ ] Create `documents` table with id (PK), title, file_path, created_at columns
- [ ] Add UNIQUE constraint on (title, file_path) to prevent duplicate documents
- [ ] Create `epic_documents` link table with epic_id, document_id, created_at and foreign key constraints
- [ ] Create `feature_documents` link table with feature_id, document_id, created_at and foreign key constraints
- [ ] Create `task_documents` link table with task_id, document_id, created_at and foreign key constraints
- [ ] All link tables use composite PRIMARY KEY (parent_id, document_id)
- [ ] Implement ON DELETE CASCADE for all foreign keys to handle orphan cleanup
- [ ] Create indexes on all foreign key columns for join performance

### Non-Functional Requirements

- [ ] Schema must support backward compatibility with existing databases (auto-migration safe)
- [ ] Queries must complete in <100ms for typical workloads (10k documents, 100k links)
- [ ] Unique constraints prevent duplicate document entries

## Implementation Plan

### Steps

1. [ ] Analyze existing migration system in `internal/db/db.go` to understand auto-migration pattern
2. [ ] Add migration function `migrateDocumentTables()` to `internal/db/db.go`
3. [ ] Implement `documents` table with columns: id (PRIMARY KEY), title TEXT NOT NULL, file_path TEXT NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, UNIQUE(title, file_path)
4. [ ] Implement `epic_documents` link table with foreign key to epics(id)
5. [ ] Implement `feature_documents` link table with foreign key to features(id)
6. [ ] Implement `task_documents` link table with foreign key to tasks(id)
7. [ ] Create composite primary keys for all link tables: (parent_id, document_id)
8. [ ] Create indexes: idx_documents_title, idx_documents_file_path, idx_epic_documents_epic_id, idx_feature_documents_feature_id, idx_task_documents_task_id
9. [ ] Test migration on clean database and existing database with data
10. [ ] Verify schema matches architecture review specification

### Technical Approach

- Use existing migration pattern from project (check migrations in `internal/db/db.go`)
- Migration must be idempotent (safe to run multiple times)
- Use prepared statements for schema creation
- Add conditional checks (`IF NOT EXISTS`) for all CREATE TABLE and CREATE INDEX statements

## Deliverables

- [ ] Migration function in `internal/db/db.go`
- [ ] All four tables created with correct constraints
- [ ] All indexes created for performance
- [ ] Schema verified via `sqlite3 shark-tasks.db .schema`

## Acceptance Criteria

- [ ] `documents` table exists with all required columns and constraints
- [ ] `epic_documents`, `feature_documents`, `task_documents` tables created with correct structure
- [ ] Foreign key constraints enforce referential integrity
- [ ] ON DELETE CASCADE works correctly
- [ ] All indexes created successfully
- [ ] Migration runs without errors on clean and existing databases
- [ ] `make test` passes (integration tests validate schema)

## Testing Strategy

- [ ] Verify schema with: `sqlite3 shark-tasks.db ".schema documents"`
- [ ] Verify constraints with UNIQUE enforcement test
- [ ] Verify foreign keys: Try inserting invalid epic_id (should fail)
- [ ] Verify cascade delete: Delete epic, verify epic_documents records are deleted
- [ ] Integration test in `internal/repository/document_repository_test.go` validates schema

## Dependencies

No upstream dependencies. Schema must be created before DocumentRepository (T-E07-F05-002) can be implemented.

## Notes

- Schema implementation follows patterns from `internal/db/migrations.go` (or similar)
- Use isSQLiteError helper for constraint validation in tests
