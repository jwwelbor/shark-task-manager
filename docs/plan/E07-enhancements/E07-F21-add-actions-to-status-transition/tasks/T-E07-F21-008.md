
---
key: T-E07-F21-008
title: Add orchestrator action to task complete command
epic: E07
feature: E07-F21
agent: backend
status: todo
priority: 7
depends_on: ["T-E07-F21-006"]
created_at: 2026-01-15T01:52:56Z
---

# Task: Add orchestrator action to task complete command

## Goal

Enhance the `shark task complete` command to return `orchestrator_action` metadata when transitioning tasks from `in_progress` to `ready_for_review`. This applies the response enhancement pattern (established in T-E07-F21-006) specifically to the complete command.

**Context**: Following the pattern from T-E07-F21-006, this task ensures the `task complete` command returns orchestrator actions, enabling orchestrators to receive next-step instructions immediately when a task is completed.

**User Story**: As an orchestrator developer, when an agent completes a task and runs `shark task complete`, I want to receive the orchestrator action for the `ready_for_review` status so that I can immediately spawn a reviewer agent without an additional query.

**Impact**: Reduces orchestrator complexity and API calls for the task completion flow, which is one of the most common status transitions in the workflow.

## Command Behavior Changes

### Current Behavior

**Existing `shark task complete` Command**:
```bash
shark task complete T-E01-F03-002 --json
# Response: {"id": 123, "key": "T-E01-F03-002", "status": "ready_for_review", ...}
```

### New Behavior

**Enhanced `shark task complete` Command**:
```bash
shark task complete T-E01-F03-002 --json
# Response includes orchestrator_action:
{
  "id": 123,
  "key": "T-E01-F03-002",
  "status": "ready_for_review",
  "orchestrator_action": {
    "action": "spawn_agent",
    "agent_type": "qa-engineer",
    "skills": ["quality", "testing"],
    "instruction": "Launch a QA engineer to review task T-E01-F03-002..."
  }
}
```

### Command Signature

**No changes to command signature** - this is a response enhancement only:
```bash
shark task complete <task-key> [--notes="..."] [--json]
```

## Response Format Specification

### JSON Output Structure

**Complete Task Complete Response**:
```json
{
  "id": 123,
  "key": "T-E01-F03-002",
  "slug": "implement-user-authentication",
  "feature_id": 45,
  "epic_id": 7,
  "title": "Implement user authentication",
  "description": "Add JWT-based authentication to API",
  "status": "ready_for_review",
  "priority": 5,
  "agent_type": "developer",
  "depends_on": ["T-E01-F03-001"],
  "file_path": "docs/plan/E01-platform/E01-F03-auth/tasks/T-E01-F03-002.md",
  "created_at": "2026-01-15T10:00:00Z",
  "updated_at": "2026-01-15T14:30:00Z",
  "orchestrator_action": {
    "action": "spawn_agent",
    "agent_type": "qa-engineer",
    "skills": ["quality", "testing", "code-review"],
    "instruction": "Launch a QA engineer to review task T-E01-F03-002. Verify implementation meets acceptance criteria, test edge cases, and ensure code quality standards are met."
  }
}
```

### Backward Compatibility

**Missing orchestrator_action**: When no action is defined for `ready_for_review` status, the field is **omitted**:

```json
{
  "id": 123,
  "key": "T-E01-F03-002",
  "status": "ready_for_review"
  // NO orchestrator_action field - omitted entirely
}
```

### Human-Readable Output

When `--json` flag is not used:

**With orchestrator action**:
```
Task T-E01-F03-002 completed successfully
Status: in_progress → ready_for_review

Next Action:
  Type: spawn_agent
  Agent: qa-engineer
  Skills: quality, testing, code-review

Instruction: Launch a QA engineer to review task T-E01-F03-002...
```

**Without orchestrator action**:
```
Task T-E01-F03-002 completed successfully
Status: in_progress → ready_for_review

Next Action: None configured
```

## Implementation Details

### CLI Command Changes

**Location**: `internal/cli/commands/task.go`

**Method to Enhance**: `runTaskComplete` (or equivalent complete command handler)

**Current Flow**:
1. Validate task key
2. Get task from repository
3. Verify task is in `in_progress` status
4. Update status to `ready_for_review`
5. Return updated task

**Enhanced Flow**:
1. Validate task key
2. Get task from repository
3. Verify task is in `in_progress` status
4. **Call repository UpdateStatus method** (returns Task + OrchestratorAction)
5. **Include orchestrator_action in response**
6. **Display action summary in human output**

**Implementation Approach**:
```go
// Pseudo-code
func runTaskComplete(cmd *cobra.Command, args []string) error {
    // 1. Validate input
    taskKey := args[0]
    notes := cmd.Flags().GetString("notes")

    // 2. Get repository (uses pattern from T-E07-F21-006)
    db := getDB()
    repo := repository.NewTaskRepository(db)

    // 3. Update status to ready_for_review
    task, action, err := repo.UpdateStatus(ctx, taskKey, "ready_for_review")
    if err != nil {
        return fmt.Errorf("failed to complete task: %w", err)
    }

    // 4. Add notes if provided
    if notes != "" {
        // Add to task history
    }

    // 5. Format response
    if cli.GlobalConfig.JSON {
        // Include orchestrator_action in JSON (uses omitempty)
        response := TaskCompleteResponse{
            Task: task,
            OrchestratorAction: action, // nil if not defined
        }
        return cli.OutputJSON(response)
    }

    // Human-readable output
    cli.Success(fmt.Sprintf("Task %s completed successfully", taskKey))
    fmt.Printf("Status: in_progress → ready_for_review\n\n")

    if action != nil {
        displayOrchestratorAction(action)
    } else {
        fmt.Println("Next Action: None configured")
    }

    return nil
}
```

### Repository Integration

**Uses existing pattern from T-E07-F21-006**:
- Repository `UpdateStatus` method already returns (Task, OrchestratorAction, error)
- No repository changes needed (already implemented in T-E07-F21-006)
- Command handler simply calls `UpdateStatus(ctx, taskKey, "ready_for_review")`

### Error Handling

**Follows T-E07-F21-006 pattern**:

| Scenario | Handling | Response |
|----------|----------|----------|
| Task not in `in_progress` | Return validation error | Fail with clear message |
| Status has no orchestrator_action | Return nil action, omit from response | Success |
| Config service unavailable | Log warning, return nil action | Success |
| Template variable missing | Use template as-is | Success |

**Error Messages**:
- **Invalid state**: "Cannot complete task: current status is 'todo', must be 'in_progress'"
- **Task not found**: "Task not found: T-E01-F03-999"
- **Missing action** (debug log): "No orchestrator action defined for status 'ready_for_review'"

## Acceptance Criteria

**From User Story**:
- [ ] `shark task complete` returns `orchestrator_action` when `ready_for_review` status has action defined
- [ ] Action includes `action`, `agent_type`, `skills`, and `instruction` fields
- [ ] Template variables (e.g., `{task_id}`) are populated in instructions
- [ ] Response is backward compatible (missing actions don't break existing code)
- [ ] JSON output format matches specification above

**Additional Criteria**:
- [ ] Human-readable output displays action summary clearly
- [ ] Missing orchestrator_action results in field omission (not null, not error)
- [ ] Notes flag still works as expected
- [ ] Only tasks in `in_progress` status can be completed (existing validation)
- [ ] Performance impact <10ms additional latency

**Integration Requirements**:
- [ ] Uses repository `UpdateStatus` method (from T-E07-F21-006)
- [ ] JSON serialization uses `omitempty` for orchestrator_action
- [ ] Works with existing task complete workflow

## Testing Requirements

### Unit Tests

**Command Handler Tests**:
- [ ] `shark task complete` includes orchestrator_action in JSON output when defined
- [ ] `shark task complete` omits orchestrator_action when not defined (backward compat)
- [ ] JSON serialization uses `omitempty` for orchestrator_action
- [ ] Human-readable output displays action summary correctly
- [ ] Missing actions handled without errors
- [ ] Notes flag still works when orchestrator_action is present

**Status Validation**:
- [ ] Cannot complete task in `todo` status (validation error)
- [ ] Cannot complete task in `ready_for_review` status (already complete)
- [ ] Cannot complete task in `completed` status (already done)
- [ ] Can complete task in `in_progress` status (happy path)

**Action Types**:
- [ ] `spawn_agent` action for `ready_for_review` includes all required fields
- [ ] `pause` action omits agent-specific fields
- [ ] Missing action returns nil without errors

### Integration Tests

**End-to-End Workflow**:
- [ ] Create task in `in_progress` status
- [ ] Run `shark task complete T-E01-F03-002 --json`
- [ ] Verify status changed to `ready_for_review`
- [ ] Verify orchestrator_action in response
- [ ] Verify instruction includes task ID

**Config Service Integration**:
- [ ] Config service loaded with orchestrator_action for `ready_for_review`
- [ ] Command retrieves action from config
- [ ] Action matches config definition
- [ ] Missing actions return nil without errors

**Template Engine Integration**:
- [ ] Template {task_id} replaced with actual task key
- [ ] Template populated correctly in JSON response
- [ ] Template populated correctly in human output

**Backward Compatibility**:
- [ ] Works with configs that don't define orchestrator_action
- [ ] Existing scripts using `shark task complete` continue to work
- [ ] Response format compatible with previous versions

### Manual Testing Scenarios

**Scenario 1: Complete task with orchestrator action defined**
```bash
# Setup: Config has orchestrator_action for ready_for_review
shark task complete T-E01-F03-002 --json
# Expected: Response includes action with qa-engineer agent
```

**Scenario 2: Complete task without orchestrator action**
```bash
# Setup: Config has no orchestrator_action for ready_for_review
shark task complete T-E01-F03-002 --json
# Expected: Response omits orchestrator_action field (not null)
```

**Scenario 3: Complete task with notes**
```bash
shark task complete T-E01-F03-002 --notes="All tests passing" --json
# Expected: Notes recorded, orchestrator_action included
```

**Scenario 4: Try to complete task not in progress**
```bash
shark task complete T-E01-F03-002 --json
# Task status: todo
# Expected: Error "Cannot complete task: current status is 'todo', must be 'in_progress'"
```

## Notes

### Design Decisions

**Why focus on `task complete` command?**
- One of the most common status transitions in workflow
- Completes developer → reviewer handoff
- High-value orchestration point (spawning QA agents)

**Why same pattern as T-E07-F21-006?**
- Consistency across all status transition commands
- Reuses existing repository integration
- Minimal code changes (command handler only)

**Why not add new flags or options?**
- Goal is response enhancement, not behavior change
- Keeps API simple and backward compatible
- Orchestrator decides whether to use action data

### Dependencies

**MUST complete before starting**:
- T-E07-F21-006: Task update response enhancement (establishes pattern)

**Blockers**: None - T-E07-F21-006 provides all infrastructure needed

### Related Tasks

**Similar command enhancements**:
- T-E07-F21-009: Add orchestrator action to `task approve`
- T-E07-F21-010: Add orchestrator action to `task start`
- All follow the same pattern established here

### Implementation Checklist

**Phase 1: Command Handler Update** (2 hours):
- [ ] Modify `runTaskComplete` to use repository `UpdateStatus` method
- [ ] Add orchestrator_action to JSON response struct
- [ ] Implement human-readable action display
- [ ] Unit tests for command handler

**Phase 2: Integration Testing** (1 hour):
- [ ] End-to-end workflow tests
- [ ] Config integration tests
- [ ] Backward compatibility tests

**Phase 3: Documentation** (30 minutes):
- [ ] Update command help text
- [ ] Add examples to CLI documentation
- [ ] Document response format

### Example Usage

**Development Workflow**:
```bash
# Developer completes implementation
shark task complete T-E01-F03-002 --notes="JWT auth implemented, all tests passing" --json

# Response includes next action
{
  "key": "T-E01-F03-002",
  "status": "ready_for_review",
  "orchestrator_action": {
    "action": "spawn_agent",
    "agent_type": "qa-engineer",
    "skills": ["quality", "testing", "code-review"],
    "instruction": "Launch a QA engineer to review task T-E01-F03-002..."
  }
}

# Orchestrator spawns QA agent immediately using action data
```

**Backward Compatible Usage**:
```bash
# Existing scripts continue to work
shark task complete T-E01-F03-002
# Output: "Task T-E01-F03-002 completed successfully"
# (orchestrator_action silently omitted if not configured)
```
