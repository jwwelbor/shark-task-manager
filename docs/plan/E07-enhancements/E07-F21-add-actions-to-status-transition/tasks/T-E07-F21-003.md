
---
key: T-E07-F21-003
title: Implement OrchestratorAction validation
epic: E07
feature: E07-F21
agent: backend
status: todo
priority: 9
depends_on: ["T-E07-F21-001"]
created_at: 2026-01-15T01:52:55Z
---

# Task: Implement OrchestratorAction validation

## Goal

Implement comprehensive validation for `OrchestratorAction` configurations to ensure workflow configurations are correct at **config load time** (fail-fast), preventing runtime errors from invalid action definitions.

**Why this matters**: Validation catches configuration errors immediately when Shark loads `.sharkconfig.json`, providing clear, actionable error messages that guide users to fix issues before deployment. This prevents orchestrators from receiving invalid action instructions during task transitions.

**Key principle**: Fail-fast at configuration load time, not at runtime.

## Validation Requirements

### Required Field Validation

**All Action Types** (spawn_agent, pause, wait_for_triage, archive):
- [ ] `action` field is present and non-empty
- [ ] `action` value is one of the four valid enum values
- [ ] `instruction_template` field is present and non-empty

**spawn_agent Action** (additional requirements):
- [ ] `agent_type` field is present and non-empty string
- [ ] `skills` field is present and is a non-empty array
- [ ] Each skill in `skills` array is a non-empty string

**Other Actions** (pause, wait_for_triage, archive):
- [ ] No additional required fields beyond action and instruction_template
- [ ] `agent_type` and `skills` are optional and ignored if present

### Enum Validation

**Valid Action Types**:
- `spawn_agent` - Launch an AI agent
- `pause` - Wait, do not spawn agent
- `wait_for_triage` - Human decision needed
- `archive` - Task complete, no further action

**Invalid Action Types**:
- Any string not in the enum above
- Empty string
- Null or missing (when orchestrator_action object is present)

### Template Syntax Validation

**Template Variable Syntax**:
- [ ] Validate template contains valid placeholder syntax: `{variable_name}`
- [ ] Currently supported: `{task_id}`
- [ ] Warn on unknown placeholders (future: {epic_id}, {feature_id}, etc.)
- [ ] Empty template is invalid (required field)

**Template Validation Rules**:
- Must be non-empty string
- Should contain at least one valid placeholder (warning if missing)
- Malformed placeholders like `{unclosed` or `unbraced}` generate warnings
- Maximum length: 2000 characters (reasonable instruction limit)

### Error Message Specifications

**Format**: All validation errors must specify:
1. **Status name** where error occurred
2. **Field name** that has the issue
3. **Problem description** (what's wrong)
4. **Suggested fix** (how to resolve)

**Error Message Examples**:

```
Error: Invalid orchestrator_action in status 'ready_for_development'
  Field: action
  Problem: Invalid action type "spawn-agent" (note: hyphen instead of underscore)
  Valid values: spawn_agent, pause, wait_for_triage, archive
  Fix: Change "spawn-agent" to "spawn_agent"
```

```
Error: Incomplete orchestrator_action in status 'ready_for_refinement_ba'
  Field: agent_type
  Problem: Missing required field for spawn_agent action
  Fix: Add "agent_type": "business-analyst" to orchestrator_action
```

```
Error: Invalid orchestrator_action in status 'ready_for_development'
  Field: skills
  Problem: Empty skills array for spawn_agent action
  Fix: Add at least one skill, e.g., "skills": ["implementation", "shark-task-management"]
```

```
Warning: Orchestrator action template in status 'ready_for_qa'
  Field: instruction_template
  Issue: Template does not contain {task_id} placeholder
  Suggestion: Consider adding {task_id} to instruction for context
```

### Validation Integration Points

**When Validation Runs**:

1. **Configuration Load** (`shark` CLI startup):
   - Parse `.sharkconfig.json`
   - Validate all `status_metadata` entries
   - If any `orchestrator_action` is invalid, fail with clear error
   - Exit code: 2 (configuration error)

2. **Configuration Validation Command** (`shark workflow validate-actions`):
   - Explicitly validate all orchestrator actions
   - Report all validation results (pass/fail per status)
   - `--strict` mode fails if any actionable status lacks orchestrator_action
   - Exit code: 0 (all valid), 1 (validation errors)

3. **Configuration Set Command** (`shark config set`):
   - If modifying status_metadata, re-validate configuration
   - Reject invalid changes with clear error message
   - Atomic: only persist valid configurations

**Fail-Fast Behavior**:
- Invalid configuration prevents Shark from starting
- No runtime validation needed (already validated at load)
- Orchestrators receive pre-validated action configurations

## Implementation Approach

### File Location

Extend existing validation in `internal/config/orchestrator_action.go`

### Validation Function Signature

```go
// Validate validates the OrchestratorAction configuration
// Returns detailed validation error with context
func (oa *OrchestratorAction) Validate(statusName string) error {
    // statusName parameter enables context-rich error messages
    // Returns ValidationError with field, problem, and suggested fix
}

// ValidateAll validates all orchestrator actions in status_metadata
// Returns slice of validation errors (empty if all valid)
func ValidateAllOrchestratorActions(statusMetadata map[string]StatusMetadata) []ValidationError
```

### Validation Error Type

```go
// ValidationError provides detailed context for configuration errors
type ValidationError struct {
    StatusName   string // Which status has the error
    FieldName    string // Which field is invalid
    Problem      string // What's wrong
    SuggestedFix string // How to fix it
}

func (ve ValidationError) Error() string {
    // Format: "Error: Invalid orchestrator_action in status 'X'\n  Field: Y\n  Problem: Z\n  Fix: W"
}
```

### Validation Logic Flow

```go
func (oa *OrchestratorAction) Validate(statusName string) error {
    // 1. Validate action enum
    if !isValidActionType(oa.Action) {
        return &ValidationError{
            StatusName:   statusName,
            FieldName:    "action",
            Problem:      fmt.Sprintf("Invalid action type \"%s\"", oa.Action),
            SuggestedFix: fmt.Sprintf("Use one of: %s", strings.Join(ValidActionTypes, ", ")),
        }
    }

    // 2. Validate instruction_template (required for all actions)
    if strings.TrimSpace(oa.InstructionTemplate) == "" {
        return &ValidationError{
            StatusName:   statusName,
            FieldName:    "instruction_template",
            Problem:      "Missing required field",
            SuggestedFix: "Add instruction_template with {task_id} placeholder",
        }
    }

    // 3. Validate spawn_agent specific requirements
    if oa.Action == ActionSpawnAgent {
        if strings.TrimSpace(oa.AgentType) == "" {
            return &ValidationError{
                StatusName:   statusName,
                FieldName:    "agent_type",
                Problem:      "Missing required field for spawn_agent action",
                SuggestedFix: "Add agent_type (e.g., \"developer\", \"business-analyst\")",
            }
        }

        if len(oa.Skills) == 0 {
            return &ValidationError{
                StatusName:   statusName,
                FieldName:    "skills",
                Problem:      "Empty or missing skills array for spawn_agent action",
                SuggestedFix: "Add at least one skill to skills array",
            }
        }

        // Check for empty skill strings
        for i, skill := range oa.Skills {
            if strings.TrimSpace(skill) == "" {
                return &ValidationError{
                    StatusName:   statusName,
                    FieldName:    fmt.Sprintf("skills[%d]", i),
                    Problem:      "Empty skill string in skills array",
                    SuggestedFix: "Remove empty skill or provide skill name",
                }
            }
        }
    }

    // 4. Validate template syntax (warnings, not errors)
    if warnings := validateTemplateSyntax(oa.InstructionTemplate); len(warnings) > 0 {
        // Log warnings but don't fail validation
        for _, warning := range warnings {
            log.Warnf("Status '%s': %s", statusName, warning)
        }
    }

    return nil
}
```

### Template Syntax Validation

```go
func validateTemplateSyntax(template string) []string {
    warnings := []string{}

    // Check for {task_id} placeholder
    if !strings.Contains(template, "{task_id}") {
        warnings = append(warnings, "Template does not contain {task_id} placeholder")
    }

    // Check for malformed placeholders
    if strings.Contains(template, "{") && !strings.Contains(template, "}") {
        warnings = append(warnings, "Malformed placeholder: unclosed brace {")
    }

    // Check for unknown placeholders (future: support {epic_id}, etc.)
    knownVars := []string{"{task_id}"}
    if placeholders := extractPlaceholders(template); len(placeholders) > 0 {
        for _, placeholder := range placeholders {
            if !contains(knownVars, placeholder) {
                warnings = append(warnings, fmt.Sprintf("Unknown placeholder %s (currently only {task_id} supported)", placeholder))
            }
        }
    }

    // Check maximum length
    if len(template) > 2000 {
        warnings = append(warnings, "Template exceeds 2000 character limit")
    }

    return warnings
}
```

## Acceptance Criteria

### Core Validation

- [ ] Validates `action` field is one of four valid enum values
- [ ] Validates `instruction_template` is present and non-empty for all action types
- [ ] Validates `agent_type` is present and non-empty for spawn_agent actions
- [ ] Validates `skills` array is present and non-empty for spawn_agent actions
- [ ] Validates individual skill strings are non-empty
- [ ] Other action types (pause, wait_for_triage, archive) don't require agent_type or skills

### Error Message Quality

- [ ] Error messages include status name where error occurred
- [ ] Error messages include field name that is invalid
- [ ] Error messages describe the problem clearly
- [ ] Error messages provide suggested fix
- [ ] Error message format is consistent and parseable

### Template Validation

- [ ] Warns if template doesn't contain {task_id} placeholder
- [ ] Warns on malformed placeholders (unclosed braces)
- [ ] Warns on unknown placeholders (future extensibility)
- [ ] Enforces maximum template length (2000 chars)
- [ ] Template warnings are logged but don't fail validation

### Integration Points

- [ ] Validation runs automatically on config load
- [ ] Invalid config causes Shark CLI to exit with code 2
- [ ] Validation errors printed to stderr before exit
- [ ] `shark workflow validate-actions` command explicitly validates all actions
- [ ] Configuration changes via `shark config set` are validated before persisting

### Backward Compatibility

- [ ] Missing `orchestrator_action` is valid (optional field)
- [ ] Validation only runs when `orchestrator_action` is present
- [ ] Existing configs without orchestrator_action continue to work
- [ ] No breaking changes to existing StatusMetadata structure

## Testing Requirements

### Unit Tests

Create `internal/config/orchestrator_action_validation_test.go`:

**Valid Configuration Tests**:
- [ ] **TestValidate_SpawnAgent_Valid**: All required fields present, validation passes
- [ ] **TestValidate_Pause_Valid**: Only action and instruction_template, validation passes
- [ ] **TestValidate_WaitForTriage_Valid**: Only action and instruction_template, validation passes
- [ ] **TestValidate_Archive_Valid**: Only action and instruction_template, validation passes

**Invalid Action Type Tests**:
- [ ] **TestValidate_InvalidActionType**: "spawn-agent" (hyphen) fails with clear error
- [ ] **TestValidate_EmptyAction**: Empty action string fails
- [ ] **TestValidate_UnknownAction**: "custom_action" fails with enum values in error

**Missing Required Fields Tests**:
- [ ] **TestValidate_MissingInstructionTemplate**: Fails for all action types
- [ ] **TestValidate_SpawnAgent_MissingAgentType**: Fails with suggested fix
- [ ] **TestValidate_SpawnAgent_MissingSkills**: Fails with suggested fix
- [ ] **TestValidate_SpawnAgent_EmptySkills**: Empty array fails
- [ ] **TestValidate_SpawnAgent_EmptySkillString**: Skill array contains "" fails

**Template Validation Tests**:
- [ ] **TestValidateTemplate_NoPlaceholder**: Warning logged but validation passes
- [ ] **TestValidateTemplate_MalformedPlaceholder**: "{unclosed" generates warning
- [ ] **TestValidateTemplate_UnknownPlaceholder**: "{epic_id}" generates warning (not yet supported)
- [ ] **TestValidateTemplate_TooLong**: Template >2000 chars generates warning

**Error Message Tests**:
- [ ] **TestValidationError_Format**: Error message includes status, field, problem, fix
- [ ] **TestValidationError_Parseable**: Error format is consistent and machine-parseable
- [ ] **TestValidateAll_MultipleErrors**: Returns all errors, not just first

### Integration Tests

Create/extend `internal/config/config_integration_test.go`:

**Config Load Tests**:
- [ ] **TestConfigLoad_ValidOrchestratorActions**: Config with valid actions loads successfully
- [ ] **TestConfigLoad_InvalidOrchestratorAction**: Config with invalid action fails to load
- [ ] **TestConfigLoad_PartiallyInvalid**: Multiple statuses, one invalid, fails with all errors listed
- [ ] **TestConfigLoad_MissingOrchestratorAction**: Config without orchestrator_action loads (backward compat)

**Validation Command Tests**:
- [ ] **TestValidateActionsCommand_AllValid**: Returns exit code 0, success message
- [ ] **TestValidateActionsCommand_SomeInvalid**: Returns exit code 1, lists all errors
- [ ] **TestValidateActionsCommand_StrictMode**: Warns if "ready_for_*" statuses lack actions

**Edge Cases**:
- [ ] **TestValidate_NullOrchestratorAction**: Null pointer handled gracefully
- [ ] **TestValidate_ExtraFields**: Extra fields in JSON are ignored (forward compatibility)

### Test Data Examples

**Valid spawn_agent**:
```json
{
  "action": "spawn_agent",
  "agent_type": "developer",
  "skills": ["implementation", "testing"],
  "instruction_template": "Implement task {task_id} following TDD"
}
```

**Invalid spawn_agent (missing agent_type)**:
```json
{
  "action": "spawn_agent",
  "skills": ["implementation"],
  "instruction_template": "Implement task {task_id}"
}
```

**Valid pause**:
```json
{
  "action": "pause",
  "instruction_template": "Task {task_id} is blocked"
}
```

**Invalid action type**:
```json
{
  "action": "invalid_type",
  "instruction_template": "Do something"
}
```

## Files to Create/Modify

### Create New Files

1. `internal/config/orchestrator_action_validation_test.go` - Comprehensive validation tests
2. `internal/config/validation_error.go` - ValidationError type and formatting

### Modify Existing Files

1. `internal/config/orchestrator_action.go` - Add Validate() method with detailed errors
2. `internal/config/config.go` - Call validation on config load, fail fast if invalid
3. `internal/cli/commands/workflow.go` - Implement `shark workflow validate-actions` command

## Documentation Requirements

- [ ] Document validation rules in `docs/CLI_REFERENCE.md` (Workflow Configuration section)
- [ ] Provide examples of common validation errors and fixes
- [ ] Document when validation runs (load time vs explicit command)
- [ ] Document error message format for programmatic parsing
- [ ] Add troubleshooting section for common configuration errors

## Related Documents

- Feature PRD: `docs/plan/E07-enhancements/E07-F21-add-actions-to-status-transition/feature.md`
- Schema definition: Task T-E07-F21-001
- Workflow Config Design: `docs/plan/E07-enhancements/E07-F21-add-actions-to-status-transition/shark-workflow-config-design.md`

## Performance Requirements

- **Validation time per action**: <1ms (simple field checks)
- **Total config load time**: <100ms (REQ-NF-002 from PRD)
- **Validation must not block**: Fail fast on load, provide all errors at once

## Notes

**Fail-Fast Philosophy**: Validation errors are fatal at configuration load time. This prevents Shark from operating with invalid configurations and ensures orchestrators never receive invalid action instructions.

**Error Aggregation**: When validating all statuses, collect ALL validation errors and report them together. Don't stop at first error. This helps users fix multiple issues in one iteration.

**Future Extensibility**: Validation logic should be extensible to support:
- Additional template variables ({epic_id}, {feature_id}, etc.)
- Custom action types (if added in future)
- Conditional validation rules (e.g., agent_type must match certain patterns)

**Backward Compatibility**: Existing configs without orchestrator_action must continue to work. Validation only runs when the field is present.
