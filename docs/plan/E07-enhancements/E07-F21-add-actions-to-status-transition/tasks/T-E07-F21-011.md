
---
key: T-E07-F21-011
title: Implement workflow validate-actions command
epic: E07
feature: E07-F21
agent: backend
status: todo
priority: 7
depends_on: ["T-E07-F21-001"]
created_at: 2026-01-15T01:52:59Z
---

# Task: Implement workflow validate-actions command

## Goal

Implement the `shark workflow validate-actions` command to validate workflow configuration completeness. This command helps catch configuration errors before deployment by checking that all statuses have appropriate orchestrator actions defined and that the action schemas are correct.

**Why this matters**: Invalid workflow configurations can cause runtime failures when orchestrators try to process status transitions. This command provides clear, actionable feedback to configuration managers, enabling them to fix issues before deployment.

**User Story**: As a workflow configuration manager, I want to validate that all actionable statuses have orchestrator actions defined so that I catch configuration errors before deployment.

## Command Specification

### Command Syntax

```bash
shark workflow validate-actions [--strict] [--json]
```

### Flags

- `--strict`: Fail with non-zero exit code if any status lacks an orchestrator action (default: warnings only)
- `--json`: Output validation results in JSON format

### Command Behavior

The command validates the `.sharkconfig.json` file and checks:

1. **Completeness**: All statuses have orchestrator actions defined
2. **Schema correctness**: Each orchestrator_action follows the schema from T-E07-F21-001
3. **Actionable status coverage**: Statuses matching pattern `ready_for_*` have actions (these are critical)
4. **Action type validity**: Action types are one of: spawn_agent, pause, wait_for_triage, archive
5. **Required fields**: spawn_agent actions have agent_type and skills defined

## Validation Checks

### Check 1: Schema Validation

For each status with `orchestrator_action`:
- [ ] Action type is valid (spawn_agent, pause, wait_for_triage, archive)
- [ ] instruction_template is present and non-empty
- [ ] If action is spawn_agent: agent_type is present
- [ ] If action is spawn_agent: skills array is present and non-empty

**Error Message Format**:
```
Error: Invalid orchestrator_action in status "ready_for_development"
  - Missing required field: agent_type (required for spawn_agent action)
```

### Check 2: Completeness Check

For each status in `status_metadata`:
- [ ] Check if orchestrator_action is present
- [ ] If missing, determine severity:
  - **Warning**: Status does not match `ready_for_*` pattern
  - **Error (--strict mode)**: Any status without action
  - **Critical Warning**: Status matches `ready_for_*` but has no action

**Warning Message Format**:
```
Warning: Status "ready_for_development" has no orchestrator_action defined
  - This status is actionable (matches ready_for_* pattern)
  - Consider adding an orchestrator_action to automate workflow
```

### Check 3: Actionable Status Coverage

Statuses matching `ready_for_*` are considered actionable (orchestrator should spawn agents):
- [ ] ready_for_refinement_ba
- [ ] ready_for_refinement_tech
- [ ] ready_for_development
- [ ] ready_for_code_review
- [ ] ready_for_qa
- [ ] ready_for_approval

**Critical Warning** if any of these lack orchestrator_action.

### Check 4: Template Syntax Validation

Check `instruction_template` for basic syntax errors:
- [ ] Contains at least one character
- [ ] If contains `{task_id}`, verify placeholder syntax is correct
- [ ] Future: validate other template variables

## Output Format

### Human-Readable Output

```
Validating workflow configuration...

✅ Status "ready_for_development": Valid
   - Action: spawn_agent
   - Agent: developer
   - Skills: test-driven-development, implementation, shark-task-management

⚠️  Status "ready_for_deployment": Missing orchestrator_action
   - This status is actionable (matches ready_for_* pattern)
   - Recommendation: Add spawn_agent or wait_for_triage action

❌ Status "ready_for_qa": Invalid orchestrator_action
   - Missing required field: skills (required for spawn_agent action)

✅ Status "blocked": Valid
   - Action: pause

✅ Status "completed": Valid
   - Action: archive

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Validation Summary
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Total statuses: 5
Valid: 3
Warnings: 1
Errors: 1

⚠️  Validation completed with warnings
❌ Run with --strict to fail on warnings
```

### JSON Output

```json
{
  "valid": true,
  "strict_mode": false,
  "total_statuses": 5,
  "valid_count": 3,
  "warning_count": 1,
  "error_count": 1,
  "results": [
    {
      "status": "ready_for_development",
      "valid": true,
      "action_type": "spawn_agent",
      "agent_type": "developer",
      "skills": ["test-driven-development", "implementation", "shark-task-management"]
    },
    {
      "status": "ready_for_deployment",
      "valid": false,
      "severity": "warning",
      "message": "Missing orchestrator_action (actionable status)",
      "recommendation": "Add spawn_agent or wait_for_triage action"
    },
    {
      "status": "ready_for_qa",
      "valid": false,
      "severity": "error",
      "message": "Missing required field: skills (required for spawn_agent action)"
    },
    {
      "status": "blocked",
      "valid": true,
      "action_type": "pause"
    },
    {
      "status": "completed",
      "valid": true,
      "action_type": "archive"
    }
  ]
}
```

## Exit Codes

- **0**: Validation passed (or passed with warnings in non-strict mode)
- **1**: Validation failed (errors found, or warnings in --strict mode)

## Implementation Approach

### File Location

Create new file: `internal/cli/commands/workflow_validate_actions.go`

### Implementation Steps

1. **Load configuration**: Use existing config loader from `internal/config`
2. **Iterate status_metadata**: For each status, validate orchestrator_action
3. **Apply validation rules**: Use OrchestratorAction.Validate() from T-E07-F21-001
4. **Detect actionable statuses**: Check if status name matches `ready_for_*` pattern
5. **Collect results**: Store validation results for each status
6. **Format output**: Human-readable table or JSON based on --json flag
7. **Determine exit code**: Based on errors and --strict mode

### Key Functions

```go
// ValidateWorkflowActions validates all orchestrator actions in config
func ValidateWorkflowActions(cfg *config.Config, strict bool) (*ValidationReport, error) {
    report := &ValidationReport{
        StrictMode: strict,
        Results:    make([]StatusValidationResult, 0),
    }

    for status, metadata := range cfg.StatusMetadata {
        result := validateStatus(status, metadata, strict)
        report.Results = append(report.Results, result)

        if result.Severity == "error" {
            report.ErrorCount++
        } else if result.Severity == "warning" {
            report.WarningCount++
        } else {
            report.ValidCount++
        }
    }

    report.TotalStatuses = len(cfg.StatusMetadata)
    report.Valid = report.ErrorCount == 0 && (!strict || report.WarningCount == 0)

    return report, nil
}

// validateStatus validates a single status's orchestrator_action
func validateStatus(status string, metadata *config.StatusMetadata, strict bool) StatusValidationResult {
    result := StatusValidationResult{
        Status: status,
        Valid:  true,
    }

    // No orchestrator_action defined
    if metadata.OrchestratorAction == nil {
        isActionable := strings.HasPrefix(status, "ready_for_")

        if isActionable {
            result.Valid = false
            result.Severity = "warning"
            result.Message = "Missing orchestrator_action (actionable status)"
            result.Recommendation = "Add spawn_agent or wait_for_triage action"
        } else if strict {
            result.Valid = false
            result.Severity = "warning"
            result.Message = "Missing orchestrator_action"
        }

        return result
    }

    // Validate orchestrator_action schema
    if err := metadata.OrchestratorAction.Validate(); err != nil {
        result.Valid = false
        result.Severity = "error"
        result.Message = err.Error()
        return result
    }

    // Valid - populate action details
    result.ActionType = metadata.OrchestratorAction.Action
    result.AgentType = metadata.OrchestratorAction.AgentType
    result.Skills = metadata.OrchestratorAction.Skills

    return result
}
```

### Data Structures

```go
type ValidationReport struct {
    Valid          bool                     `json:"valid"`
    StrictMode     bool                     `json:"strict_mode"`
    TotalStatuses  int                      `json:"total_statuses"`
    ValidCount     int                      `json:"valid_count"`
    WarningCount   int                      `json:"warning_count"`
    ErrorCount     int                      `json:"error_count"`
    Results        []StatusValidationResult `json:"results"`
}

type StatusValidationResult struct {
    Status         string   `json:"status"`
    Valid          bool     `json:"valid"`
    Severity       string   `json:"severity,omitempty"`        // "error" or "warning"
    Message        string   `json:"message,omitempty"`
    Recommendation string   `json:"recommendation,omitempty"`
    ActionType     string   `json:"action_type,omitempty"`
    AgentType      string   `json:"agent_type,omitempty"`
    Skills         []string `json:"skills,omitempty"`
}
```

## Acceptance Criteria

- [ ] `shark workflow validate-actions` checks all statuses in config
- [ ] Warns if `ready_for_*` statuses lack orchestrator actions
- [ ] `--strict` flag fails on any missing actions (exit code 1)
- [ ] Validates action schema correctness using OrchestratorAction.Validate()
- [ ] Output lists all statuses with validation results
- [ ] Human-readable output uses colors (green ✅, yellow ⚠️, red ❌)
- [ ] JSON output format matches specification above
- [ ] Exit code 0 for success, 1 for failure
- [ ] Error messages are clear and actionable
- [ ] Recommendation provided for fixable issues

## Testing Requirements

### Unit Tests

Create `internal/cli/commands/workflow_validate_actions_test.go`:

- [ ] **TestValidateActions_AllValid**: Config with all valid actions passes
- [ ] **TestValidateActions_MissingActionable**: Warning for missing `ready_for_*` action
- [ ] **TestValidateActions_StrictMode**: Strict mode fails on warnings
- [ ] **TestValidateActions_InvalidSchema**: Error for spawn_agent missing agent_type
- [ ] **TestValidateActions_NoActions**: Config with no actions shows warnings
- [ ] **TestValidateActions_MixedValidity**: Config with valid, warnings, and errors
- [ ] **TestValidateActions_JSONOutput**: JSON format matches schema
- [ ] **TestValidateActions_ExitCodes**: Correct exit codes for success/failure

### Integration Tests

- [ ] **TestWorkflowValidate_RealConfig**: Load actual `.sharkconfig.json` and validate
- [ ] **TestWorkflowValidate_ExampleConfigs**: Validate example configs from docs
- [ ] **TestWorkflowValidate_InvalidConfig**: Invalid config file fails gracefully

### Test Data

**Valid Config**:
```json
{
  "status_metadata": {
    "ready_for_development": {
      "orchestrator_action": {
        "action": "spawn_agent",
        "agent_type": "developer",
        "skills": ["implementation"],
        "instruction_template": "Implement {task_id}"
      }
    },
    "completed": {
      "orchestrator_action": {
        "action": "archive",
        "instruction_template": "Task {task_id} complete"
      }
    }
  }
}
```

**Invalid Config** (missing skills):
```json
{
  "status_metadata": {
    "ready_for_development": {
      "orchestrator_action": {
        "action": "spawn_agent",
        "agent_type": "developer",
        "instruction_template": "Implement {task_id}"
      }
    }
  }
}
```

## Documentation Requirements

- [ ] Add command to `docs/CLI_REFERENCE.md` under "Workflow Configuration" section
- [ ] Document all validation checks performed
- [ ] Provide examples of valid and invalid configurations
- [ ] Document exit codes
- [ ] Document --strict flag behavior
- [ ] Include example output (human and JSON)

## Related Tasks

- **Depends on**: T-E07-F21-001 (OrchestratorAction schema must be defined first)
- **Related**: T-E07-F21-012 (show-actions command - complements validation)

## Notes

**Actionable Status Pattern**: Statuses starting with `ready_for_` are considered actionable because they indicate the task is queued for agent work. These should almost always have orchestrator actions.

**Strict Mode Use Case**: CI/CD pipelines should use `--strict` to enforce 100% action coverage. Development workflows can use non-strict mode to allow incremental configuration.

**Future Enhancement**: Add validation for template variable syntax using regex or template parser to catch typos like `{taks_id}` (missing 's').

**Performance**: Validation should complete in <100ms even for large configs (50+ statuses) to meet REQ-NF-002.
