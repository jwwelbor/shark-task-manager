
---
key: T-E07-F21-001
title: Add OrchestratorAction schema to config
epic: E07
feature: E07-F21
agent: backend
status: todo
priority: 9
created_at: 2026-01-15T01:52:37Z
---

# Task: Add OrchestratorAction schema to config

## Goal

Define and implement the `OrchestratorAction` JSON schema in Shark's configuration system to support workflow-driven agent spawning. This schema will be added as an optional field within `status_metadata` in `.sharkconfig.json`, enabling orchestrators to receive execution instructions when task statuses change.

**Why this matters**: Currently, orchestrators have hardcoded workflow knowledge. By adding `orchestrator_action` to the config, workflow definitions become the single source of truth for both state management (Shark) and execution instructions (Orchestrator).

## Schema Definition

### OrchestratorAction Object Structure

The `orchestrator_action` object will be added to `status_metadata` with the following JSON schema:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "OrchestratorAction": {
      "type": "object",
      "required": ["action", "instruction_template"],
      "properties": {
        "action": {
          "type": "string",
          "enum": ["spawn_agent", "pause", "wait_for_triage", "archive"],
          "description": "Type of orchestrator action to perform"
        },
        "agent_type": {
          "type": "string",
          "description": "Agent type to spawn (required if action is spawn_agent)"
        },
        "skills": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of skills required for the agent"
        },
        "instruction_template": {
          "type": "string",
          "description": "Template string with {task_id} placeholder for agent instructions"
        }
      },
      "if": {
        "properties": { "action": { "const": "spawn_agent" } }
      },
      "then": {
        "required": ["agent_type", "skills"]
      }
    }
  }
}
```

### Action Types

Four action types are supported:

1. **spawn_agent**: Launch an AI agent to work on the task
   - **Required fields**: `action`, `agent_type`, `skills`, `instruction_template`
   - **Use case**: When task transitions to a status requiring agent work (e.g., `ready_for_development`)

2. **pause**: Wait, do not spawn agent
   - **Required fields**: `action`, `instruction_template`
   - **Use case**: When task is in a holding state (e.g., `blocked`, `on_hold`)

3. **wait_for_triage**: Human decision needed
   - **Required fields**: `action`, `instruction_template`
   - **Use case**: When task needs manual intervention or decision

4. **archive**: Task is complete, no further action
   - **Required fields**: `action`, `instruction_template`
   - **Use case**: Terminal statuses (e.g., `completed`, `cancelled`)

### Template Variable Substitution

The `instruction_template` field supports simple variable replacement:

- **{task_id}**: Replaced with actual task ID (e.g., `T-E07-F21-001`)
- **Implementation**: Simple string replacement using `strings.Replace()`
- **Future extensibility**: Additional variables like `{epic_id}`, `{feature_id}`, `{task_title}` can be added later

## Configuration File Structure

### Location

`.sharkconfig.json` in project root

### Example Configuration

```json
{
  "status_metadata": {
    "ready_for_development": {
      "color": "yellow",
      "description": "Queued for implementation",
      "phase": "development",
      "agent_types": ["developer"],
      "orchestrator_action": {
        "action": "spawn_agent",
        "agent_type": "developer",
        "skills": [
          "test-driven-development",
          "implementation",
          "shark-task-management"
        ],
        "instruction_template": "Launch a developer agent to implement task {task_id}. Write tests first, then implement to pass tests following the technical specifications."
      }
    },
    "blocked": {
      "color": "red",
      "description": "Waiting on external dependency",
      "phase": "any",
      "orchestrator_action": {
        "action": "pause",
        "instruction_template": "Task {task_id} is blocked. Do not spawn agent. Blocker reason documented in task notes."
      }
    },
    "completed": {
      "color": "green",
      "description": "Successfully delivered",
      "phase": "done",
      "orchestrator_action": {
        "action": "archive",
        "instruction_template": "Task {task_id} is completed. No further action needed."
      }
    }
  }
}
```

## Implementation Approach

### File Location

Create new Go package: `internal/config/orchestrator_action.go`

### Data Structures

```go
package config

// OrchestratorAction defines the action to take when a task enters a status
type OrchestratorAction struct {
    Action             string   `json:"action" yaml:"action"`
    AgentType          string   `json:"agent_type,omitempty" yaml:"agent_type,omitempty"`
    Skills             []string `json:"skills,omitempty" yaml:"skills,omitempty"`
    InstructionTemplate string  `json:"instruction_template" yaml:"instruction_template"`
}

// ActionType constants
const (
    ActionSpawnAgent     = "spawn_agent"
    ActionPause          = "pause"
    ActionWaitForTriage  = "wait_for_triage"
    ActionArchive        = "archive"
)

// ValidActionTypes for validation
var ValidActionTypes = []string{
    ActionSpawnAgent,
    ActionPause,
    ActionWaitForTriage,
    ActionArchive,
}
```

### Validation Logic

```go
// Validate validates the OrchestratorAction configuration
func (oa *OrchestratorAction) Validate() error {
    // Check action type is valid
    if !contains(ValidActionTypes, oa.Action) {
        return fmt.Errorf("invalid action type: %s (must be one of: %s)",
            oa.Action, strings.Join(ValidActionTypes, ", "))
    }

    // instruction_template is always required
    if strings.TrimSpace(oa.InstructionTemplate) == "" {
        return errors.New("instruction_template is required")
    }

    // spawn_agent requires agent_type and skills
    if oa.Action == ActionSpawnAgent {
        if strings.TrimSpace(oa.AgentType) == "" {
            return errors.New("agent_type is required for spawn_agent action")
        }
        if len(oa.Skills) == 0 {
            return errors.New("skills array is required and must not be empty for spawn_agent action")
        }
    }

    return nil
}

// PopulateTemplate replaces template variables with actual values
func (oa *OrchestratorAction) PopulateTemplate(taskID string) string {
    return strings.Replace(oa.InstructionTemplate, "{task_id}", taskID, -1)
}
```

### Integration with StatusMetadata

Extend existing `StatusMetadata` structure:

```go
type StatusMetadata struct {
    Color              string              `json:"color" yaml:"color"`
    Description        string              `json:"description" yaml:"description"`
    Phase              string              `json:"phase" yaml:"phase"`
    AgentTypes         []string            `json:"agent_types,omitempty" yaml:"agent_types,omitempty"`
    OrchestratorAction *OrchestratorAction `json:"orchestrator_action,omitempty" yaml:"orchestrator_action,omitempty"` // NEW FIELD
}
```

## Acceptance Criteria

- [ ] JSON schema defined for `OrchestratorAction` with four action types
- [ ] Go structs defined in `internal/config/orchestrator_action.go`
- [ ] Validation function checks:
  - Action type is one of: spawn_agent, pause, wait_for_triage, archive
  - instruction_template is always present
  - agent_type and skills are present for spawn_agent
- [ ] Template variable substitution implemented for {task_id}
- [ ] `StatusMetadata` struct extended with optional `orchestrator_action` field
- [ ] Backward compatibility maintained (missing orchestrator_action is valid)
- [ ] Configuration loads successfully with and without orchestrator_action
- [ ] Example `.sharkconfig.json` includes orchestrator_action for 3+ statuses

## Testing Requirements

### Unit Tests

Create `internal/config/orchestrator_action_test.go`:

- [ ] **TestOrchestratorAction_Validate_SpawnAgent**: Valid spawn_agent with all required fields passes
- [ ] **TestOrchestratorAction_Validate_SpawnAgent_MissingAgentType**: Fails with clear error
- [ ] **TestOrchestratorAction_Validate_SpawnAgent_MissingSkills**: Fails with clear error
- [ ] **TestOrchestratorAction_Validate_Pause**: Valid pause action passes
- [ ] **TestOrchestratorAction_Validate_InvalidAction**: "invalid_action" fails
- [ ] **TestOrchestratorAction_Validate_MissingInstruction**: Empty instruction_template fails
- [ ] **TestOrchestratorAction_PopulateTemplate**: {task_id} replaced correctly
- [ ] **TestOrchestratorAction_PopulateTemplate_NoPlaceholder**: Template without {task_id} unchanged

### Integration Tests

Create `internal/config/config_test.go` (extend existing tests):

- [ ] **TestConfig_LoadWithOrchestratorAction**: Load config with orchestrator_action succeeds
- [ ] **TestConfig_LoadWithoutOrchestratorAction**: Load config without orchestrator_action succeeds (backward compat)
- [ ] **TestConfig_ValidateOrchestratorActions**: Validation runs on all status_metadata entries
- [ ] **TestConfig_InvalidOrchestratorAction**: Invalid action in config fails fast with clear error

### Example Test Data

```json
{
  "status_metadata": {
    "ready_for_development": {
      "color": "yellow",
      "orchestrator_action": {
        "action": "spawn_agent",
        "agent_type": "developer",
        "skills": ["implementation"],
        "instruction_template": "Implement task {task_id}"
      }
    }
  }
}
```

## Files to Create/Modify

### Create New Files

1. `internal/config/orchestrator_action.go` - OrchestratorAction struct and validation
2. `internal/config/orchestrator_action_test.go` - Unit tests for validation and template population

### Modify Existing Files

1. `internal/config/config.go` - Extend StatusMetadata struct
2. `internal/config/config_test.go` - Add integration tests for config loading

## Documentation Requirements

- [ ] Add JSON schema reference to `docs/CLI_REFERENCE.md` (Workflow Configuration section)
- [ ] Document action types and when to use each
- [ ] Provide complete example configuration with all four action types
- [ ] Document template variable syntax ({task_id})
- [ ] Document backward compatibility (missing orchestrator_action is valid)

## Related Documents

- Feature PRD: `docs/plan/E07-enhancements/E07-F21-add-actions-to-status-transition/feature.md`
- Workflow Config Design: `docs/plan/E07-enhancements/E07-F21-add-actions-to-status-transition/shark-workflow-config-design.md`
- Schema examples in PRD: Section "JSON Schema"

## Notes

**Backward Compatibility**: The `orchestrator_action` field is optional. Existing configurations without this field will continue to work. Validation only runs on present `orchestrator_action` objects.

**Future Extensibility**: The schema is designed to be extensible:
- Additional action types can be added to the enum
- New template variables can be added (e.g., {epic_id}, {feature_id})
- Advanced template engine (text/template) can replace simple string replacement in Phase 4

**Performance**: JSON schema validation should complete in <10ms per status_metadata entry to meet REQ-NF-002 (configuration load time <100ms).

**Error Messages**: Validation errors must be clear and actionable, specifying which status and which field has the issue.
