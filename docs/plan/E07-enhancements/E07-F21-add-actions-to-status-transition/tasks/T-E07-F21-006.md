
---
key: T-E07-F21-006
title: Enhance task update response with orchestrator action
epic: E07
feature: E07-F21
agent: backend
status: todo
priority: 8
depends_on: ["T-E07-F21-001", "T-E07-F21-002", "T-E07-F21-004"]
created_at: 2026-01-15T01:52:56Z
---

# Task: Enhance task update response with orchestrator action

## Goal

Enhance the `shark task update` command and underlying repository layer to return `orchestrator_action` metadata in status transition responses. This enables AI Agent Orchestrators to receive complete execution instructions in a single API call, eliminating the need for separate queries.

**Context**: This is the core integration task that brings together:
- Schema changes (T-E07-F21-001)
- Template engine (T-E07-F21-002)
- Config service (T-E07-F21-004)

**User Story**: As an orchestrator developer, when an agent completes work and transitions a task status, I want to receive the next orchestrator action in the response so that I can immediately spawn the next agent without an additional query (Story 1).

**Impact**: Reduces API calls by 50% (from 2 to 1 per transition), improves orchestrator latency, and provides atomic state + action responses.

## API Changes

### CLI Commands to Enhance

**Primary Command: `shark task update`**

Enhanced to include `orchestrator_action` in response when status changes.

**Existing Behavior**:
```bash
shark task update T-E01-F03-002 --status ready_for_refinement_tech --json
# Response: {"id": 123, "key": "T-E01-F03-002", "status": "ready_for_refinement_tech", ...}
```

**New Behavior**:
```bash
shark task update T-E01-F03-002 --status ready_for_refinement_tech --json
# Response includes orchestrator_action:
{
  "id": 123,
  "key": "T-E01-F03-002",
  "status": "ready_for_refinement_tech",
  "orchestrator_action": {
    "action": "spawn_agent",
    "agent_type": "architect",
    "skills": ["architecture", "system-design"],
    "instruction": "Launch an architect agent to design the system architecture for task T-E01-F03-002..."
  }
}
```

**Related Commands** (may also need orchestrator_action):
- `shark task start <key>` - transitions todo → in_progress
- `shark task complete <key>` - transitions in_progress → ready_for_review
- `shark task approve <key>` - transitions ready_for_review → completed
- `shark task reopen <key>` - transitions ready_for_review → in_progress
- `shark task block <key>` - transitions to blocked
- `shark task unblock <key>` - transitions from blocked

All status transition commands should return orchestrator_action in response.

## Response Format Specification

### JSON Output Structure

**OrchestratorAction Object**:
```json
{
  "action": "spawn_agent" | "pause" | "wait_for_triage" | "archive",
  "agent_type": "string (required if action=spawn_agent)",
  "skills": ["array", "of", "strings (required if action=spawn_agent)"],
  "instruction": "string (template with {task_id} populated)"
}
```

**Complete Task Update Response**:
```json
{
  "id": 123,
  "key": "T-E01-F03-002",
  "slug": "design-system-architecture",
  "feature_id": 45,
  "epic_id": 7,
  "title": "Design system architecture",
  "description": "Create comprehensive system architecture document",
  "status": "ready_for_refinement_tech",
  "priority": 5,
  "agent_type": "architect",
  "depends_on": ["T-E01-F03-001"],
  "file_path": "docs/plan/E01-platform/E01-F03-architecture/tasks/T-E01-F03-002.md",
  "created_at": "2026-01-15T10:00:00Z",
  "updated_at": "2026-01-15T12:30:00Z",
  "orchestrator_action": {
    "action": "spawn_agent",
    "agent_type": "architect",
    "skills": ["architecture", "system-design", "specification-writing"],
    "instruction": "Launch an architect agent to design the system architecture for task T-E01-F03-002. Review requirements and create comprehensive architecture document including system components, data flow, and technology choices."
  }
}
```

### Backward Compatibility

**Missing orchestrator_action**: When no action is defined for a status, the field is **omitted** (not null):

```json
{
  "id": 123,
  "key": "T-E01-F03-002",
  "status": "in_progress"
  // NO orchestrator_action field - omitted entirely
}
```

**Existing clients** continue to work without changes. New orchestrators check for presence of field before accessing.

### Human-Readable Output

When `--json` flag is not used, display action summary:

```
Task T-E01-F03-002 updated successfully
Status: in_refinement_ba → ready_for_refinement_tech

Next Action:
  Type: spawn_agent
  Agent: architect
  Skills: architecture, system-design, specification-writing

Instruction: Launch an architect agent to design the system architecture for task T-E01-F03-002...
```

If no action defined:
```
Task T-E01-F03-002 updated successfully
Status: in_refinement_ba → ready_for_refinement_tech

Next Action: None configured
```

## Implementation Details

### Repository Layer Changes

**Location**: `internal/repository/task_repository.go`

**Methods to Enhance**:

1. **UpdateStatus(ctx, taskKey, newStatus) → (Task, OrchestratorAction, error)**
   - After updating task status in database
   - Fetch orchestrator_action for `newStatus` from config service
   - Populate template variables using task data
   - Return both updated task and action

2. **New Helper: GetOrchestratorAction(ctx, task, status) → (OrchestratorAction, error)**
   - Query config service for status metadata
   - Extract orchestrator_action if defined
   - Populate {task_id} template variable
   - Return populated action or nil if not defined

**Implementation Approach**:
```go
// Pseudo-code
func (r *TaskRepository) UpdateStatus(ctx context.Context, taskKey, newStatus string) (*models.Task, *models.OrchestratorAction, error) {
    // 1. Update task status in database
    task, err := r.update(ctx, taskKey, newStatus)
    if err != nil {
        return nil, nil, err
    }

    // 2. Get orchestrator action for new status
    action, err := r.getOrchestratorAction(ctx, task, newStatus)
    if err != nil {
        // Log warning but don't fail - action is optional
        log.Warn("Failed to get orchestrator action", "status", newStatus, "error", err)
    }

    return task, action, nil
}

func (r *TaskRepository) getOrchestratorAction(ctx context.Context, task *models.Task, status string) (*models.OrchestratorAction, error) {
    // Get status metadata from config service
    metadata, err := r.configService.GetStatusMetadata(status)
    if err != nil || metadata.OrchestratorAction == nil {
        return nil, nil // Action not defined - OK
    }

    // Populate template
    action := metadata.OrchestratorAction.Clone()
    action.Instruction = r.templateEngine.Populate(action.InstructionTemplate, map[string]string{
        "task_id": task.Key,
    })

    return action, nil
}
```

### CLI Command Changes

**Location**: `internal/cli/commands/task.go`

**Commands to Update**:

1. **`shark task update`**
   - Call repository UpdateStatus method
   - Include orchestrator_action in JSON output
   - Display action summary in human output

2. **All status transition commands**:
   - `task start`, `task complete`, `task approve`, `task reopen`, `task block`, `task unblock`
   - All use UpdateStatus internally
   - All return orchestrator_action in response

**JSON Serialization**:
- Use `omitempty` tag for `orchestrator_action` field
- Field omitted when nil (backward compatible)

**Human-Readable Display**:
- Add helper function: `displayOrchestratorAction(action *OrchestratorAction)`
- Show action type, agent type, skills summary
- Truncate instruction to first 100 chars for display

### Error Handling

**Principles**:
1. **Missing action is not an error** - field simply omitted
2. **Config service errors** - log warning, continue without action
3. **Template population errors** - log warning, return template unpopulated
4. **Invalid action schema** - caught at config load time (T-E07-F21-004)

**Error Scenarios**:

| Scenario | Handling | Response |
|----------|----------|----------|
| Status has no orchestrator_action | Return nil action, omit from response | Success |
| Config service unavailable | Log warning, return nil action | Success |
| Template variable missing | Use template as-is (unpopulated) | Success |
| Invalid action type in config | Config validation fails at load | Fail fast |
| Invalid skills array | Config validation fails at load | Fail fast |

**Logging**:
- **Debug**: "Retrieved orchestrator action for status X"
- **Warn**: "Failed to get orchestrator action: config service error"
- **Error**: Never - missing actions are not errors

## Acceptance Criteria

**From User Story 1**:
- [ ] `shark task update` returns `orchestrator_action` object when status changes
- [ ] Action includes `action`, `agent_type`, `skills`, and `instruction` fields (when action type is spawn_agent)
- [ ] Template variables (e.g., `{task_id}`) are populated in instructions
- [ ] Response is backward compatible (missing actions don't break existing code)
- [ ] JSON output format matches specification above

**Additional Criteria**:
- [ ] All status transition commands (start, complete, approve, reopen, block, unblock) return orchestrator_action
- [ ] Human-readable output displays action summary clearly
- [ ] Missing orchestrator_action results in field omission (not null, not error)
- [ ] Config service errors are handled gracefully (log warning, continue)
- [ ] Template population errors are handled gracefully (return unpopulated template)
- [ ] Performance impact <10ms additional latency per transition
- [ ] Works with existing Shark installations (backward compatible)

**Integration Requirements**:
- [ ] Repository layer returns (Task, OrchestratorAction, error) from UpdateStatus
- [ ] CLI commands serialize orchestrator_action to JSON with `omitempty`
- [ ] Config service integration tested (dependency on T-E07-F21-004)
- [ ] Template engine integration tested (dependency on T-E07-F21-002)

## Testing Requirements

### Unit Tests

**Repository Layer**:
- [ ] `UpdateStatus` returns orchestrator_action when defined in config
- [ ] `UpdateStatus` omits orchestrator_action when not defined (backward compat)
- [ ] `getOrchestratorAction` fetches action from config service correctly
- [ ] `getOrchestratorAction` populates {task_id} template variable
- [ ] `getOrchestratorAction` handles config service errors gracefully
- [ ] Template population with missing variables handled gracefully

**CLI Commands**:
- [ ] `shark task update` includes orchestrator_action in JSON output
- [ ] `shark task start` includes orchestrator_action in JSON output
- [ ] `shark task complete` includes orchestrator_action in JSON output
- [ ] JSON serialization uses `omitempty` for orchestrator_action
- [ ] Human-readable output displays action summary correctly
- [ ] Missing actions handled without errors

**Action Types**:
- [ ] `spawn_agent` action includes all required fields (agent_type, skills)
- [ ] `pause` action omits agent-specific fields
- [ ] `wait_for_triage` action omits agent-specific fields
- [ ] `archive` action omits agent-specific fields

### Integration Tests

**End-to-End Workflow**:
- [ ] Create task in draft status
- [ ] Transition to ready_for_refinement_ba
- [ ] Verify orchestrator_action in response
- [ ] Verify instruction includes task ID (T-E01-F03-002)
- [ ] Orchestrator spawns agent using action data

**Config Service Integration**:
- [ ] Config service loaded with orchestrator_action metadata
- [ ] Repository queries config service for action
- [ ] Action retrieved matches config definition
- [ ] Missing actions return nil without errors

**Template Engine Integration**:
- [ ] Template {task_id} replaced with actual task key
- [ ] Multiple template variables supported (future)
- [ ] Template syntax errors handled gracefully

**Backward Compatibility**:
- [ ] Shark installations without orchestrator_action work unchanged
- [ ] Existing orchestrators ignore new field without breaking
- [ ] Response format version compatible with v1.0

### Performance Tests

- [ ] Benchmark task update with/without orchestrator_action
- [ ] Verify <10ms additional latency
- [ ] Test with 1000+ tasks (no performance degradation)
- [ ] Config service query time <5ms

## Notes

### Design Decisions

**Why omit field instead of returning null?**
- More idiomatic JSON - missing fields indicate "not applicable"
- Reduces response payload size
- Easier for orchestrators to detect: `if (action)` vs `if (action !== null)`
- Go's `omitempty` tag handles this naturally

**Why not separate query command?**
- Goal is to reduce API calls from 2 to 1
- Atomic response (state + action) prevents race conditions
- Simpler orchestrator code (single API call per transition)

**Why template population at runtime, not config load?**
- Task ID unknown at config load time
- Keeps config static and reusable across tasks
- Allows future dynamic variables (priority, agent, etc.)

**Why graceful degradation for missing actions?**
- Backward compatibility with existing configs
- Allows incremental adoption (add actions per status over time)
- Orchestrators can implement fallback logic
- Prevents breaking changes

### Dependencies

**MUST complete before starting**:
- T-E07-F21-001: Schema changes (OrchestratorAction model)
- T-E07-F21-002: Template engine (populate {task_id})
- T-E07-F21-004: Config service (GetStatusMetadata)

**Related tasks**:
- T-E07-F21-007: Extend task list with --with-actions flag (Story 5)
- T-E07-F21-008: CLI utility commands (get-status-action, validate-actions)

### Implementation Checklist

**Phase 1: Repository Layer** (Day 1):
- [ ] Add OrchestratorAction return type to UpdateStatus
- [ ] Implement getOrchestratorAction helper
- [ ] Unit tests for repository methods
- [ ] Handle config service integration

**Phase 2: CLI Commands** (Day 2):
- [ ] Update task.go commands to include orchestrator_action
- [ ] JSON serialization with omitempty
- [ ] Human-readable display helper
- [ ] Unit tests for CLI commands

**Phase 3: Integration Testing** (Day 3):
- [ ] End-to-end workflow tests
- [ ] Config service integration tests
- [ ] Template engine integration tests
- [ ] Backward compatibility tests

**Phase 4: Performance & Documentation** (Day 4):
- [ ] Benchmark latency impact
- [ ] Update API documentation
- [ ] Add examples to CLI help text
- [ ] Code review and refinement

### Assumptions

1. **Config service is available** at runtime (dependency on T-E07-F21-004)
2. **Template engine is simple** string replacement initially (dependency on T-E07-F21-002)
3. **OrchestratorAction model exists** in internal/models (dependency on T-E07-F21-001)
4. **Backward compatibility is critical** - existing Shark installations must work unchanged
5. **Performance budget is 10ms** additional latency per transition
