
---
key: T-E07-F21-013
title: Add with-actions flag to task list command
epic: E07
feature: E07-F21
agent: backend
status: todo
priority: 5
depends_on: ["T-E07-F21-006"]
created_at: 2026-01-15T01:53:00Z
---

# Task: Add with-actions flag to task list command

## Goal

Add optional `--with-actions` flag to `shark task list` command to enable batch-fetching of orchestrator actions alongside task data. This allows AI Agent Orchestrators to poll for ready tasks and retrieve execution instructions in a single query, improving efficiency for batch operations.

**Context**: This is a "should-have" feature (Story 5) that extends the pattern established in T-E07-F21-006 (task update response enhancement) to support batch queries.

**User Story**: As an orchestrator developer, I want task list queries to optionally include orchestrator actions so that polling loops can batch-fetch all needed information.

**Impact**: Enables efficient polling patterns where orchestrators can retrieve multiple ready tasks with their actions in a single API call, reducing total API overhead in batch scenarios.

## Flag Specification

### Flag Definition

**Name**: `--with-actions`
**Type**: Boolean flag (no value required)
**Default**: `false` (backward compatible - default behavior unchanged)
**Applicable To**: `shark task list` command only

**Usage Examples**:
```bash
# Standard list (no actions) - EXISTING BEHAVIOR
shark task list --json

# List with actions included
shark task list --with-actions --json

# Filter by status with actions
shark task list --status=ready_for_development --with-actions --json

# Filter by epic and feature with actions
shark task list E07 F01 --with-actions --json

# Combined filters
shark task list --epic=E07 --agent=backend --status=ready_for_development --with-actions --json
```

### Backward Compatibility

**Critical Requirement**: Default behavior MUST NOT change.

**Without flag** (existing behavior):
```json
[
  {
    "id": 123,
    "key": "T-E01-F03-002",
    "status": "ready_for_development",
    "title": "Implement feature X"
    // NO orchestrator_action field
  }
]
```

**With flag** (new opt-in behavior):
```json
[
  {
    "id": 123,
    "key": "T-E01-F03-002",
    "status": "ready_for_development",
    "title": "Implement feature X",
    "orchestrator_action": {
      "action": "spawn_agent",
      "agent_type": "developer",
      "skills": ["test-driven-development", "implementation"],
      "instruction": "Launch a developer agent to implement task T-E01-F03-002..."
    }
  }
]
```

## Response Format Enhancement

### JSON Output Structure

**List Response with Actions**:
```json
[
  {
    "id": 123,
    "key": "T-E01-F03-002",
    "slug": "implement-feature-x",
    "feature_id": 45,
    "epic_id": 7,
    "title": "Implement feature X",
    "description": "Detailed task description",
    "status": "ready_for_development",
    "priority": 5,
    "agent_type": "developer",
    "depends_on": ["T-E01-F03-001"],
    "file_path": "docs/plan/E01/E01-F03/tasks/T-E01-F03-002.md",
    "created_at": "2026-01-15T10:00:00Z",
    "updated_at": "2026-01-15T12:30:00Z",
    "orchestrator_action": {
      "action": "spawn_agent",
      "agent_type": "developer",
      "skills": ["test-driven-development", "implementation", "shark-task-management"],
      "instruction": "Launch a developer agent to implement task T-E01-F03-002. Write tests first, then implement to pass tests following the technical specifications."
    }
  },
  {
    "id": 124,
    "key": "T-E01-F03-003",
    "status": "ready_for_code_review",
    "title": "Review feature Y",
    "orchestrator_action": {
      "action": "spawn_agent",
      "agent_type": "reviewer",
      "skills": ["code-review", "quality"],
      "instruction": "Launch a reviewer agent to review task T-E01-F03-003..."
    }
  }
]
```

**Missing Actions**: Tasks without orchestrator_action defined omit the field:
```json
[
  {
    "id": 125,
    "key": "T-E01-F03-004",
    "status": "in_progress",
    "title": "Work in progress"
    // NO orchestrator_action - omitted when not defined
  }
]
```

### Human-Readable Output

When `--json` is not used, display actions in summary:

```
Tasks (3 found)

T-E01-F03-002  |  Implement feature X  |  ready_for_development
  Next Action: spawn_agent → developer (test-driven-development, implementation)

T-E01-F03-003  |  Review feature Y  |  ready_for_code_review
  Next Action: spawn_agent → reviewer (code-review, quality)

T-E01-F03-004  |  Work in progress  |  in_progress
  Next Action: None configured
```

## Implementation Details

### CLI Command Enhancement

**Location**: `internal/cli/commands/task.go`

**Command to Modify**: `taskListCmd`

**Implementation Approach**:
```go
// Pseudo-code
func runTaskList(cmd *cobra.Command, args []string) error {
    // Existing argument parsing unchanged
    epicKey, featureKey, filters := parseListArgs(args)

    // NEW: Parse --with-actions flag
    withActions, _ := cmd.Flags().GetBool("with-actions")

    // Query repository
    tasks, err := repo.List(ctx, filters)
    if err != nil {
        return err
    }

    // NEW: If --with-actions flag set, enrich tasks with actions
    if withActions {
        tasks = enrichWithOrchestratorActions(ctx, tasks)
    }

    // Serialize output (JSON or human-readable)
    return outputTasks(tasks, withActions)
}

func enrichWithOrchestratorActions(ctx context.Context, tasks []*models.Task) []*models.Task {
    for _, task := range tasks {
        action, err := repo.GetOrchestratorAction(ctx, task, task.Status)
        if err != nil {
            // Log warning, continue without action
            log.Warn("Failed to get action", "task", task.Key, "error", err)
            continue
        }
        task.OrchestratorAction = action // Attach to task
    }
    return tasks
}
```

### Repository Layer Changes

**Location**: `internal/repository/task_repository.go`

**New Method** (reuse from T-E07-F21-006):
```go
// GetOrchestratorAction retrieves and populates orchestrator action for a task's status
func (r *TaskRepository) GetOrchestratorAction(ctx context.Context, task *models.Task, status string) (*models.OrchestratorAction, error) {
    // Get status metadata from config service
    metadata, err := r.configService.GetStatusMetadata(status)
    if err != nil || metadata.OrchestratorAction == nil {
        return nil, nil // Action not defined - OK
    }

    // Populate template
    action := metadata.OrchestratorAction.Clone()
    action.Instruction = r.templateEngine.Populate(action.InstructionTemplate, map[string]string{
        "task_id": task.Key,
    })

    return action, nil
}
```

**No database changes required** - actions retrieved from config at runtime.

### Performance Considerations

**Acceptable Overhead Target**: <10% slower than default list (per Story 5)

**Optimization Strategies**:
1. **Batch Config Queries**: Cache status metadata for duration of list operation
2. **Lazy Evaluation**: Only fetch actions when `--with-actions` is set
3. **Parallel Enrichment**: Process tasks concurrently if list is large (>100 tasks)

**Performance Test Scenarios**:
- 10 tasks: <50ms total
- 100 tasks: <200ms total
- 1000 tasks: <2s total (acceptable for batch operations)

**Measurement**:
```bash
# Benchmark without flag
time shark task list --json > /dev/null

# Benchmark with flag
time shark task list --with-actions --json > /dev/null

# Compare: with-actions should be <10% slower
```

## Error Handling

**Principles**:
1. **Missing actions are not errors** - omit field from response
2. **Config service errors** - log warning, continue without action for that task
3. **Template errors** - use unpopulated template, log warning
4. **List operation continues** even if some actions fail to load

**Error Scenarios**:

| Scenario | Handling | Impact |
|----------|----------|--------|
| Status has no orchestrator_action | Omit field from task | None - task still included |
| Config service unavailable | Log warning, omit all actions | List succeeds, no actions |
| Single action fetch fails | Log warning for that task, continue | Other tasks get actions |
| Template variable missing | Use template as-is | Action included with placeholder |

**Logging**:
- **Debug**: "Enriching {count} tasks with orchestrator actions"
- **Warn**: "Failed to get action for task {key}: {error}"
- **Error**: Never - missing actions are not fatal

## Acceptance Criteria

**From User Story 5**:
- [ ] `shark task list` supports `--with-actions` flag
- [ ] Actions included for each task in response
- [ ] Backward compatible (default behavior unchanged)
- [ ] Performance impact is acceptable (<10% slower)

**Additional Criteria**:
- [ ] Flag works with all existing list filters (--status, --agent, --epic, --feature)
- [ ] JSON output includes orchestrator_action object when flag is set
- [ ] Human-readable output displays action summary when flag is set
- [ ] Missing actions omit field (not null, not error)
- [ ] Works with empty result sets (no tasks found)
- [ ] Template variables ({task_id}) populated correctly for each task
- [ ] Config service integration tested
- [ ] Template engine integration tested

**Integration Requirements**:
- [ ] Reuses GetOrchestratorAction method from T-E07-F21-006
- [ ] Config service queried efficiently (batch/cache)
- [ ] Template engine populates variables per task
- [ ] No database schema changes required

## Testing Requirements

### Unit Tests

**CLI Command Tests**:
- [ ] `--with-actions` flag parsed correctly
- [ ] Flag defaults to false (backward compatible)
- [ ] Flag works with other filters (--status, --epic, --feature, --agent)
- [ ] JSON output includes orchestrator_action when flag set
- [ ] JSON output omits orchestrator_action when flag not set
- [ ] Human-readable output shows action summary when flag set
- [ ] Empty result sets handled correctly

**Repository Tests**:
- [ ] GetOrchestratorAction retrieves action from config service
- [ ] GetOrchestratorAction populates {task_id} template
- [ ] GetOrchestratorAction handles missing actions gracefully
- [ ] GetOrchestratorAction handles config service errors gracefully

**Action Enrichment Tests**:
- [ ] enrichWithOrchestratorActions processes all tasks
- [ ] Failed action fetch for one task doesn't affect others
- [ ] Tasks without actions omit field
- [ ] Tasks with actions include populated field

### Integration Tests

**End-to-End Workflow**:
- [ ] Create multiple tasks in "ready_for_development" status
- [ ] Run `shark task list --status=ready_for_development --with-actions --json`
- [ ] Verify all tasks have orchestrator_action in response
- [ ] Verify instructions include correct task IDs
- [ ] Orchestrator can parse and spawn agents from response

**Backward Compatibility**:
- [ ] Existing scripts without `--with-actions` work unchanged
- [ ] JSON response format identical when flag not used
- [ ] No performance regression for default behavior

**Filter Combinations**:
- [ ] `shark task list E07 --with-actions --json`
- [ ] `shark task list --agent=backend --with-actions --json`
- [ ] `shark task list --status=ready_for_development --with-actions --json`
- [ ] Multiple filters combined with --with-actions

### Performance Tests

- [ ] Benchmark task list without flag (baseline)
- [ ] Benchmark task list with flag (target: <10% slower)
- [ ] Test with 10, 100, 1000 tasks
- [ ] Verify no memory leaks with large result sets
- [ ] Config service caching reduces redundant queries

**Performance Acceptance**:
- 10 tasks: <50ms total (5ms overhead per task acceptable)
- 100 tasks: <200ms total (2ms overhead per task)
- 1000 tasks: <2s total (acceptable for batch operations)

## Notes

### Design Decisions

**Why opt-in flag instead of always including actions?**
- Backward compatibility - existing tools/scripts expect current response format
- Performance - avoid overhead when actions not needed
- Flexibility - orchestrators choose when to batch-fetch vs individual queries

**Why enrich at CLI layer instead of repository?**
- Repository List() should remain simple (just return tasks)
- CLI layer orchestrates data aggregation from multiple sources
- Config service is CLI concern, not repository concern
- Easier to test and maintain separation

**Why not add to task next command?**
- `task next` returns single task (already implemented in T-E07-F21-006)
- `task list` returns multiple tasks (batch scenario)
- Different use cases: next = find work, list = bulk operations

**Why reuse GetOrchestratorAction method?**
- Code reuse from T-E07-F21-006 (DRY principle)
- Consistent behavior across commands
- Single implementation to maintain
- Shared template population logic

### Dependencies

**MUST complete before starting**:
- T-E07-F21-006: Enhance task update response with orchestrator action (establishes pattern and GetOrchestratorAction method)

**Related tasks**:
- T-E07-F21-001: Schema changes (OrchestratorAction model)
- T-E07-F21-002: Template engine (populate {task_id})
- T-E07-F21-004: Config service (GetStatusMetadata)

### Implementation Checklist

**Phase 1: CLI Flag Addition** (Day 1):
- [ ] Add `--with-actions` flag to taskListCmd
- [ ] Parse flag value in runTaskList
- [ ] Pass flag to enrichment logic
- [ ] Unit tests for flag parsing

**Phase 2: Action Enrichment** (Day 2):
- [ ] Implement enrichWithOrchestratorActions function
- [ ] Call GetOrchestratorAction per task (reuse from T-E07-F21-006)
- [ ] Handle errors gracefully (warn, continue)
- [ ] Unit tests for enrichment

**Phase 3: Output Formatting** (Day 3):
- [ ] JSON serialization with orchestrator_action
- [ ] Human-readable display with action summary
- [ ] Handle missing actions (omit field)
- [ ] Unit tests for output

**Phase 4: Integration & Performance** (Day 4):
- [ ] End-to-end integration tests
- [ ] Backward compatibility tests
- [ ] Performance benchmarks
- [ ] Documentation updates

### Assumptions

1. **GetOrchestratorAction method exists** from T-E07-F21-006
2. **Config service is efficient** for repeated status metadata queries
3. **Performance budget is 10% overhead** for action enrichment
4. **Batch scenarios are common** enough to warrant this feature
5. **Orchestrators will use this for polling** ready tasks
6. **No database changes needed** - all config-driven
