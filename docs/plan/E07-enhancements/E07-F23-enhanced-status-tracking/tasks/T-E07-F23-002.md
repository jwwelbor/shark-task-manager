---
key: T-E07-F23-002
title: Implement Weighted Progress Calculation
epic: E07
feature: E07-F23
agent: backend
status: todo
priority: 2
depends_on: ["T-E07-F23-001"]
created_at: 2026-01-16T19:55:28Z
---

# Task: Implement Weighted Progress Calculation

**Estimated Effort:** 2 hours
**Phase:** 1 - Core Calculations
**Dependencies:** T-E07-F23-001 (Status package types)

---

## Goal

Implement `CalculateProgress()` function that uses `progress_weight` from config to calculate realistic progress percentages. Tasks at `ready_for_approval` should contribute 90% to progress (not 0%), recognizing agent work completion even before human approval.

**Example:**
```
Tasks: 2 completed, 1 ready_for_approval, 1 in_development, 1 draft
Weighted Progress: (2.0 + 0.9 + 0.5 + 0.0) / 5 = 68%
Completion Progress: 2 / 5 = 40%
```

---

## Implementation

### Create `internal/status/progress.go`

```go
package status

import (
    "fmt"
    "github.com/jwwelbor/shark-task-manager/internal/config"
)

// CalculateProgress calculates weighted and completion progress from status counts
// Uses progress_weight from config to recognize partial completion
func CalculateProgress(statusCounts map[string]int, cfg *config.Config) *ProgressInfo {
    totalTasks := 0
    weightedProgress := 0.0
    completedTasks := 0

    for status, count := range statusCounts {
        totalTasks += count
        meta := cfg.GetStatusMetadata(status)
        if meta != nil {
            weightedProgress += float64(count) * meta.ProgressWeight
            if meta.ProgressWeight >= 1.0 {
                completedTasks += count
            }
        }
    }

    if totalTasks == 0 {
        return &ProgressInfo{
            WeightedPct:     0.0,
            CompletionPct:   0.0,
            WeightedRatio:   "0/0",
            CompletionRatio: "0/0",
            TotalTasks:      0,
        }
    }

    weightedPct := (weightedProgress / float64(totalTasks)) * 100.0
    completionPct := (float64(completedTasks) / float64(totalTasks)) * 100.0

    return &ProgressInfo{
        WeightedPct:     weightedPct,
        CompletionPct:   completionPct,
        WeightedRatio:   fmt.Sprintf("%.1f/%d", weightedProgress, totalTasks),
        CompletionRatio: fmt.Sprintf("%d/%d", completedTasks, totalTasks),
        TotalTasks:      totalTasks,
    }
}
```

### Create `internal/status/progress_test.go`

Test cases:
1. All completed tasks → 100% weighted, 100% completion
2. Mixed statuses → correct weighted calculation (68% vs 40%)
3. Empty task list → 0/0 gracefully
4. Missing metadata → defaults to 0.0
5. Single task ready_for_approval → 90% weighted, 0% completion

---

## Files to Create

- `internal/status/progress.go` - CalculateProgress() implementation
- `internal/status/progress_test.go` - Comprehensive unit tests (>90% coverage)

---

## Acceptance Criteria

- [ ] CalculateProgress() function implemented
- [ ] Uses `cfg.GetStatusMetadata(status).ProgressWeight`
- [ ] Handles missing metadata gracefully (defaults to 0.0)
- [ ] Handles empty status counts (returns 0/0)
- [ ] Generates formatted ratio strings: "3.4/5" and "2/5"
- [ ] All test cases pass: `go test ./internal/status -v`
- [ ] Coverage >90%: `go test ./internal/status -cover`

---

## Testing Commands

```bash
# Run tests
go test ./internal/status -v -run TestCalculateProgress

# Check coverage
go test ./internal/status -coverprofile=coverage.out
go tool cover -func=coverage.out | grep progress.go
```

Expected: All 5+ test cases pass, >90% coverage

---

## Related Documentation

- Architecture: `architecture.md` (Section 4.2.1 - CalculateProgress)
- Implementation Plan: `implementation-plan.md` (Task E07-F23-002)
- E07-F14 Config: `.sharkconfig.json` (status_metadata.progress_weight)
