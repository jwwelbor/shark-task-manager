---
key: T-E07-F05-004
title: Write integration tests for document repository operations
epic: E07
feature: E07-F05
agent: general
status: todo
priority: 4
created_at: 2025-12-20T06:14:47Z
---

# Task: Write integration tests for document repository operations

## Goal

Write comprehensive integration tests for `DocumentRepository` in `internal/repository/document_repository_test.go` that validate all CRUD and link operations against real SQLite database.

## Requirements

### Functional Requirements

- [ ] Create test database setup using `internal/test/testdb.go` pattern
- [ ] Test `CreateOrGet` creates new document when title+path don't exist
- [ ] Test `CreateOrGet` returns existing document when title+path match
- [ ] Test `GetByID` retrieves document by ID correctly
- [ ] Test `GetByID` returns error when document ID doesn't exist
- [ ] Test `Delete` removes document and cascades to all link tables
- [ ] Test `LinkToEpic` creates valid link with correct epic_id and document_id
- [ ] Test `LinkToEpic` fails with foreign key error for non-existent epic
- [ ] Test `LinkToFeature` creates valid link with correct feature_id
- [ ] Test `LinkToFeature` fails with foreign key error for non-existent feature
- [ ] Test `LinkToTask` creates valid link with correct task_id
- [ ] Test `LinkToTask` fails with foreign key error for non-existent task
- [ ] Test duplicate link operations fail with UNIQUE constraint (no silent success on duplicate links)
- [ ] Test `UnlinkFromEpic` removes specific link without affecting other links
- [ ] Test `UnlinkFromFeature` removes specific link without affecting other links
- [ ] Test `UnlinkFromTask` removes specific link without affecting other links
- [ ] Test `ListForEpic` returns all documents linked to specific epic
- [ ] Test `ListForFeature` returns all documents linked to specific feature
- [ ] Test `ListForTask` returns all documents linked to specific task
- [ ] Test List operations return empty slice when parent has no documents

### Non-Functional Requirements

- [ ] All tests use fresh test database (isolated from each other)
- [ ] Tests clean up after themselves (rollback transactions)
- [ ] Performance: All tests complete in <100ms total
- [ ] Proper error type checking (verify specific error conditions)

## Implementation Plan

### Steps

1. [ ] Create `internal/repository/document_repository_test.go` file
2. [ ] Implement test database setup using existing testdb pattern:
   - Create fresh test database for each test
   - Initialize schema with tables
   - Clean up after test completes
3. [ ] Implement test fixtures: Create test documents, epics, features, tasks
4. [ ] Test CreateOrGet:
   - Test case: New document - should create and return ID
   - Test case: Duplicate title+path - should return existing document ID
   - Test case: Empty title - should fail
   - Test case: Empty path - should fail
5. [ ] Test GetByID:
   - Test case: Valid ID - should return document
   - Test case: Non-existent ID - should return error
6. [ ] Test Delete:
   - Test case: Valid ID - should delete document
   - Test case: Verify cascade delete removes all links
   - Test case: Non-existent ID - should return no error (idempotent)
7. [ ] Test Link operations for each parent type (Epic, Feature, Task):
   - Test case: Valid link - should create and verify in DB
   - Test case: Invalid parent ID - should fail with FK constraint error
   - Test case: Duplicate link - should fail with UNIQUE constraint
8. [ ] Test Unlink operations for each parent type:
   - Test case: Existing link - should remove
   - Test case: Non-existent link - should return no error
   - Test case: Verify only target link removed (other links remain)
9. [ ] Test List operations for each parent type:
   - Test case: Parent with documents - should return all linked documents
   - Test case: Parent without documents - should return empty slice
   - Test case: Multiple documents linked - should return all in correct order
10. [ ] Add table-driven tests for comprehensive coverage
11. [ ] Add error assertion helpers for constraint validation
12. [ ] Document test design and assumptions

### Technical Approach

- Use existing test patterns from `internal/repository/task_repository_test.go`
- Use `internal/test/testdb.TestDB()` to create isolated test databases
- Transactions: Use `defer tx.Rollback()` for test isolation
- Error checking: Use `if err == nil { t.Fatal("expected error") }` patterns
- Assertion helpers: Create reusable helpers for common checks
- Table-driven tests: Use `[]struct { name, input, expectedOutput }` pattern for multiple test cases
- Subtests: Use `t.Run()` for organized test structure

## Deliverables

- [ ] `internal/repository/document_repository_test.go` with comprehensive tests
- [ ] Minimum 30+ test cases covering all methods
- [ ] All tests passing with `make test`
- [ ] Test coverage >90% for document_repository.go
- [ ] Clear test documentation and setup

## Acceptance Criteria

- [ ] All 20+ functional requirements tested
- [ ] All CRUD operations validated
- [ ] All link operations validated
- [ ] All unlink operations validated
- [ ] All list operations validated
- [ ] Error conditions properly tested
- [ ] `make test` runs all tests successfully
- [ ] `make test-coverage` shows >85% coverage
- [ ] No race conditions detected
- [ ] Tests are isolated and deterministic

## Testing Strategy

- [ ] Create fresh test DB before each test
- [ ] Populate with test fixtures (documents, epics, features, tasks)
- [ ] Execute operation
- [ ] Verify result with SELECT query
- [ ] Check error types match expectations
- [ ] Use subtests for organized test structure

### Test Organization

```
TestCreateOrGet
  ├─ CreateNewDocument (should succeed)
  ├─ CreateExistingDocument (should return same ID)
  └─ InvalidInputs (empty title/path)

TestGetByID
  ├─ ExistingDocument (should return)
  └─ NonExistentDocument (should error)

TestLinkToEpic
  ├─ ValidEpic (should succeed)
  ├─ NonExistentEpic (should fail FK)
  └─ DuplicateLink (should fail UNIQUE)

... (similar for Feature, Task)

TestListForEpic
  ├─ WithDocuments (should return all)
  └─ WithoutDocuments (should return empty)

... (similar for Feature, Task)
```

## Dependencies

Depends on T-E07-F05-002 (DocumentRepository implementation must exist first).

## Notes

- Use existing error assertion patterns from other *_test.go files in repository package
- Consider using helper function `isSQLiteError(err, "UNIQUE constraint")` pattern
- Tests should be deterministic (no random data or timestamps)
- Test database should be deleted after each test to prevent conflicts
