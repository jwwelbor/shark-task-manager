---
agent: general
created_at: 2025-12-20T06:14:45Z
epic: E07
feature: E07-F05
key: T-E07-F05-002
priority: 2
status: todo
task_key: T-E07-F05-002
title: Implement DocumentRepository with CRUD and link operations
---

# Task: Implement DocumentRepository with CRUD and link operations

## Goal

Implement `DocumentRepository` in `internal/repository/document_repository.go` providing CRUD operations for documents and methods to link/unlink documents from epics, features, and tasks.

## Requirements

### Functional Requirements

- [ ] Create `Document` model in `internal/models/document.go` with fields: ID, Title, FilePath, CreatedAt
- [ ] Implement `CreateOrGet(ctx context.Context, title, filePath string) (*Document, error)` - upsert logic (returns existing if title+path match)
- [ ] Implement `GetByID(ctx context.Context, id int64) (*Document, error)`
- [ ] Implement `Delete(ctx context.Context, id int64) error`
- [ ] Implement `LinkToEpic(ctx context.Context, docID, epicID int64) error` with transaction support
- [ ] Implement `LinkToFeature(ctx context.Context, docID, featureID int64) error` with transaction support
- [ ] Implement `LinkToTask(ctx context.Context, docID, taskID int64) error` with transaction support
- [ ] Implement `UnlinkFromEpic(ctx context.Context, docID, epicID int64) error`
- [ ] Implement `UnlinkFromFeature(ctx context.Context, docID, featureID int64) error`
- [ ] Implement `UnlinkFromTask(ctx context.Context, docID, taskID int64) error`
- [ ] Implement `ListForEpic(ctx context.Context, epicID int64) ([]*Document, error)`
- [ ] Implement `ListForFeature(ctx context.Context, featureID int64) ([]*Document, error)`
- [ ] Implement `ListForTask(ctx context.Context, taskID int64) ([]*Document, error)`
- [ ] All methods return error as second value with proper fmt.Errorf wrapping

### Non-Functional Requirements

- [ ] All queries use prepared statements or parameterized queries (prevent SQL injection)
- [ ] Transactions wrap multi-statement operations (e.g., insert document + create link)
- [ ] Query performance <50ms for typical operations (assumed <100k documents)
- [ ] Proper error handling with context preservation

## Implementation Plan

### Steps

1. [ ] Create `internal/models/document.go` with Document struct and JSON/DB tags
2. [ ] Implement Document validation (title and filePath required and non-empty)
3. [ ] Create `internal/repository/document_repository.go` with constructor `NewDocumentRepository(db *DB)`
4. [ ] Implement `CreateOrGet` using UPSERT pattern or INSERT OR IGNORE + SELECT
5. [ ] Implement `GetByID` with SELECT statement
6. [ ] Implement `Delete` with DELETE statement (CASCADE handled by DB schema)
7. [ ] Implement `LinkToEpic` with transaction: INSERT into epic_documents with conflict handling
8. [ ] Implement `LinkToFeature` with transaction: INSERT into feature_documents
9. [ ] Implement `LinkToTask` with transaction: INSERT into task_documents
10. [ ] Implement all `UnlinkFrom*` methods with DELETE statements
11. [ ] Implement all `ListFor*` methods with JOIN queries to fetch documents for parent
12. [ ] Add error wrapping following project pattern (use fmt.Errorf with %w)
13. [ ] Test all methods with database integration tests

### Technical Approach

- Use dependency injection: constructor receives `*sql.DB` reference
- Follow existing repository pattern from task_repository.go or epic_repository.go
- Use prepared statements for prepared queries
- Transactions: `defer tx.Rollback()` pattern with explicit Commit() on success
- Context support for cancellation and timeouts
- Error handling: wrap all DB errors with context: `fmt.Errorf("operation: %w", err)`

## Deliverables

- [ ] `internal/models/document.go` with Document struct
- [ ] `internal/repository/document_repository.go` with all required methods
- [ ] All methods properly error wrapped
- [ ] All CRUD and link operations tested
- [ ] Code compiles and passes lint check

## Acceptance Criteria

- [ ] All 14 methods implemented and working
- [ ] CreateOrGet returns existing document when title+path match
- [ ] Link operations enforce foreign key constraints
- [ ] Unlink operations properly remove relationships
- [ ] List operations return correct documents for parent
- [ ] Transactions rollback on error
- [ ] All errors wrapped with context
- [ ] `make test` passes for document_repository_test.go
- [ ] No SQL injection vulnerabilities (parameterized queries only)

## Testing Strategy

- [ ] Unit tests in `internal/repository/document_repository_test.go`
- [ ] Test CreateOrGet with duplicate title+path (should return existing)
- [ ] Test link operations with invalid parent IDs (should fail with FK constraint)
- [ ] Test unlink operations remove only the specified link
- [ ] Test List operations return correct documents
- [ ] Test transaction rollback on link failure
- [ ] Test proper error wrapping
- [ ] Integration tests verify all methods with real database

## Dependencies

Depends on T-E07-F05-001 (database schema must exist first).

## Notes

- Follow existing repository patterns from `internal/repository/task_repository.go`
- Use `context.Context` parameter for all methods (required for timeouts)
- Upsert strategy: Could use `INSERT OR IGNORE ... RETURNING id` if SQLite version supports it, or `INSERT ... ON CONFLICT ... DO UPDATE`
