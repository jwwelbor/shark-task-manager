---
key: T-E07-F05-003
title: Implement related-docs CLI commands (add, delete, list)
epic: E07
feature: E07-F05
agent: general
status: todo
priority: 3
created_at: 2025-12-20T06:14:46Z
---

# Task: Implement related-docs CLI commands (add, delete, list)

## Goal

Implement CLI command group `shark related-docs` with three subcommands (add, delete, list) to manage document associations with epics, features, and tasks.

## Requirements

### Functional Requirements

- [ ] Create command group `related-docs` in `internal/cli/commands/related_docs.go`
- [ ] Implement `shark related-docs add <title> <path>` command with mutually exclusive flags: `--epic=E01`, `--feature=E01-F01`, `--task=T-...`
- [ ] Implement `shark related-docs delete <title>` command with same mutually exclusive parent flags
- [ ] Implement `shark related-docs list` command with optional parent flags (shows all if none specified)
- [ ] All commands support `--json` global flag for machine-readable output
- [ ] Add command validates parent exists before linking (epic/feature/task must exist in DB)
- [ ] Delete command succeeds silently if document or link doesn't exist (idempotent)
- [ ] List command returns documents formatted as table (default) or JSON
- [ ] All commands support `--verbose` flag for debug output

### Non-Functional Requirements

- [ ] Commands follow Cobra framework patterns from existing project
- [ ] Output uses cli.OutputJSON() and cli.OutputTable() helpers
- [ ] Proper error messages with context (e.g., "Epic E01 not found")
- [ ] Exit codes: 0 (success), 1 (not found), 2 (DB error)

## Implementation Plan

### Steps

1. [ ] Create `internal/cli/commands/related_docs.go` with three command handlers
2. [ ] Implement `relatedDocsAddCmd` with:
   - Arguments: <title> (positional), <path> (positional)
   - Flags: --epic, --feature, --task (mutually exclusive, at least one required)
   - Validation: Ensure exactly one parent flag is provided
   - Logic: Call documentRepo.CreateOrGet(), then appropriate LinkTo*() method
   - Error handling: Report if parent doesn't exist or link fails

3. [ ] Implement `relatedDocsDeleteCmd` with:
   - Arguments: <title> (positional)
   - Flags: --epic, --feature, --task (mutually exclusive, optional for delete)
   - Logic: If no parent specified, search for matching documents and prompt user
   - If parent specified, call appropriate UnlinkFrom*() method
   - Idempotent behavior: Return success even if link doesn't exist

4. [ ] Implement `relatedDocsListCmd` with:
   - No required arguments
   - Flags: --epic, --feature, --task (all optional, zero or one allowed)
   - Logic: Call appropriate ListFor*() method or list all if no parent specified
   - Output: Table format by default, JSON with --json flag

5. [ ] Implement helper function to validate mutually exclusive flags
6. [ ] Implement output formatting helpers for table and JSON
7. [ ] Register all commands in init() function: `relatedDocsCmd.AddCommand(relatedDocsAddCmd, relatedDocsDeleteCmd, relatedDocsListCmd)`
8. [ ] Wire commands to DocumentRepository instance in each command handler
9. [ ] Add proper error handling and logging for all DB operations
10. [ ] Test each command manually and with unit tests

### Technical Approach

- Follow Cobra command pattern from `internal/cli/commands/task.go` or `epic.go`
- Use `cobra.ExactArgs()` or `cobra.RangeArgs()` for argument validation
- Flags: Use `*string` for parent identifiers (epic/feature/task keys)
- Validate parent exists: Call epic/feature/task repository GetByKey() before linking
- JSON output: Use cli.OutputJSON(data) when --json flag is set
- Table output: Use cli.OutputTable(headers, rows) with column headers and formatted rows
- Error output: Use cli.Error(msg) and return appropriate exit code

## Deliverables

- [ ] `internal/cli/commands/related_docs.go` with all three commands
- [ ] Add command properly validates inputs and creates documents
- [ ] Delete command idempotently removes links
- [ ] List command displays all documents with filtering support
- [ ] All commands support --json output
- [ ] Proper error handling and messages
- [ ] Commands registered in root command structure

## Acceptance Criteria

- [ ] `shark related-docs add "Design Doc" docs/design.md --epic=E01` works correctly
- [ ] `shark related-docs delete "Design Doc" --epic=E01` removes the link
- [ ] `shark related-docs list --epic=E01` shows documents linked to E01
- [ ] `shark related-docs list --json` outputs valid JSON
- [ ] Invalid parent keys produce helpful error messages
- [ ] Mutually exclusive parent flags are enforced
- [ ] `make test` passes for CLI command tests
- [ ] `make build` succeeds without errors

## Testing Strategy

- [ ] Unit tests for command handlers in `internal/cli/commands/related_docs_test.go`
- [ ] Test add command with valid/invalid parent IDs
- [ ] Test delete command idempotency (delete same link twice succeeds both times)
- [ ] Test list command with no parent (shows all documents)
- [ ] Test list command with parent filters (--epic, --feature, --task)
- [ ] Test --json output is valid JSON
- [ ] Test --verbose output includes debug info
- [ ] Test mutually exclusive flag enforcement
- [ ] Integration test via `shark related-docs` commands in shell

## Dependencies

Depends on T-E07-F05-002 (DocumentRepository must be implemented first).

## Notes

- Document path should be relative to project root (e.g., `docs/design/architecture.md`)
- Consider adding optional `--no-validate` flag to skip checking if file exists
- Title field could be user-friendly name, not necessarily matching filename
