---
agent: general
created_at: 2025-12-20T06:14:48Z
epic: E07
feature: E07-F05
key: T-E07-F05-005
priority: 5
status: todo
task_key: T-E07-F05-005
title: Write CLI command tests and validation
---

# Task: Write CLI command tests and validation

## Goal

Write comprehensive tests for `shark related-docs` CLI commands in `internal/cli/commands/related_docs_test.go` that validate argument parsing, flag handling, output formatting, and error conditions.

## Requirements

### Functional Requirements

- [ ] Test `related-docs add` command parses title and path arguments correctly
- [ ] Test `related-docs add` validates mutually exclusive flags (--epic, --feature, --task)
- [ ] Test `related-docs add` requires exactly one parent flag
- [ ] Test `related-docs add` validates parent exists in database
- [ ] Test `related-docs add` creates document and creates link in database
- [ ] Test `related-docs add` outputs success message with document ID
- [ ] Test `related-docs add` outputs valid JSON with --json flag
- [ ] Test `related-docs add` reports error when parent doesn't exist
- [ ] Test `related-docs delete` command parses title argument correctly
- [ ] Test `related-docs delete` supports optional parent flags
- [ ] Test `related-docs delete` removes link from database
- [ ] Test `related-docs delete` succeeds silently if link doesn't exist (idempotent)
- [ ] Test `related-docs delete` outputs success message
- [ ] Test `related-docs delete` outputs valid JSON with --json flag
- [ ] Test `related-docs list` command lists all documents when no filter provided
- [ ] Test `related-docs list` filters by --epic flag
- [ ] Test `related-docs list` filters by --feature flag
- [ ] Test `related-docs list` filters by --task flag
- [ ] Test `related-docs list` outputs table format by default
- [ ] Test `related-docs list` outputs valid JSON with --json flag
- [ ] Test `related-docs list` returns empty list when no matches found

### Non-Functional Requirements

- [ ] Tests use mock DocumentRepository to avoid real database
- [ ] Tests use mock Epic/Feature/Task repositories for parent validation
- [ ] All tests complete in <100ms
- [ ] Error messages are user-friendly and actionable

## Implementation Plan

### Steps

1. [ ] Create `internal/cli/commands/related_docs_test.go` file
2. [ ] Import mock repositories (use existing mock patterns from other command tests)
3. [ ] Create test fixtures: Mock documents, epics, features, tasks
4. [ ] Test `add` command:
   - Test case: Valid add with --epic - should succeed
   - Test case: Valid add with --feature - should succeed
   - Test case: Valid add with --task - should succeed
   - Test case: No parent flag - should fail with clear error
   - Test case: Multiple parent flags - should fail
   - Test case: Non-existent epic - should fail with "Epic not found"
   - Test case: Invalid arguments (missing title or path) - should fail
   - Test case: --json output is valid JSON
   - Test case: Verify document created in mock repository

5. [ ] Test `delete` command:
   - Test case: Delete existing document link - should succeed
   - Test case: Delete non-existent link - should succeed (idempotent)
   - Test case: Delete without parent flag - should show all matching
   - Test case: --json output is valid JSON
   - Test case: Verify link removed from mock repository

6. [ ] Test `list` command:
   - Test case: List all documents - should return all
   - Test case: List with --epic filter - should return filtered
   - Test case: List with --feature filter - should return filtered
   - Test case: List with --task filter - should return filtered
   - Test case: Multiple parent flags - should fail
   - Test case: No results - should return empty slice
   - Test case: Table output format is correct
   - Test case: --json output is valid JSON

7. [ ] Test flag validation:
   - Test case: Mutually exclusive parent flags are enforced
   - Test case: Helpful error messages for invalid flags
   - Test case: --verbose flag enables debug output

8. [ ] Test output formatting:
   - Test case: Table headers are correct
   - Test case: Table rows have correct columns
   - Test case: JSON output is properly formatted (indented)
   - Test case: Success messages contain relevant info (document ID, parent key)

9. [ ] Test error handling:
   - Test case: Database errors reported to user
   - Test case: Validation errors are clear
   - Test case: Exit codes are correct (0 for success, 1 for not found, 2 for error)

10. [ ] Add integration tests (optional, use real test database):
    - Test end-to-end workflow: add doc, list, delete

### Technical Approach

- Use mock repositories: `MockDocumentRepository`, `MockEpicRepository`, `MockFeatureRepository`, `MockTaskRepository`
- Follow existing command test patterns from `task_test.go` or `epic_test.go`
- Use table-driven tests for comprehensive coverage
- Mock returns: Set up mock to return specific documents/parents
- Output testing: Capture stdout and verify formatting
- JSON validation: Use `json.Unmarshal()` to verify valid JSON
- Error testing: Check error type and message content

## Deliverables

- [ ] `internal/cli/commands/related_docs_test.go` with comprehensive tests
- [ ] Mock repositories for testing
- [ ] Minimum 25+ test cases covering all commands
- [ ] All tests passing with `make test`
- [ ] Clear test documentation

## Acceptance Criteria

- [ ] All CLI command requirements tested
- [ ] All flag combinations tested
- [ ] All error conditions tested
- [ ] Output formatting validated
- [ ] `make test` runs all tests successfully
- [ ] No real database access during tests (mocked)
- [ ] `make build` succeeds with command code
- [ ] Commands work correctly when manually tested

## Testing Strategy

### Test Organization by Command

**Add Command Tests**
- Valid operations (each parent type)
- Invalid arguments (missing title, missing path)
- Flag validation (no parent, multiple parents)
- Parent validation (non-existent parent ID)
- Output formats (table, JSON)

**Delete Command Tests**
- Valid delete (each parent type)
- Idempotent delete (already deleted)
- Optional parent flags
- Output formats

**List Command Tests**
- List all (no filter)
- Filter by epic/feature/task
- Empty results
- Multiple results
- Output formats

### Mock Setup Example

```go
func setupMocks() (*MockDocumentRepository, *MockEpicRepository) {
    docRepo := &MockDocumentRepository{
        Documents: map[int64]*models.Document{
            1: {ID: 1, Title: "Design Doc", FilePath: "docs/design.md", CreatedAt: now},
        },
        Links: map[string]bool{
            "epic:1:1": true,  // epic 1, document 1
        },
    }
    epicRepo := &MockEpicRepository{
        Epics: map[string]*models.Epic{
            "E01": {Key: "E01", ID: 1, Title: "Foundation", Status: "active"},
        },
    }
    return docRepo, epicRepo
}
```

## Dependencies

Depends on T-E07-F05-003 (CLI commands implementation must exist first).

## Notes

- Use existing mock patterns from `internal/cli/commands/` (check mock_*.go files)
- Test output capture: Use bytes.Buffer to capture stdout for testing
- JSON validation: Parse output to ensure it's valid before checking content
- Idempotency: delete should succeed even if link already removed
- Parent validation: CLI should check parent exists before attempting to link
