# User Acceptance Testing Guide - E07-F21

**Feature:** Add Orchestrator Actions to Status Transitions
**Epic:** E07 - Enhancements
**Date:** 2026-01-15
**Status:** Ready for UAT

---

## Feature Overview

This feature extends Shark's workflow configuration to include **orchestrator_action** instructions, enabling workflow-driven agent spawning without hardcoded orchestrator logic. When tasks transition to new statuses, Shark now returns execution instructions (which agent to spawn, what skills are needed, and detailed instructions) as part of the API response.

**Key Benefits:**
- **Single API call:** Task state + action instructions returned atomically
- **Configuration-driven:** Workflow definitions become the single source of truth
- **Flexible workflows:** Support different workflows without code changes
- **Backward compatible:** Existing installations work without changes

**What was built:**
- OrchestratorAction schema with validation
- Template rendering engine for variable substitution
- Config service layer for querying actions
- Enhanced task update responses with action metadata
- New CLI commands for workflow management
- Example workflow configurations
- Comprehensive documentation

---

## Prerequisites

### Environment Setup
- Shark CLI built and installed: `make install-shark`
- Test database: `shark init --non-interactive`
- Example workflows available in `docs/examples/workflows/`

### Required Files
- `.sharkconfig.json` - Workflow configuration with orchestrator_action metadata
- Example configs in `docs/examples/workflows/` (simple, wormwoodgm, enterprise)

### Test Data
Create test tasks for validation:
```bash
shark epic create "UAT Testing Epic"  # Creates E08
shark feature create E08 "UAT Feature"  # Creates E08-F01
shark task create E08 F01 "Test orchestrator actions"  # Creates T-E08-F01-001
```

---

## Test Scenarios

### Scenario 1: Basic Orchestrator Action Response

**Tasks covered:** T-E07-F21-001 (Schema), T-E07-F21-002 (Template), T-E07-F21-006 (Response enhancement)

**Setup:**
1. Copy example config: `cp docs/examples/workflows/simple.json .sharkconfig.json`
2. Create test task in `todo` status

**Steps:**
1. Run `shark task start T-E08-F01-001 --json`
2. Verify response includes `orchestrator_action` object
3. Check action fields: `action`, `agent_type`, `skills`, `instruction`
4. Verify `{task_id}` is populated with actual task key in instruction
5. Run `shark task complete T-E08-F01-001 --json`
6. Verify action for `ready_for_review` status is returned

**Expected Result:**
```json
{
  "id": ...,
  "key": "T-E08-F01-001",
  "status": "in_progress",
  "orchestrator_action": {
    "action": "spawn_agent",
    "agent_type": "developer",
    "skills": ["test-driven-development", "implementation"],
    "instruction": "Launch a developer agent to implement task T-E08-F01-001..."
  }
}
```

**Success Criteria:**
- [ ] Response includes orchestrator_action object
- [ ] Action type is valid (spawn_agent, pause, wait_for_triage, or archive)
- [ ] Template variable {task_id} is replaced with actual task key
- [ ] Human-readable output shows action summary
- [ ] All required fields present (agent_type, skills for spawn_agent)

---

### Scenario 2: Config Validation and Error Handling

**Tasks covered:** T-E07-F21-003 (Validation), T-E07-F21-011 (validate-actions command)

**Setup:**
1. Use `docs/examples/workflows/wormwoodgm.json` as test config

**Steps:**
1. Run `shark workflow validate-actions`
2. Verify all statuses with actions are validated
3. Verify actionable statuses without actions show warnings
4. Create invalid config (missing agent_type for spawn_agent):
   ```json
   "ready_for_development": {
     "orchestrator_action": {
       "action": "spawn_agent",
       "instruction": "Launch agent"
     }
   }
   ```
5. Run `shark workflow validate-actions --strict`
6. Verify clear error message with field name, problem, and suggested fix
7. Fix error and re-run validation
8. Verify validation passes

**Expected Result:**
- Invalid config shows error: "Status 'ready_for_development': missing required field 'agent_type' for spawn_agent action. Fix: Add agent_type field."
- Valid config shows: "✅ All statuses validated successfully"

**Success Criteria:**
- [ ] Validation catches missing required fields
- [ ] Validation catches invalid action types
- [ ] Error messages are clear and actionable
- [ ] --strict mode fails on warnings
- [ ] Valid configs pass validation

---

### Scenario 3: Workflow Commands

**Tasks covered:** T-E07-F21-010 (get-status-action), T-E07-F21-011 (validate-actions), T-E07-F21-012 (show-actions)

**Setup:**
1. Use `docs/examples/workflows/enterprise.json` config

**Steps:**
1. Run `shark config get-status-action ready_for_development --json`
   - Verify action is returned
2. Run `shark config get-status-action ready_for_development --task=T-E08-F01-001`
   - Verify template is populated
3. Run `shark config get-status-action invalid_status`
   - Verify error with exit code 1
4. Run `shark workflow show-actions`
   - Verify all actions displayed grouped by phase
   - Verify agent types and skills shown
5. Run `shark workflow show-actions --status=ready_for_development`
   - Verify filtering works
6. Run `shark workflow show-actions --action-type=spawn_agent --json`
   - Verify JSON output and filtering

**Expected Result:**
- Commands return proper JSON output
- Template population works when --task flag provided
- Errors have appropriate exit codes
- Phase grouping shows planning, development, review, qa, approval, done
- Filtering works for status and action type

**Success Criteria:**
- [ ] config get-status-action returns action for valid status
- [ ] Template variables populated with --task flag
- [ ] Invalid status returns error exit code 1
- [ ] workflow show-actions displays all actions
- [ ] Phase grouping is correct
- [ ] Filtering works (--status, --action-type)
- [ ] JSON output is valid and complete

---

### Scenario 4: Batch Task List with Actions

**Tasks covered:** T-E07-F21-013 (--with-actions flag)

**Setup:**
1. Create 5 test tasks in `ready_for_development` status
2. Use workflow config with orchestrator_action for ready_for_development

**Steps:**
1. Run `shark task list --status=ready_for_development --json`
   - Verify tasks returned WITHOUT orchestrator_action (default)
2. Run `shark task list --status=ready_for_development --with-actions --json`
   - Verify tasks returned WITH orchestrator_action field
3. Run `shark task list E08 F01 --with-actions --json`
   - Verify filtering by epic/feature works
4. Run `shark task list --agent=backend --with-actions --json`
   - Verify filtering by agent works
5. Measure performance with 100 tasks (if available)
   - Verify < 10% slower than default list

**Expected Result:**
```json
[
  {
    "id": 1,
    "key": "T-E08-F01-001",
    "status": "ready_for_development",
    "orchestrator_action": {
      "action": "spawn_agent",
      "agent_type": "developer",
      "skills": ["test-driven-development"],
      "instruction": "Launch developer for T-E08-F01-001..."
    }
  }
]
```

**Success Criteria:**
- [ ] Default list (no flag) omits orchestrator_action
- [ ] --with-actions includes orchestrator_action for each task
- [ ] Filtering works with --with-actions flag
- [ ] Performance acceptable (<10% slower)
- [ ] Backward compatible (default unchanged)

---

### Scenario 5: Example Workflow Configurations

**Tasks covered:** T-E07-F21-005 (Examples)

**Setup:**
1. Navigate to `docs/examples/workflows/`

**Steps:**
1. Test simple workflow:
   ```bash
   cp docs/examples/workflows/simple.json .sharkconfig.json
   shark workflow validate-actions
   shark workflow show-actions
   ```
2. Test wormwoodgm workflow:
   ```bash
   cp docs/examples/workflows/wormwoodgm.json .sharkconfig.json
   shark workflow validate-actions
   shark workflow show-actions
   ```
3. Test enterprise workflow:
   ```bash
   cp docs/examples/workflows/enterprise.json .sharkconfig.json
   shark workflow validate-actions
   shark workflow show-actions
   ```
4. Verify README.md has clear usage instructions
5. Verify all examples demonstrate the 4 action types:
   - spawn_agent
   - pause
   - wait_for_triage
   - archive

**Expected Result:**
- All three examples load without errors
- All examples pass validation
- All examples demonstrate different complexity levels
- README provides clear instructions

**Success Criteria:**
- [ ] simple.json validates successfully (4-5 statuses)
- [ ] wormwoodgm.json validates successfully (10-12 statuses)
- [ ] enterprise.json validates successfully (12-15 statuses)
- [ ] All action types demonstrated
- [ ] README explains when to use each example
- [ ] Examples work with shark CLI commands

---

### Scenario 6: Backward Compatibility

**Tasks covered:** All tasks (non-functional requirement)

**Setup:**
1. Use shark installation WITHOUT orchestrator_action in config
2. Use existing test tasks

**Steps:**
1. Run `shark task start <task> --json`
   - Verify works WITHOUT orchestrator_action field in response
2. Run `shark task list --json`
   - Verify works without --with-actions flag
3. Run `shark task complete <task> --json`
   - Verify status update succeeds
   - Verify no orchestrator_action field (omitted, not null)
4. Create new config with only status_flow and status_metadata (no actions)
5. Run all workflow commands
   - Verify graceful handling of missing actions

**Expected Result:**
- All existing shark commands work unchanged
- No orchestrator_action field in responses (omitted)
- No errors or warnings about missing actions
- Existing orchestrators continue to function

**Success Criteria:**
- [ ] Task update commands work without orchestrator_action config
- [ ] No breaking changes to existing functionality
- [ ] Missing actions omitted from response (not null)
- [ ] Workflow commands handle missing actions gracefully
- [ ] No errors in existing tests
- [ ] Existing scripts/automation work unchanged

---

### Scenario 7: Documentation Accuracy

**Tasks covered:** T-E07-F21-009 (Documentation)

**Setup:**
1. Open `docs/CLI_REFERENCE.md`
2. Have test environment ready

**Steps:**
1. Find "Task Update API Response Format" section
2. Verify JSON examples match actual CLI output
3. Test examples from documentation:
   - Copy JSON response examples
   - Run actual commands
   - Compare output
4. Test integration code examples:
   - Go example for parsing response
   - Python example for parsing response
5. Verify all 4 action types documented
6. Verify template variable documentation
7. Check for broken links/anchors

**Expected Result:**
- All examples in documentation are accurate
- JSON structures match actual API responses
- Code examples compile and work
- All action types documented with examples
- No broken links

**Success Criteria:**
- [ ] JSON examples match actual CLI output
- [ ] Go integration example is accurate
- [ ] Python integration example is accurate
- [ ] All 4 action types documented
- [ ] Template variables documented
- [ ] Error handling examples accurate
- [ ] No broken links or anchors

---

### Scenario 8: End-to-End Workflow

**Tasks covered:** All tasks (integration test)

**Setup:**
1. Fresh shark installation
2. Use wormwoodgm workflow config

**Steps:**
1. Initialize: `shark init --non-interactive`
2. Copy workflow: `cp docs/examples/workflows/wormwoodgm.json .sharkconfig.json`
3. Validate: `shark workflow validate-actions --strict`
4. Create epic: `shark epic create "E2E Test Epic"`
5. Create feature: `shark feature create E09 "E2E Feature"`
6. Create task: `shark task create E09 F01 "E2E Task"`
7. View actions: `shark workflow show-actions`
8. Start task: `shark task start T-E09-F01-001 --json`
   - Capture orchestrator_action
   - Verify developer agent instruction
9. Complete task: `shark task complete T-E09-F01-001 --json`
   - Capture orchestrator_action
   - Verify reviewer agent instruction
10. Approve task: `shark task approve T-E09-F01-001 --json`
    - Capture orchestrator_action (if archive action defined)

**Expected Result:**
- Complete lifecycle works with orchestrator actions returned at each transition
- Different agent types at different stages (developer → reviewer → archive)
- Instructions populated with task ID

**Success Criteria:**
- [ ] All commands execute successfully
- [ ] Orchestrator actions returned at appropriate transitions
- [ ] Different agent types per workflow phase
- [ ] Template variables populated correctly
- [ ] Task transitions follow configured workflow
- [ ] No errors during full lifecycle

---

## Performance Validation

**Performance Requirements:**
- Config load time: < 100ms
- Cached action query: < 1ms
- Template rendering: < 1ms per render
- Task update with action: < 10ms additional latency
- Task list --with-actions: < 10% slower than default

**Test:**
1. Load wormwoodgm config and measure time: `time shark workflow validate-actions`
2. Query action 10 times and average: `time for i in {1..10}; do shark config get-status-action ready_for_development; done`
3. Update task with action: `time shark task start <task> --json`
4. Compare with baseline (without orchestrator action feature)

**Success Criteria:**
- [ ] Config loads in < 100ms
- [ ] Action queries < 1ms (after first load)
- [ ] Task update overhead < 10ms
- [ ] All performance targets met

---

## Rollback Plan

If issues are found during UAT:

### Minor Issues (Documentation, clarifications)
- Fix and redeploy documentation
- No rollback needed

### Major Issues (Breaking changes, critical bugs)
1. **Remove orchestrator_action from config:**
   - Edit `.sharkconfig.json`
   - Remove all `orchestrator_action` fields from `status_metadata`
   - System reverts to pre-feature behavior

2. **Revert to previous Shark version:**
   ```bash
   git checkout <previous-tag>
   make install-shark
   ```

3. **Rollback scope:**
   - Tasks to revert: All E07-F21 tasks (T-E07-F21-001 through T-E07-F21-013)
   - Files to revert:
     - internal/config/orchestrator_action.go
     - internal/config/action_service.go
     - internal/template/renderer.go
     - internal/repository/task_repository.go (UpdateStatusWithAction)
     - internal/cli/commands/ (workflow_*, config_get_status_action)
     - docs/CLI_REFERENCE.md (orchestrator sections)

4. **Rollback verification:**
   - Run `make test` - all tests pass
   - Run `shark task start <task>` - works without actions
   - Verify existing workflows unaffected

---

## Sign-off

### Functional Testing
- [ ] All 8 test scenarios pass
- [ ] No critical bugs found
- [ ] Performance requirements met
- [ ] Documentation is accurate

### Non-Functional Testing
- [ ] Backward compatibility verified
- [ ] No breaking changes
- [ ] Error handling is clear
- [ ] Configuration validation works

### Production Readiness
- [ ] All tasks in `ready_for_approval` status
- [ ] Code review passed
- [ ] QA testing passed
- [ ] Documentation complete
- [ ] Examples provided and tested
- [ ] Rollback plan documented

### Approval
- [ ] Product Owner approval
- [ ] Technical Lead approval
- [ ] QA approval

**Ready for Production:** ☐ Yes ☐ No

**Notes:**
_[Add any observations, concerns, or recommendations here]_

---

**UAT Completed By:** ________________
**Date:** ________________
**Signature:** ________________
